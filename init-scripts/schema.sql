-- ============================================================
-- BANTU CRM 数据库 Schema
-- ============================================================
-- 从生产数据库导出的完整表结构
-- 包含：所有表、索引、外键、触发器、存储过程、视图
-- 生成时间: $(date +"%Y-%m-%d %H:%M:%S")
-- ============================================================

SET NAMES utf8mb4 COLLATE utf8mb4_0900_ai_ci;

-- 禁用外键检查（创建表时）
SET FOREIGN_KEY_CHECKS = 0;

CREATE TABLE IF NOT EXISTS `_migration_product_prices_log` (
  `id` int NOT NULL AUTO_INCREMENT,
  `product_id` char(36) NOT NULL,
  `price_type` varchar(50) NOT NULL,
  `currency` varchar(10) NOT NULL,
  `migrated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `migration_status` varchar(50) NOT NULL DEFAULT 'success',
  `error_message` text,
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_migration_status` (`migration_status`)
) ENGINE=InnoDB AUTO_INCREMENT=364 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='产品价格迁移日志表';
CREATE TABLE IF NOT EXISTS `_product_prices_backup` (
  `id` char(36) NOT NULL,
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `organization_id` char(36) DEFAULT NULL COMMENT '组织ID（NULL表示通用价格，跨服务无外键）',
  `price_type` varchar(50) NOT NULL COMMENT '价格类型：cost, channel, direct, list',
  `currency` varchar(10) NOT NULL COMMENT '货币：IDR, CNY, USD, EUR',
  `amount` decimal(18,2) NOT NULL COMMENT '价格金额',
  `exchange_rate` decimal(18,9) DEFAULT NULL COMMENT '汇率（用于计算）',
  `effective_from` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '生效时间',
  `effective_to` datetime DEFAULT NULL COMMENT '失效时间（NULL表示当前有效）',
  `source` varchar(50) DEFAULT NULL COMMENT '价格来源：manual, import, contract',
  `is_approved` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已审核',
  `approved_by` char(36) DEFAULT NULL COMMENT '审核人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审核时间',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `agent_extensions` (
  `organization_id` char(36) NOT NULL,
  `account_group` varchar(255) DEFAULT NULL,
  `category_name` varchar(255) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`organization_id`),
  CONSTRAINT `agent_extensions_ibfk_1` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `audit_logs` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '审计日志ID',
  `organization_id` char(36) NOT NULL COMMENT '组织ID（数据隔离）',
  `user_id` char(36) DEFAULT NULL COMMENT '操作用户ID',
  `user_name` varchar(255) DEFAULT NULL COMMENT '操作用户名称（冗余字段，便于查询）',
  `action` varchar(50) NOT NULL COMMENT '操作类型：CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT 等',
  `resource_type` varchar(50) DEFAULT NULL COMMENT '资源类型：user, organization, order, lead, customer 等',
  `resource_id` char(36) DEFAULT NULL COMMENT '资源ID',
  `resource_name` varchar(255) DEFAULT NULL COMMENT '资源名称（冗余字段，便于查询）',
  `category` varchar(50) DEFAULT NULL COMMENT '操作分类：user_management, order_management, customer_management 等',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `request_method` varchar(10) DEFAULT NULL COMMENT 'HTTP方法：GET, POST, PUT, DELETE 等',
  `request_path` varchar(500) DEFAULT NULL COMMENT '请求路径',
  `request_params` json DEFAULT NULL COMMENT '请求参数（JSON格式）',
  `old_values` json DEFAULT NULL COMMENT '修改前的值（JSON格式，用于 UPDATE 操作）',
  `new_values` json DEFAULT NULL COMMENT '修改后的值（JSON格式，用于 UPDATE 操作）',
  `status` varchar(20) NOT NULL DEFAULT 'success' COMMENT '操作状态：success, failed',
  `error_message` text COMMENT '错误信息（如果操作失败）',
  `duration_ms` int DEFAULT NULL COMMENT '操作耗时（毫秒）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间（用于分区和查询）',
  PRIMARY KEY (`id`),
  KEY `ix_audit_logs_organization` (`organization_id`),
  KEY `ix_audit_logs_user` (`user_id`),
  KEY `ix_audit_logs_action` (`action`),
  KEY `ix_audit_logs_resource_type` (`resource_type`),
  KEY `ix_audit_logs_resource_id` (`resource_id`),
  KEY `ix_audit_logs_category` (`category`),
  KEY `ix_audit_logs_created_at` (`created_at` DESC),
  KEY `idx_org_created` (`organization_id`,`created_at`),
  KEY `idx_user_created` (`user_id`,`created_at`),
  KEY `idx_resource_created` (`resource_type`,`resource_id`,`created_at`),
  KEY `idx_category_created` (`category`,`created_at`),
  CONSTRAINT `chk_audit_logs_status` CHECK ((`status` in (_utf8mb4'success',_utf8mb4'failed')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='审计日志表';
CREATE TABLE IF NOT EXISTS `biz_expense_records` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `expense_no` varchar(50) NOT NULL COMMENT '报销单号 (如 EXP-20231027-001)',
  `applicant_id` char(36) NOT NULL COMMENT '申请人/报销员工ID (关联 users.id)',
  `amount` decimal(18,2) NOT NULL COMMENT '报销金额',
  `currency` varchar(10) DEFAULT 'CNY' COMMENT '币种 (CNY/IDR)',
  `category` varchar(50) NOT NULL COMMENT '费用类别 (如: 交通费, 餐饮招待, 签证费, 资料打印)',
  `cost_attribution` enum('SALES','EXECUTION','OPERATION') NOT NULL COMMENT '成本归属: SALES(销售成本), EXECUTION(执行成本), OPERATION(公司运营)',
  `customer_id` int DEFAULT NULL COMMENT '关联客户 (销售招待常用)',
  `order_id` char(36) DEFAULT NULL COMMENT '关联主订单 (销售跟单费用)',
  `order_item_id` char(36) DEFAULT NULL COMMENT '关联具体服务项 (执行/中台办事费用)',
  `status` enum('DRAFT','PENDING','APPROVED','REJECTED','PAID') DEFAULT 'DRAFT' COMMENT '状态: 草稿, 审批中, 已同意, 已驳回, 已打款',
  `audit_status_comment` varchar(255) DEFAULT NULL COMMENT '审批/驳回意见',
  `approved_by` char(36) DEFAULT NULL COMMENT '审批人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审批时间',
  `paid_at` datetime DEFAULT NULL COMMENT '财务打款时间(实际发生成本的时间)',
  `description` text COMMENT '费用备注说明',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_expense_no` (`expense_no`),
  KEY `ix_expense_applicant` (`applicant_id`),
  KEY `ix_expense_order` (`order_id`),
  KEY `ix_expense_item` (`order_item_id`),
  KEY `ix_expense_customer` (`customer_id`),
  KEY `ix_expense_status` (`status`),
  KEY `ix_expense_attribution` (`cost_attribution`),
  KEY `ix_expense_created_at` (`created_at` DESC),
  CONSTRAINT `fk_exp_applicant` FOREIGN KEY (`applicant_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_exp_order` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`),
  CONSTRAINT `fk_exp_order_item` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`),
  CONSTRAINT `chk_expense_amount_nonneg` CHECK ((`amount` >= 0))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='浮动成本/费用报销记录表';
CREATE TABLE IF NOT EXISTS `collection_tasks` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL COMMENT '订单ID',
  `payment_stage_id` char(36) DEFAULT NULL COMMENT '付款阶段ID',
  `task_type` varchar(50) NOT NULL COMMENT '任务类型：auto(自动), manual(手动)',
  `status` varchar(50) DEFAULT 'pending' COMMENT '状态：pending(待处理), in_progress(进行中), completed(已完成), cancelled(已取消)',
  `due_date` date DEFAULT NULL COMMENT '到期日期',
  `reminder_count` int DEFAULT '0' COMMENT '提醒次数',
  `notes` text COMMENT '备注',
  `assigned_to_user_id` char(36) DEFAULT NULL COMMENT '分配给的用户ID（销售负责人）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `ix_collection_tasks_order` (`order_id`),
  KEY `ix_collection_tasks_payment_stage` (`payment_stage_id`),
  KEY `ix_collection_tasks_assigned_to` (`assigned_to_user_id`),
  KEY `ix_collection_tasks_status` (`status`),
  KEY `ix_collection_tasks_due_date` (`due_date`),
  KEY `ix_collection_tasks_created_at` (`created_at` DESC),
  CONSTRAINT `collection_tasks_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `collection_tasks_ibfk_2` FOREIGN KEY (`payment_stage_id`) REFERENCES `payment_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `collection_tasks_ibfk_3` FOREIGN KEY (`assigned_to_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `collection_tasks_ibfk_4` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_collection_tasks_reminder_count` CHECK ((`reminder_count` >= 0)),
  CONSTRAINT `chk_collection_tasks_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'in_progress',_utf8mb4'completed',_utf8mb4'cancelled'))),
  CONSTRAINT `chk_collection_tasks_type` CHECK ((`task_type` in (_utf8mb4'auto',_utf8mb4'manual')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='催款任务表';
CREATE TABLE IF NOT EXISTS `collection_todos` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '待办ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `payment_id` char(36) DEFAULT NULL COMMENT '关联收款ID（外键 → payments.id）',
  `todo_type` enum('check_payment','verify_delivery','release_new_order','finance_review','send_notification') NOT NULL COMMENT '待办类型：check_payment(检查款项), verify_delivery(验证交付), release_new_order(释放新订单), finance_review(财务核对), send_notification(发送通知)',
  `title` varchar(255) NOT NULL COMMENT '待办标题',
  `description` text COMMENT '详细描述',
  `assigned_to` char(36) DEFAULT NULL COMMENT '分配人ID（外键 → users.id，如Lulu核对）',
  `due_date` datetime DEFAULT NULL COMMENT '截止时间',
  `status` enum('pending','in_progress','completed','cancelled') NOT NULL DEFAULT 'pending' COMMENT '待办状态',
  `completed_at` datetime DEFAULT NULL COMMENT '完成时间',
  `completed_by` char(36) DEFAULT NULL COMMENT '完成人ID（外键 → users.id）',
  `notification_sent` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已发送提醒（1=是）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_collection_todos_opportunity_id` (`opportunity_id`),
  KEY `ix_collection_todos_payment_id` (`payment_id`),
  KEY `ix_collection_todos_assigned_to` (`assigned_to`),
  KEY `ix_collection_todos_status` (`status`),
  KEY `ix_collection_todos_type` (`todo_type`),
  KEY `fk_collection_todos_completed_by` (`completed_by`),
  CONSTRAINT `fk_collection_todos_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_collection_todos_completed_by` FOREIGN KEY (`completed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_collection_todos_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_collection_todos_payment_id` FOREIGN KEY (`payment_id`) REFERENCES `payments` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='收款待办事项表 - 支持检查款项、交付验证、新订单释放通知、财务核对提醒';
CREATE TABLE IF NOT EXISTS `company_registration_info` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '记录ID',
  `execution_order_id` char(36) NOT NULL COMMENT '公司注册执行订单ID（外键 → execution_orders.id，一对一）',
  `company_name` varchar(255) NOT NULL COMMENT '公司名称',
  `nib` varchar(100) DEFAULT NULL COMMENT 'NIB企业登记证号',
  `npwp` varchar(100) DEFAULT NULL COMMENT '税卡号',
  `izin_lokasi` varchar(100) DEFAULT NULL COMMENT '公司户籍',
  `akta` varchar(100) DEFAULT NULL COMMENT '公司章程',
  `sk` varchar(100) DEFAULT NULL COMMENT '司法部批文',
  `registration_status` enum('in_progress','completed','failed') NOT NULL DEFAULT 'in_progress' COMMENT '注册状态',
  `completed_at` datetime DEFAULT NULL COMMENT '注册完成时间（触发后续订单释放）',
  `notes` text COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_company_reg_order_id` (`execution_order_id`),
  KEY `ix_company_reg_status` (`registration_status`),
  CONSTRAINT `fk_company_reg_execution_order_id` FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='公司注册信息记录表 - 记录NIB、NPWP等关键信息，用于依赖查询和释放后续订单';
CREATE TABLE IF NOT EXISTS `contacts` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `customer_id` int NOT NULL COMMENT '客户ID',
  `organization_id` char(36) NOT NULL COMMENT 'ç»„ç»‡IDï¼ˆæ•°æ®éš”ç¦»ï¼‰',
  `owner_user_id` char(36) DEFAULT NULL COMMENT 'è´Ÿè´£äººIDï¼ˆæ•°æ®éš”ç¦»ï¼‰',
  `name` varchar(255) NOT NULL COMMENT 'è”ç³»äººå§“å',
  `email` varchar(255) DEFAULT NULL,
  `phone` varchar(50) DEFAULT NULL,
  `mobile` varchar(50) DEFAULT NULL,
  `position` varchar(255) DEFAULT NULL,
  `department` varchar(255) DEFAULT NULL,
  `is_primary` tinyint(1) DEFAULT '0',
  `is_decision_maker` tinyint(1) DEFAULT '0',
  `contact_role` varchar(100) DEFAULT NULL,
  `address` text,
  `city` varchar(100) DEFAULT NULL,
  `province` varchar(100) DEFAULT NULL,
  `country` varchar(100) DEFAULT NULL,
  `postal_code` varchar(20) DEFAULT NULL,
  `preferred_contact_method` varchar(50) DEFAULT NULL,
  `wechat_id` varchar(100) DEFAULT NULL,
  `notes` text,
  `is_active` tinyint(1) DEFAULT '1',
  `created_by` char(36) DEFAULT NULL,
  `updated_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_contacts_one_primary_per_customer` (`customer_id`,`is_primary`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_contacts_customer` (`customer_id`),
  KEY `ix_contacts_email` (`email`),
  KEY `ix_contacts_phone` (`phone`),
  KEY `ix_contacts_primary` (`customer_id`,`is_primary`),
  KEY `ix_contacts_owner` (`owner_user_id`),
  KEY `ix_contacts_organization` (`organization_id`),
  CONSTRAINT `contacts_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE CASCADE,
  CONSTRAINT `contacts_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `contacts_ibfk_3` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `contacts_ibfk_4` FOREIGN KEY (`owner_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `contacts_ibfk_5` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `contract_documents` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '文件记录ID',
  `contract_id` char(36) NOT NULL COMMENT '合同ID（外键 → contracts.id）',
  `document_type` enum('quotation_pdf','contract_pdf','invoice_pdf') NOT NULL COMMENT '文件类型：quotation_pdf(报价单), contract_pdf(合同), invoice_pdf(发票)',
  `file_name` varchar(255) NOT NULL COMMENT '文件名（如：QUO-20251228-001.pdf）',
  `file_url` varchar(500) NOT NULL COMMENT 'OSS存储路径（班兔合同云）',
  `file_size_kb` int DEFAULT NULL COMMENT '文件大小（KB）',
  `generated_at` datetime DEFAULT NULL COMMENT '生成时间',
  `sent_at` datetime DEFAULT NULL COMMENT '发送给客户时间',
  `version` int NOT NULL DEFAULT '1' COMMENT '版本号（同一类型可重生成）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '生成人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_contract_document_type_version` (`contract_id`,`document_type`,`version`),
  KEY `ix_contract_documents_contract_id` (`contract_id`),
  KEY `ix_contract_documents_type` (`document_type`),
  KEY `fk_contract_documents_created_by` (`created_by`),
  CONSTRAINT `fk_contract_documents_contract_id` FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_contract_documents_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='合同相关文件表 - 存储报价单、合同、发票三个PDF（班兔合同云 OSS）';
CREATE TABLE IF NOT EXISTS `contract_entities` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '签约主体ID',
  `entity_code` varchar(50) NOT NULL COMMENT '主体代码（唯一，如：BJ_BANTU, HB_BANTU, PT_PUBLIC, PT_PRIVATE_IDR, PT_RMB_PRIVATE）',
  `entity_name` varchar(255) NOT NULL COMMENT '主体名称（如：北京班兔科技有限公司）',
  `short_name` varchar(100) NOT NULL COMMENT '简称（如：北京班兔）',
  `legal_representative` varchar(100) DEFAULT NULL COMMENT '法定代表人',
  `tax_rate` decimal(5,4) NOT NULL DEFAULT '0.0000' COMMENT '税点（例如：0.0100 = 1%）',
  `tax_id` varchar(100) DEFAULT NULL COMMENT '税号',
  `bank_name` varchar(200) DEFAULT NULL COMMENT '开户行',
  `bank_account_no` varchar(100) DEFAULT NULL COMMENT '收款账户',
  `bank_account_name` varchar(200) DEFAULT NULL COMMENT '账户名称',
  `currency` varchar(10) NOT NULL DEFAULT 'CNY' COMMENT '主要收款币种：CNY 或 IDR',
  `address` text COMMENT '公司地址',
  `contact_phone` varchar(50) DEFAULT NULL COMMENT '联系电话',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `entity_code` (`entity_code`),
  UNIQUE KEY `uk_entity_code` (`entity_code`),
  KEY `ix_entities_active` (`is_active`),
  KEY `ix_entities_currency` (`currency`),
  KEY `fk_entities_created_by` (`created_by`),
  KEY `fk_entities_updated_by` (`updated_by`),
  CONSTRAINT `fk_entities_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_entities_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='签约主体管理表 - 支持后台新增/修改/删除签约主体及收款账户、税点信息';
CREATE TABLE IF NOT EXISTS `contract_material_documents` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '资料上传记录ID',
  `contract_id` char(36) NOT NULL COMMENT '合同ID（外键 → contracts.id）',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id，便于查询）',
  `quotation_item_id` char(36) DEFAULT NULL COMMENT '关联报价单明细ID（外键 → quotation_items.id，标识所属服务）',
  `product_id` char(36) DEFAULT NULL COMMENT '产品ID（外键 → products.id）',
  `rule_id` char(36) NOT NULL COMMENT '资料规则ID（外键 → product_document_rules.id）',
  `wechat_group_no` varchar(100) DEFAULT NULL COMMENT '关联微信群编号（用于链路聚合）',
  `document_name` varchar(255) NOT NULL COMMENT '上传文件名',
  `file_url` varchar(500) NOT NULL COMMENT 'OSS存储路径（班兔自有合同云）',
  `file_size_kb` int DEFAULT NULL COMMENT '文件大小',
  `file_type` varchar(50) DEFAULT NULL COMMENT '文件MIME类型',
  `uploaded_by` char(36) DEFAULT NULL COMMENT '上传人ID（外键 → users.id，可为客户通过临时链接上传）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `validation_status` enum('pending','passed','failed') NOT NULL DEFAULT 'pending' COMMENT '校验状态：pending(待校验), passed(通过), failed(失败)',
  `validation_message` text COMMENT '校验失败原因',
  `status` enum('submitted','approved','rejected') NOT NULL DEFAULT 'submitted' COMMENT '审批状态',
  `approved_by` char(36) DEFAULT NULL COMMENT '审批人ID（外键 → users.id）',
  `approved_at` datetime DEFAULT NULL COMMENT '审批时间',
  `approval_notes` text COMMENT '审批备注',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_contract_rule_once` (`contract_id`,`rule_id`) COMMENT '同一合同同一规则只允许上传一次（可扩展支持多份）',
  KEY `ix_material_contract_id` (`contract_id`),
  KEY `ix_material_opportunity_id` (`opportunity_id`),
  KEY `ix_material_quotation_item_id` (`quotation_item_id`),
  KEY `ix_material_rule_id` (`rule_id`),
  KEY `ix_material_wechat_group_no` (`wechat_group_no`),
  KEY `ix_material_validation_status` (`validation_status`),
  KEY `ix_material_status` (`status`),
  KEY `fk_material_product_id` (`product_id`),
  KEY `fk_material_uploaded_by` (`uploaded_by`),
  KEY `fk_material_approved_by` (`approved_by`),
  CONSTRAINT `fk_material_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_material_contract_id` FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_material_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_material_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_material_quotation_item_id` FOREIGN KEY (`quotation_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_material_rule_id` FOREIGN KEY (`rule_id`) REFERENCES `product_document_rules` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_material_uploaded_by` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='合同资料收集表 - 实际上传资料、校验、审批，支持群编号与服务关联';
CREATE TABLE IF NOT EXISTS `contract_templates` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '合同模板ID',
  `template_code` varchar(50) NOT NULL COMMENT '模板代码（唯一，如：CONTRACT_BJ_BANTU, CONTRACT_PT_PUBLIC）',
  `template_name` varchar(255) NOT NULL COMMENT '模板名称',
  `entity_id` char(36) NOT NULL COMMENT '关联签约主体ID（外键 → contract_entities.id）',
  `language` enum('zh','id','zh_id','en_zh') NOT NULL DEFAULT 'zh' COMMENT '模板语言',
  `file_url` varchar(500) NOT NULL COMMENT '模板文件路径（OSS链接，HTML/FreeMarker/Word等）',
  `file_type` enum('html','docx','freemarker','pdf_background') NOT NULL COMMENT '模板类型',
  `header_logo_url` varchar(500) DEFAULT NULL COMMENT '抬头Logo',
  `footer_text` text COMMENT '页脚文本',
  `is_default_for_entity` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否为该主体默认模板（1=是）',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `template_code` (`template_code`),
  UNIQUE KEY `uk_contract_template_code` (`template_code`),
  KEY `ix_contract_templates_entity_id` (`entity_id`),
  KEY `ix_contract_templates_active` (`is_active`),
  KEY `fk_contract_templates_created_by` (`created_by`),
  KEY `fk_contract_templates_updated_by` (`updated_by`),
  CONSTRAINT `fk_contract_templates_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_contract_templates_entity_id` FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_contract_templates_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='合同PDF模板表 - 每个签约主体专用合同模板';
CREATE TABLE IF NOT EXISTS `contracts` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '合同ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `quotation_id` char(36) DEFAULT NULL COMMENT '关联报价单ID（外键 → quotations.id，通常为primary_quotation_id）',
  `contract_no` varchar(50) NOT NULL COMMENT '合同编号（如：CON-20251228-001）',
  `entity_id` char(36) NOT NULL COMMENT '乙方签约主体ID（外键 → contract_entities.id）',
  `party_a_name` varchar(255) NOT NULL COMMENT '甲方名称（客户公司/个人名）',
  `party_a_contact` varchar(100) DEFAULT NULL COMMENT '甲方联系人',
  `party_a_phone` varchar(50) DEFAULT NULL COMMENT '甲方联系电话',
  `party_a_email` varchar(255) DEFAULT NULL COMMENT '甲方邮箱',
  `party_a_address` text COMMENT '甲方地址',
  `total_amount_with_tax` decimal(18,2) NOT NULL COMMENT '含税总金额（自动计算 = 报价金额 + 税点）',
  `tax_amount` decimal(18,2) NOT NULL DEFAULT '0.00' COMMENT '税额（自动计算）',
  `tax_rate` decimal(5,4) NOT NULL DEFAULT '0.0000' COMMENT '税率（冗余自contract_entities，便于查询）',
  `status` enum('draft','sent','signed','effective','terminated') NOT NULL DEFAULT 'draft' COMMENT '合同状态',
  `signed_at` datetime DEFAULT NULL COMMENT '签署时间',
  `effective_from` date DEFAULT NULL COMMENT '合同生效日期',
  `effective_to` date DEFAULT NULL COMMENT '合同到期日期（长周期服务使用）',
  `template_id` char(36) DEFAULT NULL COMMENT '使用的合同模板ID（外键 → contract_templates.id）',
  `wechat_group_no` varchar(100) DEFAULT NULL COMMENT '关联微信群编号（继承自报价单）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `contract_no` (`contract_no`),
  UNIQUE KEY `uk_contract_no` (`contract_no`),
  KEY `ix_contracts_opportunity_id` (`opportunity_id`),
  KEY `ix_contracts_quotation_id` (`quotation_id`),
  KEY `ix_contracts_entity_id` (`entity_id`),
  KEY `ix_contracts_status` (`status`),
  KEY `ix_contracts_wechat_group_no` (`wechat_group_no`),
  KEY `fk_contracts_template_id` (`template_id`),
  KEY `fk_contracts_created_by` (`created_by`),
  CONSTRAINT `fk_contracts_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_contracts_entity_id` FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_contracts_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_contracts_quotation_id` FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_contracts_template_id` FOREIGN KEY (`template_id`) REFERENCES `contract_templates` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='合同主表 - 记录甲方信息、乙方签约主体、含税金额、模板使用';
CREATE TABLE IF NOT EXISTS `customer_channels` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `description` text COMMENT '渠道描述',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_customer_channels_active` (`is_active`),
  KEY `ix_customer_channels_display_order` (`display_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `customer_documents` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `customer_id` int NOT NULL COMMENT '客户ID',
  `customer_name` varchar(255) DEFAULT NULL COMMENT '客户名称（冗余字段）',
  `document_type` varchar(50) NOT NULL COMMENT '文档类型：passport(护照), id_card(身份证), business_license(营业执照), visa(签证), other(其他)',
  `document_name` varchar(255) NOT NULL COMMENT '文档名称',
  `document_number` varchar(100) DEFAULT NULL COMMENT '文档编号（如护照号、身份证号）',
  `issuing_country` varchar(100) DEFAULT NULL COMMENT '签发国家',
  `issuing_authority` varchar(255) DEFAULT NULL COMMENT '签发机构',
  `issue_date` date DEFAULT NULL COMMENT '签发日期',
  `expiry_date` date DEFAULT NULL COMMENT '到期日期',
  `is_valid` tinyint(1) DEFAULT '1' COMMENT '是否有效',
  `file_url` varchar(500) DEFAULT NULL COMMENT '文件URL（完整路径）',
  `file_path` varchar(500) DEFAULT NULL COMMENT '文件路径（相对路径）',
  `file_name` varchar(255) DEFAULT NULL COMMENT '文件名',
  `file_size` bigint DEFAULT NULL COMMENT '文件大小（字节）',
  `file_type` varchar(50) DEFAULT NULL COMMENT '文件类型（如：image/jpeg, application/pdf）',
  `thumbnail_url` varchar(500) DEFAULT NULL COMMENT '缩略图URL',
  `full_name` varchar(255) DEFAULT NULL COMMENT '姓名（从护照提取）',
  `first_name` varchar(255) DEFAULT NULL COMMENT '名',
  `last_name` varchar(255) DEFAULT NULL COMMENT '姓',
  `date_of_birth` date DEFAULT NULL COMMENT '出生日期',
  `gender` varchar(10) DEFAULT NULL COMMENT '性别：male, female, other',
  `nationality` varchar(100) DEFAULT NULL COMMENT '国籍',
  `place_of_birth` varchar(255) DEFAULT NULL COMMENT '出生地',
  `address` text COMMENT '地址',
  `city` varchar(100) DEFAULT NULL COMMENT '城市',
  `province` varchar(100) DEFAULT NULL COMMENT '省/州',
  `country` varchar(100) DEFAULT NULL COMMENT '国家',
  `postal_code` varchar(20) DEFAULT NULL COMMENT '邮编',
  `phone` varchar(50) DEFAULT NULL COMMENT '电话',
  `email` varchar(255) DEFAULT NULL COMMENT '邮箱',
  `status` varchar(50) DEFAULT 'active' COMMENT '状态：active(有效), expired(过期), cancelled(已取消)',
  `notes` text COMMENT '备注',
  `is_primary` tinyint(1) DEFAULT '0' COMMENT '是否主要文档',
  `is_verified` tinyint(1) DEFAULT '0' COMMENT '是否已验证',
  `verified_by` char(36) DEFAULT NULL COMMENT '验证人ID',
  `verified_at` datetime DEFAULT NULL COMMENT '验证时间',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `verified_by` (`verified_by`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_customer_documents_customer` (`customer_id`),
  KEY `ix_customer_documents_type` (`document_type`),
  KEY `ix_customer_documents_number` (`document_number`),
  KEY `ix_customer_documents_status` (`status`),
  KEY `ix_customer_documents_expiry` (`expiry_date`),
  KEY `ix_customer_documents_is_primary` (`customer_id`,`is_primary`),
  KEY `ix_customer_documents_is_verified` (`is_verified`),
  CONSTRAINT `customer_documents_ibfk_2` FOREIGN KEY (`verified_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customer_documents_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customer_documents_ibfk_4` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_customer_documents_gender` CHECK (((`gender` in (_utf8mb4'male',_utf8mb4'female',_utf8mb4'other')) or (`gender` is null))),
  CONSTRAINT `chk_customer_documents_status` CHECK ((`status` in (_utf8mb4'active',_utf8mb4'expired',_utf8mb4'cancelled'))),
  CONSTRAINT `chk_customer_documents_type` CHECK ((`document_type` in (_utf8mb4'passport',_utf8mb4'id_card',_utf8mb4'business_license',_utf8mb4'visa',_utf8mb4'other')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户文档表 - 保存客户的护照、身份证等文档信息';
CREATE TABLE IF NOT EXISTS `customer_follow_ups` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `customer_id` int NOT NULL COMMENT '客户ID',
  `follow_up_type` varchar(50) NOT NULL COMMENT '跟进类型：call(电话), meeting(会议), email(邮件), note(备注), visit(拜访), wechat(微信), whatsapp(WhatsApp)',
  `content` text COMMENT '跟进内容',
  `follow_up_date` datetime NOT NULL COMMENT '跟进日期',
  `status_before` varchar(50) DEFAULT NULL COMMENT '跟进前状态（可选）',
  `status_after` varchar(50) DEFAULT NULL COMMENT '跟进后状态（可选）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `ix_customer_follow_ups_customer` (`customer_id`),
  KEY `ix_customer_follow_ups_date` (`follow_up_date` DESC),
  KEY `ix_customer_follow_ups_type` (`follow_up_type`),
  KEY `ix_customer_follow_ups_created_at` (`created_at` DESC),
  CONSTRAINT `customer_follow_ups_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE CASCADE,
  CONSTRAINT `customer_follow_ups_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_customer_follow_ups_type` CHECK ((`follow_up_type` in (_utf8mb4'call',_utf8mb4'meeting',_utf8mb4'email',_utf8mb4'note',_utf8mb4'visit',_utf8mb4'wechat',_utf8mb4'whatsapp')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户跟进记录表';
CREATE TABLE IF NOT EXISTS `customer_level_prices` (
  `id` char(36) NOT NULL,
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `customer_level_code` varchar(50) NOT NULL COMMENT '客户等级代码（外键 → customer_levels.code）',
  `currency` varchar(10) NOT NULL COMMENT '货币：IDR, CNY, USD, EUR',
  `amount` decimal(18,2) NOT NULL COMMENT '价格金额',
  `effective_from` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '生效时间',
  `effective_to` datetime DEFAULT NULL COMMENT '失效时间（NULL表示当前有效）',
  `source` varchar(50) DEFAULT NULL COMMENT '价格来源：manual, import, contract',
  `is_approved` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已审核',
  `approved_by` char(36) DEFAULT NULL COMMENT '审核人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审核时间',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_customer_level_code` (`customer_level_code`),
  KEY `idx_currency` (`currency`),
  KEY `idx_effective_from` (`effective_from`),
  KEY `idx_effective_to` (`effective_to`),
  KEY `idx_product_level_currency` (`product_id`,`customer_level_code`,`currency`),
  KEY `fk_customer_level_prices_approved_by` (`approved_by`),
  KEY `fk_customer_level_prices_changed_by` (`changed_by`),
  CONSTRAINT `fk_customer_level_prices_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_customer_level_prices_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_customer_level_prices_customer_level_code` FOREIGN KEY (`customer_level_code`) REFERENCES `customer_levels` (`code`) ON DELETE RESTRICT,
  CONSTRAINT `fk_customer_level_prices_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_customer_level_prices_amount_nonneg` CHECK ((`amount` >= 0)),
  CONSTRAINT `chk_customer_level_prices_currency` CHECK ((`currency` in (_utf8mb4'IDR',_utf8mb4'CNY',_utf8mb4'USD',_utf8mb4'EUR')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户等级价格表';
CREATE TABLE IF NOT EXISTS `customer_levels` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) NOT NULL COMMENT '等级代码（如：2, 3, 4, 5, 6）',
  `name_zh` varchar(255) NOT NULL COMMENT '等级名称（中文）',
  `name_id` varchar(255) NOT NULL COMMENT '等级名称（印尼语）',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '排序顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `description_zh` text COMMENT '描述（中文）',
  `description_id` text COMMENT '描述（印尼语）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_customer_levels_code` (`code`),
  KEY `idx_customer_levels_active` (`is_active`),
  KEY `idx_customer_levels_sort` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户等级配置表';
CREATE TABLE IF NOT EXISTS `customer_notes` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `customer_id` int NOT NULL COMMENT '客户ID',
  `note_type` varchar(50) NOT NULL COMMENT '备注类型：comment(评论), reminder(提醒), task(任务), internal(内部), customer_feedback(客户反馈)',
  `content` text NOT NULL COMMENT '备注内容',
  `is_important` tinyint(1) DEFAULT '0' COMMENT '是否重要',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `ix_customer_notes_customer` (`customer_id`),
  KEY `ix_customer_notes_type` (`note_type`),
  KEY `ix_customer_notes_important` (`is_important`),
  KEY `ix_customer_notes_created_at` (`created_at` DESC),
  CONSTRAINT `customer_notes_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE CASCADE,
  CONSTRAINT `customer_notes_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_customer_notes_type` CHECK ((`note_type` in (_utf8mb4'comment',_utf8mb4'reminder',_utf8mb4'task',_utf8mb4'internal',_utf8mb4'customer_feedback')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='客户备注表';
CREATE TABLE IF NOT EXISTS `customer_sources` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `description` text COMMENT '来源描述',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_customer_sources_active` (`is_active`),
  KEY `ix_customer_sources_display_order` (`display_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `customers` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '客户ID：数据库自增，5位数字',
  `id_external` varchar(255) DEFAULT NULL,
  `owner_id_external` varchar(255) DEFAULT NULL,
  `owner_name` varchar(255) DEFAULT NULL,
  `created_by_external` varchar(255) DEFAULT NULL,
  `created_by_name` varchar(255) DEFAULT NULL,
  `updated_by_external` varchar(255) DEFAULT NULL,
  `updated_by_name` varchar(255) DEFAULT NULL,
  `created_at_src` datetime DEFAULT NULL,
  `updated_at_src` datetime DEFAULT NULL,
  `last_action_at_src` datetime DEFAULT NULL,
  `change_log_at_src` datetime DEFAULT NULL,
  `linked_module` varchar(100) DEFAULT NULL,
  `linked_id_external` varchar(255) DEFAULT NULL,
  `name` varchar(255) NOT NULL,
  `code` varchar(100) DEFAULT NULL,
  `level` varchar(50) DEFAULT NULL,
  `parent_id_external` varchar(255) DEFAULT NULL,
  `parent_customer_id` int DEFAULT NULL COMMENT '父客户ID（外键 → customers.id）',
  `parent_name` varchar(255) DEFAULT NULL,
  `industry_id` char(36) DEFAULT NULL COMMENT 'è¡Œä¸šIDï¼ˆå¤–é”® â†’ industries.idï¼‰',
  `description` text,
  `tags` json DEFAULT (json_array()),
  `is_locked` tinyint(1) DEFAULT NULL,
  `last_enriched_at_src` datetime DEFAULT NULL,
  `enrich_status` varchar(50) DEFAULT NULL,
  `channel_name` varchar(255) DEFAULT NULL,
  `source_name` varchar(255) DEFAULT NULL,
  `customer_requirements` text,
  `source_id` char(36) DEFAULT NULL,
  `channel_id` char(36) DEFAULT NULL,
  `customer_source_type` varchar(50) DEFAULT 'own',
  `customer_type` varchar(50) DEFAULT 'individual',
  `owner_user_id` char(36) DEFAULT NULL,
  `agent_user_id` char(36) DEFAULT NULL,
  `agent_id` char(36) DEFAULT NULL,
  `organization_id` char(36) NOT NULL COMMENT 'ç»„ç»‡IDï¼ˆæ•°æ®éš”ç¦»ï¼‰',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `last_follow_up_at` datetime DEFAULT NULL COMMENT '最后跟进时间',
  `next_follow_up_at` datetime DEFAULT NULL COMMENT '下次跟进时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_external` (`id_external`),
  UNIQUE KEY `ux_customers_code` (`code`),
  KEY `source_id` (`source_id`),
  KEY `channel_id` (`channel_id`),
  KEY `ix_customers_source_type` (`customer_source_type`),
  KEY `ix_customers_customer_type` (`customer_type`),
  KEY `ix_customers_owner` (`owner_user_id`),
  KEY `ix_customers_agent` (`agent_user_id`),
  KEY `ix_customers_agent_id` (`agent_id`),
  KEY `ix_customers_parent` (`parent_customer_id`),
  KEY `ix_customers_source` (`customer_source_type`),
  KEY `ix_customers_organization` (`organization_id`),
  KEY `ix_customers_last_follow_up` (`last_follow_up_at`),
  KEY `ix_customers_next_follow_up` (`next_follow_up_at`),
  KEY `ix_customers_industry_id` (`industry_id`),
  CONSTRAINT `customers_ibfk_1` FOREIGN KEY (`parent_customer_id`) REFERENCES `customers` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_2` FOREIGN KEY (`source_id`) REFERENCES `customer_sources` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_3` FOREIGN KEY (`channel_id`) REFERENCES `customer_channels` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_4` FOREIGN KEY (`owner_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_5` FOREIGN KEY (`agent_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_6` FOREIGN KEY (`agent_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `customers_ibfk_7` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_customers_industry` FOREIGN KEY (`industry_id`) REFERENCES `industries` (`id`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `chk_customer_source_type` CHECK ((`customer_source_type` in (_utf8mb4'own',_utf8mb4'agent'))),
  CONSTRAINT `chk_customer_type` CHECK ((`customer_type` in (_utf8mb4'individual',_utf8mb4'organization')))
) ENGINE=InnoDB AUTO_INCREMENT=12000 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `deliverables` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) DEFAULT NULL,
  `order_stage_id` char(36) DEFAULT NULL,
  `deliverable_type` varchar(100) NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text,
  `file_path` text,
  `file_url` text,
  `file_size` bigint DEFAULT NULL,
  `mime_type` varchar(100) DEFAULT NULL,
  `is_verified` tinyint(1) DEFAULT '0',
  `verified_by` char(36) DEFAULT NULL,
  `verified_at` datetime DEFAULT NULL,
  `uploaded_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `verified_by` (`verified_by`),
  KEY `ix_deliverables_order` (`order_id`),
  KEY `ix_deliverables_stage` (`order_stage_id`),
  KEY `ix_deliverables_uploaded` (`uploaded_by`),
  CONSTRAINT `deliverables_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `deliverables_ibfk_2` FOREIGN KEY (`order_stage_id`) REFERENCES `order_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `deliverables_ibfk_3` FOREIGN KEY (`verified_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `deliverables_ibfk_4` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_deliverables_file_size_nonneg` CHECK ((coalesce(`file_size`,0) >= 0))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `exchange_rate_history` (
  `id` char(36) NOT NULL,
  `from_currency` varchar(10) NOT NULL COMMENT '源货币：IDR, CNY, USD, EUR',
  `to_currency` varchar(10) NOT NULL COMMENT '目标货币：IDR, CNY, USD, EUR',
  `rate` decimal(18,9) NOT NULL COMMENT '汇率',
  `effective_from` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '生效时间',
  `effective_to` datetime DEFAULT NULL COMMENT '失效时间（NULL表示当前有效）',
  `source` varchar(50) DEFAULT NULL COMMENT '汇率来源：manual, api, import',
  `source_reference` varchar(255) DEFAULT NULL COMMENT '来源参考（如API提供商）',
  `is_approved` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已审核',
  `approved_by` char(36) DEFAULT NULL COMMENT '审核人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审核时间',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_from_currency` (`from_currency`),
  KEY `idx_to_currency` (`to_currency`),
  KEY `idx_effective_from` (`effective_from`),
  KEY `idx_effective_to` (`effective_to`),
  KEY `idx_currency_pair` (`from_currency`,`to_currency`),
  KEY `fk_exchange_rate_history_approved_by` (`approved_by`),
  KEY `fk_exchange_rate_history_changed_by` (`changed_by`),
  CONSTRAINT `fk_exchange_rate_history_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_exchange_rate_history_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_exchange_rate_history_currencies_different` CHECK ((`from_currency` <> `to_currency`)),
  CONSTRAINT `chk_exchange_rate_history_from_currency` CHECK ((`from_currency` in (_utf8mb4'IDR',_utf8mb4'CNY',_utf8mb4'USD',_utf8mb4'EUR'))),
  CONSTRAINT `chk_exchange_rate_history_rate_positive` CHECK ((`rate` > 0)),
  CONSTRAINT `chk_exchange_rate_history_to_currency` CHECK ((`to_currency` in (_utf8mb4'IDR',_utf8mb4'CNY',_utf8mb4'USD',_utf8mb4'EUR')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='汇率历史表';
CREATE TABLE IF NOT EXISTS `execution_order_dependencies` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '依赖关系ID',
  `execution_order_id` char(36) NOT NULL COMMENT '当前订单ID（外键 → execution_orders.id，被依赖方）',
  `prerequisite_order_id` char(36) NOT NULL COMMENT '前置依赖订单ID（外键 → execution_orders.id，如公司注册订单）',
  `dependency_type` enum('company_registration','visa_kitas','sbu_quota','material_approval') NOT NULL COMMENT '依赖类型',
  `status` enum('pending','satisfied','blocked') NOT NULL DEFAULT 'pending' COMMENT '依赖满足状态',
  `satisfied_at` datetime DEFAULT NULL COMMENT '依赖满足时间',
  `notes` text COMMENT '备注',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_prerequisite` (`execution_order_id`,`prerequisite_order_id`),
  KEY `ix_dependencies_execution_order_id` (`execution_order_id`),
  KEY `ix_dependencies_prerequisite_order_id` (`prerequisite_order_id`),
  KEY `ix_dependencies_status` (`status`),
  CONSTRAINT `fk_dependencies_execution_order_id` FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_dependencies_prerequisite_order_id` FOREIGN KEY (`prerequisite_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='执行订单依赖关系表 - 实现公司注册→签证→后续释放逻辑，支持SBU/配额依赖';
CREATE TABLE IF NOT EXISTS `execution_order_items` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '明细ID',
  `execution_order_id` char(36) NOT NULL COMMENT '执行订单ID（外键 → execution_orders.id）',
  `quotation_item_id` char(36) DEFAULT NULL COMMENT '关联报价单明细ID（外键 → quotation_items.id）',
  `product_id` char(36) DEFAULT NULL COMMENT '产品ID（外键 → products.id）',
  `item_name` varchar(255) NOT NULL COMMENT '服务名称',
  `service_category` enum('one_time','long_term') NOT NULL COMMENT '服务类别（继承自报价单）',
  `status` enum('pending','in_progress','completed','blocked') NOT NULL DEFAULT 'pending' COMMENT '明细状态',
  `assigned_to` char(36) DEFAULT NULL COMMENT '分配执行人ID（外键 → users.id，可覆盖订单级别分配）',
  `notes` text COMMENT '执行备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_order_items_execution_order_id` (`execution_order_id`),
  KEY `ix_order_items_quotation_item_id` (`quotation_item_id`),
  KEY `ix_order_items_status` (`status`),
  KEY `fk_order_items_product_id` (`product_id`),
  KEY `fk_order_items_assigned_to` (`assigned_to`),
  CONSTRAINT `fk_order_items_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_order_items_execution_order_id` FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_order_items_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_order_items_quotation_item_id` FOREIGN KEY (`quotation_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='执行订单明细表 - 细粒度服务任务跟踪';
CREATE TABLE IF NOT EXISTS `execution_orders` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '执行订单ID',
  `order_no` varchar(50) NOT NULL COMMENT '执行订单编号（如：EXEC-20251228-001）',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `contract_id` char(36) DEFAULT NULL COMMENT '关联合同ID（外键 → contracts.id）',
  `parent_order_id` char(36) DEFAULT NULL COMMENT '父订单ID（外键 → execution_orders.id，用于组合单拆分后的主订单）',
  `order_type` enum('main','one_time','long_term','company_registration','visa_kitas') NOT NULL COMMENT '订单类型：main(主订单), one_time(一次性), long_term(长周期), company_registration(公司注册), visa_kitas(签证/KITAS)',
  `wechat_group_no` varchar(100) DEFAULT NULL COMMENT '关联微信群编号（继承自商机/报价单，用于逻辑链路聚合）',
  `requires_company_registration` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否需要公司注册（1=是，作为必须条件判断）',
  `company_registration_order_id` char(36) DEFAULT NULL COMMENT '关联的公司注册执行订单ID（外键 → execution_orders.id）',
  `status` enum('pending','in_progress','completed','blocked','cancelled') NOT NULL DEFAULT 'pending' COMMENT '订单状态：blocked(依赖阻塞)',
  `planned_start_date` date DEFAULT NULL COMMENT '计划开始日期',
  `planned_end_date` date DEFAULT NULL COMMENT '计划结束日期',
  `actual_start_date` date DEFAULT NULL COMMENT '实际开始日期',
  `actual_end_date` date DEFAULT NULL COMMENT '实际结束日期',
  `assigned_to` char(36) DEFAULT NULL COMMENT '分配执行人ID（外键 → users.id）',
  `assigned_team` varchar(100) DEFAULT NULL COMMENT '分配团队（如：中台交付组、签证组）',
  `assigned_at` datetime DEFAULT NULL COMMENT '分配时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id，通常系统自动或销售）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `order_no` (`order_no`),
  UNIQUE KEY `uk_execution_order_no` (`order_no`),
  KEY `ix_execution_orders_opportunity_id` (`opportunity_id`),
  KEY `ix_execution_orders_contract_id` (`contract_id`),
  KEY `ix_execution_orders_parent_order_id` (`parent_order_id`),
  KEY `ix_execution_orders_company_reg_order_id` (`company_registration_order_id`),
  KEY `ix_execution_orders_wechat_group_no` (`wechat_group_no`),
  KEY `ix_execution_orders_status` (`status`),
  KEY `ix_execution_orders_assigned_to` (`assigned_to`),
  KEY `fk_execution_orders_created_by` (`created_by`),
  CONSTRAINT `fk_execution_orders_assigned_to` FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_execution_orders_company_reg_order_id` FOREIGN KEY (`company_registration_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_execution_orders_contract_id` FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_execution_orders_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_execution_orders_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_execution_orders_parent_order_id` FOREIGN KEY (`parent_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='执行订单主表 - 支持订单拆分、类型区分、公司注册依赖、群编号聚合、任务分配';
CREATE TABLE IF NOT EXISTS `file_storage` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `file_name` varchar(255) NOT NULL COMMENT '原始文件名',
  `file_type` varchar(50) NOT NULL COMMENT '文件类型: EXPENSE_PROOF(报销凭证), CONTRACT(合同), ORDER_FILE(订单文件), ORDER_ITEM_FILE(订单项文件), SERVICE_DOC(服务文档)',
  `file_size` bigint NOT NULL COMMENT '文件大小（字节）',
  `file_md5` varchar(32) NOT NULL COMMENT '文件MD5值（用于校验文件完整性）',
  `mime_type` varchar(100) DEFAULT NULL COMMENT 'MIME类型（如：image/jpeg, application/pdf）',
  `file_extension` varchar(20) DEFAULT NULL COMMENT '文件扩展名（如：jpg, pdf, docx）',
  `oss_bucket` varchar(100) NOT NULL COMMENT 'OSS存储桶名称',
  `oss_key` varchar(500) NOT NULL COMMENT 'OSS对象键（文件路径）',
  `oss_url` varchar(1000) NOT NULL COMMENT 'OSS访问URL（完整URL，支持CDN加速）',
  `oss_region` varchar(50) DEFAULT NULL COMMENT 'OSS区域（如：ap-southeast-5）',
  `business_type` varchar(50) NOT NULL COMMENT '业务类型: EXPENSE(报销), CONTRACT(合同), ORDER(订单), ORDER_ITEM(订单项), SERVICE(服务)',
  `business_id` char(36) DEFAULT NULL COMMENT '业务对象ID（关联到具体的业务记录，如报销单ID、合同ID等）',
  `description` varchar(500) DEFAULT NULL COMMENT '文件描述',
  `tags` json DEFAULT NULL COMMENT '文件标签（JSON数组，如：["发票", "2024年12月"]）',
  `is_public` tinyint(1) DEFAULT '0' COMMENT '是否公开访问（0=私有, 1=公开）',
  `uploaded_by` char(36) NOT NULL COMMENT '上传人ID（关联 users.id）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `status` varchar(20) DEFAULT 'ACTIVE' COMMENT '文件状态: ACTIVE(有效), DELETED(已删除), ARCHIVED(已归档)',
  `deleted_at` datetime DEFAULT NULL COMMENT '删除时间',
  `deleted_by` char(36) DEFAULT NULL COMMENT '删除人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_file_oss_key` (`oss_bucket`,`oss_key`),
  KEY `ix_file_business` (`business_type`,`business_id`),
  KEY `ix_file_type` (`file_type`),
  KEY `ix_file_md5` (`file_md5`),
  KEY `ix_file_uploaded_by` (`uploaded_by`),
  KEY `ix_file_status` (`status`),
  KEY `ix_file_uploaded_at` (`uploaded_at` DESC),
  KEY `fk_file_deleter` (`deleted_by`),
  CONSTRAINT `fk_file_deleter` FOREIGN KEY (`deleted_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_file_uploader` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`),
  CONSTRAINT `chk_file_size_nonneg` CHECK ((`file_size` >= 0))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='文件存储表：统一管理所有文件的元数据信息';
CREATE TABLE IF NOT EXISTS `follow_up_statuses` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) NOT NULL COMMENT '状态代码（如：1, 2, 3, 4, 5）',
  `name_zh` varchar(255) NOT NULL COMMENT '状态名称（中文）',
  `name_id` varchar(255) NOT NULL COMMENT '状态名称（印尼语）',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '排序顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `description_zh` text COMMENT '描述（中文）',
  `description_id` text COMMENT '描述（印尼语）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_follow_up_statuses_code` (`code`),
  KEY `idx_follow_up_statuses_active` (`is_active`),
  KEY `idx_follow_up_statuses_sort` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='跟进状态配置表';
CREATE TABLE IF NOT EXISTS `industries` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) NOT NULL COMMENT 'è¡Œä¸šä»£ç ',
  `name_zh` varchar(255) NOT NULL COMMENT 'è¡Œä¸šåç§°ï¼ˆä¸­æ–‡ï¼‰',
  `name_id` varchar(255) NOT NULL COMMENT 'è¡Œä¸šåç§°ï¼ˆå°å°¼è¯­ï¼‰',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT 'æŽ’åºé¡ºåº',
  `is_active` tinyint(1) DEFAULT '1' COMMENT 'æ˜¯å¦æ¿€æ´»',
  `description_zh` text COMMENT 'æè¿°ï¼ˆä¸­æ–‡ï¼‰',
  `description_id` text COMMENT 'æè¿°ï¼ˆå°å°¼è¯­ï¼‰',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_industries_code` (`code`),
  KEY `idx_industries_active` (`is_active`),
  KEY `idx_industries_sort` (`sort_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='è¡Œä¸šé…ç½®è¡¨';
CREATE TABLE IF NOT EXISTS `invoice_files` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '发票文件ID',
  `invoice_id` char(36) NOT NULL COMMENT '发票ID（外键 → invoices.id）',
  `file_name` varchar(255) NOT NULL COMMENT '文件名（如：INV-20251228-001.pdf）',
  `file_url` varchar(500) NOT NULL COMMENT 'OSS存储路径（班兔合同云）',
  `file_size_kb` int DEFAULT NULL COMMENT '文件大小（KB）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `uploaded_by` char(36) DEFAULT NULL COMMENT '上传人ID（外键 → users.id，通常Lulu）',
  `is_primary` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否主要文件（1=是）',
  PRIMARY KEY (`id`),
  KEY `ix_invoice_files_invoice_id` (`invoice_id`),
  KEY `fk_invoice_files_uploaded_by` (`uploaded_by`),
  CONSTRAINT `fk_invoice_files_invoice_id` FOREIGN KEY (`invoice_id`) REFERENCES `invoices` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_invoice_files_uploaded_by` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='发票文件表 - 存储发票PDF文件（班兔合同云 OSS）';
CREATE TABLE IF NOT EXISTS `invoices` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '发票ID',
  `contract_id` char(36) NOT NULL COMMENT '关联合同ID（外键 → contracts.id）',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `invoice_no` varchar(50) NOT NULL COMMENT '发票编号（如：INV-20251228-001）',
  `entity_id` char(36) NOT NULL COMMENT '签约主体ID（外键 → contract_entities.id，Lulu选择主体）',
  `contract_amount` decimal(18,2) NOT NULL COMMENT '合同金额（显示给Lulu）',
  `customer_name` varchar(255) NOT NULL COMMENT '客户发票抬头',
  `customer_bank_account` varchar(255) DEFAULT NULL COMMENT '客户银行账户',
  `invoice_amount` decimal(18,2) NOT NULL COMMENT '发票金额（含税）',
  `tax_amount` decimal(18,2) NOT NULL DEFAULT '0.00' COMMENT '税额',
  `currency` varchar(10) NOT NULL COMMENT '币种：CNY 或 IDR',
  `invoice_type` varchar(50) DEFAULT NULL COMMENT '发票类型（如：增值税专用发票、普通发票）',
  `status` enum('draft','issued','uploaded','sent') NOT NULL DEFAULT 'draft' COMMENT '发票状态',
  `issued_at` datetime DEFAULT NULL COMMENT '开票时间',
  `uploaded_at` datetime DEFAULT NULL COMMENT '上传时间（Lulu上传）',
  `sent_at` datetime DEFAULT NULL COMMENT '发送给客户时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id，通常Lulu）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `invoice_no` (`invoice_no`),
  UNIQUE KEY `uk_invoice_no` (`invoice_no`),
  KEY `ix_invoices_contract_id` (`contract_id`),
  KEY `ix_invoices_opportunity_id` (`opportunity_id`),
  KEY `ix_invoices_entity_id` (`entity_id`),
  KEY `ix_invoices_status` (`status`),
  KEY `fk_invoices_created_by` (`created_by`),
  CONSTRAINT `fk_invoices_contract_id` FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_invoices_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_invoices_entity_id` FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_invoices_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='发票主表 - Lulu上传发票，支持多主体选择，显示合同金额，填写客户抬头和银行账户';
CREATE TABLE IF NOT EXISTS `lead_follow_ups` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `lead_id` char(36) NOT NULL COMMENT '线索ID',
  `follow_up_type` varchar(50) NOT NULL COMMENT '跟进类型：call(电话), meeting(会议), email(邮件), note(备注)',
  `content` text COMMENT '跟进内容',
  `follow_up_date` datetime NOT NULL COMMENT '跟进日期',
  `status_before` varchar(50) DEFAULT NULL COMMENT 'è·Ÿè¿›å‰çº¿ç´¢çŠ¶æ€',
  `status_after` varchar(50) DEFAULT NULL COMMENT 'è·Ÿè¿›åŽçº¿ç´¢çŠ¶æ€',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `ix_lead_follow_ups_lead` (`lead_id`),
  KEY `ix_lead_follow_ups_date` (`follow_up_date` DESC),
  KEY `ix_lead_follow_ups_type` (`follow_up_type`),
  KEY `ix_lead_follow_ups_status_before` (`status_before`),
  KEY `ix_lead_follow_ups_status_after` (`status_after`),
  CONSTRAINT `lead_follow_ups_ibfk_1` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE,
  CONSTRAINT `lead_follow_ups_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_lead_follow_ups_status_after` CHECK ((`status_after` in (_latin1'new',_latin1'contacted',_latin1'qualified',_latin1'converted',_latin1'lost'))),
  CONSTRAINT `chk_lead_follow_ups_status_before` CHECK ((`status_before` in (_latin1'new',_latin1'contacted',_latin1'qualified',_latin1'converted',_latin1'lost'))),
  CONSTRAINT `chk_lead_follow_ups_type` CHECK ((`follow_up_type` in (_utf8mb4'call',_utf8mb4'meeting',_utf8mb4'email',_utf8mb4'note')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='线索跟进记录表';
CREATE TABLE IF NOT EXISTS `lead_followup_logs` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '跟进记录ID',
  `lead_id` char(36) NOT NULL COMMENT '线索ID（外键 → leads.id）',
  `user_id` char(36) NOT NULL COMMENT '跟进人ID（外键 → users.id）',
  `action_type` varchar(50) NOT NULL COMMENT '跟进动作：call, email, wechat, visit 等',
  `notes` text COMMENT '跟进内容',
  `followed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '跟进时间',
  PRIMARY KEY (`id`),
  KEY `ix_lead_followup_lead_id` (`lead_id`),
  KEY `ix_lead_followup_followed_at` (`followed_at` DESC),
  KEY `fk_lead_followup_user_id` (`user_id`),
  CONSTRAINT `fk_lead_followup_lead_id` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_lead_followup_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='线索跟进日志表 - 用于判断7天无跟进释放公海';
CREATE TABLE IF NOT EXISTS `lead_notes` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `lead_id` char(36) NOT NULL COMMENT '线索ID',
  `note_type` varchar(50) NOT NULL COMMENT '备注类型：comment(评论), reminder(提醒), task(任务)',
  `content` text NOT NULL COMMENT '备注内容',
  `is_important` tinyint(1) DEFAULT '0' COMMENT '是否重要',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `ix_lead_notes_lead` (`lead_id`),
  KEY `ix_lead_notes_type` (`note_type`),
  KEY `ix_lead_notes_important` (`is_important`),
  KEY `ix_lead_notes_created_at` (`created_at` DESC),
  CONSTRAINT `lead_notes_ibfk_1` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE,
  CONSTRAINT `lead_notes_ibfk_2` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_lead_notes_type` CHECK ((`note_type` in (_utf8mb4'comment',_utf8mb4'reminder',_utf8mb4'task')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='线索备注表';
CREATE TABLE IF NOT EXISTS `lead_pools` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `name` varchar(255) NOT NULL COMMENT '线索池名称',
  `organization_id` char(36) NOT NULL COMMENT '组织ID',
  `description` text COMMENT '描述',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `ix_lead_pools_organization` (`organization_id`),
  KEY `ix_lead_pools_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='线索池表';
CREATE TABLE IF NOT EXISTS `leads` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `name` varchar(255) NOT NULL COMMENT '线索名称',
  `company_name` varchar(255) DEFAULT NULL COMMENT '公司名称',
  `contact_name` varchar(255) DEFAULT NULL COMMENT '联系人姓名',
  `phone` varchar(50) DEFAULT NULL COMMENT '联系电话',
  `email` varchar(255) DEFAULT NULL COMMENT '邮箱',
  `address` text COMMENT '地址',
  `customer_id` int DEFAULT NULL COMMENT '关联客户ID（可选）',
  `organization_id` varchar(36) DEFAULT NULL,
  `owner_user_id` char(36) DEFAULT NULL COMMENT '销售负责人ID',
  `released_by` char(36) DEFAULT NULL COMMENT '释放操作人ID（外键 → users.id）',
  `status` varchar(50) DEFAULT 'new' COMMENT '状态：new(新建), contacted(已联系), qualified(已确认), converted(已转化), lost(已丢失)',
  `pool_status` enum('private','countdown','public') NOT NULL DEFAULT 'private' COMMENT '线索池状态：private(私有), countdown(七天倒计时), public(公海)',
  `level` varchar(50) DEFAULT NULL COMMENT '客户分级',
  `is_in_public_pool` tinyint(1) DEFAULT '0' COMMENT '是否在公海池',
  `pool_id` char(36) DEFAULT NULL COMMENT '线索池ID',
  `moved_to_pool_at` datetime DEFAULT NULL COMMENT '移入公海池时间',
  `tianyancha_data` json DEFAULT NULL COMMENT '天眼查数据（JSON格式）',
  `tianyancha_synced_at` datetime DEFAULT NULL COMMENT '天眼查同步时间',
  `last_follow_up_at` datetime DEFAULT NULL COMMENT '最后跟进时间',
  `next_follow_up_at` datetime DEFAULT NULL COMMENT '下次跟进时间',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `release_countdown_at` datetime DEFAULT NULL COMMENT '进入七天释放倒计时时间',
  `released_at` datetime DEFAULT NULL COMMENT '释放到公海时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_leads_organization` (`organization_id`),
  KEY `ix_leads_owner` (`owner_user_id`),
  KEY `ix_leads_status` (`status`),
  KEY `ix_leads_public_pool` (`is_in_public_pool`),
  KEY `ix_leads_customer` (`customer_id`),
  KEY `ix_leads_pool` (`pool_id`),
  KEY `ix_leads_company_name` (`company_name`),
  KEY `ix_leads_phone` (`phone`),
  KEY `ix_leads_email` (`email`),
  KEY `ix_leads_created_at` (`created_at` DESC),
  KEY `fk_leads_customer_level` (`level`),
  KEY `owner_user_id` (`owner_user_id`),
  KEY `fk_leads_released_by` (`released_by`),
  CONSTRAINT `fk_leads_customer_level` FOREIGN KEY (`level`) REFERENCES `customer_levels` (`code`) ON DELETE SET NULL ON UPDATE CASCADE,
  CONSTRAINT `fk_leads_released_by` FOREIGN KEY (`released_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `leads_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE SET NULL,
  CONSTRAINT `leads_ibfk_4` FOREIGN KEY (`pool_id`) REFERENCES `lead_pools` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_leads_status` CHECK ((`status` in (_utf8mb4'new',_utf8mb4'contacted',_utf8mb4'qualified',_utf8mb4'converted',_utf8mb4'lost')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='线索表';
CREATE TABLE IF NOT EXISTS `material_notification_emails` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '邮件记录ID',
  `contract_id` char(36) DEFAULT NULL COMMENT '关联合同ID（外键 → contracts.id）',
  `opportunity_id` char(36) DEFAULT NULL COMMENT '关联商机ID（外键 → opportunities.id）',
  `material_document_id` char(36) DEFAULT NULL COMMENT '关联资料记录ID（外键 → contract_material_documents.id）',
  `email_type` varchar(100) NOT NULL COMMENT '邮件类型（如：upload_reminder, approval_notification, docs_missing）',
  `recipient_email` varchar(255) NOT NULL COMMENT '收件人邮箱',
  `subject` varchar(500) NOT NULL COMMENT '邮件主题',
  `body_preview` text COMMENT '邮件正文预览（前200字符）',
  `sent_at` datetime DEFAULT NULL COMMENT '发送时间',
  `sent_status` enum('queued','sent','failed') NOT NULL DEFAULT 'queued' COMMENT '发送状态',
  `error_message` text COMMENT '失败原因',
  `sent_by` char(36) DEFAULT NULL COMMENT '触发发送人ID（外键 → users.id）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_email_contract_id` (`contract_id`),
  KEY `ix_email_opportunity_id` (`opportunity_id`),
  KEY `ix_email_material_id` (`material_document_id`),
  KEY `ix_email_recipient` (`recipient_email`),
  KEY `ix_email_sent_status` (`sent_status`),
  KEY `fk_email_sent_by` (`sent_by`),
  CONSTRAINT `fk_email_contract_id` FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_email_material_id` FOREIGN KEY (`material_document_id`) REFERENCES `contract_material_documents` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_email_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_email_sent_by` FOREIGN KEY (`sent_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='资料办理邮件通知记录表 - 支持bantumail.service发送追踪（如催资料、审批通知）';
CREATE TABLE IF NOT EXISTS `menu_permissions` (
  `menu_id` char(36) NOT NULL,
  `permission_id` char(36) NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`menu_id`,`permission_id`),
  KEY `ix_menu_permissions_menu` (`menu_id`),
  KEY `ix_menu_permissions_permission` (`permission_id`),
  CONSTRAINT `menu_permissions_ibfk_1` FOREIGN KEY (`menu_id`) REFERENCES `menus` (`id`) ON DELETE CASCADE,
  CONSTRAINT `menu_permissions_ibfk_2` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `menus` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) NOT NULL COMMENT '菜单编码（唯一）',
  `name_zh` varchar(255) NOT NULL COMMENT '菜单名称（中文）',
  `name_id` varchar(255) NOT NULL COMMENT '菜单名称（印尼语）',
  `description_zh` text COMMENT '菜单描述（中文）',
  `description_id` text COMMENT '菜单描述（印尼语）',
  `parent_id` char(36) DEFAULT NULL COMMENT '父菜单ID（支持树形结构）',
  `path` varchar(255) DEFAULT NULL COMMENT '路由路径（如：/users）',
  `component` varchar(255) DEFAULT NULL COMMENT '前端组件路径',
  `icon` varchar(100) DEFAULT NULL COMMENT '图标名称',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否激活',
  `is_visible` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否可见（控制菜单显示）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_menus_code` (`code`),
  KEY `ix_menus_parent` (`parent_id`),
  KEY `ix_menus_active` (`is_active`),
  KEY `ix_menus_visible` (`is_visible`),
  KEY `ix_menus_order` (`display_order`),
  CONSTRAINT `menus_ibfk_1` FOREIGN KEY (`parent_id`) REFERENCES `menus` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `notifications` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `user_id` char(36) NOT NULL COMMENT '用户ID',
  `notification_type` varchar(50) NOT NULL COMMENT '通知类型：collection_task(催款任务), lead_assigned(线索分配), order_updated(订单更新)',
  `title` varchar(255) NOT NULL COMMENT '通知标题',
  `content` text COMMENT '通知内容',
  `resource_type` varchar(50) DEFAULT NULL COMMENT '资源类型',
  `resource_id` char(36) DEFAULT NULL COMMENT '资源ID',
  `is_read` tinyint(1) DEFAULT '0' COMMENT '是否已读',
  `read_at` datetime DEFAULT NULL COMMENT '阅读时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `ix_notifications_user` (`user_id`),
  KEY `ix_notifications_type` (`notification_type`),
  KEY `ix_notifications_read` (`is_read`),
  KEY `ix_notifications_resource` (`resource_type`,`resource_id`),
  KEY `ix_notifications_created_at` (`created_at` DESC),
  KEY `ix_notifications_user_read` (`user_id`,`is_read`),
  CONSTRAINT `notifications_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_notifications_type` CHECK ((`notification_type` in (_utf8mb4'collection_task',_utf8mb4'lead_assigned',_utf8mb4'order_updated',_utf8mb4'lead_created',_utf8mb4'lead_updated')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='通知表';
CREATE TABLE IF NOT EXISTS `operation_audit_logs` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `operation_type` varchar(50) NOT NULL COMMENT '操作类型: CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT, PRICE_CHANGE, STATUS_CHANGE等',
  `entity_type` varchar(100) NOT NULL COMMENT '实体类型（表名）: products, orders, customers等',
  `entity_id` char(36) DEFAULT NULL COMMENT '实体ID（记录ID）',
  `user_id` char(36) NOT NULL COMMENT '操作人ID',
  `username` varchar(255) DEFAULT NULL COMMENT '操作人用户名（冗余字段，便于查询）',
  `organization_id` char(36) DEFAULT NULL COMMENT '操作人所属组织ID',
  `operated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  `data_before` json DEFAULT NULL COMMENT '操作前的数据（JSON格式）',
  `data_after` json DEFAULT NULL COMMENT '操作后的数据（JSON格式）',
  `changed_fields` json DEFAULT NULL COMMENT '变更字段列表（JSON数组，如：["name", "price"])',
  `ip_address` varchar(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` varchar(500) DEFAULT NULL COMMENT '用户代理',
  `request_path` varchar(500) DEFAULT NULL COMMENT '请求路径',
  `request_method` varchar(10) DEFAULT NULL COMMENT '请求方法（GET/POST/PUT/DELETE）',
  `request_params` json DEFAULT NULL COMMENT '请求参数（JSON格式，敏感信息需脱敏）',
  `status` varchar(20) NOT NULL DEFAULT 'SUCCESS' COMMENT '操作状态: SUCCESS, FAILURE',
  `error_message` text COMMENT '错误信息（如果失败）',
  `error_code` varchar(50) DEFAULT NULL COMMENT '错误码',
  `operation_source` varchar(50) DEFAULT 'API' COMMENT '操作来源: API, ADMIN, IMPORT, BATCH等',
  `batch_id` char(36) DEFAULT NULL COMMENT '批次ID（用于关联多个操作，如批量导入）',
  `duration_ms` int DEFAULT NULL COMMENT '操作耗时（毫秒）',
  `notes` text COMMENT '备注说明',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_audit_operation_type` (`operation_type`),
  KEY `ix_audit_entity` (`entity_type`,`entity_id`),
  KEY `ix_audit_user` (`user_id`),
  KEY `ix_audit_organization` (`organization_id`),
  KEY `ix_audit_operated_at` (`operated_at` DESC),
  KEY `ix_audit_status` (`status`),
  KEY `ix_audit_batch` (`batch_id`),
  CONSTRAINT `fk_audit_organization` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_audit_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='操作审计日志表';
CREATE TABLE IF NOT EXISTS `opportunities` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `customer_id` int NOT NULL COMMENT '客户ID',
  `lead_id` char(36) DEFAULT NULL COMMENT '来源线索ID（可选，用于追溯）',
  `name` varchar(255) NOT NULL COMMENT '商机名称',
  `amount` decimal(18,2) DEFAULT NULL COMMENT '商机金额',
  `service_type` enum('one_time','long_term','mixed') NOT NULL DEFAULT 'one_time' COMMENT '服务类型：one_time(一次性), long_term(长周期), mixed(混合)',
  `tax_service_cycle_months` int DEFAULT NULL COMMENT '财税服务周期（月，6或12）',
  `tax_service_start_date` date DEFAULT NULL COMMENT '财税服务开始日期',
  `has_staged_services` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否包含分阶段服务（财税/IT分阶段）',
  `split_order_required` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否需要拆分独立订单（1=是，长周期服务将生成独立订单）',
  `primary_quotation_id` char(36) DEFAULT NULL COMMENT '主报价单ID（客户接受的最终报价单，外键 → quotations.id）',
  `primary_contract_id` char(36) DEFAULT NULL COMMENT '主合同ID（签署生效的最终合同，外键 → contracts.id）',
  `is_split_required` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否需要订单拆分（1=需要，长周期服务标记）',
  `probability` int DEFAULT NULL COMMENT '成交概率（0-100）',
  `stage` varchar(50) NOT NULL DEFAULT 'initial_contact' COMMENT '商机阶段（initial_contact, needs_analysis, proposal, negotiation, closed_won, closed_lost）',
  `current_stage_id` char(36) DEFAULT NULL COMMENT '当前阶段ID（外键 → opportunity_stage_templates.id）',
  `status` varchar(50) NOT NULL DEFAULT 'active' COMMENT '状态（active, won, lost, cancelled）',
  `owner_user_id` char(36) DEFAULT NULL COMMENT '负责人（外键 → users.id）',
  `developed_by` char(36) DEFAULT NULL COMMENT '开发人ID（外键 → users.id）',
  `expected_close_date` date DEFAULT NULL COMMENT '预期成交日期',
  `actual_close_date` date DEFAULT NULL COMMENT '实际成交日期',
  `description` text COMMENT '描述',
  `organization_id` char(36) NOT NULL COMMENT '组织ID（数据隔离）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `last_followup_at` datetime DEFAULT NULL COMMENT '最后跟进时间',
  `is_stale` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否长久未跟进（1=是）',
  `workflow_status` varchar(50) NOT NULL DEFAULT 'active' COMMENT '工作流整体状态：active(进行中), paused(暂停), completed(完成), cancelled(取消)',
  `collection_status` enum('not_started','partial','full','overpaid') NOT NULL DEFAULT 'not_started' COMMENT '整体收款状态：not_started(未开始), partial(部分回款), full(全额回款), overpaid(超收)',
  `total_received_amount` decimal(18,2) NOT NULL DEFAULT '0.00' COMMENT '已收总金额（冗余，自动维护）',
  `final_payment_id` char(36) DEFAULT NULL COMMENT '尾款记录ID（外键 → payments.id）',
  PRIMARY KEY (`id`),
  KEY `ix_opportunities_customer` (`customer_id`),
  KEY `ix_opportunities_lead` (`lead_id`),
  KEY `ix_opportunities_owner` (`owner_user_id`),
  KEY `ix_opportunities_organization` (`organization_id`),
  KEY `ix_opportunities_stage` (`stage`),
  KEY `ix_opportunities_status` (`status`),
  KEY `ix_opportunities_created` (`created_at` DESC),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `fk_opportunities_current_stage` (`current_stage_id`),
  KEY `fk_opportunities_developed_by` (`developed_by`),
  KEY `fk_opportunities_primary_quotation_id` (`primary_quotation_id`),
  KEY `fk_opportunities_primary_contract_id` (`primary_contract_id`),
  KEY `fk_opportunities_final_payment_id` (`final_payment_id`),
  CONSTRAINT `fk_opportunities_current_stage` FOREIGN KEY (`current_stage_id`) REFERENCES `opportunity_stage_templates` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_opportunities_developed_by` FOREIGN KEY (`developed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_opportunities_final_payment_id` FOREIGN KEY (`final_payment_id`) REFERENCES `payments` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_opportunities_primary_contract_id` FOREIGN KEY (`primary_contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_opportunities_primary_quotation_id` FOREIGN KEY (`primary_quotation_id`) REFERENCES `quotations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `opportunities_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `opportunities_ibfk_2` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE SET NULL,
  CONSTRAINT `opportunities_ibfk_3` FOREIGN KEY (`owner_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `opportunities_ibfk_4` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `opportunities_ibfk_5` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_opportunities_probability` CHECK (((`probability` >= 0) and (`probability` <= 100))),
  CONSTRAINT `chk_opportunities_stage` CHECK ((`stage` in (_utf8mb4'initial_contact',_utf8mb4'needs_analysis',_utf8mb4'proposal',_utf8mb4'negotiation',_utf8mb4'closed_won',_utf8mb4'closed_lost'))),
  CONSTRAINT `chk_opportunities_status` CHECK ((`status` in (_utf8mb4'active',_utf8mb4'won',_utf8mb4'lost',_utf8mb4'cancelled')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机表';
    IF NEW.current_stage_id <> OLD.current_stage_id OR (NEW.current_stage_id IS NOT NULL AND OLD.current_stage_id IS NULL) THEN
        
        UPDATE `opportunity_stage_history`
        SET `exited_at` = NOW()
        WHERE `opportunity_id` = OLD.id AND `exited_at` IS NULL;
        
        INSERT INTO `opportunity_stage_history`
            (`opportunity_id`, `stage_id`, `entered_at`, `requires_approval`)
        SELECT NEW.id, NEW.current_stage_id, NOW(), COALESCE(st.`requires_approval`, 0)
        FROM `opportunity_stage_templates` st
        WHERE st.`id` = NEW.current_stage_id;
    END IF;
END */;;
CREATE TABLE IF NOT EXISTS `opportunity_payment_stages` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `stage_number` int NOT NULL COMMENT '阶段序号（1, 2, 3...）',
  `stage_name` varchar(255) NOT NULL COMMENT '阶段名称（如：首付款、中期款、尾款）',
  `amount` decimal(18,2) NOT NULL COMMENT '应付金额',
  `due_date` date DEFAULT NULL COMMENT '到期日期',
  `payment_trigger` varchar(50) DEFAULT 'manual' COMMENT '付款触发条件（manual, milestone, date, completion）',
  `status` varchar(50) NOT NULL DEFAULT 'pending' COMMENT '状态（pending, paid, overdue, cancelled）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `ix_opportunity_payment_stages_opportunity` (`opportunity_id`),
  KEY `ix_opportunity_payment_stages_stage_number` (`opportunity_id`,`stage_number`),
  KEY `ix_opportunity_payment_stages_status` (`status`),
  KEY `ix_opportunity_payment_stages_due_date` (`due_date`),
  CONSTRAINT `opportunity_payment_stages_ibfk_1` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_opportunity_payment_stages_amount` CHECK ((`amount` >= 0)),
  CONSTRAINT `chk_opportunity_payment_stages_stage_number` CHECK ((`stage_number` > 0)),
  CONSTRAINT `chk_opportunity_payment_stages_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'paid',_utf8mb4'overdue',_utf8mb4'cancelled'))),
  CONSTRAINT `chk_opportunity_payment_stages_trigger` CHECK ((`payment_trigger` in (_utf8mb4'manual',_utf8mb4'milestone',_utf8mb4'date',_utf8mb4'completion')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机付款阶段表';
CREATE TABLE IF NOT EXISTS `opportunity_products` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `quantity` int NOT NULL DEFAULT '1' COMMENT '数量',
  `unit_price` decimal(18,2) DEFAULT NULL COMMENT '单价',
  `total_amount` decimal(18,2) DEFAULT NULL COMMENT '总金额',
  `execution_order` int NOT NULL DEFAULT '1' COMMENT '执行顺序（1, 2, 3...）',
  `status` varchar(50) NOT NULL DEFAULT 'pending' COMMENT '状态（pending: 待执行, in_progress: 进行中, completed: 已完成, cancelled: 已取消）',
  `start_date` date DEFAULT NULL COMMENT '开始日期',
  `expected_completion_date` date DEFAULT NULL COMMENT '预期完成日期',
  `actual_completion_date` date DEFAULT NULL COMMENT '实际完成日期',
  `notes` text COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_opportunity_product` (`opportunity_id`,`product_id`),
  KEY `ix_opportunity_products_opportunity` (`opportunity_id`),
  KEY `ix_opportunity_products_product` (`product_id`),
  KEY `ix_opportunity_products_execution_order` (`opportunity_id`,`execution_order`),
  KEY `ix_opportunity_products_status` (`status`),
  CONSTRAINT `opportunity_products_ibfk_1` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `opportunity_products_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `chk_opportunity_products_execution_order` CHECK ((`execution_order` > 0)),
  CONSTRAINT `chk_opportunity_products_quantity` CHECK ((`quantity` > 0)),
  CONSTRAINT `chk_opportunity_products_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'in_progress',_utf8mb4'completed',_utf8mb4'cancelled')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机产品关联表';
CREATE TABLE IF NOT EXISTS `opportunity_service_dependencies` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '依赖关系ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `dependent_service_stage_id` char(36) DEFAULT NULL COMMENT '依赖目标阶段ID（外键 → opportunity_service_stages.id）',
  `prerequisite_type` varchar(50) NOT NULL COMMENT '前置依赖类型（如：document, service_stage）',
  `prerequisite_description` varchar(500) NOT NULL COMMENT '依赖描述（如：护照首页用于后续签证）',
  `prerequisite_document_type` varchar(100) DEFAULT NULL COMMENT '资料类型（如：passport_front）',
  `is_mandatory` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否必须（1=是）',
  `status` enum('pending','satisfied','blocked') NOT NULL DEFAULT 'pending' COMMENT '依赖状态',
  `satisfied_at` datetime DEFAULT NULL COMMENT '满足时间',
  `satisfied_by` char(36) DEFAULT NULL COMMENT '满足操作人ID（外键 → users.id）',
  `notes` text COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_dependencies_opportunity_id` (`opportunity_id`),
  KEY `ix_dependencies_dependent_stage_id` (`dependent_service_stage_id`),
  KEY `ix_dependencies_status` (`status`),
  KEY `fk_dependencies_satisfied_by` (`satisfied_by`),
  CONSTRAINT `fk_dependencies_dependent_stage_id` FOREIGN KEY (`dependent_service_stage_id`) REFERENCES `opportunity_service_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_dependencies_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_dependencies_satisfied_by` FOREIGN KEY (`satisfied_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机服务依赖关系表 - 处理服务的本质依赖（如上游资料项目）';
CREATE TABLE IF NOT EXISTS `opportunity_service_stages` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '服务阶段记录ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `stage_number` int NOT NULL COMMENT '阶段序号（1=业务注册阶段，2=执行阶段）',
  `stage_name` varchar(255) NOT NULL COMMENT '阶段名称（如：公司设立/NIB/税卡、月报税/年报）',
  `stage_description` text COMMENT '阶段描述',
  `planned_start_date` date DEFAULT NULL COMMENT '计划开始日期',
  `planned_end_date` date DEFAULT NULL COMMENT '计划结束日期',
  `actual_start_date` date DEFAULT NULL COMMENT '实际开始日期',
  `actual_end_date` date DEFAULT NULL COMMENT '实际结束日期',
  `status` enum('pending','in_progress','completed','delayed') NOT NULL DEFAULT 'pending' COMMENT '阶段状态',
  `requires_approval` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否需要审批',
  `approved_by` char(36) DEFAULT NULL COMMENT '审批人ID（外键 → users.id）',
  `approved_at` datetime DEFAULT NULL COMMENT '审批时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_opportunity_stage_number` (`opportunity_id`,`stage_number`),
  KEY `ix_service_stages_opportunity_id` (`opportunity_id`),
  KEY `ix_service_stages_status` (`status`),
  KEY `fk_service_stages_approved_by` (`approved_by`),
  KEY `fk_service_stages_created_by` (`created_by`),
  CONSTRAINT `fk_service_stages_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_service_stages_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_service_stages_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机服务阶段表 - 财税/IT分阶段录入与审批';
CREATE TABLE IF NOT EXISTS `opportunity_stage_history` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '历史记录唯一ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `stage_id` char(36) NOT NULL COMMENT '阶段ID（外键 → opportunity_stage_templates.id）',
  `entered_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '进入该阶段的时间',
  `exited_at` datetime DEFAULT NULL COMMENT '退出该阶段的时间（NULL表示当前阶段）',
  `duration_days` int GENERATED ALWAYS AS (if((`exited_at` is null),NULL,(to_days(`exited_at`) - to_days(`entered_at`)))) STORED COMMENT '该阶段持续天数',
  `conditions_met_json` json DEFAULT NULL COMMENT '满足的推进条件详情JSON',
  `requires_approval` tinyint(1) NOT NULL DEFAULT '0' COMMENT '该阶段是否需要审批',
  `approval_status` varchar(50) DEFAULT 'pending' COMMENT '审批状态：pending(待审批), approved(通过), rejected(拒绝)',
  `approved_by` char(36) DEFAULT NULL COMMENT '审批人ID（外键 → users.id）',
  `approval_at` datetime DEFAULT NULL COMMENT '审批时间',
  `approval_notes` text COMMENT '审批备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  PRIMARY KEY (`id`),
  KEY `ix_stage_history_opportunity_id` (`opportunity_id`),
  KEY `ix_stage_history_stage_id` (`stage_id`),
  KEY `ix_stage_history_entered_at` (`entered_at` DESC),
  KEY `ix_stage_history_approval_status` (`approval_status`),
  KEY `fk_stage_history_approved_by` (`approved_by`),
  CONSTRAINT `fk_stage_history_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_stage_history_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_stage_history_stage_id` FOREIGN KEY (`stage_id`) REFERENCES `opportunity_stage_templates` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `chk_stage_history_approval_status` CHECK ((`approval_status` in (_utf8mb4'pending',_utf8mb4'approved',_utf8mb4'rejected')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机阶段历史表 - 记录每个商机的阶段流转、条件满足、审批详情';
CREATE TABLE IF NOT EXISTS `opportunity_stage_templates` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '阶段模板唯一ID',
  `code` varchar(50) NOT NULL COMMENT '阶段代码（唯一，程序中使用，如：new, quotation）',
  `name_zh` varchar(255) NOT NULL COMMENT '阶段名称（中文）',
  `name_id` varchar(255) NOT NULL COMMENT '阶段名称（印尼语）',
  `description_zh` text COMMENT '阶段描述（中文）',
  `description_id` text COMMENT '阶段描述（印尼语）',
  `stage_order` int NOT NULL COMMENT '阶段顺序（1=最早，9=最晚）',
  `requires_approval` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否需要审批（1=需要，0=不需要）',
  `approval_roles_json` json DEFAULT NULL COMMENT '需要审批的角色列表JSON，例如：["sales_manager","finance"]',
  `conditions_json` json DEFAULT NULL COMMENT '进入下一阶段所需条件JSON（灵活扩展）',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用该阶段模板',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_stage_templates_code` (`code`),
  KEY `ix_stage_templates_order` (`stage_order`),
  KEY `ix_stage_templates_active` (`is_active`),
  KEY `fk_stage_templates_created_by` (`created_by`),
  KEY `fk_stage_templates_updated_by` (`updated_by`),
  CONSTRAINT `fk_stage_templates_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_stage_templates_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='商机阶段模板表 - 定义所有固定阶段，支持动态扩展';
CREATE TABLE IF NOT EXISTS `order_assignments` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL,
  `assigned_to_user_id` char(36) NOT NULL,
  `assigned_by_user_id` char(36) DEFAULT NULL,
  `assignment_type` varchar(50) DEFAULT 'operation',
  `is_primary` tinyint(1) DEFAULT '1',
  `vendor_id` char(36) DEFAULT NULL,
  `organization_employee_id` char(36) DEFAULT NULL,
  `vendor_employee_id` char(36) DEFAULT NULL,
  `assigned_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `unassigned_at` datetime DEFAULT NULL,
  `notes` text,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `assigned_by_user_id` (`assigned_by_user_id`),
  KEY `vendor_id` (`vendor_id`),
  KEY `vendor_employee_id` (`vendor_employee_id`),
  KEY `ix_order_assignments_order` (`order_id`),
  KEY `ix_order_assignments_user` (`assigned_to_user_id`),
  KEY `ix_order_assignments_active` (`order_id`,`assigned_to_user_id`),
  KEY `ix_order_assignments_org_employee` (`organization_employee_id`),
  CONSTRAINT `order_assignments_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `order_assignments_ibfk_2` FOREIGN KEY (`assigned_to_user_id`) REFERENCES `users` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `order_assignments_ibfk_3` FOREIGN KEY (`assigned_by_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_assignments_ibfk_4` FOREIGN KEY (`vendor_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_assignments_ibfk_5` FOREIGN KEY (`organization_employee_id`) REFERENCES `organization_employees` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_assignments_ibfk_6` FOREIGN KEY (`vendor_employee_id`) REFERENCES `organization_employees` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `order_comments` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL COMMENT '订单ID',
  `order_stage_id` char(36) DEFAULT NULL COMMENT '关联的订单阶段ID（可选）',
  `comment_type` varchar(50) DEFAULT 'general' COMMENT '评论类型：general(普通), internal(内部), customer(客户), system(系统)',
  `content_zh` text COMMENT '评论内容（中文）',
  `content_id` text COMMENT '评论内容（印尼语）',
  `is_internal` tinyint(1) DEFAULT '0' COMMENT '是否内部评论（客户不可见）',
  `is_pinned` tinyint(1) DEFAULT '0' COMMENT '是否置顶',
  `replied_to_comment_id` char(36) DEFAULT NULL COMMENT '回复的评论ID（支持回复）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `ix_order_comments_order` (`order_id`),
  KEY `ix_order_comments_stage` (`order_stage_id`),
  KEY `ix_order_comments_created_by` (`created_by`),
  KEY `ix_order_comments_created_at` (`created_at` DESC),
  KEY `ix_order_comments_replied_to` (`replied_to_comment_id`),
  CONSTRAINT `order_comments_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `order_comments_ibfk_2` FOREIGN KEY (`order_stage_id`) REFERENCES `order_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_comments_ibfk_3` FOREIGN KEY (`replied_to_comment_id`) REFERENCES `order_comments` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_comments_ibfk_4` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_order_comments_type` CHECK ((`comment_type` in (_utf8mb4'general',_utf8mb4'internal',_utf8mb4'customer',_utf8mb4'system')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单评论表 - 订单评论和沟通记录';
CREATE TABLE IF NOT EXISTS `order_files` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL COMMENT '订单ID',
  `order_item_id` char(36) DEFAULT NULL COMMENT '关联的订单项ID（可选，文件可关联到具体订单项）',
  `order_stage_id` char(36) DEFAULT NULL COMMENT '关联的订单阶段ID（不同步骤上传不同文件）',
  `file_category` varchar(100) DEFAULT NULL COMMENT '文件分类：passport(护照), visa(签证), document(文档), other(其他)',
  `file_name_zh` varchar(255) DEFAULT NULL COMMENT '文件名称（中文）',
  `file_name_id` varchar(255) DEFAULT NULL COMMENT '文件名称（印尼语）',
  `file_type` varchar(50) DEFAULT NULL COMMENT '文件类型：image, pdf, doc, excel, other',
  `file_path` text COMMENT '文件存储路径（相对路径）',
  `file_url` text COMMENT '文件访问URL（完整路径）',
  `file_size` bigint DEFAULT NULL COMMENT '文件大小（字节）',
  `mime_type` varchar(100) DEFAULT NULL COMMENT 'MIME类型',
  `description_zh` text COMMENT '文件描述（中文）',
  `description_id` text COMMENT '文件描述（印尼语）',
  `is_required` tinyint(1) DEFAULT '0' COMMENT '是否必需文件',
  `is_verified` tinyint(1) DEFAULT '0' COMMENT '是否已验证',
  `verified_by` char(36) DEFAULT NULL COMMENT '验证人ID',
  `verified_at` datetime DEFAULT NULL COMMENT '验证时间',
  `uploaded_by` char(36) DEFAULT NULL COMMENT '上传人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `verified_by` (`verified_by`),
  KEY `ix_order_files_order` (`order_id`),
  KEY `ix_order_files_item` (`order_item_id`),
  KEY `ix_order_files_stage` (`order_stage_id`),
  KEY `ix_order_files_category` (`file_category`),
  KEY `ix_order_files_uploaded_by` (`uploaded_by`),
  KEY `ix_order_files_created_at` (`created_at` DESC),
  CONSTRAINT `order_files_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `order_files_ibfk_2` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_files_ibfk_3` FOREIGN KEY (`order_stage_id`) REFERENCES `order_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_files_ibfk_4` FOREIGN KEY (`verified_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_files_ibfk_5` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_order_files_file_size_nonneg` CHECK ((coalesce(`file_size`,0) >= 0))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单文件表 - 订单相关文件（护照、签证、文档等）';
CREATE TABLE IF NOT EXISTS `order_items` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL COMMENT '订单ID',
  `item_number` int NOT NULL COMMENT '订单项序号（1, 2, 3...）',
  `product_id` char(36) DEFAULT NULL COMMENT '产品/服务ID',
  `product_name_zh` varchar(255) DEFAULT NULL COMMENT '产品名称（中文）',
  `product_name_id` varchar(255) DEFAULT NULL COMMENT '产品名称（印尼语）',
  `product_code` varchar(100) DEFAULT NULL COMMENT '产品代码',
  `service_type_id` char(36) DEFAULT NULL COMMENT '服务类型ID',
  `service_type_name_zh` varchar(255) DEFAULT NULL COMMENT '服务类型名称（中文）',
  `service_type_name_id` varchar(255) DEFAULT NULL COMMENT '服务类型名称（印尼语）',
  `quantity` int DEFAULT '1' COMMENT '数量',
  `unit` varchar(50) DEFAULT NULL COMMENT '单位',
  `unit_price` decimal(18,2) DEFAULT NULL COMMENT '单价',
  `discount_amount` decimal(18,2) DEFAULT '0.00' COMMENT '折扣金额',
  `item_amount` decimal(18,2) DEFAULT NULL COMMENT '订单项金额（quantity * unit_price - discount_amount）',
  `currency_code` varchar(10) DEFAULT 'CNY' COMMENT '货币代码',
  `description_zh` text COMMENT '订单项描述（中文）',
  `description_id` text COMMENT '订单项描述（印尼语）',
  `requirements` text COMMENT '需求和要求',
  `expected_start_date` date DEFAULT NULL COMMENT '预期开始日期',
  `expected_completion_date` date DEFAULT NULL COMMENT '预期完成日期',
  `status` varchar(50) DEFAULT 'pending' COMMENT '订单项状态：pending(待处理), in_progress(进行中), completed(已完成), cancelled(已取消)',
  `item_type` enum('long_term','one_time') NOT NULL DEFAULT 'one_time' COMMENT '服务项类型：long_term(长周期), one_time(一次性)',
  `cycle_months` int DEFAULT NULL COMMENT '若长周期，指定月数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `selected_supplier_id` char(36) DEFAULT NULL COMMENT '执行该项的服务提供方ID（可以是内部团队或外部供应商）',
  `delivery_type` enum('INTERNAL','VENDOR') DEFAULT NULL COMMENT '交付类型: INTERNAL=内部交付, VENDOR=供应商交付',
  `supplier_cost_history_id` char(36) DEFAULT NULL COMMENT '关联的成本版本ID',
  `snapshot_cost_cny` decimal(18,2) DEFAULT '0.00' COMMENT '下单时的RMB成本快照',
  `snapshot_cost_idr` decimal(18,2) DEFAULT '0.00' COMMENT '下单时的IDR成本快照',
  `estimated_profit_cny` decimal(18,2) DEFAULT '0.00' COMMENT '预估毛利(CNY)',
  `estimated_profit_idr` decimal(18,2) DEFAULT '0.00' COMMENT '预估毛利(IDR)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_order_items_order_item_number` (`order_id`,`item_number`),
  KEY `ix_order_items_order` (`order_id`),
  KEY `ix_order_items_product` (`product_id`),
  KEY `ix_order_items_service_type` (`service_type_id`),
  KEY `ix_order_items_status` (`status`),
  KEY `ix_order_items_item_number` (`order_id`,`item_number`),
  KEY `ix_order_items_supplier` (`selected_supplier_id`),
  KEY `ix_order_items_delivery_type` (`delivery_type`),
  KEY `ix_order_items_cost_history` (`supplier_cost_history_id`),
  CONSTRAINT `fk_order_item_supplier` FOREIGN KEY (`selected_supplier_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_items_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `order_items_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_items_ibfk_3` FOREIGN KEY (`service_type_id`) REFERENCES `service_types` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_order_items_amounts_nonneg` CHECK (((coalesce(`quantity`,0) >= 0) and (coalesce(`unit_price`,0) >= 0) and (coalesce(`discount_amount`,0) >= 0) and (coalesce(`item_amount`,0) >= 0))),
  CONSTRAINT `chk_order_items_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'in_progress',_utf8mb4'completed',_utf8mb4'cancelled')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单项表 - 一个订单可以包含多个订单项';
CREATE TABLE IF NOT EXISTS `order_payments` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '回款记录ID',
  `order_id` char(36) NOT NULL COMMENT '订单ID（外键 → orders.id）',
  `order_item_id` char(36) DEFAULT NULL COMMENT '订单项ID（外键 → order_items.id，若针对具体服务）',
  `payment_amount` decimal(18,2) NOT NULL COMMENT '本次回款金额',
  `payment_date` date NOT NULL COMMENT '回款日期（长周期为每月实际日期）',
  `payment_type` enum('monthly','full','partial') NOT NULL DEFAULT 'full' COMMENT '回款类型：monthly(长周期月付), full(全部), partial(部分)',
  `is_excluded_from_full` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否排除在全部回款计算中（1=长周期服务）',
  `status` enum('pending','confirmed','overdue') NOT NULL DEFAULT 'pending' COMMENT '回款状态',
  `confirmed_by` char(36) DEFAULT NULL COMMENT '确认人ID（外键 → users.id，如Lulu）',
  `confirmed_at` datetime DEFAULT NULL COMMENT '确认时间',
  `notes` text COMMENT '回款备注（如财务核对信息）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_payments_order_id` (`order_id`),
  KEY `ix_payments_order_item_id` (`order_item_id`),
  KEY `ix_payments_status` (`status`),
  KEY `ix_payments_payment_date` (`payment_date`),
  KEY `fk_payments_confirmed_by` (`confirmed_by`),
  CONSTRAINT `fk_payments_confirmed_by` FOREIGN KEY (`confirmed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_payments_order_id` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_payments_order_item_id` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单回款记录表 - 支持长周期每月回款和排除计算';
CREATE TABLE IF NOT EXISTS `order_price_snapshots` (
  `id` char(36) NOT NULL,
  `order_id` char(36) NOT NULL COMMENT '订单ID（外键 → orders.id）',
  `order_item_id` char(36) DEFAULT NULL COMMENT '订单项ID（外键 → order_items.id）',
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `price_type` varchar(50) NOT NULL COMMENT '价格类型：cost, channel, direct, list',
  `currency` varchar(10) NOT NULL COMMENT '货币：IDR, CNY, USD, EUR',
  `unit_price` decimal(18,2) NOT NULL COMMENT '单价快照',
  `quantity` int NOT NULL DEFAULT '1' COMMENT '数量',
  `subtotal` decimal(18,2) NOT NULL COMMENT '小计',
  `discount_amount` decimal(18,2) NOT NULL DEFAULT '0.00' COMMENT '折扣金额',
  `final_amount` decimal(18,2) NOT NULL COMMENT '最终金额',
  `exchange_rate` decimal(18,9) DEFAULT NULL COMMENT '汇率快照',
  `base_currency` varchar(10) NOT NULL COMMENT '基准货币',
  `converted_currency` varchar(10) NOT NULL COMMENT '转换后货币',
  `customer_level_code` varchar(50) DEFAULT NULL COMMENT '客户等级代码',
  `customer_level_price` decimal(18,2) DEFAULT NULL COMMENT '客户等级价格',
  `snapshot_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '快照时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_order_item_id` (`order_item_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_snapshot_at` (`snapshot_at`),
  CONSTRAINT `fk_order_price_snapshots_order_id` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_order_price_snapshots_order_item_id` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_order_price_snapshots_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `chk_order_price_snapshots_amount_nonneg` CHECK (((`unit_price` >= 0) and (`subtotal` >= 0) and (`final_amount` >= 0))),
  CONSTRAINT `chk_order_price_snapshots_currency` CHECK ((`currency` in (_utf8mb4'IDR',_utf8mb4'CNY',_utf8mb4'USD',_utf8mb4'EUR'))),
  CONSTRAINT `chk_order_price_snapshots_price_type` CHECK ((`price_type` in (_utf8mb4'cost',_utf8mb4'channel',_utf8mb4'direct',_utf8mb4'list')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单价格快照表';
CREATE TABLE IF NOT EXISTS `order_stages` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL,
  `stage_name` varchar(255) NOT NULL,
  `stage_code` varchar(100) DEFAULT NULL,
  `stage_order` int NOT NULL,
  `status` varchar(50) DEFAULT 'pending',
  `started_at` datetime DEFAULT NULL,
  `completed_at` datetime DEFAULT NULL,
  `progress_percent` int DEFAULT '0',
  `notes` text,
  `assigned_to_user_id` char(36) DEFAULT NULL,
  `created_by` char(36) DEFAULT NULL,
  `updated_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `order_item_id` char(36) DEFAULT NULL COMMENT '关联的订单项ID（核心字段，阶段关联到具体的服务项）',
  `expected_start_date` date DEFAULT NULL COMMENT '预期开始日期',
  `expected_end_date` date DEFAULT NULL COMMENT '预期结束日期(根据标准时长计算)',
  `actual_start_date` date DEFAULT NULL COMMENT '实际开始日期',
  `actual_end_date` date DEFAULT NULL COMMENT '实际结束日期',
  `is_overdue` tinyint(1) DEFAULT '0' COMMENT '是否已超期',
  `alert_level` varchar(20) DEFAULT 'normal' COMMENT '预警级别: normal, warning, critical',
  `stage_template_id` char(36) DEFAULT NULL COMMENT '关联的阶段模板ID',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_order_stages_order` (`order_id`),
  KEY `ix_order_stages_assigned` (`assigned_to_user_id`),
  KEY `ix_order_stages_status` (`status`),
  KEY `fk_order_stage_template` (`stage_template_id`),
  KEY `ix_order_stages_order_item` (`order_item_id`),
  KEY `ix_order_stages_expected` (`expected_end_date`),
  KEY `ix_order_stages_overdue` (`is_overdue`),
  KEY `ix_order_stages_alert` (`alert_level`),
  CONSTRAINT `fk_order_stage_order_item` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_order_stage_template` FOREIGN KEY (`stage_template_id`) REFERENCES `service_stage_templates` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_stages_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `order_stages_ibfk_2` FOREIGN KEY (`assigned_to_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_stages_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `order_stages_ibfk_4` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_order_stages_progress_range` CHECK (((`progress_percent` >= 0) and (`progress_percent` <= 100))),
  CONSTRAINT `chk_order_stages_reference` CHECK ((`order_id` is not null))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `order_statuses` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) NOT NULL,
  `name` varchar(255) NOT NULL,
  `description` text,
  `display_order` int DEFAULT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `orders` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_number` varchar(100) NOT NULL,
  `title` varchar(255) NOT NULL,
  `customer_id` int NOT NULL COMMENT '客户ID',
  `product_id` char(36) DEFAULT NULL,
  `product_name` varchar(255) DEFAULT NULL,
  `sales_user_id` char(36) NOT NULL,
  `sales_username` varchar(255) DEFAULT NULL,
  `quantity` int DEFAULT '1',
  `unit_price` decimal(18,2) DEFAULT NULL,
  `total_amount` decimal(18,2) DEFAULT NULL,
  `currency_code` varchar(10) DEFAULT 'CNY',
  `discount_amount` decimal(18,2) DEFAULT '0.00',
  `final_amount` decimal(18,2) DEFAULT NULL,
  `status_id` char(36) DEFAULT NULL,
  `status_code` varchar(50) DEFAULT NULL,
  `order_type` enum('combination','long_term','one_time') NOT NULL DEFAULT 'one_time' COMMENT '订单类型：combination(组合), long_term(长周期，如财税每月回款), one_time(一次性交付)',
  `cycle_months` int DEFAULT NULL COMMENT '长周期服务月数（NULL=非长周期, 6/12/等）',
  `start_date` date DEFAULT NULL COMMENT '长周期服务开始日期（影响每月回款计算）',
  `monthly_payment_amount` decimal(18,2) DEFAULT NULL COMMENT '长周期每月回款金额（自动计算：总价 / cycle_months）',
  `is_fully_paid_excluding_long` tinyint(1) NOT NULL DEFAULT '0' COMMENT '排除长周期后是否全部回款（1=是，用于销售收入确认）',
  `expected_start_date` date DEFAULT NULL,
  `expected_completion_date` date DEFAULT NULL,
  `actual_start_date` date DEFAULT NULL,
  `actual_completion_date` date DEFAULT NULL,
  `customer_notes` text,
  `internal_notes` text,
  `requirements` text,
  `created_by` char(36) DEFAULT NULL,
  `updated_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `service_record_id` char(36) DEFAULT NULL COMMENT '服务记录ID',
  `opportunity_id` char(36) DEFAULT NULL COMMENT '商机ID（可选，用于追溯）',
  `workflow_instance_id` char(36) DEFAULT NULL COMMENT '关联的工作流实例ID',
  `entry_city` varchar(255) DEFAULT NULL COMMENT 'Entry city (来自 EVOA)',
  `passport_id` varchar(100) DEFAULT NULL COMMENT 'Passport ID (来自 EVOA)',
  `processor` varchar(255) DEFAULT NULL COMMENT 'Processor (来自 EVOA)',
  `exchange_rate` decimal(18,6) DEFAULT NULL COMMENT '汇率',
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_orders_number` (`order_number`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_orders_customer` (`customer_id`),
  KEY `ix_orders_product` (`product_id`),
  KEY `ix_orders_sales` (`sales_user_id`),
  KEY `ix_orders_status` (`status_code`),
  KEY `ix_orders_status_id` (`status_id`),
  KEY `ix_orders_created` (`created_at` DESC),
  KEY `ix_orders_service_record` (`service_record_id`),
  KEY `ix_orders_workflow_instance` (`workflow_instance_id`),
  KEY `ix_orders_opportunity` (`opportunity_id`),
  CONSTRAINT `fk_orders_service_record` FOREIGN KEY (`service_record_id`) REFERENCES `service_records` (`id`) ON DELETE SET NULL,
  CONSTRAINT `orders_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `orders_ibfk_2` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `orders_ibfk_3` FOREIGN KEY (`sales_user_id`) REFERENCES `users` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `orders_ibfk_4` FOREIGN KEY (`status_id`) REFERENCES `order_statuses` (`id`) ON DELETE SET NULL,
  CONSTRAINT `orders_ibfk_5` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `orders_ibfk_6` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `orders_ibfk_opportunity` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_orders_amounts_nonneg` CHECK (((coalesce(`quantity`,0) >= 0) and (coalesce(`unit_price`,0) >= 0) and (coalesce(`total_amount`,0) >= 0) and (coalesce(`discount_amount`,0) >= 0) and (coalesce(`final_amount`,0) >= 0)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `organization_domain_relations` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `organization_id` char(36) NOT NULL COMMENT 'ç»„ç»‡ID',
  `domain_id` char(36) NOT NULL COMMENT 'é¢†åŸŸID',
  `is_primary` tinyint(1) DEFAULT '0' COMMENT 'æ˜¯å¦ä¸»è¦é¢†åŸŸ',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_org_domain_relation` (`organization_id`,`domain_id`),
  KEY `ix_org_domain_relations_org` (`organization_id`),
  KEY `ix_org_domain_relations_domain` (`domain_id`),
  KEY `ix_org_domain_relations_primary` (`organization_id`,`is_primary`),
  CONSTRAINT `organization_domain_relations_ibfk_1` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE CASCADE,
  CONSTRAINT `organization_domain_relations_ibfk_2` FOREIGN KEY (`domain_id`) REFERENCES `organization_domains` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ç»„ç»‡é¢†åŸŸå…³è”è¡¨';
CREATE TABLE IF NOT EXISTS `organization_domains` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) NOT NULL COMMENT 'é¢†åŸŸä»£ç ï¼ˆå”¯ä¸€ï¼‰',
  `name_zh` varchar(255) NOT NULL COMMENT 'é¢†åŸŸåç§°ï¼ˆä¸­æ–‡ï¼‰',
  `name_id` varchar(255) NOT NULL COMMENT 'é¢†åŸŸåç§°ï¼ˆå°å°¼è¯­ï¼‰',
  `description_zh` text COMMENT 'é¢†åŸŸæè¿°ï¼ˆä¸­æ–‡ï¼‰',
  `description_id` text COMMENT 'é¢†åŸŸæè¿°ï¼ˆå°å°¼è¯­ï¼‰',
  `display_order` int DEFAULT '0' COMMENT 'æ˜¾ç¤ºé¡ºåº',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT 'æ˜¯å¦æ¿€æ´»',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_organization_domains_code` (`code`),
  KEY `ix_organization_domains_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ç»„ç»‡é¢†åŸŸè¡¨';
CREATE TABLE IF NOT EXISTS `organization_employees` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `user_id` char(36) NOT NULL,
  `organization_id` char(36) NOT NULL,
  `first_name` varchar(255) DEFAULT NULL,
  `last_name` varchar(255) DEFAULT NULL,
  `full_name` varchar(510) GENERATED ALWAYS AS (concat(ifnull(`first_name`,_utf8mb4''),_utf8mb4' ',ifnull(`last_name`,_utf8mb4''))) STORED,
  `email` varchar(255) DEFAULT NULL,
  `phone` varchar(50) DEFAULT NULL,
  `position` varchar(255) DEFAULT NULL,
  `department` varchar(255) DEFAULT NULL,
  `employee_number` varchar(100) DEFAULT NULL,
  `is_primary` tinyint(1) DEFAULT '0',
  `is_manager` tinyint(1) DEFAULT '0',
  `is_decision_maker` tinyint(1) DEFAULT '0',
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `joined_at` date DEFAULT NULL,
  `left_at` date DEFAULT NULL,
  `id_external` varchar(255) DEFAULT NULL,
  `external_user_id` varchar(255) DEFAULT NULL,
  `notes` text,
  `created_by` char(36) DEFAULT NULL,
  `updated_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_organization_employees_org` (`organization_id`),
  KEY `ix_organization_employees_org_active` (`organization_id`,`is_active`),
  KEY `ix_organization_employees_user` (`user_id`),
  KEY `ix_organization_employees_user_active` (`user_id`,`is_active`),
  KEY `ix_organization_employees_primary` (`user_id`,`is_primary`,`is_active`),
  KEY `ix_organization_employees_email` (`email`),
  KEY `ix_organization_employees_phone` (`phone`),
  CONSTRAINT `organization_employees_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `organization_employees_ibfk_2` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE CASCADE,
  CONSTRAINT `organization_employees_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `organization_employees_ibfk_4` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `organizations` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `name` text NOT NULL,
  `code` varchar(255) DEFAULT NULL,
  `external_id` varchar(255) DEFAULT NULL,
  `organization_type` varchar(50) NOT NULL,
  `parent_id` char(36) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `phone` varchar(50) DEFAULT NULL,
  `website` varchar(255) DEFAULT NULL,
  `logo_url` varchar(500) DEFAULT NULL,
  `description` text,
  `street` text,
  `city` varchar(100) DEFAULT NULL,
  `state_province` varchar(100) DEFAULT NULL,
  `postal_code` varchar(20) DEFAULT NULL,
  `country_region` varchar(100) DEFAULT NULL,
  `country` varchar(100) DEFAULT NULL,
  `country_code` varchar(10) DEFAULT NULL,
  `company_size` varchar(50) DEFAULT NULL,
  `company_nature` varchar(50) DEFAULT NULL,
  `company_type` varchar(50) DEFAULT NULL,
  `industry` varchar(100) DEFAULT NULL,
  `industry_code` varchar(50) DEFAULT NULL,
  `sub_industry` varchar(100) DEFAULT NULL,
  `business_scope` text,
  `registration_number` varchar(100) DEFAULT NULL,
  `tax_id` varchar(100) DEFAULT NULL,
  `legal_representative` varchar(255) DEFAULT NULL,
  `established_date` date DEFAULT NULL,
  `registered_capital` decimal(18,2) DEFAULT NULL,
  `registered_capital_currency` varchar(10) DEFAULT 'CNY',
  `company_status` varchar(50) DEFAULT NULL,
  `annual_revenue` decimal(18,2) DEFAULT NULL,
  `annual_revenue_currency` varchar(10) DEFAULT 'CNY',
  `employee_count` int DEFAULT NULL,
  `revenue_year` int DEFAULT NULL,
  `certifications` json DEFAULT (json_array()),
  `business_license_url` varchar(500) DEFAULT NULL,
  `tax_certificate_url` varchar(500) DEFAULT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `is_locked` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æ˜¯å¦é”å®šï¼šFalse=åˆä½œï¼ˆé»˜è®¤ï¼‰ï¼ŒTrue=é”å®šï¼ˆæ–­å¼€åˆä½œï¼‰',
  `is_verified` tinyint(1) DEFAULT '0',
  `verified_at` datetime DEFAULT NULL,
  `verified_by` char(36) DEFAULT NULL,
  `owner_id_external` varchar(255) DEFAULT NULL,
  `owner_name` varchar(255) DEFAULT NULL,
  `created_by_external` varchar(255) DEFAULT NULL,
  `created_by_name` varchar(255) DEFAULT NULL,
  `updated_by_external` varchar(255) DEFAULT NULL,
  `updated_by_name` varchar(255) DEFAULT NULL,
  `created_at_src` datetime DEFAULT NULL,
  `updated_at_src` datetime DEFAULT NULL,
  `last_action_at_src` datetime DEFAULT NULL,
  `linked_module` varchar(100) DEFAULT NULL,
  `linked_id_external` varchar(255) DEFAULT NULL,
  `tags` json DEFAULT (json_array()),
  `do_not_email` tinyint(1) DEFAULT NULL,
  `unsubscribe_method` varchar(50) DEFAULT NULL,
  `unsubscribe_date_src` text,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `developed_by` char(36) DEFAULT NULL COMMENT '客户开发人ID（外键 → users.id）',
  `last_contact_at` datetime DEFAULT NULL COMMENT '最后联系时间，用于判断长久未跟进',
  `is_stale` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否长久未跟进客户（1=是）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  UNIQUE KEY `external_id` (`external_id`),
  KEY `verified_by` (`verified_by`),
  KEY `ix_organizations_code` (`code`),
  KEY `ix_organizations_type` (`organization_type`),
  KEY `ix_organizations_type_active` (`organization_type`,`is_active`),
  KEY `ix_organizations_email` (`email`),
  KEY `ix_organizations_phone` (`phone`),
  KEY `ix_organizations_parent` (`parent_id`),
  KEY `ix_organizations_country` (`country`),
  KEY `ix_organizations_country_code` (`country_code`),
  KEY `ix_organizations_size` (`company_size`),
  KEY `ix_organizations_nature` (`company_nature`),
  KEY `ix_organizations_industry` (`industry`),
  KEY `ix_organizations_registration` (`registration_number`),
  KEY `ix_organizations_tax_id` (`tax_id`),
  KEY `ix_organizations_status` (`company_status`),
  KEY `ix_organizations_verified` (`is_verified`),
  KEY `ix_organizations_employee_count` (`employee_count`),
  KEY `fk_organizations_developed_by` (`developed_by`),
  CONSTRAINT `fk_organizations_developed_by` FOREIGN KEY (`developed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `organizations_ibfk_1` FOREIGN KEY (`parent_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `organizations_ibfk_2` FOREIGN KEY (`verified_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_organizations_capital_nonneg` CHECK ((coalesce(`registered_capital`,0) >= 0)),
  CONSTRAINT `chk_organizations_company_type` CHECK (((`company_type` is null) or (`company_type` in (_utf8mb4'limited',_utf8mb4'unlimited',_utf8mb4'partnership',_utf8mb4'sole_proprietorship',_utf8mb4'other')))),
  CONSTRAINT `chk_organizations_employee_nonneg` CHECK ((coalesce(`employee_count`,0) >= 0)),
  CONSTRAINT `chk_organizations_nature` CHECK (((`company_nature` is null) or (`company_nature` in (_utf8mb4'state_owned',_utf8mb4'private',_utf8mb4'foreign',_utf8mb4'joint_venture',_utf8mb4'collective',_utf8mb4'individual',_utf8mb4'other')))),
  CONSTRAINT `chk_organizations_revenue_nonneg` CHECK ((coalesce(`annual_revenue`,0) >= 0)),
  CONSTRAINT `chk_organizations_size` CHECK (((`company_size` is null) or (`company_size` in (_utf8mb4'micro',_utf8mb4'small',_utf8mb4'medium',_utf8mb4'large',_utf8mb4'enterprise')))),
  CONSTRAINT `chk_organizations_status` CHECK (((`company_status` is null) or (`company_status` in (_utf8mb4'normal',_utf8mb4'cancelled',_utf8mb4'revoked',_utf8mb4'liquidated',_utf8mb4'other')))),
  CONSTRAINT `chk_organizations_type` CHECK ((`organization_type` in (_utf8mb4'internal',_utf8mb4'vendor',_utf8mb4'agent')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `payment_stages` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL COMMENT '订单ID',
  `order_number` varchar(100) DEFAULT NULL COMMENT '订单号（冗余字段）',
  `service_record_id` char(36) DEFAULT NULL COMMENT '服务记录ID',
  `stage_number` int NOT NULL COMMENT '阶段序号（1, 2, 3...）',
  `stage_name` varchar(255) DEFAULT NULL COMMENT '阶段名称（如：首付款、中期款、尾款）',
  `stage_description` text COMMENT '阶段描述',
  `amount` decimal(18,2) NOT NULL COMMENT '应付金额',
  `paid_amount` decimal(18,2) DEFAULT '0.00' COMMENT '已付金额',
  `remaining_amount` decimal(18,2) GENERATED ALWAYS AS ((`amount` - `paid_amount`)) STORED COMMENT '剩余金额（计算字段）',
  `currency_code` varchar(10) DEFAULT 'CNY' COMMENT '货币代码',
  `payment_condition` text COMMENT '付款条件/触发条件',
  `payment_trigger` varchar(50) DEFAULT NULL COMMENT '付款触发：manual(手动), milestone(里程碑), date(日期), completion(完成)',
  `trigger_date` date DEFAULT NULL COMMENT '触发日期',
  `trigger_milestone` varchar(255) DEFAULT NULL COMMENT '触发里程碑',
  `due_date` date DEFAULT NULL COMMENT '到期日期',
  `expected_payment_date` date DEFAULT NULL COMMENT '预期付款日期',
  `actual_payment_date` date DEFAULT NULL COMMENT '实际付款日期',
  `status` varchar(50) DEFAULT 'pending' COMMENT '状态：pending(待付), partial(部分付款), paid(已付), overdue(逾期), cancelled(已取消)',
  `payment_status` varchar(50) DEFAULT 'unpaid' COMMENT '付款状态：unpaid(未付), partial(部分付款), paid(已付), refunded(已退款)',
  `finance_record_id` varchar(255) DEFAULT NULL COMMENT '财务系统记录ID',
  `finance_sync_status` varchar(50) DEFAULT 'pending' COMMENT '财务同步状态：pending(待同步), synced(已同步), failed(同步失败)',
  `finance_sync_at` datetime DEFAULT NULL COMMENT '财务同步时间',
  `finance_sync_error` text COMMENT '财务同步错误信息',
  `invoice_number` varchar(100) DEFAULT NULL COMMENT '发票号',
  `invoice_date` date DEFAULT NULL COMMENT '发票日期',
  `invoice_url` varchar(500) DEFAULT NULL COMMENT '发票URL',
  `notes` text COMMENT '备注',
  `internal_notes` text COMMENT '内部备注',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_payment_stages_order` (`order_id`),
  KEY `ix_payment_stages_service_record` (`service_record_id`),
  KEY `ix_payment_stages_stage_number` (`order_id`,`stage_number`),
  KEY `ix_payment_stages_status` (`status`),
  KEY `ix_payment_stages_payment_status` (`payment_status`),
  KEY `ix_payment_stages_due_date` (`due_date`),
  KEY `ix_payment_stages_finance_sync` (`finance_sync_status`),
  KEY `ix_payment_stages_finance_record` (`finance_record_id`),
  CONSTRAINT `payment_stages_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
  CONSTRAINT `payment_stages_ibfk_2` FOREIGN KEY (`service_record_id`) REFERENCES `service_records` (`id`) ON DELETE SET NULL,
  CONSTRAINT `payment_stages_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `payment_stages_ibfk_4` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_payment_stages_amount_nonneg` CHECK (((coalesce(`amount`,0) >= 0) and (coalesce(`paid_amount`,0) >= 0))),
  CONSTRAINT `chk_payment_stages_finance_sync_status` CHECK ((`finance_sync_status` in (_utf8mb4'pending',_utf8mb4'synced',_utf8mb4'failed'))),
  CONSTRAINT `chk_payment_stages_payment_status` CHECK ((`payment_status` in (_utf8mb4'unpaid',_utf8mb4'partial',_utf8mb4'paid',_utf8mb4'refunded'))),
  CONSTRAINT `chk_payment_stages_stage_number` CHECK ((`stage_number` > 0)),
  CONSTRAINT `chk_payment_stages_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'partial',_utf8mb4'paid',_utf8mb4'overdue',_utf8mb4'cancelled'))),
  CONSTRAINT `chk_payment_stages_trigger` CHECK (((`payment_trigger` in (_utf8mb4'manual',_utf8mb4'milestone',_utf8mb4'date',_utf8mb4'completion')) or (`payment_trigger` is null)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='分阶段付款表 - 管理订单的分阶段付款计划';
CREATE TABLE IF NOT EXISTS `payment_vouchers` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '凭证记录ID',
  `payment_id` char(36) NOT NULL COMMENT '收款记录ID（外键 → payments.id）',
  `file_name` varchar(255) NOT NULL COMMENT '凭证文件名（如：转账截图.jpg）',
  `file_url` varchar(500) NOT NULL COMMENT 'OSS存储路径（班兔合同云）',
  `file_size_kb` int DEFAULT NULL COMMENT '文件大小',
  `uploaded_by` char(36) DEFAULT NULL COMMENT '上传人ID（外键 → users.id，通常销售或客户）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `is_primary` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否主要凭证（1=是，用于核对）',
  PRIMARY KEY (`id`),
  KEY `ix_payment_vouchers_payment_id` (`payment_id`),
  KEY `ix_payment_vouchers_is_primary` (`is_primary`),
  KEY `fk_payment_vouchers_uploaded_by` (`uploaded_by`),
  CONSTRAINT `fk_payment_vouchers_payment_id` FOREIGN KEY (`payment_id`) REFERENCES `payments` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_payment_vouchers_uploaded_by` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='收款凭证上传表 - 存储转账截图等凭证，整合合同云 OSS';
CREATE TABLE IF NOT EXISTS `payments` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `order_id` char(36) NOT NULL,
  `payment_type` varchar(50) NOT NULL,
  `amount` decimal(18,2) NOT NULL,
  `currency_code` varchar(10) DEFAULT 'CNY',
  `payment_method` varchar(50) DEFAULT NULL,
  `payment_date` date DEFAULT NULL,
  `received_at` datetime DEFAULT NULL,
  `transaction_id` varchar(255) DEFAULT NULL,
  `bank_account` varchar(255) DEFAULT NULL,
  `payer_name` varchar(255) DEFAULT NULL,
  `payer_account` varchar(255) DEFAULT NULL,
  `status` varchar(50) DEFAULT 'pending',
  `confirmed_by` char(36) DEFAULT NULL,
  `confirmed_at` datetime DEFAULT NULL,
  `notes` text,
  `created_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `payment_stage_id` char(36) DEFAULT NULL COMMENT '付款阶段ID',
  PRIMARY KEY (`id`),
  KEY `confirmed_by` (`confirmed_by`),
  KEY `created_by` (`created_by`),
  KEY `ix_payments_order` (`order_id`),
  KEY `ix_payments_status` (`status`),
  KEY `ix_payments_date` (`payment_date` DESC),
  KEY `ix_payments_payment_stage` (`payment_stage_id`),
  CONSTRAINT `fk_payments_payment_stage` FOREIGN KEY (`payment_stage_id`) REFERENCES `payment_stages` (`id`) ON DELETE SET NULL,
  CONSTRAINT `payments_ibfk_1` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `payments_ibfk_2` FOREIGN KEY (`confirmed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `payments_ibfk_3` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `permissions` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) NOT NULL COMMENT '权限编码（唯一，如：user.create）',
  `name_zh` varchar(255) NOT NULL COMMENT '权限名称（中文）',
  `name_id` varchar(255) NOT NULL COMMENT '权限名称（印尼语）',
  `description_zh` text COMMENT '权限描述（中文）',
  `description_id` text COMMENT '权限描述（印尼语）',
  `resource_type` varchar(50) NOT NULL COMMENT '资源类型（如：user、organization、order 等）',
  `action` varchar(50) NOT NULL COMMENT '操作类型（如：create、view、update、delete、list 等）',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否激活',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `ix_permissions_code` (`code`),
  KEY `ix_permissions_resource_type` (`resource_type`),
  KEY `ix_permissions_action` (`action`),
  KEY `ix_permissions_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `price_change_logs` (
  `id` char(36) NOT NULL,
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `price_id` char(36) DEFAULT NULL COMMENT '价格ID（外键 → product_prices.id）',
  `change_type` varchar(50) NOT NULL COMMENT '变更类型：create, update, delete, activate, deactivate',
  `price_type` varchar(50) NOT NULL COMMENT '价格类型：cost, channel, direct, list',
  `currency` varchar(10) NOT NULL COMMENT '货币：IDR, CNY, USD, EUR',
  `old_price` decimal(18,2) DEFAULT NULL COMMENT '变更前价格',
  `new_price` decimal(18,2) DEFAULT NULL COMMENT '变更后价格',
  `price_change_amount` decimal(18,2) DEFAULT NULL COMMENT '价格变动金额',
  `price_change_percentage` decimal(5,2) DEFAULT NULL COMMENT '价格变动百分比',
  `old_effective_from` datetime DEFAULT NULL COMMENT '变更前生效时间',
  `new_effective_from` datetime DEFAULT NULL COMMENT '变更后生效时间',
  `old_effective_to` datetime DEFAULT NULL COMMENT '变更前失效时间',
  `new_effective_to` datetime DEFAULT NULL COMMENT '变更后失效时间',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人ID',
  `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '变更时间',
  `affected_orders_count` int DEFAULT NULL COMMENT '受影响订单数量（预估）',
  `impact_analysis` json DEFAULT NULL COMMENT '影响分析（JSON格式）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_price_id` (`price_id`),
  KEY `idx_change_type` (`change_type`),
  KEY `idx_price_type` (`price_type`),
  KEY `idx_changed_at` (`changed_at`),
  KEY `idx_changed_by` (`changed_by`),
  CONSTRAINT `fk_price_change_logs_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_price_change_logs_price_id` FOREIGN KEY (`price_id`) REFERENCES `product_prices` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_price_change_logs_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_price_change_logs_change_type` CHECK ((`change_type` in (_utf8mb4'create',_utf8mb4'update',_utf8mb4'delete',_utf8mb4'activate',_utf8mb4'deactivate'))),
  CONSTRAINT `chk_price_change_logs_currency` CHECK ((`currency` in (_utf8mb4'IDR',_utf8mb4'CNY',_utf8mb4'USD',_utf8mb4'EUR'))),
  CONSTRAINT `chk_price_change_logs_price_type` CHECK ((`price_type` in (_utf8mb4'cost',_utf8mb4'channel',_utf8mb4'direct',_utf8mb4'list')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='价格变更日志表';
CREATE TABLE IF NOT EXISTS `product_categories` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(100) NOT NULL,
  `name` varchar(255) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `description` text COMMENT '分类描述',
  `parent_id` char(36) DEFAULT NULL COMMENT '父分类ID',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `product_dependencies` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `depends_on_product_id` char(36) NOT NULL COMMENT '依赖的产品ID（外键 → products.id）',
  `dependency_type` varchar(50) NOT NULL DEFAULT 'required' COMMENT '依赖类型（required: 必须, recommended: 推荐, optional: 可选）',
  `description` text COMMENT '依赖说明',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_product_dependency` (`product_id`,`depends_on_product_id`),
  KEY `ix_product_dependencies_product` (`product_id`),
  KEY `ix_product_dependencies_depends_on` (`depends_on_product_id`),
  KEY `ix_product_dependencies_type` (`dependency_type`),
  CONSTRAINT `product_dependencies_ibfk_1` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `product_dependencies_ibfk_2` FOREIGN KEY (`depends_on_product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_product_dependencies_type` CHECK ((`dependency_type` in (_utf8mb4'required',_utf8mb4'recommended',_utf8mb4'optional')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='产品依赖关系表';
CREATE TABLE IF NOT EXISTS `product_document_rules` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '资料规则ID',
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `rule_code` varchar(100) NOT NULL COMMENT '规则代码（唯一，便于程序识别，如：PASSPORT_FRONT, COMPANY_NIB）',
  `document_name_zh` varchar(255) NOT NULL COMMENT '资料名称（中文，如：护照首页）',
  `document_name_id` varchar(255) DEFAULT NULL COMMENT '资料名称（印尼文）',
  `document_type` enum('image','pdf','text','number','date','file') NOT NULL COMMENT '资料类型：image(图片), pdf, text(文本), number(数字), date(日期), file(任意文件)',
  `is_required` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否必填（1=是）',
  `max_size_kb` int DEFAULT NULL COMMENT '最大文件大小（KB）',
  `allowed_extensions` varchar(200) DEFAULT NULL COMMENT '允许扩展名（逗号分隔，如：jpg,png,pdf）',
  `validation_rules_json` json DEFAULT NULL COMMENT '校验规则JSON，例如：{"min_width": 800, "min_height": 600, "aspect_ratio": "3:4"} 用于图片护照',
  `depends_on_rule_id` char(36) DEFAULT NULL COMMENT '依赖的前置资料规则ID（外键 → product_document_rules.id，上游资料完成才解锁本资料）',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '显示排序',
  `description` text COMMENT '资料说明（如：护照有效期不能低于18个月）',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_product_rule_code` (`product_id`,`rule_code`),
  KEY `ix_product_rules_product_id` (`product_id`),
  KEY `ix_product_rules_depends_on` (`depends_on_rule_id`),
  KEY `ix_product_rules_active` (`is_active`),
  KEY `fk_product_rules_created_by` (`created_by`),
  KEY `fk_product_rules_updated_by` (`updated_by`),
  CONSTRAINT `fk_product_rules_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_product_rules_depends_on_rule_id` FOREIGN KEY (`depends_on_rule_id`) REFERENCES `product_document_rules` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_product_rules_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_product_rules_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='产品资料规则表 - 每个服务产品配置独立资料要求，支持类型、格式、依赖、校验，高可扩展';
CREATE TABLE IF NOT EXISTS `product_price_list` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_id` char(36) NOT NULL COMMENT '关联服务/产品ID',
  `price_level2_cny` decimal(18,2) DEFAULT '0.00' COMMENT '等级2价格(CNY): 央企总部和龙头企业',
  `price_level3_cny` decimal(18,2) DEFAULT '0.00' COMMENT '等级3价格(CNY): 国有企业和上市公司',
  `price_level4_cny` decimal(18,2) DEFAULT '0.00' COMMENT '等级4价格(CNY): 非上市品牌公司',
  `price_level5_cny` decimal(18,2) DEFAULT '0.00' COMMENT '等级5价格(CNY): 中小型企业',
  `price_level6_cny` decimal(18,2) DEFAULT '0.00' COMMENT '等级6价格(CNY): 个人创业小公司',
  `price_level2_idr` decimal(18,2) DEFAULT '0.00' COMMENT '等级2价格(IDR): 央企总部和龙头企业',
  `price_level3_idr` decimal(18,2) DEFAULT '0.00' COMMENT '等级3价格(IDR): 国有企业和上市公司',
  `price_level4_idr` decimal(18,2) DEFAULT '0.00' COMMENT '等级4价格(IDR): 非上市品牌公司',
  `price_level5_idr` decimal(18,2) DEFAULT '0.00' COMMENT '等级5价格(IDR): 中小型企业',
  `price_level6_idr` decimal(18,2) DEFAULT '0.00' COMMENT '等级6价格(IDR): 个人创业小公司',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否启用',
  `effective_from` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '生效开始时间',
  `effective_to` datetime DEFAULT NULL COMMENT '生效结束时间（NULL表示一直有效）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_product_active` (`product_id`,`is_active`),
  KEY `ix_price_list_product` (`product_id`),
  KEY `ix_price_list_active` (`is_active`),
  KEY `ix_price_list_effective` (`effective_from`,`effective_to`),
  KEY `fk_price_list_creator` (`created_by`),
  CONSTRAINT `fk_price_list_creator` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_price_list_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_price_nonneg` CHECK (((coalesce(`price_level2_cny`,0) >= 0) and (coalesce(`price_level3_cny`,0) >= 0) and (coalesce(`price_level4_cny`,0) >= 0) and (coalesce(`price_level5_cny`,0) >= 0) and (coalesce(`price_level6_cny`,0) >= 0) and (coalesce(`price_level2_idr`,0) >= 0) and (coalesce(`price_level3_idr`,0) >= 0) and (coalesce(`price_level4_idr`,0) >= 0) and (coalesce(`price_level5_idr`,0) >= 0) and (coalesce(`price_level6_idr`,0) >= 0)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='销售价格体系表：一个产品一条记录，包含四个固定客户等级的价格';
CREATE TABLE IF NOT EXISTS `product_prices` (
  `id` char(36) NOT NULL,
  `product_id` char(36) NOT NULL COMMENT '产品ID（外键 → products.id）',
  `organization_id` char(36) DEFAULT NULL COMMENT '组织ID（NULL表示通用价格，跨服务无外键）',
  `price_channel_idr` decimal(18,2) DEFAULT NULL COMMENT '渠道价-IDR',
  `price_channel_cny` decimal(18,2) DEFAULT NULL COMMENT '渠道价-CNY',
  `price_direct_idr` decimal(18,2) DEFAULT NULL COMMENT '直客价-IDR',
  `price_direct_cny` decimal(18,2) DEFAULT NULL COMMENT '直客价-CNY',
  `price_list_idr` decimal(18,2) DEFAULT NULL COMMENT '列表价-IDR',
  `price_list_cny` decimal(18,2) DEFAULT NULL COMMENT '列表价-CNY',
  `price_cost_idr` decimal(18,2) DEFAULT NULL COMMENT 'æˆæœ¬ä»·-IDR',
  `price_cost_cny` decimal(18,2) DEFAULT NULL COMMENT 'æˆæœ¬ä»·-CNY',
  `exchange_rate` decimal(18,9) DEFAULT NULL COMMENT '汇率（用于计算）',
  `effective_from` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '生效时间',
  `effective_to` datetime DEFAULT NULL COMMENT '失效时间（NULL表示当前有效）',
  `source` varchar(50) DEFAULT NULL COMMENT '价格来源：manual, import, contract',
  `is_approved` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已审核',
  `approved_by` char(36) DEFAULT NULL COMMENT '审核人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审核时间',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_organization_id` (`organization_id`),
  KEY `idx_effective_from` (`effective_from`),
  KEY `idx_effective_to` (`effective_to`),
  KEY `fk_product_prices_approved_by` (`approved_by`),
  KEY `fk_product_prices_changed_by` (`changed_by`),
  CONSTRAINT `fk_product_prices_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_product_prices_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_product_prices_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_product_prices_channel_cny_nonneg` CHECK (((`price_channel_cny` is null) or (`price_channel_cny` >= 0))),
  CONSTRAINT `chk_product_prices_channel_idr_nonneg` CHECK (((`price_channel_idr` is null) or (`price_channel_idr` >= 0))),
  CONSTRAINT `chk_product_prices_cost_cny_nonneg` CHECK (((`price_cost_cny` is null) or (`price_cost_cny` >= 0))),
  CONSTRAINT `chk_product_prices_cost_idr_nonneg` CHECK (((`price_cost_idr` is null) or (`price_cost_idr` >= 0))),
  CONSTRAINT `chk_product_prices_direct_cny_nonneg` CHECK (((`price_direct_cny` is null) or (`price_direct_cny` >= 0))),
  CONSTRAINT `chk_product_prices_direct_idr_nonneg` CHECK (((`price_direct_idr` is null) or (`price_direct_idr` >= 0))),
  CONSTRAINT `chk_product_prices_list_cny_nonneg` CHECK (((`price_list_cny` is null) or (`price_list_cny` >= 0))),
  CONSTRAINT `chk_product_prices_list_idr_nonneg` CHECK (((`price_list_idr` is null) or (`price_list_idr` >= 0)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='产品价格表';
CREATE TABLE IF NOT EXISTS `products` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `id_external` varchar(255) DEFAULT NULL,
  `owner_id_external` varchar(255) DEFAULT NULL,
  `owner_name` varchar(255) DEFAULT NULL,
  `created_by_external` varchar(255) DEFAULT NULL,
  `created_by_name` varchar(255) DEFAULT NULL,
  `updated_by_external` varchar(255) DEFAULT NULL,
  `updated_by_name` varchar(255) DEFAULT NULL,
  `created_at_src` datetime DEFAULT NULL,
  `updated_at_src` datetime DEFAULT NULL,
  `last_action_at_src` datetime DEFAULT NULL,
  `linked_module` varchar(100) DEFAULT NULL,
  `linked_id_external` varchar(255) DEFAULT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `code` varchar(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `enterprise_service_code` varchar(50) DEFAULT NULL COMMENT '企业服务编码（系统自动生成，格式：{分类代码}-{服务类型代码}-{序号}）',
  `code_generation_rule` varchar(100) DEFAULT NULL COMMENT '编码生成规则（用于记录生成规则）',
  `vendor_id` char(36) DEFAULT NULL,
  `vendor_id_external` varchar(255) DEFAULT NULL,
  `vendor_name` varchar(255) DEFAULT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `category_code` varchar(100) DEFAULT NULL,
  `unit` varchar(50) DEFAULT NULL,
  `is_taxable` tinyint(1) DEFAULT NULL,
  `tax_rate` decimal(5,2) DEFAULT NULL,
  `tax_code` varchar(50) DEFAULT NULL,
  `tags` json DEFAULT (json_array()),
  `is_locked` tinyint(1) DEFAULT NULL,
  `notes` text,
  `required_documents` text,
  `processing_time` varchar(255) DEFAULT NULL,
  `category_id` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `price_cost_idr_test` decimal(18,2) DEFAULT NULL COMMENT '测试字段',
  `service_type` varchar(50) DEFAULT NULL COMMENT '服务类型',
  `status` varchar(50) DEFAULT 'active' COMMENT '状态',
  `price_status` varchar(50) DEFAULT 'active' COMMENT '价格状态：active（生效中）, pending（待生效）, suspended（已暂停）',
  `price_locked` tinyint(1) NOT NULL DEFAULT '0' COMMENT '价格是否锁定（锁定后不允许修改）',
  `price_locked_by` char(36) DEFAULT NULL COMMENT '价格锁定人ID',
  `price_locked_at` datetime DEFAULT NULL COMMENT '价格锁定时间',
  `service_subtype` varchar(50) DEFAULT NULL COMMENT '服务子类型',
  `validity_period` int DEFAULT NULL COMMENT '有效期（天数）',
  `processing_days` int DEFAULT NULL COMMENT '处理天数',
  `processing_time_text` varchar(255) DEFAULT NULL COMMENT '处理时间文本描述',
  `is_urgent_available` tinyint(1) DEFAULT '0' COMMENT '是否支持加急',
  `urgent_processing_days` int DEFAULT NULL COMMENT '加急处理天数',
  `urgent_price_surcharge` decimal(18,2) DEFAULT NULL COMMENT '加急附加费',
  `channel_profit` decimal(18,2) DEFAULT NULL COMMENT '渠道方利润',
  `channel_profit_rate` decimal(5,4) DEFAULT NULL COMMENT '渠道方利润率',
  `channel_customer_profit` decimal(18,2) DEFAULT NULL COMMENT '渠道客户利润',
  `channel_customer_profit_rate` decimal(5,4) DEFAULT NULL COMMENT '渠道客户利润率',
  `direct_profit` decimal(18,2) DEFAULT NULL COMMENT '直客利润',
  `direct_profit_rate` decimal(5,4) DEFAULT NULL COMMENT '直客利润率',
  `commission_rate` decimal(5,4) DEFAULT NULL COMMENT '提成比例',
  `commission_amount` decimal(18,2) DEFAULT NULL COMMENT '提成金额',
  `equivalent_cny` decimal(18,2) DEFAULT NULL COMMENT '等值人民币',
  `monthly_orders` int DEFAULT NULL COMMENT '每月单数',
  `total_amount` decimal(18,2) DEFAULT NULL COMMENT '合计',
  `sla_description` text COMMENT 'SLA 描述',
  `service_level` varchar(50) DEFAULT NULL COMMENT '服务级别',
  `suspended_reason` text COMMENT '暂停原因',
  `discontinued_at` datetime DEFAULT NULL COMMENT '停用时间',
  `service_type_id` char(36) DEFAULT NULL COMMENT '服务类型ID',
  `std_duration_days` int DEFAULT '7' COMMENT '标准执行总时长(天)',
  `allow_multi_vendor` tinyint(1) DEFAULT '1' COMMENT '是否允许多供应商接单（1=允许，0=单一供应商）',
  `default_supplier_id` char(36) DEFAULT NULL COMMENT '默认供应商ID（当allow_multi_vendor=0时使用）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_external` (`id_external`),
  UNIQUE KEY `ux_products_code` (`code`),
  UNIQUE KEY `idx_products_enterprise_service_code` (`enterprise_service_code`),
  KEY `vendor_id` (`vendor_id`),
  KEY `category_id` (`category_id`),
  KEY `ix_products_active` (`is_active`),
  KEY `fk_products_default_supplier` (`default_supplier_id`),
  KEY `idx_products_price_status` (`price_status`),
  KEY `idx_products_price_locked` (`price_locked`),
  KEY `fk_products_price_locked_by` (`price_locked_by`),
  CONSTRAINT `fk_products_default_supplier` FOREIGN KEY (`default_supplier_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_products_price_locked_by` FOREIGN KEY (`price_locked_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `quotation_documents` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '资料记录ID',
  `quotation_id` char(36) NOT NULL COMMENT '报价单ID（外键 → quotations.id）',
  `wechat_group_no` varchar(100) DEFAULT NULL COMMENT '关联微信群编号（与报价单一致，用于链路查询）',
  `document_type` varchar(100) NOT NULL COMMENT '资料类型（如：passport_front, company_nib, shareholder_ktp）',
  `document_name` varchar(255) NOT NULL COMMENT '资料文件名',
  `file_url` varchar(500) NOT NULL COMMENT '存储路径（OSS链接）',
  `uploaded_by` char(36) DEFAULT NULL COMMENT '上传人ID（外键 → users.id，可为客户或销售）',
  `uploaded_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '上传时间',
  `related_item_id` char(36) DEFAULT NULL COMMENT '关联报价单明细行ID（外键 → quotation_items.id）',
  PRIMARY KEY (`id`),
  KEY `ix_quotation_documents_quotation_id` (`quotation_id`),
  KEY `ix_quotation_documents_group_no` (`wechat_group_no`),
  KEY `ix_quotation_documents_type` (`document_type`),
  KEY `ix_quotation_documents_related_item_id` (`related_item_id`),
  KEY `fk_quotation_documents_uploaded_by` (`uploaded_by`),
  CONSTRAINT `fk_quotation_documents_quotation_id` FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_quotation_documents_related_item_id` FOREIGN KEY (`related_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_quotation_documents_uploaded_by` FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='报价单资料上传表 - 支持按群编号和项目关联上传公司资料';
CREATE TABLE IF NOT EXISTS `quotation_items` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '明细行ID',
  `quotation_id` char(36) NOT NULL COMMENT '报价单ID（外键 → quotations.id）',
  `opportunity_item_id` char(36) DEFAULT NULL COMMENT '关联商机明细ID（外键 → opportunity_products.id，便于追溯）',
  `product_id` char(36) DEFAULT NULL COMMENT '产品ID（外键 → products.id）',
  `item_name` varchar(255) NOT NULL COMMENT '服务名称',
  `quantity` decimal(10,2) NOT NULL DEFAULT '1.00' COMMENT '数量',
  `unit_price_primary` decimal(18,2) NOT NULL COMMENT '主货币单价（应用折扣后）',
  `unit_cost` decimal(18,2) NOT NULL DEFAULT '0.00' COMMENT '成本单价（后台校验用，不对外显示）',
  `is_below_cost` tinyint(1) GENERATED ALWAYS AS ((case when (`unit_price_primary` < `unit_cost`) then 1 else 0 end)) STORED COMMENT '是否低于成本（1=是，前端标红警告）',
  `total_price_primary` decimal(18,2) NOT NULL COMMENT '主货币小计',
  `service_category` enum('one_time','long_term') NOT NULL COMMENT '服务类别（继承自商机明细，用于后续拆单）',
  `sort_order` int NOT NULL DEFAULT '0' COMMENT '显示排序',
  `description` text COMMENT '描述',
  PRIMARY KEY (`id`),
  KEY `ix_quotation_items_quotation_id` (`quotation_id`),
  KEY `ix_quotation_items_below_cost` (`is_below_cost`),
  KEY `ix_quotation_items_opportunity_item_id` (`opportunity_item_id`),
  KEY `ix_quotation_items_product_id` (`product_id`),
  CONSTRAINT `fk_quotation_items_opportunity_item_id` FOREIGN KEY (`opportunity_item_id`) REFERENCES `opportunity_products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_quotation_items_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_quotation_items_quotation_id` FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='报价单明细表 - 支持成本隐藏校验、低于成本标红、继承服务类别用于拆单';
CREATE TABLE IF NOT EXISTS `quotation_templates` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '模板ID',
  `template_code` varchar(50) NOT NULL COMMENT '模板代码（唯一，如：BJ_BANTU_CNY, PT_PUBLIC_IDR）',
  `template_name` varchar(255) NOT NULL COMMENT '模板名称（如：北京班兔人民币模板）',
  `description` text COMMENT '模板描述',
  `primary_currency` varchar(10) NOT NULL COMMENT '主货币：IDR 或 CNY',
  `language` enum('zh','id','zh_id','en_zh') NOT NULL DEFAULT 'zh' COMMENT '模板语言：zh(中文), id(印尼文), zh_id(中印双语), en_zh(英中)',
  `file_url` varchar(500) NOT NULL COMMENT '模板文件存储路径（OSS链接，通常为HTML/FreeMarker/Word模板）',
  `file_type` enum('html','docx','freemarker','pdf_background') NOT NULL COMMENT '模板文件类型（用于后端渲染选择）',
  `header_logo_url` varchar(500) DEFAULT NULL COMMENT '抬头Logo',
  `footer_text` text COMMENT '页脚文本',
  `bank_account_info_json` json DEFAULT NULL COMMENT '银行账户信息JSON（根据签约主体不同）',
  `tax_info_json` json DEFAULT NULL COMMENT '税率及税号信息JSON',
  `is_default` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否为默认模板（1=是，同条件优先使用）',
  `is_active` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id）',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID（外键 → users.id）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `template_code` (`template_code`),
  UNIQUE KEY `uk_template_code` (`template_code`),
  KEY `ix_templates_currency` (`primary_currency`),
  KEY `ix_templates_language` (`language`),
  KEY `ix_templates_active` (`is_active`),
  KEY `fk_templates_created_by` (`created_by`),
  KEY `fk_templates_updated_by` (`updated_by`),
  CONSTRAINT `fk_templates_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_templates_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='报价单PDF模板表 - 支持多签约主体、多货币、多语言模板管理';
CREATE TABLE IF NOT EXISTS `quotations` (
  `id` char(36) NOT NULL DEFAULT (uuid()) COMMENT '报价单ID',
  `opportunity_id` char(36) NOT NULL COMMENT '商机ID（外键 → opportunities.id）',
  `quotation_no` varchar(50) NOT NULL COMMENT '报价单编号（如：QUO-20251228-001）',
  `version` int NOT NULL DEFAULT '1' COMMENT '版本号（同一商机多份报价单时递增）',
  `currency_primary` varchar(10) NOT NULL DEFAULT 'IDR' COMMENT '主货币：IDR 或 CNY（双货币支持）',
  `exchange_rate` decimal(18,9) DEFAULT NULL COMMENT '汇率（用于双货币换算，IDR → CNY 或反之）',
  `payment_terms` enum('full_upfront','50_50','70_30','post_payment') NOT NULL COMMENT '付款方式：full_upfront(全款), 50_50(50%预付+50%尾款), 70_30(70%预付+30%尾款), post_payment(后付)',
  `discount_rate` decimal(5,2) NOT NULL DEFAULT '0.00' COMMENT '折扣比例（%），不允许赠送，仅比例优惠',
  `total_amount_primary` decimal(18,2) NOT NULL COMMENT '主货币总金额（已应用折扣后）',
  `total_amount_secondary` decimal(18,2) DEFAULT NULL COMMENT '第二货币总金额（根据汇率换算）',
  `valid_until` date DEFAULT NULL COMMENT '报价有效期至',
  `status` enum('draft','sent','accepted','rejected','expired') NOT NULL DEFAULT 'draft' COMMENT '报价单状态',
  `wechat_group_no` varchar(100) DEFAULT NULL COMMENT '关联微信群编号（父级群编号，用于逻辑链路聚合）',
  `pdf_generated_at` datetime DEFAULT NULL COMMENT 'PDF生成时间（支持下载保存）',
  `sent_at` datetime DEFAULT NULL COMMENT '发送给客户时间',
  `template_id` char(36) DEFAULT NULL COMMENT '使用的PDF模板ID（外键 → quotation_templates.id）',
  `template_code_at_generation` varchar(50) DEFAULT NULL COMMENT '生成PDF时模板代码（冗余，防止模板后续变更影响历史报价单）',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID（外键 → users.id，通常销售人员）',
  PRIMARY KEY (`id`),
  UNIQUE KEY `quotation_no` (`quotation_no`),
  UNIQUE KEY `uk_quotation_opportunity_version` (`opportunity_id`,`version`),
  UNIQUE KEY `uk_quotation_no` (`quotation_no`),
  KEY `ix_quotations_opportunity_id` (`opportunity_id`),
  KEY `ix_quotations_wechat_group_no` (`wechat_group_no`),
  KEY `ix_quotations_status` (`status`),
  KEY `ix_quotations_template_id` (`template_id`),
  KEY `fk_quotations_created_by` (`created_by`),
  CONSTRAINT `fk_quotations_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_quotations_opportunity_id` FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_quotations_template_id` FOREIGN KEY (`template_id`) REFERENCES `quotation_templates` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='报价单主表 - 支持双货币、付款方式、折扣比例、群编号、PDF模板与操作';
CREATE TABLE IF NOT EXISTS `role_permissions` (
  `role_id` char(36) NOT NULL,
  `permission_id` char(36) NOT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`role_id`,`permission_id`),
  KEY `ix_role_permissions_role` (`role_id`),
  KEY `ix_role_permissions_permission` (`permission_id`),
  CONSTRAINT `role_permissions_ibfk_1` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE,
  CONSTRAINT `role_permissions_ibfk_2` FOREIGN KEY (`permission_id`) REFERENCES `permissions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `roles` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) NOT NULL,
  `name` varchar(255) NOT NULL,
  `name_zh` varchar(255) DEFAULT NULL COMMENT 'è§’è‰²åç§°ï¼ˆä¸­æ–‡ï¼‰',
  `name_id` varchar(255) DEFAULT NULL COMMENT 'è§’è‰²åç§°ï¼ˆå°å°¼è¯­ï¼‰',
  `description` text,
  `description_zh` text COMMENT 'è§’è‰²æè¿°ï¼ˆä¸­æ–‡ï¼‰',
  `description_id` text COMMENT 'è§’è‰²æè¿°ï¼ˆå°å°¼è¯­ï¼‰',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `service_records` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `id_external` varchar(255) DEFAULT NULL COMMENT '外部系统ID',
  `owner_id_external` varchar(255) DEFAULT NULL COMMENT '所有者外部ID',
  `owner_name` varchar(255) DEFAULT NULL COMMENT '所有者名称',
  `created_by_external` varchar(255) DEFAULT NULL COMMENT '创建者外部ID',
  `created_by_name` varchar(255) DEFAULT NULL COMMENT '创建者名称',
  `updated_by_external` varchar(255) DEFAULT NULL COMMENT '更新者外部ID',
  `updated_by_name` varchar(255) DEFAULT NULL COMMENT '更新者名称',
  `created_at_src` datetime DEFAULT NULL COMMENT '源系统创建时间',
  `updated_at_src` datetime DEFAULT NULL COMMENT '源系统更新时间',
  `last_action_at_src` datetime DEFAULT NULL COMMENT '最近操作时间',
  `linked_module` varchar(100) DEFAULT NULL COMMENT '关联模块',
  `linked_id_external` varchar(255) DEFAULT NULL COMMENT '关联外部ID',
  `customer_id` int NOT NULL COMMENT '客户ID',
  `customer_name` varchar(255) DEFAULT NULL COMMENT '客户名称（冗余字段，便于查询）',
  `service_type_id` char(36) DEFAULT NULL COMMENT '服务类型ID',
  `service_type_name` varchar(255) DEFAULT NULL COMMENT '服务类型名称（冗余字段）',
  `product_id` char(36) DEFAULT NULL COMMENT '产品/服务ID（可选，具体产品）',
  `product_name` varchar(255) DEFAULT NULL COMMENT '产品/服务名称（冗余字段）',
  `product_code` varchar(100) DEFAULT NULL COMMENT '产品/服务编码（冗余字段）',
  `service_name` varchar(255) DEFAULT NULL COMMENT '服务名称',
  `service_description` text COMMENT '服务描述/需求详情',
  `service_code` varchar(100) DEFAULT NULL COMMENT '服务编码',
  `contact_id` char(36) DEFAULT NULL COMMENT '接单人员ID（关联 contacts 表）',
  `contact_name` varchar(255) DEFAULT NULL COMMENT '接单人员名称（冗余字段）',
  `sales_user_id` char(36) DEFAULT NULL COMMENT '销售用户ID（冗余，便于查询）',
  `sales_username` varchar(255) DEFAULT NULL COMMENT '销售用户名（冗余字段）',
  `status` varchar(50) DEFAULT 'pending' COMMENT '状态：pending(待处理), in_progress(进行中), completed(已完成), cancelled(已取消), on_hold(暂停)',
  `status_description` varchar(255) DEFAULT NULL COMMENT '状态描述',
  `priority` varchar(20) DEFAULT 'normal' COMMENT '优先级：low(低), normal(普通), high(高), urgent(紧急)',
  `expected_start_date` date DEFAULT NULL COMMENT '预期开始日期',
  `expected_completion_date` date DEFAULT NULL COMMENT '预期完成日期',
  `actual_start_date` date DEFAULT NULL COMMENT '实际开始日期',
  `actual_completion_date` date DEFAULT NULL COMMENT '实际完成日期',
  `deadline` date DEFAULT NULL COMMENT '截止日期',
  `estimated_price` decimal(18,2) DEFAULT NULL COMMENT '预估价格',
  `final_price` decimal(18,2) DEFAULT NULL COMMENT '最终价格',
  `currency_code` varchar(10) DEFAULT 'CNY' COMMENT '货币代码',
  `price_notes` text COMMENT '价格备注',
  `quantity` int DEFAULT '1' COMMENT '数量',
  `unit` varchar(50) DEFAULT NULL COMMENT '单位',
  `requirements` text COMMENT '需求和要求',
  `customer_requirements` text COMMENT '客户需求',
  `internal_notes` text COMMENT '内部备注',
  `customer_notes` text COMMENT '客户备注',
  `required_documents` text COMMENT '所需文档',
  `attachments` json DEFAULT NULL COMMENT '附件列表（JSON数组）',
  `last_follow_up_at` datetime DEFAULT NULL COMMENT '最后跟进时间',
  `next_follow_up_at` datetime DEFAULT NULL COMMENT '下次跟进时间',
  `follow_up_notes` text COMMENT '跟进备注',
  `tags` json DEFAULT (json_array()) COMMENT '标签（JSON数组）',
  `category` varchar(100) DEFAULT NULL COMMENT '分类',
  `source` varchar(100) DEFAULT NULL COMMENT '来源',
  `channel` varchar(100) DEFAULT NULL COMMENT '渠道',
  `referral_customer_id` int DEFAULT NULL COMMENT '推荐客户ID',
  `referral_customer_name` varchar(255) DEFAULT NULL COMMENT '推荐客户名称',
  `is_locked` tinyint(1) DEFAULT '0' COMMENT '是否锁定',
  `is_urgent` tinyint(1) DEFAULT '0' COMMENT '是否紧急',
  `is_important` tinyint(1) DEFAULT '0' COMMENT '是否重要',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `id_external` (`id_external`),
  KEY `created_by` (`created_by`),
  KEY `updated_by` (`updated_by`),
  KEY `ix_service_records_customer` (`customer_id`),
  KEY `ix_service_records_customer_name` (`customer_name`),
  KEY `ix_service_records_service_type` (`service_type_id`),
  KEY `ix_service_records_product` (`product_id`),
  KEY `ix_service_records_product_code` (`product_code`),
  KEY `ix_service_records_contact` (`contact_id`),
  KEY `ix_service_records_sales` (`sales_user_id`),
  KEY `ix_service_records_status` (`status`),
  KEY `ix_service_records_priority` (`priority`),
  KEY `ix_service_records_expected_start` (`expected_start_date`),
  KEY `ix_service_records_expected_completion` (`expected_completion_date`),
  KEY `ix_service_records_actual_start` (`actual_start_date`),
  KEY `ix_service_records_actual_completion` (`actual_completion_date`),
  KEY `ix_service_records_deadline` (`deadline`),
  KEY `ix_service_records_created_at` (`created_at`),
  KEY `ix_service_records_last_follow_up` (`last_follow_up_at`),
  KEY `ix_service_records_next_follow_up` (`next_follow_up_at`),
  KEY `ix_service_records_is_urgent` (`is_urgent`),
  KEY `ix_service_records_is_important` (`is_important`),
  KEY `ix_service_records_is_active` (`is_active`),
  KEY `ix_service_records_referral_customer` (`referral_customer_id`),
  KEY `ix_service_records_id_external` (`id_external`),
  KEY `ix_service_records_owner` (`owner_id_external`),
  KEY `ix_service_records_customer_status` (`customer_id`,`status`),
  KEY `ix_service_records_contact_status` (`contact_id`,`status`),
  KEY `ix_service_records_sales_status` (`sales_user_id`,`status`),
  KEY `ix_service_records_service_type_status` (`service_type_id`,`status`),
  CONSTRAINT `service_records_ibfk_1` FOREIGN KEY (`customer_id`) REFERENCES `customers` (`id`) ON DELETE CASCADE,
  CONSTRAINT `service_records_ibfk_2` FOREIGN KEY (`service_type_id`) REFERENCES `service_types` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_3` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_4` FOREIGN KEY (`contact_id`) REFERENCES `contacts` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_5` FOREIGN KEY (`sales_user_id`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_6` FOREIGN KEY (`referral_customer_id`) REFERENCES `customers` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_7` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `service_records_ibfk_8` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_service_records_price_nonneg` CHECK (((coalesce(`estimated_price`,0) >= 0) and (coalesce(`final_price`,0) >= 0))),
  CONSTRAINT `chk_service_records_priority` CHECK ((`priority` in (_utf8mb4'low',_utf8mb4'normal',_utf8mb4'high',_utf8mb4'urgent'))),
  CONSTRAINT `chk_service_records_quantity_nonneg` CHECK ((coalesce(`quantity`,0) >= 0)),
  CONSTRAINT `chk_service_records_status` CHECK ((`status` in (_utf8mb4'pending',_utf8mb4'in_progress',_utf8mb4'completed',_utf8mb4'cancelled',_utf8mb4'on_hold')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='服务记录表 - 记录客户的服务需求/意向';
CREATE TABLE IF NOT EXISTS `service_stage_templates` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_id` char(36) NOT NULL COMMENT '关联服务ID',
  `stage_name_zh` varchar(100) NOT NULL COMMENT '阶段名称（中文）',
  `stage_name_id` varchar(100) DEFAULT NULL COMMENT '阶段名称（印尼语）',
  `stage_order` int NOT NULL COMMENT '排序 (1,2,3,4...)',
  `standard_days` int DEFAULT '0' COMMENT '该阶段标准耗时(天)',
  `is_milestone` tinyint(1) DEFAULT '0' COMMENT '是否为关键里程碑',
  `description` text COMMENT '阶段描述',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_stage_product_order` (`product_id`,`stage_order`),
  KEY `ix_stage_tpl_product` (`product_id`),
  KEY `ix_stage_tpl_order` (`product_id`,`stage_order`),
  KEY `fk_stage_tpl_creator` (`created_by`),
  CONSTRAINT `fk_stage_tpl_creator` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_stage_tpl_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_stage_days_nonneg` CHECK ((`standard_days` >= 0)),
  CONSTRAINT `chk_stage_order_positive` CHECK ((`stage_order` > 0))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='服务执行阶段标准模板';
CREATE TABLE IF NOT EXISTS `service_types` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `name` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL,
  `name_en` varchar(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL,
  `description` text COMMENT '类型描述',
  `display_order` int DEFAULT '0' COMMENT '显示顺序',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `code` (`code`),
  KEY `idx_service_types_code` (`code`),
  KEY `idx_service_types_active` (`is_active`),
  KEY `idx_service_types_display_order` (`display_order`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='服务类型表';
CREATE TABLE IF NOT EXISTS `supplier_cost_history` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_id` char(36) NOT NULL COMMENT '关联服务ID',
  `supplier_id` char(36) NOT NULL COMMENT '关联服务提供方ID (可以是 organizations表 type=vendor 或 type=internal)',
  `delivery_type` enum('INTERNAL','VENDOR') NOT NULL COMMENT '交付类型: INTERNAL=内部交付, VENDOR=供应商交付',
  `version` int NOT NULL DEFAULT '1' COMMENT '版本号（同一服务提供方同一服务的版本号递增）',
  `cost_cny` decimal(18,2) DEFAULT '0.00' COMMENT '人民币成本价格',
  `cost_idr` decimal(18,2) DEFAULT '0.00' COMMENT '印尼盾成本价格',
  `effective_start_at` datetime NOT NULL COMMENT '生效开始时间',
  `effective_end_at` datetime DEFAULT NULL COMMENT '失效时间 (NULL代表当前一直有效)',
  `is_current` tinyint(1) DEFAULT '1' COMMENT '是否为当前最新成本价格',
  `notes` text COMMENT '备注说明（如：涨价原因、特殊条件、内部成本计算方式等）',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `ix_cost_lookup` (`product_id`,`supplier_id`,`is_current`),
  KEY `ix_cost_product` (`product_id`),
  KEY `ix_cost_supplier` (`supplier_id`),
  KEY `ix_cost_delivery_type` (`delivery_type`),
  KEY `ix_cost_effective` (`effective_start_at`,`effective_end_at`),
  KEY `ix_cost_version` (`product_id`,`supplier_id`,`version`),
  KEY `fk_cost_creator` (`created_by`),
  CONSTRAINT `fk_cost_creator` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_cost_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_cost_supplier` FOREIGN KEY (`supplier_id`) REFERENCES `organizations` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_cost_nonneg` CHECK (((coalesce(`cost_cny`,0) >= 0) and (coalesce(`cost_idr`,0) >= 0)))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='服务提供方成本历史表(版本控制，支持内部交付和供应商交付)';
CREATE TABLE IF NOT EXISTS `system_config` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `config_key` varchar(100) NOT NULL COMMENT '配置键（唯一索引）',
  `config_value` json NOT NULL COMMENT '配置值（JSON格式）',
  `config_type` varchar(50) NOT NULL COMMENT '配置类型: oss/ai/sms/email/system',
  `description` varchar(500) DEFAULT NULL COMMENT '配置描述',
  `is_enabled` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否启用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_config_key` (`config_key`),
  KEY `ix_config_type` (`config_type`),
  KEY `ix_config_enabled` (`is_enabled`),
  KEY `fk_config_created_by` (`created_by`),
  KEY `fk_config_updated_by` (`updated_by`),
  CONSTRAINT `fk_config_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_config_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='系统配置表';
CREATE TABLE IF NOT EXISTS `system_config_history` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `config_id` char(36) NOT NULL COMMENT '配置ID',
  `old_value` json DEFAULT NULL COMMENT '旧值（JSON格式）',
  `new_value` json NOT NULL COMMENT '新值（JSON格式）',
  `changed_by` char(36) NOT NULL COMMENT '变更人ID',
  `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '变更时间',
  `change_reason` varchar(500) DEFAULT NULL COMMENT '变更原因',
  PRIMARY KEY (`id`),
  KEY `ix_history_config_id` (`config_id`),
  KEY `ix_history_changed_at` (`changed_at` DESC),
  KEY `ix_history_changed_by` (`changed_by`),
  CONSTRAINT `fk_history_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_history_config` FOREIGN KEY (`config_id`) REFERENCES `system_config` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='系统配置历史表';
CREATE TABLE IF NOT EXISTS `temporary_links` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `link_token` varchar(255) NOT NULL COMMENT '链接令牌（唯一）',
  `resource_type` varchar(50) NOT NULL COMMENT '资源类型：service_account(服务账号), order(订单), customer(客户)',
  `resource_id` char(36) NOT NULL COMMENT '资源ID',
  `expires_at` datetime DEFAULT NULL COMMENT '过期时间',
  `max_access_count` int DEFAULT '1' COMMENT '最大访问次数',
  `current_access_count` int DEFAULT '0' COMMENT '当前访问次数',
  `is_active` tinyint(1) DEFAULT '1' COMMENT '是否激活',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `link_token` (`link_token`),
  UNIQUE KEY `ux_temporary_links_token` (`link_token`),
  KEY `ix_temporary_links_resource` (`resource_type`,`resource_id`),
  KEY `ix_temporary_links_active` (`is_active`),
  KEY `ix_temporary_links_expires` (`expires_at`),
  KEY `ix_temporary_links_created_by` (`created_by`),
  CONSTRAINT `temporary_links_ibfk_1` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `chk_temporary_links_current_access` CHECK ((`current_access_count` >= 0)),
  CONSTRAINT `chk_temporary_links_max_access` CHECK ((`max_access_count` > 0)),
  CONSTRAINT `chk_temporary_links_resource_type` CHECK ((`resource_type` in (_utf8mb4'service_account',_utf8mb4'order',_utf8mb4'customer')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='临时链接表';
CREATE TABLE IF NOT EXISTS `user_roles` (
  `user_id` char(36) NOT NULL,
  `role_id` char(36) NOT NULL,
  PRIMARY KEY (`user_id`,`role_id`),
  KEY `role_id` (`role_id`),
  CONSTRAINT `user_roles_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `user_roles_ibfk_2` FOREIGN KEY (`role_id`) REFERENCES `roles` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `users` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `username` varchar(255) NOT NULL,
  `email` varchar(255) NOT NULL,
  `phone` varchar(50) DEFAULT NULL,
  `display_name` varchar(255) DEFAULT NULL,
  `password_hash` varchar(255) DEFAULT NULL,
  `avatar_url` varchar(500) DEFAULT NULL,
  `bio` text,
  `gender` varchar(10) DEFAULT NULL,
  `address` text,
  `contact_phone` varchar(50) DEFAULT NULL,
  `whatsapp` varchar(50) DEFAULT NULL,
  `wechat` varchar(100) DEFAULT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  `is_locked` tinyint(1) NOT NULL DEFAULT '0' COMMENT 'æ˜¯å¦é”å®šï¼šFalse=æ­£å¸¸ï¼ˆé»˜è®¤ï¼‰ï¼ŒTrue=é”å®šï¼ˆç¦ç”¨ç™»å½•ï¼‰',
  `last_login_at` datetime DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `email` (`email`),
  UNIQUE KEY `ux_users_email` (`email`),
  KEY `ix_users_username` (`username`),
  KEY `ix_users_phone` (`phone`),
  KEY `ix_users_active` (`is_active`),
  KEY `ix_users_wechat` (`wechat`),
  KEY `ix_users_locked` (`is_locked`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
CREATE TABLE IF NOT EXISTS `vendor_product_financials` (
  `id` char(36) NOT NULL,
  `vendor_product_id` char(36) NOT NULL COMMENT '供应商产品关联ID',
  `order_id` char(36) DEFAULT NULL COMMENT '关联订单ID（如果有）（跨服务，无外键）',
  `cost_amount_idr` decimal(18,2) DEFAULT NULL COMMENT '成本金额（IDR）',
  `cost_amount_cny` decimal(18,2) DEFAULT NULL COMMENT '成本金额（CNY）',
  `exchange_rate` decimal(18,9) DEFAULT NULL COMMENT '汇率',
  `account_code` varchar(100) DEFAULT NULL COMMENT '会计科目代码',
  `cost_center` varchar(100) DEFAULT NULL COMMENT '成本中心',
  `expense_category` varchar(100) DEFAULT NULL COMMENT '费用类别',
  `department` varchar(100) DEFAULT NULL COMMENT '部门',
  `invoice_number` varchar(255) DEFAULT NULL COMMENT '发票号',
  `invoice_date` date DEFAULT NULL COMMENT '发票日期',
  `payment_status` varchar(50) NOT NULL DEFAULT 'pending' COMMENT '付款状态：pending, paid, cancelled, refunded',
  `payment_id` char(36) DEFAULT NULL COMMENT '关联付款记录ID（跨服务，无外键）',
  `is_approved` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否已审核',
  `approved_by` char(36) DEFAULT NULL COMMENT '审核人ID',
  `approved_at` datetime DEFAULT NULL COMMENT '审核时间',
  `approval_notes` text COMMENT '审核备注',
  `notes` text COMMENT '备注',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_vendor_product_id` (`vendor_product_id`),
  KEY `idx_order_id` (`order_id`),
  KEY `idx_invoice_number` (`invoice_number`),
  KEY `idx_payment_status` (`payment_status`),
  KEY `idx_payment_id` (`payment_id`),
  KEY `idx_is_approved` (`is_approved`),
  KEY `fk_vendor_product_financials_approved_by` (`approved_by`),
  KEY `fk_vendor_product_financials_created_by` (`created_by`),
  KEY `fk_vendor_product_financials_updated_by` (`updated_by`),
  CONSTRAINT `fk_vendor_product_financials_approved_by` FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_vendor_product_financials_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_vendor_product_financials_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_vendor_product_financials_vendor_product` FOREIGN KEY (`vendor_product_id`) REFERENCES `vendor_products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `chk_vendor_product_financials_amount_nonneg` CHECK (((coalesce(`cost_amount_idr`,0) >= 0) and (coalesce(`cost_amount_cny`,0) >= 0))),
  CONSTRAINT `chk_vendor_product_financials_payment_status` CHECK ((`payment_status` in (_utf8mb4'pending',_utf8mb4'paid',_utf8mb4'cancelled',_utf8mb4'refunded')))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='供应商产品财务记录表';
CREATE TABLE IF NOT EXISTS `vendor_product_price_history` (
  `id` char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT 'ä¸»é”®ID',
  `vendor_product_id` char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci NOT NULL COMMENT 'ä¾›åº”å•†äº§å“å…³è”ID',
  `old_price_cny` decimal(18,2) DEFAULT NULL COMMENT '旧价格（人民币）',
  `old_price_idr` decimal(18,2) DEFAULT NULL COMMENT '旧价格（印尼盾）',
  `new_price_cny` decimal(18,2) DEFAULT NULL COMMENT '新价格（人民币）',
  `new_price_idr` decimal(18,2) DEFAULT NULL COMMENT '新价格（印尼盾）',
  `old_price` decimal(18,2) DEFAULT NULL COMMENT 'æ—§ä»·æ ¼',
  `new_price` decimal(18,2) NOT NULL COMMENT 'æ–°ä»·æ ¼',
  `currency` varchar(3) NOT NULL DEFAULT 'IDR' COMMENT 'è´§å¸ç±»åž‹ï¼šIDR/CNY',
  `effective_from` datetime NOT NULL COMMENT 'ç”Ÿæ•ˆå¼€å§‹æ—¶é—´',
  `effective_to` datetime DEFAULT NULL COMMENT 'ç”Ÿæ•ˆç»“æŸæ—¶é—´ï¼ˆå¦‚æžœä¸ºNULLè¡¨ç¤ºå½“å‰æœ‰æ•ˆï¼‰',
  `change_reason` text COMMENT 'å˜æ›´åŽŸå› ',
  `changed_by` char(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci DEFAULT NULL COMMENT 'å˜æ›´äººID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_vendor_product_id` (`vendor_product_id`),
  KEY `idx_effective_from` (`effective_from`),
  KEY `idx_effective_to` (`effective_to`),
  KEY `fk_vendor_product_price_history_changed_by` (`changed_by`),
  CONSTRAINT `fk_vendor_product_price_history_changed_by` FOREIGN KEY (`changed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_vendor_product_price_history_vendor_product` FOREIGN KEY (`vendor_product_id`) REFERENCES `vendor_products` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='ä¾›åº”å•†äº§å“ä»·æ ¼åŽ†å²è¡¨';
CREATE TABLE IF NOT EXISTS `vendor_products` (
  `id` char(36) NOT NULL,
  `organization_id` char(36) NOT NULL COMMENT '供应商组织ID（跨服务，无外键）',
  `product_id` char(36) NOT NULL COMMENT '产品ID',
  `is_primary` tinyint(1) NOT NULL DEFAULT '0' COMMENT '是否主要供应商',
  `priority` int NOT NULL DEFAULT '0' COMMENT '优先级（数字越小优先级越高）',
  `cost_price_idr` decimal(18,2) DEFAULT NULL COMMENT '成本价（IDR）',
  `cost_price_cny` decimal(18,2) DEFAULT NULL COMMENT '成本价（CNY）',
  `exchange_rate` decimal(18,9) DEFAULT '2000.000000000' COMMENT '汇率',
  `min_quantity` int NOT NULL DEFAULT '1' COMMENT '最小订购量',
  `max_quantity` int DEFAULT NULL COMMENT '最大订购量',
  `lead_time_days` int DEFAULT NULL COMMENT '交货期（天数）',
  `processing_days` int DEFAULT NULL COMMENT '该组织处理该服务的天数',
  `is_available` tinyint(1) NOT NULL DEFAULT '1' COMMENT '是否可用',
  `availability_notes` text COMMENT '可用性说明',
  `available_from` datetime DEFAULT NULL COMMENT '可用开始时间',
  `available_to` datetime DEFAULT NULL COMMENT '可用结束时间',
  `account_code` varchar(100) DEFAULT NULL COMMENT '会计科目代码',
  `cost_center` varchar(100) DEFAULT NULL COMMENT '成本中心',
  `expense_category` varchar(100) DEFAULT NULL COMMENT '费用类别',
  `notes` text COMMENT '备注',
  `created_by` char(36) DEFAULT NULL COMMENT '创建人ID',
  `updated_by` char(36) DEFAULT NULL COMMENT '更新人ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_organization_product` (`organization_id`,`product_id`),
  KEY `idx_organization_id` (`organization_id`),
  KEY `idx_product_id` (`product_id`),
  KEY `idx_is_primary` (`is_primary`),
  KEY `idx_is_available` (`is_available`),
  KEY `fk_vendor_products_created_by` (`created_by`),
  KEY `fk_vendor_products_updated_by` (`updated_by`),
  CONSTRAINT `fk_vendor_products_created_by` FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
  CONSTRAINT `fk_vendor_products_product_id` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_vendor_products_updated_by` FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='供应商产品关联表';
SET @saved_cs_client     = @@character_set_client;
 1 AS `order_id`,
 1 AS `total_amount`,
 1 AS `long_term_amount`,
 1 AS `one_time_amount`,
 1 AS `received_amount`,
 1 AS `long_term_received`,
 1 AS `is_one_time_fully_paid`,
 1 AS `is_fully_paid_excluding_long`*/;
SET character_set_client = @saved_cs_client;

-- 重新启用外键检查
SET FOREIGN_KEY_CHECKS = 1;
