# 订单与工作流业务逻辑文档

## 一、核心业务需求

### 1.1 业务场景

#### 客户-服务-订单关系
1. **一个客户可以有多条服务记录**（service_records）
   - 客户可以提出多个服务需求
   - 每个服务需求对应一条服务记录

2. **一个服务记录可以生成多个订单**（orders）
   - 一个服务需求可能分多次下单
   - 例如：客户需要办理多个签证，可以分批次下单

3. **一个订单可以包含多个订单项**（order_items）
   - 一个订单可以包含多个服务项目
   - 例如：一个订单可以包含多个签证办理、公司注册等项目
   - 每个订单项对应一个产品/服务（product_id）

#### 订单总金额计算
- 订单总金额 = 所有订单项金额的汇总
- `total_amount = SUM(order_items.item_amount)`
- `final_amount = total_amount - discount_amount`（订单级折扣）

### 1.2 工作流场景

#### 订单审批流程
1. **订单提交**（submitted）
   - 销售创建订单并提交
   - 订单状态自动变为 "已提交"

2. **订单审批**（approved）
   - 经理审核订单
   - 可以批准或拒绝

3. **订单分配**（assigned）
   - 审批通过后，分配给做单人员（operation）
   - 创建订单阶段（order_stages）

4. **订单处理**（processing）
   - 做单人员按阶段处理订单
   - 每个阶段可以上传文件、添加评论

5. **订单完成**（completed）
   - 所有阶段完成后，订单状态变为 "已完成"

### 1.3 双语支持场景

#### 中印尼双语员工
- 系统需要支持中印尼双语显示
- 所有展示字段（名称、描述、任务名称等）需要支持双语
- 用户可以通过 `lang` 参数选择显示语言（zh/id）

## 二、核心业务规则

### 2.1 订单管理规则

#### 订单创建规则
1. 订单必须关联一个客户（customer_id）
2. 订单可以关联一个服务记录（service_record_id，可选）
3. 订单必须包含至少一个订单项（order_items）
4. 订单总金额从订单项汇总计算
5. 订单号（order_number）必须唯一

#### 订单项规则
1. 每个订单项对应一个产品/服务（product_id）
2. 订单项金额 = quantity * unit_price - discount_amount
3. 每个订单项可以独立管理状态（pending, in_progress, completed, cancelled）
4. 订单项支持双语名称和描述

#### 订单状态流转规则
1. 订单创建时，状态为 "submitted"（已提交）
2. 审批通过后，状态变为 "approved"（已审批）
3. 分配后，状态变为 "assigned"（已分配）
4. 开始处理后，状态变为 "processing"（处理中）
5. 完成后，状态变为 "completed"（已完成）
6. 可以取消订单，状态变为 "cancelled"（已取消）

### 2.2 工作流规则

#### 工作流定义规则
1. 工作流定义使用 JSON 格式存储（definition_json）
2. 工作流定义包含完整的双语信息（name_zh, name_id）
3. 工作流定义包含阶段列表（stages）和流转规则（transitions）
4. 每个阶段可以配置任务类型（user_task, service_task, script_task）

#### 工作流实例规则
1. 创建订单时，可以启动工作流实例
2. 工作流实例关联到订单（business_type='order', business_id=order_id）
3. 工作流实例根据定义自动流转
4. 每个阶段可以创建任务（workflow_tasks）

#### 任务分配规则
1. 任务可以分配给用户（assigned_to_user_id）
2. 任务可以分配给角色（assigned_to_role_id）
3. 任务完成后，工作流自动流转到下一阶段
4. 任务支持双语名称（task_name_zh, task_name_id）

### 2.3 订单评论规则

#### 评论类型
1. **普通评论**（general）：所有用户可见
2. **内部评论**（internal）：客户不可见，仅内部人员可见
3. **客户评论**（customer）：客户添加的评论
4. **系统评论**（system）：系统自动生成的评论

#### 评论功能
1. 支持回复评论（replied_to_comment_id）
2. 支持置顶评论（is_pinned）
3. 评论可以关联到订单阶段（order_stage_id）
4. 评论内容支持双语（content_zh, content_id）

### 2.4 订单文件规则

#### 文件分类
1. **护照**（passport）：护照相关文件
2. **签证**（visa）：签证相关文件
3. **文档**（document）：其他文档
4. **其他**（other）：其他类型文件

#### 文件关联
1. 文件可以关联到订单（order_id）
2. 文件可以关联到订单项（order_item_id）- 不同订单项可以上传不同文件
3. 文件可以关联到订单阶段（order_stage_id）- 不同步骤上传不同文件

#### 文件验证
1. 文件可以标记为必需文件（is_required）
2. 文件可以验证（is_verified, verified_by, verified_at）
3. 文件存储使用 MinIO 对象存储

### 2.5 订单阶段规则

#### 阶段创建
1. 订单分配后，根据工作流定义创建订单阶段
2. 每个阶段有阶段序号（stage_order）
3. 每个阶段可以分配给用户（assigned_to_user_id）

#### 阶段状态
1. **pending**：待处理
2. **in_progress**：进行中
3. **completed**：已完成
4. **cancelled**：已取消

#### 阶段进度
1. 阶段进度（progress_percent）：0-100
2. 阶段可以添加备注（notes）
3. 阶段完成时间（completed_at）

## 三、业务流程

### 3.1 订单创建流程

```
1. 销售创建订单
   ├── 填写订单基本信息（客户、标题等）
   ├── 添加订单项（产品、数量、单价等）
   └── 提交订单

2. 系统处理
   ├── 生成订单号（order_number）
   ├── 计算订单总金额（从订单项汇总）
   ├── 设置订单状态为 "submitted"
   └── 可选：启动工作流实例

3. 订单审批
   ├── 经理查看待审批订单
   ├── 审批通过/拒绝
   └── 审批通过后，状态变为 "approved"
```

### 3.2 订单分配流程

```
1. 订单审批通过后
   ├── 查看待分配订单
   └── 分配给做单人员（operation）

2. 系统处理
   ├── 创建订单分配记录（order_assignments）
   ├── 设置订单状态为 "assigned"
   └── 根据工作流定义创建订单阶段（order_stages）
```

### 3.3 订单处理流程

```
1. 做单人员接单
   ├── 查看分配给自己的订单
   └── 开始处理订单

2. 按阶段处理
   ├── 开始阶段（status = 'in_progress'）
   ├── 上传文件（order_files）
   ├── 添加评论（order_comments）
   ├── 更新阶段进度（progress_percent）
   └── 完成阶段（status = 'completed'）

3. 订单完成
   ├── 所有阶段完成后
   ├── 订单状态变为 "completed"
   └── 工作流实例完成
```

### 3.4 工作流流转流程

```
1. 工作流启动
   ├── 创建工作流实例（workflow_instances）
   ├── 设置当前阶段（current_stage）
   └── 创建初始任务（workflow_tasks）

2. 任务处理
   ├── 用户查看待办任务
   ├── 处理任务（上传文件、添加评论等）
   └── 完成任务

3. 自动流转
   ├── 任务完成后，检查流转条件
   ├── 满足条件后，流转到下一阶段
   └── 创建新阶段的任务
```

## 四、数据验证规则

### 4.1 订单验证
- 订单号必须唯一
- 订单必须关联客户
- 订单必须包含至少一个订单项
- 订单总金额必须 >= 0
- 订单折扣金额必须 >= 0

### 4.2 订单项验证
- 订单项数量必须 > 0
- 订单项单价必须 >= 0
- 订单项折扣金额必须 >= 0
- 订单项金额必须 >= 0
- 订单项序号必须唯一（在同一订单内）

### 4.3 工作流验证
- 工作流定义代码必须唯一
- 工作流定义必须包含至少一个阶段
- 工作流实例必须关联业务对象（订单或服务记录）
- 任务必须分配给用户或角色

### 4.4 文件验证
- 文件大小必须 >= 0
- 文件必须关联订单
- 文件路径和 URL 必须有效

## 五、特殊业务场景

### 5.1 EVOA_VISA 数据导入
- 从 EVOA_VISA.xlsx 导入数据到 orders 表
- 字段映射：
  - 记录ID → id_external
  - Customer Name → customer_name
  - Entry city → entry_city
  - Passport ID → passport_id
  - Payment amount → total_amount
  - Processor → processor

### 5.2 订单关联服务记录
- 订单可以关联服务记录（service_record_id）
- 一个服务记录可以生成多个订单
- 订单和服务记录可以独立管理

### 5.3 订单项独立管理
- 每个订单项可以独立管理状态
- 不同订单项可以有不同的处理进度
- 订单项可以独立上传文件

### 5.4 双语显示
- 所有展示字段支持中印尼双语
- 用户通过 `lang` 参数选择显示语言
- 默认语言为中文（zh）

## 六、性能优化

### 6.1 数据库优化
- 订单项表创建索引（order_id, product_id, status）
- 订单文件表创建索引（order_id, order_item_id, order_stage_id）
- 订单评论表创建索引（order_id, order_stage_id, created_at）

### 6.2 查询优化
- 订单列表查询时，使用分页
- 订单详情查询时，使用 JOIN 查询订单项
- 文件列表查询时，支持按阶段、订单项筛选

### 6.3 缓存策略
- 工作流定义可以缓存（不经常变化）
- 订单状态列表可以缓存
- 文件 URL 可以缓存

## 七、错误处理

### 7.1 订单错误
- 订单不存在：返回 404
- 订单状态不允许操作：返回 400
- 订单金额计算错误：返回 500

### 7.2 工作流错误
- 工作流定义不存在：返回 404
- 工作流实例状态不允许操作：返回 400
- 工作流流转条件不满足：返回 400

### 7.3 文件错误
- 文件不存在：返回 404
- 文件上传失败：返回 500
- 文件大小超限：返回 400


