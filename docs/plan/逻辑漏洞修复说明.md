# é€»è¾‘æ¼æ´ä¿®å¤è¯´æ˜

**ä¿®å¤æ—¥æœŸ**: 2024-12-13  
**ä¿®å¤æ–‡ä»¶**: `init-scripts/migrations/create_service_vendor_management_tables.sql`

---

## âœ… å·²ä¿®å¤çš„æ¼æ´

### 1. product_price_list å”¯ä¸€ç´¢å¼•ä¼˜åŒ–

**ä¿®å¤å†…å®¹**:
- æ·»åŠ è§¦å‘å™¨ç¡®ä¿ä¸€ä¸ªäº§å“åªæœ‰ä¸€ä¸ª `is_active=1` çš„è®°å½•
- è§¦å‘å™¨åœ¨ INSERT å’Œ UPDATE æ—¶æ£€æŸ¥

**è§¦å‘å™¨**:
- `trg_product_price_list_single_active` (INSERT)
- `trg_product_price_list_single_active_update` (UPDATE)

---

### 2. order_items delivery_type ä¸€è‡´æ€§æ£€æŸ¥

**ä¿®å¤å†…å®¹**:
- æ·»åŠ è§¦å‘å™¨æ£€æŸ¥ `delivery_type` ä¸ `supplier_id` å¯¹åº”çš„ `organization_type` æ˜¯å¦åŒ¹é…
- vendor -> VENDOR
- internal -> INTERNAL

**è§¦å‘å™¨**:
- `trg_order_items_check_delivery_type_insert` (INSERT)
- `trg_order_items_check_delivery_type_update` (UPDATE)

---

### 3. order_items æˆæœ¬å¿«ç…§è‡ªåŠ¨åŒæ­¥

**ä¿®å¤å†…å®¹**:
- æ·»åŠ è§¦å‘å™¨è‡ªåŠ¨åŒæ­¥ `snapshot_cost_cny/idr` ä¸ `supplier_cost_history_id`
- å½“ `supplier_cost_history_id` æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æˆæœ¬å¿«ç…§

**è§¦å‘å™¨**:
- `trg_order_items_sync_cost_snapshot_insert` (INSERT)
- `trg_order_items_sync_cost_snapshot_update` (UPDATE)

---

### 4. order_stages order_item_id ä¸€è‡´æ€§æ£€æŸ¥

**ä¿®å¤å†…å®¹**:
- æ·»åŠ è§¦å‘å™¨æ£€æŸ¥ `order_item_id` å¯¹åº”çš„ `order_id` æ˜¯å¦ä¸ `order_stages.order_id` ä¸€è‡´

**è§¦å‘å™¨**:
- `trg_order_stages_check_order_item_insert` (INSERT)
- `trg_order_stages_check_order_item_update` (UPDATE)

---

### 5. service_stage_templates é˜¶æ®µé¡ºåºå”¯ä¸€æ€§

**ä¿®å¤å†…å®¹**:
- æ·»åŠ å”¯ä¸€ç´¢å¼•ç¡®ä¿åŒä¸€äº§å“çš„é˜¶æ®µé¡ºåºä¸é‡å¤
- `UNIQUE KEY ux_stage_product_order (product_id, stage_order)`

---

### 6. biz_expense_records æŠ¥é”€å•å·è‡ªåŠ¨ç”Ÿæˆ

**ä¿®å¤å†…å®¹**:
- æ·»åŠ è§¦å‘å™¨è‡ªåŠ¨ç”ŸæˆæŠ¥é”€å•å·
- æ ¼å¼ï¼š`EXP-YYYYMMDD-001`ï¼ˆæ¯å¤©ä»001å¼€å§‹ï¼‰

**è§¦å‘å™¨**:
- `trg_biz_expense_records_generate_no` (INSERT)

---

### 7. ä»·æ ¼æŸ¥è¯¢é€»è¾‘ä¼˜åŒ–

**ä¿®å¤å†…å®¹**:
- æ·»åŠ  `effective_from <= NOW()` æ£€æŸ¥
- ç¡®ä¿ä¸è¿”å›å°šæœªç”Ÿæ•ˆçš„ä»·æ ¼

---

### 8. æˆæœ¬ä»·æ ¼ç‰ˆæœ¬æ›´æ–°é€»è¾‘ä¼˜åŒ–

**ä¿®å¤å†…å®¹**:
- ä½¿ç”¨äº‹åŠ¡å’Œ `FOR UPDATE` é”é˜²æ­¢å¹¶å‘é—®é¢˜
- å…³é—­æ‰€æœ‰æ—§ç‰ˆæœ¬ï¼ˆä¸ä»…ä»…æ˜¯å½“å‰ç‰ˆæœ¬ï¼‰ï¼Œé˜²æ­¢æ—¶é—´æ®µé‡å 

---

## âš ï¸ éœ€è¦åœ¨åº”ç”¨å±‚ä¿è¯çš„é€»è¾‘

### 1. supplier_cost_history ç‰ˆæœ¬å·ç”Ÿæˆ

**è¯´æ˜**: è™½ç„¶SQLè„šæœ¬ä¸­æä¾›äº†äº‹åŠ¡ç¤ºä¾‹ï¼Œä½†å®é™…åº”ç”¨ä¸­å»ºè®®ï¼š
- åœ¨åº”ç”¨å±‚ä½¿ç”¨äº‹åŠ¡
- ä½¿ç”¨ `SELECT ... FOR UPDATE` åŠ é”
- æˆ–è€…ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼ˆå¦‚æœå¤šå®ä¾‹éƒ¨ç½²ï¼‰

### 2. product_price_list ä»·æ ¼æ›´æ–°æµç¨‹

**è¯´æ˜**: 
- æ›´æ–°ä»·æ ¼æ—¶ï¼Œå»ºè®®å…ˆåˆ›å»ºæ–°è®°å½•ï¼ˆ`is_active=0`ï¼‰ï¼Œå®¡æ‰¹é€šè¿‡åå†æ¿€æ´»
- æˆ–è€…ç›´æ¥æ›´æ–°ç°æœ‰è®°å½•ï¼Œä¿ç•™å†å²ç‰ˆæœ¬åˆ° `product_price_history` è¡¨

### 3. service_stage_templates é˜¶æ®µé¡ºåºè¿ç»­æ€§

**è¯´æ˜**:
- å”¯ä¸€ç´¢å¼•åªä¿è¯ä¸é‡å¤ï¼Œä¸ä¿è¯è¿ç»­æ€§
- éœ€è¦åœ¨åº”ç”¨å±‚æ£€æŸ¥ï¼šé˜¶æ®µé¡ºåºå¿…é¡»ä»1å¼€å§‹è¿ç»­ï¼ˆ1, 2, 3, 4...ï¼‰

---

## ğŸ“ æµ‹è¯•å»ºè®®

### 1. è§¦å‘å™¨æµ‹è¯•

```sql
-- æµ‹è¯•1ï¼šproduct_price_list å”¯ä¸€æ€§
INSERT INTO product_price_list (product_id, is_active, ...) VALUES ('product1', 1, ...);
INSERT INTO product_price_list (product_id, is_active, ...) VALUES ('product1', 1, ...);  -- åº”è¯¥å¤±è´¥

-- æµ‹è¯•2ï¼šdelivery_type ä¸€è‡´æ€§
INSERT INTO order_items (selected_supplier_id, delivery_type, ...) 
VALUES ('vendor_id', 'INTERNAL', ...);  -- åº”è¯¥å¤±è´¥

-- æµ‹è¯•3ï¼šæˆæœ¬å¿«ç…§åŒæ­¥
INSERT INTO order_items (supplier_cost_history_id, ...) 
VALUES ('cost_history_id', ...);
-- æ£€æŸ¥ snapshot_cost_cny æ˜¯å¦è‡ªåŠ¨å¡«å……

-- æµ‹è¯•4ï¼šorder_stages ä¸€è‡´æ€§
INSERT INTO order_stages (order_id, order_item_id, ...) 
VALUES ('order1', 'item_from_order2', ...);  -- åº”è¯¥å¤±è´¥

-- æµ‹è¯•5ï¼šæŠ¥é”€å•å·ç”Ÿæˆ
INSERT INTO biz_expense_records (applicant_id, amount, ...) 
VALUES ('user1', 100, ...);
-- æ£€æŸ¥ expense_no æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ
```

### 2. å¹¶å‘æµ‹è¯•

```sql
-- æµ‹è¯• supplier_cost_history ç‰ˆæœ¬å·å¹¶å‘
-- åœ¨ä¸¤ä¸ªä¼šè¯ä¸­åŒæ—¶æ‰§è¡Œï¼š
BEGIN;
SELECT MAX(version) INTO @v FROM supplier_cost_history WHERE product_id=? AND supplier_id=? FOR UPDATE;
INSERT INTO supplier_cost_history (..., version, ...) VALUES (..., @v+1, ...);
COMMIT;
```

---

## ğŸ” å…¶ä»–æ½œåœ¨é—®é¢˜

### 1. æ–‡ä»¶åˆ é™¤æ—¶çš„OSSæ¸…ç†

**é—®é¢˜**: åˆ é™¤ `file_storage` è®°å½•æ—¶ï¼ŒOSSä¸­çš„æ–‡ä»¶å¯èƒ½æ²¡æœ‰è¢«åˆ é™¤

**å»ºè®®**: 
- æ·»åŠ è§¦å‘å™¨æˆ–åº”ç”¨å±‚é€»è¾‘ï¼Œåˆ é™¤è®°å½•æ—¶åŒæ—¶åˆ é™¤OSSæ–‡ä»¶
- æˆ–è€…ä½¿ç”¨è½¯åˆ é™¤ï¼Œå®šæœŸæ¸…ç†

### 2. è®¢å•é¡¹çŠ¶æ€å˜æ›´æ—¶çš„æˆæœ¬å¿«ç…§ä¿æŠ¤

**é—®é¢˜**: è®¢å•å®Œæˆåï¼Œå¦‚æœä¿®æ”¹ `supplier_cost_history_id`ï¼Œæˆæœ¬å¿«ç…§ä¼šè¢«æ›´æ–°

**å»ºè®®**:
- æ·»åŠ æ£€æŸ¥ï¼šå¦‚æœè®¢å•é¡¹çŠ¶æ€ä¸º `completed`ï¼Œç¦æ­¢ä¿®æ”¹æˆæœ¬ç›¸å…³å­—æ®µ

### 3. ä»·æ ¼ç”Ÿæ•ˆæ—¶é—´çš„è¾¹ç•Œæƒ…å†µ

**é—®é¢˜**: `effective_from` å’Œ `effective_to` éƒ½æ˜¯ DATETIMEï¼Œéœ€è¦è€ƒè™‘æ—¶åŒº

**å»ºè®®**:
- ç»Ÿä¸€ä½¿ç”¨ UTC æ—¶é—´
- æˆ–è€…åœ¨åº”ç”¨å±‚å¤„ç†æ—¶åŒºè½¬æ¢

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] product_price_list å”¯ä¸€ç´¢å¼•ä¿®å¤
- [x] delivery_type ä¸€è‡´æ€§æ£€æŸ¥è§¦å‘å™¨
- [x] æˆæœ¬å¿«ç…§è‡ªåŠ¨åŒæ­¥è§¦å‘å™¨
- [x] order_stages ä¸€è‡´æ€§æ£€æŸ¥è§¦å‘å™¨
- [x] service_stage_templates å”¯ä¸€çº¦æŸ
- [x] æŠ¥é”€å•å·è‡ªåŠ¨ç”Ÿæˆè§¦å‘å™¨
- [x] ä»·æ ¼æŸ¥è¯¢é€»è¾‘ä¼˜åŒ–ï¼ˆæ·»åŠ  effective_from æ£€æŸ¥ï¼‰
- [x] æˆæœ¬ä»·æ ¼ç‰ˆæœ¬æ›´æ–°é€»è¾‘ä¼˜åŒ–ï¼ˆäº‹åŠ¡+é”ï¼‰
- [ ] åº”ç”¨å±‚ç‰ˆæœ¬å·ç”Ÿæˆé€»è¾‘ï¼ˆéœ€è¦åœ¨ä»£ç ä¸­å®ç°ï¼‰
- [ ] åº”ç”¨å±‚é˜¶æ®µé¡ºåºè¿ç»­æ€§æ£€æŸ¥ï¼ˆéœ€è¦åœ¨ä»£ç ä¸­å®ç°ï¼‰
- [ ] æ–‡ä»¶åˆ é™¤æ—¶çš„OSSæ¸…ç†é€»è¾‘ï¼ˆéœ€è¦åœ¨ä»£ç ä¸­å®ç°ï¼‰
