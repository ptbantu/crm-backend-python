# 多币种多供应商多价格需求 - 数据库结构分析

## 一、需求概述

支持以下功能：
1. **多币种**：产品价格可以支持多种货币（IDR、CNY、USD等）
2. **多供应商**：同一产品可以有多个供应商提供，每个供应商有不同的价格
3. **多价格**：同一产品在不同供应商、不同币种下可以有多个价格类型（成本价、渠道价、直客价、列表价等）

## 二、当前数据库结构分析

### 2.1 Products表结构（关键字段）

```sql
CREATE TABLE `products` (
  `id` char(36) NOT NULL,
  `vendor_id` char(36) DEFAULT NULL,  -- 只能关联一个供应商
  `price_list` decimal(18,2) DEFAULT NULL,
  `price_channel` decimal(18,2) DEFAULT NULL,
  `price_cost` decimal(18,2) DEFAULT NULL,
  
  -- 硬编码的IDR和CNY价格字段
  `price_cost_idr` decimal(18,2) DEFAULT NULL COMMENT '成本价（IDR）',
  `price_cost_cny` decimal(18,2) DEFAULT NULL COMMENT '成本价（CNY）',
  `price_channel_idr` decimal(18,2) DEFAULT NULL COMMENT '渠道价（IDR）',
  `price_channel_cny` decimal(18,2) DEFAULT NULL COMMENT '渠道价（CNY）',
  `price_direct_idr` decimal(18,2) DEFAULT NULL COMMENT '直客价（IDR）',
  `price_direct_cny` decimal(18,2) DEFAULT NULL COMMENT '直客价（CNY）',
  `price_list_idr` decimal(18,2) DEFAULT NULL COMMENT '列表价（IDR）',
  `price_list_cny` decimal(18,2) DEFAULT NULL COMMENT '列表价（CNY）',
  
  `default_currency` varchar(10) DEFAULT 'IDR' COMMENT '默认货币',
  `exchange_rate` decimal(18,9) DEFAULT '2000.000000000' COMMENT '汇率（IDR/CNY）',
  ...
)
```

### 2.2 Orders表结构（关键字段）

```sql
CREATE TABLE `orders` (
  `id` char(36) NOT NULL,
  `currency_code` varchar(10) DEFAULT 'CNY',  -- 订单级货币
  `exchange_rate` decimal(18,6) DEFAULT NULL COMMENT '汇率',
  ...
)
```

### 2.3 Order_items表结构（关键字段）

```sql
CREATE TABLE `order_items` (
  `id` char(36) NOT NULL,
  `order_id` char(36) NOT NULL,
  `product_id` char(36) DEFAULT NULL,
  `unit_price` decimal(18,2) DEFAULT NULL,
  `currency_code` varchar(10) DEFAULT 'CNY' COMMENT '货币代码',
  ...
)
```

### 2.4 Organizations表结构（供应商）

```sql
CREATE TABLE `organizations` (
  `id` char(36) NOT NULL,
  `organization_type` varchar(50) NOT NULL,  -- 'vendor', 'agent', 'internal'
  ...
)
```

## 三、当前结构存在的问题

### 3.1 多币种支持问题

**问题1：硬编码币种字段**
- ❌ 当前使用硬编码字段（`price_cost_idr`, `price_cost_cny`等）
- ❌ 添加新币种需要修改表结构（如USD需要添加`price_cost_usd`等）
- ❌ 无法动态支持新币种

**问题2：汇率管理不完善**
- ⚠️ 只有IDR/CNY的固定汇率字段
- ❌ 没有币种基础数据表
- ❌ 没有汇率历史记录表

**问题3：订单币种支持有限**
- ⚠️ 订单和订单项有`currency_code`字段，但产品价格是硬编码的
- ❌ 无法灵活选择币种

### 3.2 多供应商支持问题

**问题1：产品只能关联一个供应商**
- ❌ `products.vendor_id`只能关联一个供应商
- ❌ 同一产品无法由多个供应商提供
- ❌ 无法比较不同供应商的价格

**问题2：供应商价格无法区分**
- ❌ 无法记录同一产品在不同供应商下的不同价格
- ❌ 无法管理供应商优先级

### 3.3 多价格支持问题

**问题1：价格类型硬编码**
- ⚠️ 有4种价格类型（cost、channel、direct、list）
- ⚠️ 但每种类型都硬编码了IDR和CNY两个版本
- ❌ 无法灵活扩展价格类型

**问题2：价格与供应商、币种耦合**
- ❌ 价格直接存储在products表中
- ❌ 无法实现"产品+供应商+币种+价格类型"的组合

**问题3：价格历史记录缺失**
- ❌ 没有价格变更历史
- ❌ 无法追溯价格变化

## 四、需求满足度评估

| 需求项 | 当前支持情况 | 满足度 |
|--------|------------|--------|
| 多币种（IDR、CNY） | 部分支持（硬编码字段） | ⚠️ 60% |
| 多币种（动态扩展） | 不支持 | ❌ 0% |
| 多供应商（同一产品） | 不支持 | ❌ 0% |
| 多价格类型 | 部分支持（4种类型） | ⚠️ 70% |
| 供应商+币种+价格组合 | 不支持 | ❌ 0% |
| 价格历史记录 | 不支持 | ❌ 0% |
| 汇率管理 | 部分支持（固定汇率） | ⚠️ 30% |

**总体满足度：约 30%**

## 五、建议的数据库结构改进方案

### 5.1 新增表结构

#### 1. 币种表（currencies）
```sql
CREATE TABLE `currencies` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(10) NOT NULL COMMENT '币种代码（ISO 4217）',
  `name` varchar(100) NOT NULL COMMENT '币种名称',
  `symbol` varchar(10) DEFAULT NULL COMMENT '货币符号',
  `is_active` tinyint(1) DEFAULT '1',
  `display_order` int DEFAULT '0',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_currencies_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='币种表';
```

#### 2. 汇率表（exchange_rates）
```sql
CREATE TABLE `exchange_rates` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `from_currency_code` varchar(10) NOT NULL COMMENT '源币种',
  `to_currency_code` varchar(10) NOT NULL COMMENT '目标币种',
  `rate` decimal(18,9) NOT NULL COMMENT '汇率',
  `effective_date` date NOT NULL COMMENT '生效日期',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_exchange_rates_currency_date` (`from_currency_code`, `to_currency_code`, `effective_date`),
  KEY `ix_exchange_rates_from_currency` (`from_currency_code`),
  KEY `ix_exchange_rates_to_currency` (`to_currency_code`),
  KEY `ix_exchange_rates_effective_date` (`effective_date` DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='汇率表';
```

#### 3. 价格类型表（price_types）
```sql
CREATE TABLE `price_types` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `code` varchar(50) NOT NULL COMMENT '价格类型代码',
  `name` varchar(100) NOT NULL COMMENT '价格类型名称',
  `description` text COMMENT '描述',
  `display_order` int DEFAULT '0',
  `is_active` tinyint(1) DEFAULT '1',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_price_types_code` (`code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='价格类型表';
```

#### 4. 产品供应商价格表（product_vendor_prices）- 核心表
```sql
CREATE TABLE `product_vendor_prices` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_id` char(36) NOT NULL COMMENT '产品ID',
  `vendor_id` char(36) NOT NULL COMMENT '供应商ID',
  `price_type_id` char(36) NOT NULL COMMENT '价格类型ID',
  `currency_code` varchar(10) NOT NULL COMMENT '币种代码',
  `price` decimal(18,2) NOT NULL COMMENT '价格',
  `is_default` tinyint(1) DEFAULT '0' COMMENT '是否为默认价格',
  `priority` int DEFAULT '0' COMMENT '优先级（用于多供应商排序）',
  `valid_from` date DEFAULT NULL COMMENT '生效日期',
  `valid_to` date DEFAULT NULL COMMENT '失效日期',
  `is_active` tinyint(1) DEFAULT '1',
  `created_by` char(36) DEFAULT NULL,
  `updated_by` char(36) DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_product_vendor_price` (`product_id`, `vendor_id`, `price_type_id`, `currency_code`, `valid_from`),
  KEY `ix_product_vendor_prices_product` (`product_id`),
  KEY `ix_product_vendor_prices_vendor` (`vendor_id`),
  KEY `ix_product_vendor_prices_price_type` (`price_type_id`),
  KEY `ix_product_vendor_prices_currency` (`currency_code`),
  KEY `ix_product_vendor_prices_active` (`is_active`, `valid_from`, `valid_to`),
  CONSTRAINT `fk_product_vendor_prices_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_product_vendor_prices_vendor` FOREIGN KEY (`vendor_id`) REFERENCES `organizations` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_product_vendor_prices_price_type` FOREIGN KEY (`price_type_id`) REFERENCES `price_types` (`id`) ON DELETE RESTRICT,
  CONSTRAINT `fk_product_vendor_prices_currency` FOREIGN KEY (`currency_code`) REFERENCES `currencies` (`code`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='产品供应商价格表（支持多供应商、多币种、多价格类型）';
```

#### 5. 价格历史表（product_price_history）
```sql
CREATE TABLE `product_price_history` (
  `id` char(36) NOT NULL DEFAULT (uuid()),
  `product_vendor_price_id` char(36) NOT NULL COMMENT '产品供应商价格ID',
  `old_price` decimal(18,2) DEFAULT NULL COMMENT '旧价格',
  `new_price` decimal(18,2) NOT NULL COMMENT '新价格',
  `currency_code` varchar(10) NOT NULL COMMENT '币种代码',
  `change_reason` text COMMENT '变更原因',
  `changed_by` char(36) DEFAULT NULL COMMENT '变更人',
  `changed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '变更时间',
  PRIMARY KEY (`id`),
  KEY `ix_price_history_product_vendor_price` (`product_vendor_price_id`),
  KEY `ix_price_history_changed_at` (`changed_at` DESC),
  CONSTRAINT `fk_price_history_product_vendor_price` FOREIGN KEY (`product_vendor_price_id`) REFERENCES `product_vendor_prices` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='价格历史记录表';
```

### 5.2 修改现有表结构

#### 1. Products表修改
```sql
-- 保留vendor_id作为默认供应商（向后兼容）
-- 移除硬编码的价格字段（或标记为deprecated）
-- 添加默认币种字段
ALTER TABLE `products` 
  ADD COLUMN `default_currency_code` varchar(10) DEFAULT 'IDR' COMMENT '默认币种代码',
  ADD CONSTRAINT `fk_products_default_currency` FOREIGN KEY (`default_currency_code`) REFERENCES `currencies` (`code`);
```

#### 2. Orders表修改
```sql
-- 添加汇率关联
ALTER TABLE `orders`
  ADD COLUMN `exchange_rate_id` char(36) DEFAULT NULL COMMENT '使用的汇率ID',
  ADD CONSTRAINT `fk_orders_exchange_rate` FOREIGN KEY (`exchange_rate_id`) REFERENCES `exchange_rates` (`id`);
```

#### 3. Order_items表修改
```sql
-- 添加供应商和价格类型关联
ALTER TABLE `order_items`
  ADD COLUMN `vendor_id` char(36) DEFAULT NULL COMMENT '使用的供应商ID',
  ADD COLUMN `price_type_id` char(36) DEFAULT NULL COMMENT '使用的价格类型ID',
  ADD COLUMN `product_vendor_price_id` char(36) DEFAULT NULL COMMENT '使用的产品供应商价格ID（快照）',
  ADD CONSTRAINT `fk_order_items_vendor` FOREIGN KEY (`vendor_id`) REFERENCES `organizations` (`id`),
  ADD CONSTRAINT `fk_order_items_price_type` FOREIGN KEY (`price_type_id`) REFERENCES `price_types` (`id`);
```

## 六、数据迁移建议

### 6.1 迁移步骤

1. **创建新表**
   - 创建currencies表并初始化数据（IDR、CNY、USD等）
   - 创建exchange_rates表并初始化汇率
   - 创建price_types表并初始化数据（cost、channel、direct、list）
   - 创建product_vendor_prices表
   - 创建product_price_history表

2. **数据迁移**
   ```sql
   -- 迁移products表中的价格数据到product_vendor_prices表
   INSERT INTO product_vendor_prices (product_id, vendor_id, price_type_id, currency_code, price, is_default)
   SELECT 
     p.id as product_id,
     p.vendor_id,
     pt.id as price_type_id,
     'IDR' as currency_code,
     CASE pt.code
       WHEN 'cost' THEN p.price_cost_idr
       WHEN 'channel' THEN p.price_channel_idr
       WHEN 'direct' THEN p.price_direct_idr
       WHEN 'list' THEN p.price_list_idr
     END as price,
     1 as is_default
   FROM products p
   CROSS JOIN price_types pt
   WHERE p.vendor_id IS NOT NULL
     AND CASE pt.code
       WHEN 'cost' THEN p.price_cost_idr IS NOT NULL
       WHEN 'channel' THEN p.price_channel_idr IS NOT NULL
       WHEN 'direct' THEN p.price_direct_idr IS NOT NULL
       WHEN 'list' THEN p.price_list_idr IS NOT NULL
     END;
   
   -- 同样迁移CNY价格
   INSERT INTO product_vendor_prices (product_id, vendor_id, price_type_id, currency_code, price, is_default)
   SELECT 
     p.id as product_id,
     p.vendor_id,
     pt.id as price_type_id,
     'CNY' as currency_code,
     CASE pt.code
       WHEN 'cost' THEN p.price_cost_cny
       WHEN 'channel' THEN p.price_channel_cny
       WHEN 'direct' THEN p.price_direct_cny
       WHEN 'list' THEN p.price_list_cny
     END as price,
     1 as is_default
   FROM products p
   CROSS JOIN price_types pt
   WHERE p.vendor_id IS NOT NULL
     AND CASE pt.code
       WHEN 'cost' THEN p.price_cost_cny IS NOT NULL
       WHEN 'channel' THEN p.price_channel_cny IS NOT NULL
       WHEN 'direct' THEN p.price_direct_cny IS NOT NULL
       WHEN 'list' THEN p.price_list_cny IS NOT NULL
     END;
   ```

3. **向后兼容处理**
   - 保留products表中的旧字段（标记为deprecated）
   - 创建视图或函数提供向后兼容的查询接口
   - 逐步迁移应用代码使用新表结构

## 七、改进后的优势

### 7.1 多币种支持
✅ 动态添加新币种，无需修改表结构
✅ 支持任意币种组合的汇率
✅ 汇率历史记录，支持汇率追溯

### 7.2 多供应商支持
✅ 同一产品可以有多个供应商
✅ 每个供应商可以有独立的价格
✅ 支持供应商优先级排序

### 7.3 多价格支持
✅ 灵活的价格类型管理
✅ 产品+供应商+币种+价格类型的完整组合
✅ 价格有效期管理
✅ 价格变更历史记录

### 7.4 扩展性
✅ 易于添加新的币种、价格类型
✅ 支持复杂的定价策略
✅ 便于价格分析和报表

## 八、实施建议

### 8.1 优先级
1. **P0（必须）**：创建核心表结构（currencies, price_types, product_vendor_prices）
2. **P1（重要）**：数据迁移脚本
3. **P2（优化）**：汇率管理、价格历史

### 8.2 实施步骤
1. 阶段1：创建新表结构（不影响现有功能）
2. 阶段2：数据迁移（并行运行，验证数据一致性）
3. 阶段3：应用代码改造（逐步迁移）
4. 阶段4：移除旧字段（确认无依赖后）

### 8.3 风险评估
- ⚠️ **数据迁移风险**：需要仔细验证迁移脚本
- ⚠️ **性能影响**：新表结构可能影响查询性能，需要优化索引
- ⚠️ **兼容性风险**：需要保持向后兼容，避免影响现有功能

## 九、结论

**当前数据库结构无法满足多币种、多供应商、多价格的需求。**

**主要问题：**
1. 币种硬编码，无法动态扩展
2. 产品只能关联一个供应商
3. 价格与供应商、币种耦合，无法灵活组合

**建议：**
采用新的表结构设计，通过`product_vendor_prices`表实现产品、供应商、币种、价格类型的灵活组合，满足未来业务扩展需求。
