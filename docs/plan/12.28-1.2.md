### BANTU CRM 商机阶段功能块整理

基于您提供的商机阶段列表（从1. 新建 到9. 收款）和后续需求描述（注意事项1、逻辑2、逻辑3，以及办理资料、回款、报价单、合同、发票、签约主体、OSS邮箱等补充），我将每个阶段现有的描述作为基础，整理出需要添加的功能块。这些功能块是根据商机不同阶段划分的模块化需求，旨在整合长周期订单拆分、依赖逻辑、客户/线索处理、签约主体管理等，确保流程连贯。功能块聚焦于新增或增强的部分，便于模块化开发。

#### 1. 新建 (Newly Created)
   - 现有：商机初始创建阶段，涉及基本信息录入，如关联客户、初步需求确认。
   - 需要添加的功能块：
     - 客户创建与关联：支持先创建客户记录，作为起点；关联到特定开发人员（如Lilly开发的客户）；针对长久未跟进客户，进行特殊标记或自动提醒/释放。
     - 线索处理整合：线索进入“七天释放状态”后，如果7天内无跟进，自动释放到公海池；公海释放由指定角色（如销售经理）触发。
     - 服务类型初步划分：识别长周期服务（如财税/IT）与一次性服务，支持初步订单拆分标记，便于后续独立合同管理。

#### 2. 服务方案 (Service Plan)
   - 现有：制定服务方案，基于客户需求，定义服务内容（如签证、公司注册、财税托管等）。
   - 需要添加的功能块：
     - 财税/IT服务阶段定义：财税服务分业务注册阶段1（公司设立/NIB/税卡等）和阶段2执行（月报税/年报等）；IT服务类似分阶段（如开发、上线、维护），每个阶段独立录入，便于分阶段审批和执行。
     - 财税服务周期选择：设置开始时间；支持1年周期默认，6个月或12个月选项勾选，由销售人员操作，影响定价、回款和合同条款。
     - 服务依赖初步检查：标记服务的本质依赖（如上游资料项目，例如护照首页用于后续签证），确保方案中处理资料依赖关系。

#### 3. 报价单 (Quotation)
   - 现有：生成报价单；付款方式支持50%预付 + 50%尾款、全款、后付；原则不会做赠送，使用比例方式处理优惠；双货币支持（RMB + IDR）。
   - 需要添加的功能块：
     - 成本隐藏与校验：报价单不直接显示成本；价格不能低于成本价格（标红警告）。
     - 操作增强：支持下载保存PDF并发送。
     - 群编号与资料关联：报价单项目支持父级-群编号关联；上传新的公司资料需与报价单项目关联；按照群编号对应出所有逻辑链路，便于查询和跟踪。
     - 订单拆分整合：长周期服务（如财税/IT）与一次性服务拆分成独立订单，便于分别跟踪执行、回款和依赖；合同层面长周期服务对应独立合同。

#### 4. 合同 (Contract)
   - 现有：签署合同；使用标准化模板，交付报价单 + 合同 + Invoice。
   - 需要添加的功能块：
     - 阶段合同信息录入：录入甲方（客户）信息；选择乙方签约主体。
     - 签约主体后台管理：支持新增、修改、删除签约主体，以及收款账户信息；示例主体包括北京班兔、湖北班兔、PT BANTU 对公、PT BANTU（印尼盾私-胡老师、RMB 对公-安鹏）。
     - 税点与金额计算：税点加入最终金额；主体信息管理包括主体名称、开户行、收款账户、税点、税号（示例：北京/湖北班兔税点1%、PT班兔对私/对公税点0%、PT班兔人民币对私税点1%）。
     - 合同云存储支持：整合班兔自己的合同云 OSS 云存储，便于存储和访问合同资料。

#### 5. 发票 (Invoice)
   - 现有：开具发票；支持多主体，选择后显示合同金额，并填写客户抬头/银行账户。
   - 需要添加的功能块：
     - 上传与主体选择：Lulu 上传发票，支持不同主体选择；如果选择湖北/北京班兔，显示合同金额，填写客户发票抬头和银行账户；开票方式为人工开票上传。
     - 签约主体整合：与签约主体管理联动，确保税点加入最终金额。
     - OSS存储支持：发票上传后，整合合同云 OSS 云存储，便于访问。

#### 6. 办理资料 (Handling Materials)
   - 现有：收集和办理资料；维护一套规则（如资料要求、依赖检查）；审批通过后才能执行金额（e.g., 预付或尾款）。
   - 需要添加的功能块：
     - 规则维护增强：系统维护一套办理资料规则（如资料类型、格式要求、依赖检查）。
     - 资料依赖处理：处理服务的本质依赖之前的资料项目（如护照首页用于公司注册后的签证），确保上游资料完成才能执行下游服务。
     - 审批与金额执行：审批通过后释放金额（预付或尾款）；整合群编号关联，便于资料上传与报价单项目联动。
     - OSS邮箱支持：整合国外的bantumail.service，支持自己重置邮箱密码，便于管理办理资料相关的邮件。

#### 7. 回款状态 (Collection Status)
   - 现有：管理回款；支持多种模式：上传凭证、财务人员（Lulu）确认核对入账、审核信息；处理确认信息缺失情况。
   - 需要添加的功能块：
     - 多模式增强：支持信息不完整时的处理（如提醒或拒绝）。
     - 依赖与拆分整合：回款考虑长周期/一次性订单拆分，便于分阶段回款；与财税/IT服务周期选择联动，影响回款条款。
     - 签约主体联动：回款核对时，考虑税点和主体信息（如北京/湖北班兔税点1%）。

#### 8. 分配执行 (Assign Execution)
   - 现有：分配执行任务；基于审批结果，分配给执行人员或团队。
   - 需要添加的功能块：
     - 订单分配总体要求：考虑公司注册的存在作为必须条件；只要有公司注册，就必须处理签证、KITAS（暂住证）和转签申请。
     - 流转逻辑整合：
       - 逻辑1（无公司注册）：直接执行订单，适用于无注册依赖的服务（如单纯签证或落地签）。
       - 逻辑2（有公司注册）：先完成公司注册/中台交付，然后释放后续订单；公司注册完成后释放签证/投资签证类订单；完成签证后释放所有剩余订单；处理SBU（建筑资质）和配额等后续问题；公司注册信息需记录，便于查询。
     - 群编号与分拆：使用群编号对应客户关系；执行订单分拆成小订单，便于细粒度执行；按照群编号对应逻辑链路。
     - 资料依赖检查：确保分配前处理资料依赖关系。

#### 9. 收款 (Collection)
   - 现有：最终收款阶段；条件：已经全部交付；动作：请检查款项、创建代办事项、释放新订单等；支持待办事项提醒（e.g., 新订单释放通知）。
   - 需要添加的功能块：
     - 交付检查增强：整合全部交付条件，包括长周期订单拆分和依赖完成（如公司注册后释放签证）。
     - 待办与提醒扩展：支持新订单释放通知，便于跟踪后续；与回款多模式联动（如Lulu核对）。
     - 签约主体与税点：收款时考虑税点加入最终金额，确保与主体信息一致。
     - OSS支持：收款凭证上传后，整合合同云 OSS 云存储，便于存储。


     商机的SQL 阶段的： 
     -- ============================================================
-- BANTU CRM 商机流程数据库结构（完整 SQL 导出）
-- ============================================================
-- 设计目标：
-- 1. 支持固定的9个商机阶段（新建 → 服务方案 → 报价单 → 合同 → 发票 → 办理资料 → 回款状态 → 分配执行 → 收款）
-- 2. 每个阶段可配置是否需要审批、推进条件（JSON 灵活扩展）
-- 3. 所有外键字段命名严格统一：目标表名（单数） + _id（如 opportunity_id、stage_id、user_id）
-- 4. 高扩展性：新增阶段只需插入模板表，无需修改表结构
-- 5. 完整阶段历史记录，支持审计、回溯、审批追踪
-- 6. 与现有表最小冲突，仅对 opportunities 表进行扩展
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 修改现有表：opportunities（商机主表）
-- ============================================================
ALTER TABLE `opportunities`
    ADD COLUMN `current_stage_id` CHAR(36) NULL 
        COMMENT '当前阶段ID（外键 → opportunity_stage_templates.id）' 
        AFTER `stage`,  -- 假设原有 stage 字段存在，可保留作为冗余或逐步废弃
    ADD COLUMN `workflow_status` VARCHAR(50) NOT NULL DEFAULT 'active' 
        COMMENT '工作流整体状态：active(进行中), paused(暂停), completed(完成), cancelled(取消)',
    ADD CONSTRAINT `fk_opportunities_current_stage` 
        FOREIGN KEY (`current_stage_id`) REFERENCES `opportunity_stage_templates` (`id`) 
        ON DELETE SET NULL;

-- ============================================================
-- 2. 新表：opportunity_stage_templates（商机阶段模板表）
--    定义所有阶段，支持未来扩展
-- ============================================================
CREATE TABLE IF NOT EXISTS `opportunity_stage_templates` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '阶段模板唯一ID',
    `code` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '阶段代码（唯一，程序中使用，如：new, quotation）',
    `name_zh` VARCHAR(255) NOT NULL 
        COMMENT '阶段名称（中文）',
    `name_id` VARCHAR(255) NOT NULL 
        COMMENT '阶段名称（印尼语，可选后续填充）',
    `description_zh` TEXT 
        COMMENT '阶段描述（中文）',
    `description_id` TEXT 
        COMMENT '阶段描述（印尼语）',
    `stage_order` INT NOT NULL 
        COMMENT '阶段顺序（1=最早，9=最晚）',
    `requires_approval` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否需要审批（1=需要，0=不需要）',
    `approval_roles_json` JSON DEFAULT NULL 
        COMMENT '需要审批的角色列表JSON，例如：["sales_manager","finance"]',
    `conditions_json` JSON DEFAULT NULL 
        COMMENT '进入下一阶段所需条件JSON（灵活扩展），例如：{"docs_collected":true,"payment_min":50}',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1 
        COMMENT '是否启用该阶段模板',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP 
        COMMENT '更新时间',
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id）',
    `updated_by` CHAR(36) NULL 
        COMMENT '更新人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    KEY `ix_stage_templates_code` (`code`),
    KEY `ix_stage_templates_order` (`stage_order`),
    KEY `ix_stage_templates_active` (`is_active`),
    CONSTRAINT `fk_stage_templates_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_stage_templates_updated_by` 
        FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='商机阶段模板表 - 定义所有固定阶段，支持动态扩展';

-- ============================================================
-- 3. 插入固定的9个商机阶段（初始数据）
-- ============================================================
INSERT INTO `opportunity_stage_templates` 
    (`code`, `name_zh`, `name_id`, `description_zh`, `stage_order`, `requires_approval`, `approval_roles_json`, `conditions_json`)
VALUES
    ('new',               '新建',         'Newly Created',      '商机初始创建阶段，录入基本信息及关联客户', 1, 0, NULL, NULL),
    ('service_plan',      '服务方案',     'Service Plan',       '制定服务方案，明确服务内容及需求',         2, 0, NULL, '{"demand_confirmed": true}'),
    ('quotation',         '报价单',       'Quotation',          '生成报价单，支持多种付款方式',             3, 1, '["sales_manager"]', '{"scheme_approved": true}'),
    ('contract',          '合同',         'Contract',           '签署合同，交付报价单+合同+Invoice',       4, 1, '["legal","sales_manager"]', '{"quote_accepted": true}'),
    ('invoice',           '发票',         'Invoice',            '开具发票，支持多签约主体',                 5, 1, '["finance"]', '{"contract_signed": true}'),
    ('handling_materials','办理资料',     'Handling Materials','收集办理资料，审批后释放金额',             6, 1, '["execution","finance"]', '{"invoice_issued": true, "docs_collected": true}'),
    ('collection_status', '回款状态',     'Collection Status',  '管理回款，支持多种回款模式及财务确认',     7, 0, NULL, '{"materials_approved": true}'),
    ('assign_execution',  '分配执行',     'Assign Execution',   '根据审批结果分配执行任务',                 8, 1, '["execution_manager"]', '{"payment_confirmed": true}'),
    ('collection',        '收款',         'Collection',         '全部交付后最终收款，释放新订单',           9, 0, NULL, '{"execution_completed": true}');

-- ============================================================
-- 4. 新表：opportunity_stage_history（商机阶段历史表）
--    记录每个商机的阶段流转、审批、条件满足情况，用于审计和报表
-- ============================================================
CREATE TABLE IF NOT EXISTS `opportunity_stage_history` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '历史记录唯一ID',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `stage_id` CHAR(36) NOT NULL 
        COMMENT '阶段ID（外键 → opportunity_stage_templates.id）',
    `entered_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '进入该阶段的时间',
    `exited_at` DATETIME DEFAULT NULL 
        COMMENT '退出该阶段的时间（NULL表示当前阶段）',
    `duration_days` INT GENERATED ALWAYS AS 
        (IF(`exited_at` IS NULL, NULL, DATEDIFF(`exited_at`, `entered_at`))) STORED 
        COMMENT '该阶段持续天数（计算字段）',
    `conditions_met_json` JSON DEFAULT NULL 
        COMMENT '满足的推进条件详情JSON（记录实际证据，如文档链接）',
    `requires_approval` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '该阶段是否需要审批（冗余自模板，便于查询）',
    `approval_status` VARCHAR(50) DEFAULT 'pending' 
        COMMENT '审批状态：pending(待审批), approved(通过), rejected(拒绝)',
    `approved_by` CHAR(36) DEFAULT NULL 
        COMMENT '审批人ID（外键 → users.id）',
    `approval_at` DATETIME DEFAULT NULL 
        COMMENT '审批通过/拒绝时间',
    `approval_notes` TEXT 
        COMMENT '审批备注/拒绝原因',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '记录创建时间',

    PRIMARY KEY (`id`),
    KEY `ix_stage_history_opportunity_id` (`opportunity_id`),
    KEY `ix_stage_history_stage_id` (`stage_id`),
    KEY `ix_stage_history_entered_at` (`entered_at` DESC),
    KEY `ix_stage_history_approval_status` (`approval_status`),
    CONSTRAINT `fk_stage_history_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_stage_history_stage_id` 
        FOREIGN KEY (`stage_id`) REFERENCES `opportunity_stage_templates` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `fk_stage_history_approved_by` 
        FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `chk_stage_history_approval_status` 
        CHECK (`approval_status` IN ('pending', 'approved', 'rejected'))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='商机阶段历史表 - 记录每个商机的阶段流转、条件满足、审批详情';

-- ============================================================
-- 5. 触发器：商机阶段变更时自动记录历史（可选自动化）
-- ============================================================
DELIMITER //

CREATE TRIGGER `trg_opportunity_stage_update` 
BEFORE UPDATE ON `opportunities`
FOR EACH ROW
BEGIN
    IF NEW.current_stage_id <> OLD.current_stage_id OR 
       (NEW.current_stage_id IS NOT NULL AND OLD.current_stage_id IS NULL) THEN
        
        -- 标记旧阶段退出时间
        UPDATE `opportunity_stage_history`
        SET `exited_at` = NOW()
        WHERE `opportunity_id` = OLD.id 
          AND `exited_at` IS NULL;

        -- 插入新阶段记录（条件与审批状态由应用层控制，这里仅记录进入）
        INSERT INTO `opportunity_stage_history` 
            (`opportunity_id`, `stage_id`, `entered_at`, `requires_approval`)
        SELECT 
            NEW.id, 
            NEW.current_stage_id, 
            NOW(), 
            COALESCE(st.`requires_approval`, 0)
        FROM `opportunity_stage_templates` st 
        WHERE st.`id` = NEW.current_stage_id;
    END IF;
END //

DELIMITER ;

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 应用层在推进阶段前，必须校验 opportunity_stage_templates.conditions_json 和 requires_approval
-- 2. 审批通过后，才允许更新 opportunities.current_stage_id
-- 3. 所有阶段变更都会自动写入 opportunity_stage_history，便于审计和报表
-- 4. 如需新增阶段，只需 INSERT 到 opportunity_stage_templates 表即可，无需改表结构

### 第一阶段（新建 Newly Created）所需表结构修改与新增

为了完整支持**新建阶段**的三个新增功能块（客户创建与关联、线索处理整合、服务类型初步划分），需要在现有数据库基础上进行以下表结构调整。所有修改严格遵守**外键统一命名规范（目标表名_id）**。

#### 1. 修改现有表

**1.1 opportunities（商机主表）**  
添加字段支持阶段功能
```sql
ALTER TABLE `opportunities`
    -- 服务类型初步划分：长周期 vs 一次性服务
    ADD COLUMN `service_type` ENUM('one_time', 'long_term', 'mixed') NOT NULL DEFAULT 'one_time'
        COMMENT '服务类型：one_time(一次性), long_term(长周期，如财税/IT), mixed(混合，支持后续订单拆分)' AFTER `amount`,

    -- 长周期服务初步标记（便于后续拆分合同）
    ADD COLUMN `is_split_required` TINYINT(1) NOT NULL DEFAULT 0
        COMMENT '是否需要订单拆分（1=需要，长周期服务标记）' AFTER `service_type`,

    -- 线索来源追踪（支持7天公海释放）
    ADD COLUMN `lead_id` CHAR(36) NULL
        COMMENT '关联线索ID（外键 → leads.id，若从线索转换而来）' AFTER `is_split_required`,
    ADD CONSTRAINT `fk_opportunities_lead_id` 
        FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE SET NULL,

    -- 长久未跟进标记（针对Lilly等特定开发人）
    ADD COLUMN `last_followup_at` DATETIME NULL
        COMMENT '最后跟进时间，用于计算长久未跟进' AFTER `updated_at`,
    ADD COLUMN `is_stale` TINYINT(1) NOT NULL DEFAULT 0
        COMMENT '是否长久未跟进（1=是，需要特殊标记/提醒）' AFTER `last_followup_at`,

    -- 开发人/归属人（支持Lilly开发的客户特殊逻辑）
    ADD COLUMN `developed_by` CHAR(36) NULL
        COMMENT '开发人ID（外键 → users.id，如Lilly开发的客户）' AFTER `owner_id`,
    ADD CONSTRAINT `fk_opportunities_developed_by` 
        FOREIGN KEY (`developed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL;
```

**1.2 leads（线索表，假设已存在，若无需新建）**  
添加字段支持7天公海释放逻辑
```sql
ALTER TABLE `leads`
    -- 线索进入七天释放状态的起始时间
    ADD COLUMN `release_countdown_at` DATETIME NULL
        COMMENT '进入七天释放倒计时时间（无跟进后设置）' AFTER `updated_at`,

    -- 公海状态
    ADD COLUMN `pool_status` ENUM('private', 'countdown', 'public') NOT NULL DEFAULT 'private'
        COMMENT '线索池状态：private(私有), countdown(七天倒计时), public(公海)' AFTER `status`,

    -- 释放操作人（销售经理触发释放）
    ADD COLUMN `released_by` CHAR(36) NULL
        COMMENT '释放到公海的操作人ID（外键 → users.id）' AFTER `owner_id`,
    ADD COLUMN `released_at` DATETIME NULL
        COMMENT '释放到公海时间',
    ADD CONSTRAINT `fk_leads_released_by` 
        FOREIGN KEY (`released_by`) REFERENCES `users` (`id`) ON DELETE SET NULL;
```

**1.3 organizations（客户/组织表，假设客户用此表存储）**  
加强客户创建与关联支持
```sql
ALTER TABLE `organizations`
    -- 开发人标记（支持Lilly开发的客户）
    ADD COLUMN `developed_by` CHAR(36) NULL
        COMMENT '客户开发人ID（外键 → users.id，如Lilly开发）' AFTER `owner_id`,
    ADD CONSTRAINT `fk_organizations_developed_by` 
        FOREIGN KEY (`developed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,

    -- 长久未跟进标记
    ADD COLUMN `last_contact_at` DATETIME NULL
        COMMENT '最后联系时间，用于判断长久未跟进',
    ADD COLUMN `is_stale` TINYINT(1) NOT NULL DEFAULT 0
        COMMENT '是否长久未跟进客户（1=是）';
```

#### 2. 新增表（可选增强）

**2.1 lead_followup_logs（线索跟进日志表）**  
用于精确判断“7天无跟进”（推荐新建，便于审计）
```sql
CREATE TABLE IF NOT EXISTS `lead_followup_logs` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) COMMENT '跟进记录ID',
    `lead_id` CHAR(36) NOT NULL COMMENT '线索ID（外键 → leads.id）',
    `user_id` CHAR(36) NOT NULL COMMENT '跟进人ID（外键 → users.id）',
    `action_type` VARCHAR(50) NOT NULL COMMENT '跟进动作：call, email, wechat, visit 等',
    `notes` TEXT COMMENT '跟进内容',
    `followed_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '跟进时间',

    PRIMARY KEY (`id`),
    KEY `ix_lead_followup_lead_id` (`lead_id`),
    KEY `ix_lead_followup_followed_at` (`followed_at` DESC),
    CONSTRAINT `fk_lead_followup_lead_id` FOREIGN KEY (`lead_id`) REFERENCES `leads` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_lead_followup_user_id` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='线索跟进日志表 - 用于判断7天无跟进释放公海';
```

#### 3. 定时任务/触发器建议（应用层或数据库层实现）

- **7天公海释放**：每日定时任务检查 `leads` 表中 `pool_status='private'` 且最后跟进（`lead_followup_logs` 或 `updated_at`）距今 >7天 → 自动设为 `countdown`，再过7天无跟进 → 设为 `public` 并记录 `released_by`（系统用户）。
- **长久未跟进标记**：定时任务扫描 `opportunities.last_followup_at` 或 `organizations.last_contact_at` 超过阈值（如30天）→ 设置 `is_stale=1` 并发送提醒。
- **客户优先创建**：应用层强制：在创建商机前必须有关联 `organization_id`，若无则先引导创建客户。

#### 总结：第一阶段涉及修改的表

| 表名                | 修改目的                           | 主要新增字段                             |
|---------------------|------------------------------------|------------------------------------------|
| opportunities       | 服务类型划分 + 线索关联 + 未跟进标记 | service_type, is_split_required, lead_id, last_followup_at, is_stale, developed_by |
| leads               | 7天公海释放逻辑                    | release_countdown_at, pool_status, released_by, released_at |
| organizations       | 客户开发人与未跟进标记             | developed_by, last_contact_at, is_stale  |
| lead_followup_logs  | 新建：精确跟踪跟进行为             | 全表                                     |

这些修改完全支持**新建阶段**的三个功能块，且外键命名统一、可扩展性强，为后续阶段（如报价单拆分、依赖释放）打下基础。

#### 2. 服务方案 (Service Plan)

### BANTU CRM 组合订单与回款计算需求澄清及设计调整

基于您描述的组合订单场景（包含长周期财税服务每月回款 + 一次性交付服务），我对之前的数据库设计进行调整，确保在销售收入计算时能自动处理“排除长周期部分后视作全部回款”。核心是区分服务类型，并在回款逻辑中分离计算。

#### 需求澄清
- **组合订单**：一个父订单下包含多个子服务（如财税托管 + 签证 + 公司注册）。
- **长周期服务**（e.g., 财税/IT）：每月回款，周期可选（默认1年、6/12个月），不视为一次性全部回款。
- **一次性服务**：交付即全款。
- **销售收入计算**：对于整个组合订单，排除长周期部分后，剩余一次性服务视为全部回款（即收入确认）。长周期部分按月逐步确认回款。
- **影响**：定价、合同、发票需分离长/短周期；回款状态自动计算，避免手动干预。

#### 数据库设计调整
在现有opportunities和orders表基础上，添加字段/表支持区分与计算。回款逻辑通过视图或应用层查询实现（e.g., SQL函数计算总回款率）。

1. **修改现有表：orders（订单主表）**
   - 添加字段区分周期类型和回款规则。
```sql
ALTER TABLE `orders`
    ADD COLUMN `order_type` ENUM('combination', 'long_term', 'one_time') NOT NULL DEFAULT 'one_time' 
        COMMENT '订单类型：combination(组合), long_term(长周期，如财税每月回款), one_time(一次性交付)',
    ADD COLUMN `cycle_months` INT NULL 
        COMMENT '长周期服务月数（NULL=非长周期, 6/12/等）',
    ADD COLUMN `start_date` DATE NULL 
        COMMENT '长周期服务开始日期（影响每月回款计算）',
    ADD COLUMN `monthly_payment_amount` DECIMAL(18,2) NULL 
        COMMENT '长周期每月回款金额（自动计算：总价 / cycle_months）',
    ADD COLUMN `is_fully_paid_excluding_long` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '排除长周期后是否全部回款（1=是，用于销售收入确认）';
```

2. **修改现有表：order_items（订单项子表）**
   - 每个服务项标记类型，便于组合订单分离计算。
```sql
ALTER TABLE `order_items`
    ADD COLUMN `item_type` ENUM('long_term', 'one_time') NOT NULL DEFAULT 'one_time' 
        COMMENT '服务项类型：long_term(长周期), one_time(一次性)',
    ADD COLUMN `cycle_months` INT NULL 
        COMMENT '若长周期，指定月数';
```

3. **新表：order_payments（订单回款记录表）**
   - 记录每月回款，支持长周期逐月确认；自动计算排除长周期后的回款状态。
```sql
CREATE TABLE IF NOT EXISTS `order_payments` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) COMMENT '回款记录ID',
    `order_id` CHAR(36) NOT NULL COMMENT '订单ID（外键 → orders.id）',
    `order_item_id` CHAR(36) NULL COMMENT '订单项ID（外键 → order_items.id，若针对具体服务）',
    `payment_amount` DECIMAL(18,2) NOT NULL COMMENT '本次回款金额',
    `payment_date` DATE NOT NULL COMMENT '回款日期（长周期为每月实际日期）',
    `payment_type` ENUM('monthly', 'full', 'partial') NOT NULL DEFAULT 'full' COMMENT '回款类型：monthly(长周期月付), full(全部), partial(部分)',
    `is_excluded_from_full` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '是否排除在全部回款计算中（1=长周期服务）',
    `status` ENUM('pending', 'confirmed', 'overdue') NOT NULL DEFAULT 'pending' COMMENT '回款状态',
    `confirmed_by` CHAR(36) NULL COMMENT '确认人ID（外键 → users.id，如Lulu）',
    `confirmed_at` DATETIME NULL COMMENT '确认时间',
    `notes` TEXT COMMENT '回款备注（如财务核对信息）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (`id`),
    KEY `ix_payments_order_id` (`order_id`),
    KEY `ix_payments_order_item_id` (`order_item_id`),
    KEY `ix_payments_status` (`status`),
    CONSTRAINT `fk_payments_order_id` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_payments_order_item_id` FOREIGN KEY (`order_item_id`) REFERENCES `order_items` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_payments_confirmed_by` FOREIGN KEY (`confirmed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='订单回款记录表 - 支持长周期每月回款和排除计算';
```

4. **视图：vw_order_revenue_calc（销售收入计算视图）**
   - 自动计算回款：排除长周期部分后，检查是否全部回款。
```sql
CREATE VIEW `vw_order_revenue_calc` AS
SELECT 
    o.id AS order_id,
    SUM(oi.amount) AS total_amount,  -- 总价
    SUM(CASE WHEN oi.item_type = 'long_term' THEN oi.amount ELSE 0 END) AS long_term_amount,  -- 长周期总价
    SUM(CASE WHEN oi.item_type = 'one_time' THEN oi.amount ELSE 0 END) AS one_time_amount,  -- 一次性总价
    SUM(p.payment_amount) AS received_amount,  -- 已收总款
    SUM(CASE WHEN p.is_excluded_from_full = 1 THEN p.payment_amount ELSE 0 END) AS long_term_received,  -- 长周期已收
    (SUM(CASE WHEN oi.item_type = 'one_time' THEN oi.amount ELSE 0 END) = 
     SUM(CASE WHEN p.is_excluded_from_full = 0 THEN p.payment_amount ELSE 0 END)) AS is_one_time_fully_paid,  -- 一次性部分是否全款
    o.is_fully_paid_excluding_long AS is_fully_paid_excluding_long  -- 排除长周期后全款标志
FROM orders o
LEFT JOIN order_items oi ON oi.order_id = o.id
LEFT JOIN order_payments p ON p.order_id = o.id
GROUP BY o.id;
```

#### 实现逻辑
- **创建组合订单**：父订单类型设为'combination'，子项标记'long_term'或'one_time'。长周期项自动生成每月回款记录（e.g., 12个月，每月插入一条'pending'记录）。
- **回款确认**：长周期每月手动确认（Lulu核对）；一次性交付后自动设全款。
- **销售收入计算**：查询视图，若`is_one_time_fully_paid=1`，则整个订单（排除长周期）视为全回款，确认收入。长周期按每月`received_amount`逐步确认。
- **自动化**：触发器在订单创建时，若有长周期项，预生成12个月回款记录；应用层在交付一次性项时更新`is_fully_paid_excluding_long=1`。

这个调整确保组合订单回款计算灵活，财税等长周期不影响一次性部分收入确认。如果需要SQL脚本测试或进一步细化（如积分福利整合），随时说！

阶段3： 报价单：
-- ============================================================
-- BANTU CRM 第三阶段（报价单 Quotation）完整表结构变更 SQL
-- ============================================================
-- 涵盖以下所有功能：
-- 1. 报价单主表与明细表（双货币、付款方式、折扣比例、成本隐藏与校验）
-- 2. 报价单资料上传（支持群编号关联、项目关联）
-- 3. 报价单PDF模板管理（多签约主体、多货币、多语言）
-- 4. opportunities 表扩展（拆单标记、主报价单关联）
-- 所有外键命名统一为 target_table_id 规范
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 修改 opportunities 表（支持后续拆单和主报价单记录）
-- ============================================================
ALTER TABLE `opportunities`
    ADD COLUMN `split_order_required` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否需要拆分独立订单（1=是，长周期服务将生成独立订单）' AFTER `has_staged_services`,
    ADD COLUMN `primary_quotation_id` CHAR(36) NULL 
        COMMENT '主报价单ID（客户接受的最终报价单，外键 → quotations.id）' AFTER `split_order_required`,
    ADD CONSTRAINT `fk_opportunities_primary_quotation_id` 
        FOREIGN KEY (`primary_quotation_id`) REFERENCES `quotations` (`id`) ON DELETE SET NULL;

-- ============================================================
-- 2. 新表：quotations（报价单主表）
-- ============================================================
CREATE TABLE IF NOT EXISTS `quotations` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '报价单ID',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `quotation_no` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '报价单编号（如：QUO-20251228-001）',
    `version` INT NOT NULL DEFAULT 1 
        COMMENT '版本号（同一商机多份报价单时递增）',
    `currency_primary` VARCHAR(10) NOT NULL DEFAULT 'IDR' 
        COMMENT '主货币：IDR 或 CNY（双货币支持）',
    `exchange_rate` DECIMAL(18,9) NULL 
        COMMENT '汇率（用于双货币换算，IDR → CNY 或反之）',
    `payment_terms` ENUM('full_upfront', '50_50', '70_30', 'post_payment') NOT NULL 
        COMMENT '付款方式：full_upfront(全款), 50_50(50%预付+50%尾款), 70_30(70%预付+30%尾款), post_payment(后付)',
    `discount_rate` DECIMAL(5,2) NOT NULL DEFAULT 0.00 
        COMMENT '折扣比例（%），不允许赠送，仅比例优惠',
    `total_amount_primary` DECIMAL(18,2) NOT NULL 
        COMMENT '主货币总金额（已应用折扣后）',
    `total_amount_secondary` DECIMAL(18,2) NULL 
        COMMENT '第二货币总金额（根据汇率换算）',
    `valid_until` DATE NULL 
        COMMENT '报价有效期至',
    `status` ENUM('draft', 'sent', 'accepted', 'rejected', 'expired') NOT NULL DEFAULT 'draft' 
        COMMENT '报价单状态',
    `wechat_group_no` VARCHAR(100) NULL 
        COMMENT '关联微信群编号（父级群编号，用于逻辑链路聚合）',
    `pdf_generated_at` DATETIME NULL 
        COMMENT 'PDF生成时间（支持下载保存）',
    `sent_at` DATETIME NULL 
        COMMENT '发送给客户时间',
    `template_id` CHAR(36) NULL 
        COMMENT '使用的PDF模板ID（外键 → quotation_templates.id）',
    `template_code_at_generation` VARCHAR(50) NULL 
        COMMENT '生成PDF时模板代码（冗余，防止模板后续变更影响历史报价单）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id，通常销售人员）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_quotation_opportunity_version` (`opportunity_id`, `version`),
    UNIQUE KEY `uk_quotation_no` (`quotation_no`),
    KEY `ix_quotations_opportunity_id` (`opportunity_id`),
    KEY `ix_quotations_wechat_group_no` (`wechat_group_no`),
    KEY `ix_quotations_status` (`status`),
    KEY `ix_quotations_template_id` (`template_id`),
    CONSTRAINT `fk_quotations_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_quotations_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_quotations_template_id` 
        FOREIGN KEY (`template_id`) REFERENCES `quotation_templates` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='报价单主表 - 支持双货币、付款方式、折扣比例、群编号、PDF模板与操作';

-- ============================================================
-- 3. 新表：quotation_items（报价单明细表）
-- ============================================================
CREATE TABLE IF NOT EXISTS `quotation_items` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '明细行ID',
    `quotation_id` CHAR(36) NOT NULL 
        COMMENT '报价单ID（外键 → quotations.id）',
    `opportunity_item_id` CHAR(36) NULL 
        COMMENT '关联商机明细ID（外键 → opportunity_items.id，便于追溯）',
    `product_id` CHAR(36) NULL 
        COMMENT '产品ID（外键 → products.id）',
    `item_name` VARCHAR(255) NOT NULL 
        COMMENT '服务名称',
    `quantity` DECIMAL(10,2) NOT NULL DEFAULT 1,
    `unit_price_primary` DECIMAL(18,2) NOT NULL 
        COMMENT '主货币单价（应用折扣后）',
    `unit_cost` DECIMAL(18,2) NOT NULL DEFAULT 0.00 
        COMMENT '成本单价（后台校验用，不对外显示）',
    `is_below_cost` TINYINT(1) GENERATED ALWAYS AS 
        (CASE WHEN `unit_price_primary` < `unit_cost` THEN 1 ELSE 0 END) STORED 
        COMMENT '是否低于成本（1=是，前端标红警告）',
    `total_price_primary` DECIMAL(18,2) NOT NULL 
        COMMENT '主货币小计',
    `service_category` ENUM('one_time', 'long_term') NOT NULL 
        COMMENT '服务类别（继承自商机明细，用于后续拆单）',
    `sort_order` INT NOT NULL DEFAULT 0 
        COMMENT '显示排序',
    `description` TEXT,

    PRIMARY KEY (`id`),
    KEY `ix_quotation_items_quotation_id` (`quotation_id`),
    KEY `ix_quotation_items_below_cost` (`is_below_cost`),
    KEY `ix_quotation_items_opportunity_item_id` (`opportunity_item_id`),
    CONSTRAINT `fk_quotation_items_quotation_id` 
        FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_quotation_items_opportunity_item_id` 
        FOREIGN KEY (`opportunity_item_id`) REFERENCES `opportunity_items` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_quotation_items_product_id` 
        FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='报价单明细表 - 支持成本隐藏校验、低于成本标红、继承服务类别用于拆单';

-- ============================================================
-- 4. 新表：quotation_documents（报价单资料上传表）
-- ============================================================
CREATE TABLE IF NOT EXISTS `quotation_documents` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '资料记录ID',
    `quotation_id` CHAR(36) NOT NULL 
        COMMENT '报价单ID（外键 → quotations.id）',
    `wechat_group_no` VARCHAR(100) NULL 
        COMMENT '关联微信群编号（与报价单一致，用于链路查询）',
    `document_type` VARCHAR(100) NOT NULL 
        COMMENT '资料类型（如：passport_front, company_nib, shareholder_ktp）',
    `document_name` VARCHAR(255) NOT NULL 
        COMMENT '资料文件名',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT '存储路径（OSS链接）',
    `uploaded_by` CHAR(36) NULL 
        COMMENT '上传人ID（外键 → users.id，可为客户或销售）',
    `uploaded_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '上传时间',
    `related_item_id` CHAR(36) NULL 
        COMMENT '关联报价单明细行ID（外键 → quotation_items.id）',

    PRIMARY KEY (`id`),
    KEY `ix_quotation_documents_quotation_id` (`quotation_id`),
    KEY `ix_quotation_documents_group_no` (`wechat_group_no`),
    KEY `ix_quotation_documents_type` (`document_type`),
    KEY `ix_quotation_documents_related_item_id` (`related_item_id`),
    CONSTRAINT `fk_quotation_documents_quotation_id` 
        FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_quotation_documents_uploaded_by` 
        FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_quotation_documents_related_item_id` 
        FOREIGN KEY (`related_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='报价单资料上传表 - 支持按群编号和项目关联上传公司资料';

-- ============================================================
-- 5. 新表：quotation_templates（报价单PDF模板表）
-- ============================================================
CREATE TABLE IF NOT EXISTS `quotation_templates` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '模板ID',
    `template_code` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '模板代码（唯一，如：BJ_BANTU_CNY, PT_PUBLIC_IDR）',
    `template_name` VARCHAR(255) NOT NULL 
        COMMENT '模板名称（如：北京班兔人民币模板）',
    `description` TEXT 
        COMMENT '模板描述',
    `primary_currency` VARCHAR(10) NOT NULL 
        COMMENT '主货币：IDR 或 CNY',
    `language` ENUM('zh', 'id', 'zh_id', 'en_zh') NOT NULL DEFAULT 'zh' 
        COMMENT '模板语言：zh(中文), id(印尼文), zh_id(中印双语), en_zh(英中)',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT '模板文件存储路径（OSS链接，通常为HTML/FreeMarker/Word模板）',
    `file_type` ENUM('html', 'docx', 'freemarker', 'pdf_background') NOT NULL 
        COMMENT '模板文件类型（用于后端渲染选择）',
    `header_logo_url` VARCHAR(500) NULL 
        COMMENT '抬头Logo',
    `footer_text` TEXT NULL 
        COMMENT '页脚文本',
    `bank_account_info_json` JSON NULL 
        COMMENT '银行账户信息JSON（根据签约主体不同）',
    `tax_info_json` JSON NULL 
        COMMENT '税率及税号信息JSON',
    `is_default` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否为默认模板（1=是，同条件优先使用）',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1 
        COMMENT '是否启用',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id）',
    `updated_by` CHAR(36) NULL 
        COMMENT '更新人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_template_code` (`template_code`),
    KEY `ix_templates_currency` (`primary_currency`),
    KEY `ix_templates_language` (`language`),
    KEY `ix_templates_active` (`is_active`),
    CONSTRAINT `fk_templates_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_templates_updated_by` 
        FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='报价单PDF模板表 - 支持多签约主体、多货币、多语言模板管理';

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 生成报价单时，根据货币、语言、签约主体自动推荐 quotation_templates
-- 2. 保存报价单记录 template_id，便于后续重新生成PDF
-- 3. quotation_items.unit_cost 用于后台校验，不对外显示；is_below_cost 自动标红
-- 4. quotation_documents 支持按群编号和明细行关联资料上传
-- 5. 客户接受报价单后，设置 opportunities.primary_quotation_id，触发后续订单拆分 

```sql
-- ============================================================
-- BANTU CRM 第四阶段（合同 Contract）完整表结构变更 SQL
-- ============================================================
-- 涵盖以下所有功能：
-- 1. 签约主体管理（后台新增/修改/删除、收款账户、税点、税号）
-- 2. 合同主表（关联报价单、签约主体、甲方信息）
-- 3. 合同PDF模板管理（多签约主体专用模板）
-- 4. 合同文件存储记录（支持合同云 OSS 存储，记录报价单+合同+发票三个PDF）
-- 5. opportunities 表扩展（记录最终合同ID）
-- 所有外键命名统一为 target_table_id 规范
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 新表：contract_entities（签约主体表）
--    后台管理签约主体：北京班兔、湖北班兔、PT BANTU 对公/对私 等
-- ============================================================
CREATE TABLE IF NOT EXISTS `contract_entities` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '签约主体ID',
    `entity_code` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '主体代码（唯一，如：BJ_BANTU, HB_BANTU, PT_PUBLIC, PT_PRIVATE_IDR, PT_RMB_PRIVATE）',
    `entity_name` VARCHAR(255) NOT NULL 
        COMMENT '主体名称（如：北京班兔科技有限公司）',
    `short_name` VARCHAR(100) NOT NULL 
        COMMENT '简称（如：北京班兔）',
    `legal_representative` VARCHAR(100) NULL 
        COMMENT '法定代表人',
    `tax_rate` DECIMAL(5,4) NOT NULL DEFAULT 0.0000 
        COMMENT '税点（例如：0.0100 = 1%）',
    `tax_id` VARCHAR(100) NULL 
        COMMENT '税号',
    `bank_name` VARCHAR(200) NULL 
        COMMENT '开户行',
    `bank_account_no` VARCHAR(100) NULL 
        COMMENT '收款账户',
    `bank_account_name` VARCHAR(200) NULL 
        COMMENT '账户名称',
    `currency` VARCHAR(10) NOT NULL DEFAULT 'CNY' 
        COMMENT '主要收款币种：CNY 或 IDR',
    `address` TEXT NULL 
        COMMENT '公司地址',
    `contact_phone` VARCHAR(50) NULL 
        COMMENT '联系电话',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1 
        COMMENT '是否启用',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id）',
    `updated_by` CHAR(36) NULL 
        COMMENT '更新人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_entity_code` (`entity_code`),
    KEY `ix_entities_active` (`is_active`),
    KEY `ix_entities_currency` (`currency`),
    CONSTRAINT `fk_entities_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_entities_updated_by` 
        FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='签约主体管理表 - 支持后台新增/修改/删除签约主体及收款账户、税点信息';

-- ============================================================
-- 2. 新表：contract_templates（合同PDF模板表）
--    每个签约主体可配置专用合同模板
-- ============================================================
CREATE TABLE IF NOT EXISTS `contract_templates` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '合同模板ID',
    `template_code` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '模板代码（唯一，如：CONTRACT_BJ_BANTU, CONTRACT_PT_PUBLIC）',
    `template_name` VARCHAR(255) NOT NULL 
        COMMENT '模板名称',
    `entity_id` CHAR(36) NOT NULL 
        COMMENT '关联签约主体ID（外键 → contract_entities.id）',
    `language` ENUM('zh', 'id', 'zh_id', 'en_zh') NOT NULL DEFAULT 'zh' 
        COMMENT '模板语言',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT '模板文件路径（OSS链接，HTML/FreeMarker/Word等）',
    `file_type` ENUM('html', 'docx', 'freemarker', 'pdf_background') NOT NULL 
        COMMENT '模板类型',
    `header_logo_url` VARCHAR(500) NULL 
        COMMENT '抬头Logo',
    `footer_text` TEXT NULL 
        COMMENT '页脚文本',
    `is_default_for_entity` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否为该主体默认模板（1=是）',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL,
    `updated_by` CHAR(36) NULL,

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_contract_template_code` (`template_code`),
    KEY `ix_contract_templates_entity_id` (`entity_id`),
    KEY `ix_contract_templates_active` (`is_active`),
    CONSTRAINT `fk_contract_templates_entity_id` 
        FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_contract_templates_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_contract_templates_updated_by` 
        FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='合同PDF模板表 - 每个签约主体专用合同模板';

-- ============================================================
-- 3. 新表：contracts（合同主表）
-- ============================================================
CREATE TABLE IF NOT EXISTS `contracts` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '合同ID',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `quotation_id` CHAR(36) NULL 
        COMMENT '关联报价单ID（外键 → quotations.id，通常为primary_quotation_id）',
    `contract_no` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '合同编号（如：CON-20251228-001）',
    `entity_id` CHAR(36) NOT NULL 
        COMMENT '乙方签约主体ID（外键 → contract_entities.id）',
    `party_a_name` VARCHAR(255) NOT NULL 
        COMMENT '甲方名称（客户公司/个人名）',
    `party_a_contact` VARCHAR(100) NULL 
        COMMENT '甲方联系人',
    `party_a_phone` VARCHAR(50) NULL 
        COMMENT '甲方联系电话',
    `party_a_email` VARCHAR(255) NULL 
        COMMENT '甲方邮箱',
    `party_a_address` TEXT NULL 
        COMMENT '甲方地址',
    `total_amount_with_tax` DECIMAL(18,2) NOT NULL 
        COMMENT '含税总金额（自动计算 = 报价金额 + 税点）',
    `tax_amount` DECIMAL(18,2) NOT NULL DEFAULT 0.00 
        COMMENT '税额（自动计算）',
    `status` ENUM('draft', 'sent', 'signed', 'effective', 'terminated') NOT NULL DEFAULT 'draft' 
        COMMENT '合同状态',
    `signed_at` DATETIME NULL 
        COMMENT '签署时间',
    `effective_from` DATE NULL 
        COMMENT '合同生效日期',
    `effective_to` DATE NULL 
        COMMENT '合同到期日期（长周期服务使用）',
    `template_id` CHAR(36) NULL 
        COMMENT '使用的合同模板ID（外键 → contract_templates.id）',
    `wechat_group_no` VARCHAR(100) NULL 
        COMMENT '关联微信群编号（继承自报价单）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_contract_no` (`contract_no`),
    KEY `ix_contracts_opportunity_id` (`opportunity_id`),
    KEY `ix_contracts_quotation_id` (`quotation_id`),
    KEY `ix_contracts_entity_id` (`entity_id`),
    KEY `ix_contracts_status` (`status`),
    KEY `ix_contracts_wechat_group_no` (`wechat_group_no`),
    CONSTRAINT `fk_contracts_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_contracts_quotation_id` 
        FOREIGN KEY (`quotation_id`) REFERENCES `quotations` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_contracts_entity_id` 
        FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `fk_contracts_template_id` 
        FOREIGN KEY (`template_id`) REFERENCES `contract_templates` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_contracts_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='合同主表 - 记录甲方信息、乙方签约主体、含税金额、模板使用';

-- ============================================================
-- 4. 新表：contract_documents（合同相关文件存储表）
--    一次性交付三个PDF：报价单PDF + 合同PDF + 发票PDF（合同云 OSS 存储）
-- ============================================================
CREATE TABLE IF NOT EXISTS `contract_documents` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '文件记录ID',
    `contract_id` CHAR(36) NOT NULL 
        COMMENT '合同ID（外键 → contracts.id）',
    `document_type` ENUM('quotation_pdf', 'contract_pdf', 'invoice_pdf') NOT NULL 
        COMMENT '文件类型：quotation_pdf(报价单), contract_pdf(合同), invoice_pdf(发票)',
    `file_name` VARCHAR(255) NOT NULL 
        COMMENT '文件名（如：QUO-20251228-001.pdf）',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT 'OSS存储路径',
    `file_size_kb` INT NULL 
        COMMENT '文件大小（KB）',
    `generated_at` DATETIME NULL 
        COMMENT '生成时间',
    `sent_at` DATETIME NULL 
        COMMENT '发送给客户时间',
    `version` INT NOT NULL DEFAULT 1 
        COMMENT '版本号（同一类型可重生成）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '生成人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_contract_document_type_version` (`contract_id`, `document_type`, `version`),
    KEY `ix_contract_documents_contract_id` (`contract_id`),
    KEY `ix_contract_documents_type` (`document_type`),
    CONSTRAINT `fk_contract_documents_contract_id` 
        FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_contract_documents_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='合同相关文件表 - 存储报价单、合同、发票三个PDF（班兔合同云 OSS）';

-- ============================================================
-- 5. 修改 opportunities 表（记录最终合同）
-- ============================================================
ALTER TABLE `opportunities`
    ADD COLUMN `primary_contract_id` CHAR(36) NULL 
        COMMENT '主合同ID（签署生效的最终合同，外键 → contracts.id）' AFTER `primary_quotation_id`,
    ADD CONSTRAINT `fk_opportunities_primary_contract_id` 
        FOREIGN KEY (`primary_contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL;

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 后台先维护 contract_entities（签约主体）和 contract_templates（合同模板）
-- 2. 创建合同时选择 entity_id → 自动拉取税率、银行账户 → 计算含税金额
-- 3. 选择或自动匹配 contract_templates 生成合同PDF
-- 4. 一键生成并存储三个PDF到 contract_documents（报价单PDF可复用 quotations 生成的）
-- 5. 合同签署后更新 status='signed/effective'，设置 opportunities.primary_contract_id
-- 6. 所有文件统一存班兔自有合同云 OSS（file_url 指向 OSS 路径）
```

以上 SQL 完整实现了**合同阶段**的所有新增需求：
- 签约主体后台管理（含税点、收款账户）
- 甲方信息录入 + 乙方主体选择
- 自动含税金额计算
- 专用合同PDF模板
- 一次性交付并存储三个PDF（报价单 + 合同 + 发票）到自有合同云 OSS

所有表结构与前三阶段无缝衔接，外键统一规范，可直接执行。

```sql
-- ============================================================
-- BANTU CRM 第六阶段（办理资料 Handling Materials）完整表结构变更 SQL
-- ============================================================
-- 涵盖以下所有功能：
-- 1. 每个服务产品（products）可配置独立的资料规则（类型、格式、必填、依赖）
-- 2. 资料规则高度可扩展（支持图片、PDF、文本、数字等类型，校验规则JSON）
-- 3. 商机/合同级资料收集与上传（支持群编号、关联服务明细）
-- 4. 资料依赖检查（上游资料完成才能解锁下游服务）
-- 5. 资料审批流程（审批通过后释放金额）
-- 6. OSS存储 + 国外bantumail.service邮件通知支持（记录邮件发送）
-- 所有外键命名统一为 target_table_id 规范
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 新表：product_document_rules（产品资料规则表）
--    每个产品（products）可配置多条资料要求，高可扩展性
-- ============================================================
CREATE TABLE IF NOT EXISTS `product_document_rules` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '资料规则ID',
    `product_id` CHAR(36) NOT NULL 
        COMMENT '产品ID（外键 → products.id）',
    `rule_code` VARCHAR(100) NOT NULL 
        COMMENT '规则代码（唯一，便于程序识别，如：PASSPORT_FRONT, COMPANY_NIB）',
    `document_name_zh` VARCHAR(255) NOT NULL 
        COMMENT '资料名称（中文，如：护照首页）',
    `document_name_id` VARCHAR(255) NULL 
        COMMENT '资料名称（印尼文）',
    `document_type` ENUM('image', 'pdf', 'text', 'number', 'date', 'file') NOT NULL 
        COMMENT '资料类型：image(图片), pdf, text(文本), number(数字), date(日期), file(任意文件)',
    `is_required` TINYINT(1) NOT NULL DEFAULT 1 
        COMMENT '是否必填（1=是）',
    `max_size_kb` INT NULL 
        COMMENT '最大文件大小（KB）',
    `allowed_extensions` VARCHAR(200) NULL 
        COMMENT '允许扩展名（逗号分隔，如：jpg,png,pdf）',
    `validation_rules_json` JSON NULL 
        COMMENT '校验规则JSON，例如：{"min_width": 800, "min_height": 600, "aspect_ratio": "3:4"} 用于图片护照',
    `depends_on_rule_id` CHAR(36) NULL 
        COMMENT '依赖的前置资料规则ID（外键 → product_document_rules.id，上游资料完成才解锁本资料）',
    `sort_order` INT NOT NULL DEFAULT 0 
        COMMENT '显示排序',
    `description` TEXT NULL 
        COMMENT '资料说明（如：护照有效期不能低于18个月）',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL,
    `updated_by` CHAR(36) NULL,

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_product_rule_code` (`product_id`, `rule_code`),
    KEY `ix_product_rules_product_id` (`product_id`),
    KEY `ix_product_rules_depends_on` (`depends_on_rule_id`),
    KEY `ix_product_rules_active` (`is_active`),
    CONSTRAINT `fk_product_rules_product_id` 
        FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_product_rules_depends_on_rule_id` 
        FOREIGN KEY (`depends_on_rule_id`) REFERENCES `product_document_rules` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_product_rules_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_product_rules_updated_by` 
        FOREIGN KEY (`updated_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='产品资料规则表 - 每个服务产品配置独立资料要求，支持类型、格式、依赖、校验，高可扩展';

-- ============================================================
-- 2. 新表：contract_material_documents（合同资料收集表）
--    实际资料上传记录，支持群编号、关联服务明细、规则校验
-- ============================================================
CREATE TABLE IF NOT EXISTS `contract_material_documents` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '资料上传记录ID',
    `contract_id` CHAR(36) NOT NULL 
        COMMENT '合同ID（外键 → contracts.id）',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id，便于查询）',
    `quotation_item_id` CHAR(36) NULL 
        COMMENT '关联报价单明细ID（外键 → quotation_items.id，标识所属服务）',
    `product_id` CHAR(36) NULL 
        COMMENT '产品ID（外键 → products.id）',
    `rule_id` CHAR(36) NOT NULL 
        COMMENT '资料规则ID（外键 → product_document_rules.id）',
    `wechat_group_no` VARCHAR(100) NULL 
        COMMENT '关联微信群编号（用于链路聚合）',
    `document_name` VARCHAR(255) NOT NULL 
        COMMENT '上传文件名',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT 'OSS存储路径（班兔自有合同云）',
    `file_size_kb` INT NULL 
        COMMENT '文件大小',
    `file_type` VARCHAR(50) NULL 
        COMMENT '文件MIME类型',
    `uploaded_by` CHAR(36) NULL 
        COMMENT '上传人ID（外键 → users.id，可为客户通过临时链接上传）',
    `uploaded_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '上传时间',
    `validation_status` ENUM('pending', 'passed', 'failed') NOT NULL DEFAULT 'pending' 
        COMMENT '校验状态：pending(待校验), passed(通过), failed(失败)',
    `validation_message` TEXT NULL 
        COMMENT '校验失败原因',
    `status` ENUM('submitted', 'approved', 'rejected') NOT NULL DEFAULT 'submitted' 
        COMMENT '审批状态',
    `approved_by` CHAR(36) NULL 
        COMMENT '审批人ID（外键 → users.id）',
    `approved_at` DATETIME NULL 
        COMMENT '审批时间',
    `approval_notes` TEXT NULL 
        COMMENT '审批备注',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_contract_rule_once` (`contract_id`, `rule_id`) 
        COMMENT '同一合同同一规则只允许上传一次（可扩展支持多份）',
    KEY `ix_material_contract_id` (`contract_id`),
    KEY `ix_material_opportunity_id` (`opportunity_id`),
    KEY `ix_material_quotation_item_id` (`quotation_item_id`),
    KEY `ix_material_rule_id` (`rule_id`),
    KEY `ix_material_wechat_group_no` (`wechat_group_no`),
    KEY `ix_material_validation_status` (`validation_status`),
    KEY `ix_material_status` (`status`),
    CONSTRAINT `fk_material_contract_id` 
        FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_material_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_material_quotation_item_id` 
        FOREIGN KEY (`quotation_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_material_product_id` 
        FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_material_rule_id` 
        FOREIGN KEY (`rule_id`) REFERENCES `product_document_rules` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `fk_material_uploaded_by` 
        FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_material_approved_by` 
        FOREIGN KEY (`approved_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='合同资料收集表 - 实际上传资料、校验、审批，支持群编号与服务关联';

-- ============================================================
-- 3. 新表：material_notification_emails（资料相关邮件通知记录）
--    支持国外bantumail.service邮件发送记录（重置密码、通知客户上传资料等）
-- ============================================================
CREATE TABLE IF NOT EXISTS `material_notification_emails` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '邮件记录ID',
    `contract_id` CHAR(36) NULL 
        COMMENT '关联合同ID（外键 → contracts.id）',
    `opportunity_id` CHAR(36) NULL 
        COMMENT '关联商机ID（外键 → opportunities.id）',
    `material_document_id` CHAR(36) NULL 
        COMMENT '关联资料记录ID（外键 → contract_material_documents.id）',
    `email_type` VARCHAR(100) NOT NULL 
        COMMENT '邮件类型（如：upload_reminder, approval_notification, docs_missing）',
    `recipient_email` VARCHAR(255) NOT NULL 
        COMMENT '收件人邮箱',
    `subject` VARCHAR(500) NOT NULL 
        COMMENT '邮件主题',
    `body_preview` TEXT NULL 
        COMMENT '邮件正文预览（前200字符）',
    `sent_at` DATETIME NULL 
        COMMENT '发送时间',
    `sent_status` ENUM('queued', 'sent', 'failed') NOT NULL DEFAULT 'queued' 
        COMMENT '发送状态',
    `error_message` TEXT NULL 
        COMMENT '失败原因',
    `sent_by` CHAR(36) NULL 
        COMMENT '触发发送人ID（外键 → users.id）',

    PRIMARY KEY (`id`),
    KEY `ix_email_contract_id` (`contract_id`),
    KEY `ix_email_opportunity_id` (`opportunity_id`),
    KEY `ix_email_material_id` (`material_document_id`),
    KEY `ix_email_recipient` (`recipient_email`),
    KEY `ix_email_sent_status` (`sent_status`),
    CONSTRAINT `fk_email_contract_id` 
        FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_email_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_email_material_id` 
        FOREIGN KEY (`material_document_id`) REFERENCES `contract_material_documents` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_email_sent_by` 
        FOREIGN KEY (`sent_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='资料办理邮件通知记录表 - 支持bantumail.service发送追踪（如催资料、审批通知）';

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 后台先为每个产品（products）配置 product_document_rules（支持图片尺寸校验、文件类型、依赖链）
-- 2. 合同生成后，系统根据合同内服务明细自动生成所需资料清单（contract_material_documents 待上传记录）
-- 3. 客户/销售通过临时链接上传 → 存储到班兔合同云 OSS → 自动校验 validation_rules_json
-- 4. 校验通过后进入审批 → 审批通过后触发“释放金额”（应用层控制付款）
-- 5. 所有关键动作（如催资料）通过 bantumail.service 发送邮件，并记录到 material_notification_emails
-- 6. 高扩展性：新增资料类型只需扩展 document_type 枚举 + validation_rules_json 字段即可
```

此结构完全满足**办理资料阶段**所有需求：
- 每个服务产品独立配置资料规则（类型、格式、依赖、校验），扩展性极高
- 实际资料上传与合同/服务明细/群编号强关联
- 自动校验 + 审批流程，审批通过后可释放金额
- 所有文件存自有合同云 OSS
- 邮件通知支持自建 bantumail.service（记录发送状态）

与前阶段（报价单、合同）无缝对接，可直接执行。

```sql
-- ============================================================
-- BANTU CRM 第八阶段（分配执行 Assign Execution）完整表结构变更 SQL
-- ============================================================
-- 涵盖以下所有功能：
-- 1. 执行订单主表（支持从合同/商机拆分生成多个执行订单）
-- 2. 执行订单明细（细粒度任务，支持服务类别区分）
-- 3. 订单依赖关系（公司注册 → 签证/KITAS → 后续服务释放逻辑）
-- 4. 执行任务分配（分配给个人/团队，基于审批结果）
-- 5. 群编号聚合 + 公司注册信息记录
-- 6. 资料依赖检查整合（与办理资料阶段联动）
-- 所有外键命名统一为 target_table_id 规范
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 新表：execution_orders（执行订单主表）
--    支持从合同拆分生成多个执行订单（一次性服务独立订单，长周期服务独立订单）
-- ============================================================
CREATE TABLE IF NOT EXISTS `execution_orders` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '执行订单ID',
    `order_no` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '执行订单编号（如：EXEC-20251228-001）',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `contract_id` CHAR(36) NULL 
        COMMENT '关联合同ID（外键 → contracts.id）',
    `parent_order_id` CHAR(36) NULL 
        COMMENT '父订单ID（外键 → execution_orders.id，用于组合单拆分后的主订单）',
    `order_type` ENUM('main', 'one_time', 'long_term', 'company_registration', 'visa_kitas') NOT NULL 
        COMMENT '订单类型：main(主订单), one_time(一次性), long_term(长周期), company_registration(公司注册), visa_kitas(签证/KITAS)',
    `wechat_group_no` VARCHAR(100) NULL 
        COMMENT '关联微信群编号（继承自商机/报价单，用于逻辑链路聚合）',
    `requires_company_registration` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否需要公司注册（1=是，作为必须条件判断）',
    `company_registration_order_id` CHAR(36) NULL 
        COMMENT '关联的公司注册执行订单ID（外键 → execution_orders.id）',
    `status` ENUM('pending', 'in_progress', 'completed', 'blocked', 'cancelled') NOT NULL DEFAULT 'pending' 
        COMMENT '订单状态：blocked(依赖阻塞)',
    `planned_start_date` DATE NULL 
        COMMENT '计划开始日期',
    `planned_end_date` DATE NULL 
        COMMENT '计划结束日期',
    `actual_start_date` DATE NULL,
    `actual_end_date` DATE NULL,
    `assigned_to` CHAR(36) NULL 
        COMMENT '分配执行人ID（外键 → users.id）',
    `assigned_team` VARCHAR(100) NULL 
        COMMENT '分配团队（如：中台交付组、签证组）',
    `assigned_at` DATETIME NULL 
        COMMENT '分配时间',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id，通常系统自动或销售）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_execution_order_no` (`order_no`),
    KEY `ix_execution_orders_opportunity_id` (`opportunity_id`),
    KEY `ix_execution_orders_contract_id` (`contract_id`),
    KEY `ix_execution_orders_parent_order_id` (`parent_order_id`),
    KEY `ix_execution_orders_company_reg_order_id` (`company_registration_order_id`),
    KEY `ix_execution_orders_wechat_group_no` (`wechat_group_no`),
    KEY `ix_execution_orders_status` (`status`),
    KEY `ix_execution_orders_assigned_to` (`assigned_to`),
    CONSTRAINT `fk_execution_orders_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_execution_orders_contract_id` 
        FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_execution_orders_parent_order_id` 
        FOREIGN KEY (`parent_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_execution_orders_company_reg_order_id` 
        FOREIGN KEY (`company_registration_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_execution_orders_assigned_to` 
        FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_execution_orders_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='执行订单主表 - 支持订单拆分、类型区分、公司注册依赖、群编号聚合、任务分配';

-- ============================================================
-- 2. 新表：execution_order_items（执行订单明细表）
--    细粒度任务，便于跟踪每项服务执行
-- ============================================================
CREATE TABLE IF NOT EXISTS `execution_order_items` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '明细ID',
    `execution_order_id` CHAR(36) NOT NULL 
        COMMENT '执行订单ID（外键 → execution_orders.id）',
    `quotation_item_id` CHAR(36) NULL 
        COMMENT '关联报价单明细ID（外键 → quotation_items.id）',
    `product_id` CHAR(36) NULL 
        COMMENT '产品ID（外键 → products.id）',
    `item_name` VARCHAR(255) NOT NULL 
        COMMENT '服务名称',
    `service_category` ENUM('one_time', 'long_term') NOT NULL 
        COMMENT '服务类别（继承自报价单）',
    `status` ENUM('pending', 'in_progress', 'completed', 'blocked') NOT NULL DEFAULT 'pending' 
        COMMENT '明细状态',
    `assigned_to` CHAR(36) NULL 
        COMMENT '分配执行人ID（外键 → users.id，可覆盖订单级别分配）',
    `notes` TEXT NULL 
        COMMENT '执行备注',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (`id`),
    KEY `ix_order_items_execution_order_id` (`execution_order_id`),
    KEY `ix_order_items_quotation_item_id` (`quotation_item_id`),
    KEY `ix_order_items_status` (`status`),
    CONSTRAINT `fk_order_items_execution_order_id` 
        FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_order_items_quotation_item_id` 
        FOREIGN KEY (`quotation_item_id`) REFERENCES `quotation_items` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_order_items_product_id` 
        FOREIGN KEY (`product_id`) REFERENCES `products` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_order_items_assigned_to` 
        FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='执行订单明细表 - 细粒度服务任务跟踪';

-- ============================================================
-- 3. 新表：execution_order_dependencies（执行订单依赖关系表）
--    实现流转逻辑：公司注册完成 → 释放签证 → 释放后续
-- ============================================================
CREATE TABLE IF NOT EXISTS `execution_order_dependencies` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '依赖关系ID',
    `execution_order_id` CHAR(36) NOT NULL 
        COMMENT '当前订单ID（外键 → execution_orders.id，被依赖方）',
    `prerequisite_order_id` CHAR(36) NOT NULL 
        COMMENT '前置依赖订单ID（外键 → execution_orders.id，如公司注册订单）',
    `dependency_type` ENUM('company_registration', 'visa_kitas', 'sbu_quota', 'material_approval') NOT NULL 
        COMMENT '依赖类型',
    `status` ENUM('pending', 'satisfied', 'blocked') NOT NULL DEFAULT 'pending' 
        COMMENT '依赖满足状态',
    `satisfied_at` DATETIME NULL 
        COMMENT '依赖满足时间',
    `notes` TEXT NULL,

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_order_prerequisite` (`execution_order_id`, `prerequisite_order_id`),
    KEY `ix_dependencies_execution_order_id` (`execution_order_id`),
    KEY `ix_dependencies_prerequisite_order_id` (`prerequisite_order_id`),
    KEY `ix_dependencies_status` (`status`),
    CONSTRAINT `fk_dependencies_execution_order_id` 
        FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_dependencies_prerequisite_order_id` 
        FOREIGN KEY (`prerequisite_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='执行订单依赖关系表 - 实现公司注册→签证→后续释放逻辑，支持SBU/配额依赖';

-- ============================================================
-- 4. 新表：company_registration_info（公司注册信息记录表）
--    专用于记录公司注册执行订单的关键信息，便于后续查询和依赖释放
-- ============================================================
CREATE TABLE IF NOT EXISTS `company_registration_info` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '记录ID',
    `execution_order_id` CHAR(36) NOT NULL 
        COMMENT '公司注册执行订单ID（外键 → execution_orders.id，一对一）',
    `company_name` VARCHAR(255) NOT NULL 
        COMMENT '公司名称',
    `nib` VARCHAR(100) NULL 
        COMMENT 'NIB企业登记证号',
    `npwp` VARCHAR(100) NULL 
        COMMENT '税卡号',
    `izin_lokasi` VARCHAR(100) NULL 
        COMMENT '公司户籍',
    `akta` VARCHAR(100) NULL 
        COMMENT '公司章程',
    `sk` VARCHAR(100) NULL 
        COMMENT '司法部批文',
    `registration_status` ENUM('in_progress', 'completed', 'failed') NOT NULL DEFAULT 'in_progress' 
        COMMENT '注册状态',
    `completed_at` DATETIME NULL 
        COMMENT '注册完成时间（触发后续订单释放）',
    `notes` TEXT NULL,
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_company_reg_order_id` (`execution_order_id`),
    KEY `ix_company_reg_status` (`registration_status`),
    CONSTRAINT `fk_company_reg_execution_order_id` 
        FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='公司注册信息记录表 - 记录NIB、NPWP等关键信息，用于依赖查询和释放后续订单';

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 合同签署后，系统根据 quotation_items.service_category 自动拆分 execution_orders：
--    - 包含公司注册服务 → 生成 company_registration 类型订单
--    - 包含签证/KITAS → 生成 visa_kitas 类型，依赖 company_registration_order_id
--    - 长周期（如财税） → 生成 long_term 独立订单
--    - 其他 → one_time 订单
-- 2. 流转逻辑（应用层控制）：
--    - 无公司注册：直接分配执行
--    - 有公司注册：设置 requires_company_registration=1，所有下游订单 status='blocked'，记录依赖
--    - 公司注册完成（company_registration_info.completed_at 不为空）→ 自动释放签证订单
--    - 签证完成 → 释放所有剩余订单
-- 3. 分配执行：审批通过后设置 assigned_to / assigned_team
-- 4. 群编号继承自商机/报价单，所有相关订单统一 wechat_group_no，便于链路查询
-- 5. 资料依赖检查：在分配前校验 contract_material_documents 中相关规则是否 approved
```

此结构完全满足**分配执行阶段**所有需求：
- 支持订单自动/手动拆分（长周期 vs 一次性）
- 严格实现公司注册依赖流转逻辑（阻塞 → 释放）
- 细粒度任务分配（订单级 + 明细级）
- 群编号全链路聚合
- 公司注册关键信息持久化记录
- 与资料办理阶段（contract_material_documents）无缝联动检查

所有表与前阶段（合同、报价单、办理资料）完美衔接，可直接执行。


-- ============================================================
-- BANTU CRM 第九阶段（收款 Collection）完整表结构变更 SQL
-- ============================================================
-- 涵盖以下所有功能：
-- 1. 收款记录主表（支持多笔部分回款、多种模式）
-- 2. 收款凭证上传（整合合同云 OSS 存储）
-- 3. 交付检查与最终收款状态（整合执行订单依赖完成、长周期拆分）
-- 4. 待办事项与提醒（新订单释放通知、财务核对提醒）
-- 5. 签约主体税点一致性校验（回款金额含税匹配合同）
-- 所有外键命名统一为 target_table_id 规范
-- 生成时间: 2025-12-28
-- ============================================================

SET NAMES utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
SET FOREIGN_KEY_CHECKS = 0;

-- ============================================================
-- 1. 新表：payments（收款记录主表）
--    支持多笔回款、部分回款、多种模式（上传凭证、Lulu核对）
-- ============================================================
CREATE TABLE IF NOT EXISTS `payments` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '收款记录ID',
    `payment_no` VARCHAR(50) NOT NULL UNIQUE 
        COMMENT '收款编号（如：PAY-20251228-001）',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `contract_id` CHAR(36) NULL 
        COMMENT '关联合同ID（外键 → contracts.id）',
    `execution_order_id` CHAR(36) NULL 
        COMMENT '关联执行订单ID（外键 → execution_orders.id，支持长周期独立回款）',
    `entity_id` CHAR(36) NOT NULL 
        COMMENT '签约主体ID（外键 → contract_entities.id，确保税点一致）',
    `amount` DECIMAL(18,2) NOT NULL 
        COMMENT '本次收款金额（含税）',
    `tax_amount` DECIMAL(18,2) NOT NULL DEFAULT 0.00 
        COMMENT '本次税额（冗余，便于核对）',
    `currency` VARCHAR(10) NOT NULL 
        COMMENT '币种：CNY 或 IDR',
    `payment_method` VARCHAR(100) NULL 
        COMMENT '付款方式（如：银行转账、微信、支付宝）',
    `payment_mode` ENUM('full', 'partial', 'prepayment', 'final') NOT NULL 
        COMMENT '回款模式：full(全款), partial(部分), prepayment(预付), final(尾款)',
    `status` ENUM('pending_review', 'confirmed', 'rejected', 'refunded') NOT NULL DEFAULT 'pending_review' 
        COMMENT '收款状态：pending_review(待Lulu核对), confirmed(已确认), rejected(拒绝), refunded(退款)',
    `reviewed_by` CHAR(36) NULL 
        COMMENT '核对人ID（外键 → users.id，通常Lulu）',
    `reviewed_at` DATETIME NULL 
        COMMENT '核对时间',
    `review_notes` TEXT NULL 
        COMMENT '核对备注',
    `received_at` DATE NULL 
        COMMENT '到账日期',
    `is_final_payment` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否尾款（1=是，触发最终收款检查）',
    `delivery_verified` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '交付已验证（1=是，所有执行订单及依赖完成）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    `created_by` CHAR(36) NULL 
        COMMENT '创建人ID（外键 → users.id，通常销售或客户上传）',

    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_payment_no` (`payment_no`),
    KEY `ix_payments_opportunity_id` (`opportunity_id`),
    KEY `ix_payments_contract_id` (`contract_id`),
    KEY `ix_payments_execution_order_id` (`execution_order_id`),
    KEY `ix_payments_entity_id` (`entity_id`),
    KEY `ix_payments_status` (`status`),
    KEY `ix_payments_is_final_payment` (`is_final_payment`),
    CONSTRAINT `fk_payments_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_payments_contract_id` 
        FOREIGN KEY (`contract_id`) REFERENCES `contracts` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_payments_execution_order_id` 
        FOREIGN KEY (`execution_order_id`) REFERENCES `execution_orders` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_payments_entity_id` 
        FOREIGN KEY (`entity_id`) REFERENCES `contract_entities` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `fk_payments_reviewed_by` 
        FOREIGN KEY (`reviewed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_payments_created_by` 
        FOREIGN KEY (`created_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='收款记录表 - 支持多笔回款、部分回款、Lulu核对、税点一致性、交付验证';

-- ============================================================
-- 2. 新表：payment_vouchers（收款凭证上传表）
--    收款凭证上传后整合合同云 OSS 存储
-- ============================================================
CREATE TABLE IF NOT EXISTS `payment_vouchers` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '凭证记录ID',
    `payment_id` CHAR(36) NOT NULL 
        COMMENT '收款记录ID（外键 → payments.id）',
    `file_name` VARCHAR(255) NOT NULL 
        COMMENT '凭证文件名（如：转账截图.jpg）',
    `file_url` VARCHAR(500) NOT NULL 
        COMMENT 'OSS存储路径（班兔合同云）',
    `file_size_kb` INT NULL 
        COMMENT '文件大小',
    `uploaded_by` CHAR(36) NULL 
        COMMENT '上传人ID（外键 → users.id，通常销售或客户）',
    `uploaded_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP 
        COMMENT '上传时间',
    `is_primary` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否主要凭证（1=是，用于核对）',

    PRIMARY KEY (`id`),
    KEY `ix_payment_vouchers_payment_id` (`payment_id`),
    KEY `ix_payment_vouchers_is_primary` (`is_primary`),
    CONSTRAINT `fk_payment_vouchers_payment_id` 
        FOREIGN KEY (`payment_id`) REFERENCES `payments` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_payment_vouchers_uploaded_by` 
        FOREIGN KEY (`uploaded_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='收款凭证上传表 - 存储转账截图等凭证，整合合同云 OSS';

-- ============================================================
-- 3. 新表：collection_todos（收款待办事项与提醒表）
--    支持新订单释放通知、财务核对提醒等
-- ============================================================
CREATE TABLE IF NOT EXISTS `collection_todos` (
    `id` CHAR(36) NOT NULL DEFAULT (UUID()) 
        COMMENT '待办ID',
    `opportunity_id` CHAR(36) NOT NULL 
        COMMENT '商机ID（外键 → opportunities.id）',
    `payment_id` CHAR(36) NULL 
        COMMENT '关联收款ID（外键 → payments.id）',
    `todo_type` ENUM('check_payment', 'verify_delivery', 'release_new_order', 'finance_review', 'send_notification') NOT NULL 
        COMMENT '待办类型：check_payment(检查款项), verify_delivery(验证交付), release_new_order(释放新订单), finance_review(财务核对), send_notification(发送通知)',
    `title` VARCHAR(255) NOT NULL 
        COMMENT '待办标题',
    `description` TEXT NULL 
        COMMENT '详细描述',
    `assigned_to` CHAR(36) NULL 
        COMMENT '分配人ID（外键 → users.id，如Lulu核对）',
    `due_date` DATETIME NULL 
        COMMENT '截止时间',
    `status` ENUM('pending', 'in_progress', 'completed', 'cancelled') NOT NULL DEFAULT 'pending' 
        COMMENT '待办状态',
    `completed_at` DATETIME NULL 
        COMMENT '完成时间',
    `completed_by` CHAR(36) NULL 
        COMMENT '完成人ID（外键 → users.id）',
    `notification_sent` TINYINT(1) NOT NULL DEFAULT 0 
        COMMENT '是否已发送提醒（1=是）',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY (`id`),
    KEY `ix_collection_todos_opportunity_id` (`opportunity_id`),
    KEY `ix_collection_todos_payment_id` (`payment_id`),
    KEY `ix_collection_todos_assigned_to` (`assigned_to`),
    KEY `ix_collection_todos_status` (`status`),
    KEY `ix_collection_todos_type` (`todo_type`),
    CONSTRAINT `fk_collection_todos_opportunity_id` 
        FOREIGN KEY (`opportunity_id`) REFERENCES `opportunities` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_collection_todos_payment_id` 
        FOREIGN KEY (`payment_id`) REFERENCES `payments` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_collection_todos_assigned_to` 
        FOREIGN KEY (`assigned_to`) REFERENCES `users` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_collection_todos_completed_by` 
        FOREIGN KEY (`completed_by`) REFERENCES `users` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci 
  COMMENT='收款待办事项表 - 支持检查款项、交付验证、新订单释放通知、财务核对提醒';

-- ============================================================
-- 4. 修改 opportunities 表（记录收款完成状态）
-- ============================================================
ALTER TABLE `opportunities`
    ADD COLUMN `collection_status` ENUM('not_started', 'partial', 'full', 'overpaid') NOT NULL DEFAULT 'not_started' 
        COMMENT '整体收款状态：not_started(未开始), partial(部分回款), full(全额回款), overpaid(超收)' AFTER `workflow_status`,
    ADD COLUMN `total_received_amount` DECIMAL(18,2) NOT NULL DEFAULT 0.00 
        COMMENT '已收总金额（冗余，自动维护）' AFTER `collection_status`,
    ADD COLUMN `final_payment_id` CHAR(36) NULL 
        COMMENT '尾款记录ID（外键 → payments.id）' AFTER `total_received_amount`,
    ADD CONSTRAINT `fk_opportunities_final_payment_id` 
        FOREIGN KEY (`final_payment_id`) REFERENCES `payments` (`id`) ON DELETE SET NULL;

-- ============================================================
-- 完成
-- ============================================================
SET FOREIGN_KEY_CHECKS = 1;

-- 使用说明：
-- 1. 交付检查增强（应用层）：
--    - 尾款支付（is_final_payment=1）时，检查所有 execution_orders.status='completed' 且依赖 satisfied
--    - 检查长周期订单是否按月确认（可通过 payment_mode='partial' 记录）
--    - 全部满足 → 设置 payments.delivery_verified=1，更新 opportunities.collection_status='full'
-- 2. 待办与提醒：
--    - 收款上传 → 自动创建 collection_todos（type='finance_review', assigned_to=Lulu）
--    - 尾款确认 + 交付验证通过 → 创建 type='release_new_order' 待办，发送通知
-- 3. 签约主体与税点：
--    - 收款时 entity_id 必须与 contract.entity_id 一致，金额含税匹配 contract.total_amount_with_tax
-- 4. OSS支持：
--    - 凭证上传到 payment_vouchers.file_url（班兔合同云 OSS）
-- 5. 最终收款触发：
--    - opportunities.collection_status='full' → 可关闭商机或释放后续业务