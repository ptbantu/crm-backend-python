# 6. 联系人管理

## 6.1 创建联系人

### 核心业务逻辑说明
为客户创建联系人，支持设置主要联系人，一个客户只能有一个主要联系人。

### 详细业务逻辑

#### 6.1.1 联系人创建流程
1. **验证客户存在**
   - 验证客户ID是否存在

2. **验证输入数据**
   - 验证姓名不能为空
   - 验证邮箱格式（如果提供）
   - 验证手机号格式（如果提供）

3. **处理主要联系人**
   - 如果设置为主要联系人（`is_primary = True`），先取消该客户的其他主要联系人
   - 确保一个客户只有一个主要联系人

4. **创建联系人记录**
   - 设置联系人基本信息（姓名、邮箱、手机、微信等）
   - 设置联系人职位、部门
   - 设置联系人角色（决策者、影响者等）
   - 设置联系人地址信息
   - 设置首选联系方式

5. **返回创建结果**
   - 返回联系人信息

### 关键文件路径
- **API端点**: `service_management/api/v1/contacts.py` - `POST /api/v1/customers/{customer_id}/contacts`
- **服务层**: `service_management/services/contact_service.py` - `ContactService.create_contact()`
- **数据访问层**: `service_management/repositories/contact_repository.py`
- **模型定义**: `common/models/contact.py` - `Contact`

### 代码位置引用
```python
# service_management/services/contact_service.py
async def create_contact(self, request: ContactCreateRequest) -> ContactResponse:
    # 1. 验证客户是否存在
    customer = await self.customer_repo.get_by_id(request.customer_id)
    if not customer:
        raise BusinessException(detail="客户不存在", status_code=404)
    
    # 2. 如果设置为主要联系人，取消其他主要联系人
    if request.is_primary:
        await self.contact_repo.set_primary_contact("", request.customer_id)  # 先取消所有
    
    # 3. 创建联系人
    contact = Contact(
        customer_id=request.customer_id,
        first_name=request.first_name,
        last_name=request.last_name,
        email=request.email,
        phone=request.phone,
        mobile=request.mobile,
        wechat_id=request.wechat_id,
        position=request.position,
        department=request.department,
        contact_role=request.contact_role,
        is_primary=request.is_primary,
        is_decision_maker=request.is_decision_maker,
        address=request.address,
        preferred_contact_method=request.preferred_contact_method,
    )
    contact = await self.contact_repo.create(contact)
    
    # 4. 如果设置为主要联系人，确保设置成功
    if request.is_primary:
        await self.contact_repo.set_primary_contact(contact.id, request.customer_id)
        await self.db.refresh(contact)
    
    return await self._to_response(contact)
```

### 潜在问题与注意事项
1. **主要联系人**: 一个客户只能有一个主要联系人，设置新的主要联系人时会自动取消旧的
2. **联系人角色**: 联系人角色用于标识联系人在采购决策中的角色（决策者、影响者、使用者等）
3. **首选联系方式**: 记录联系人的首选联系方式（电话、邮件、微信等），用于后续沟通

---

## 6.2 更新联系人

### 核心业务逻辑说明
更新联系人信息，包括基本信息、联系方式、职位等。

### 详细业务逻辑
1. **验证联系人存在**
   - 查询联系人是否存在

2. **验证输入数据**
   - 验证邮箱格式（如果修改邮箱）
   - 验证手机号格式（如果修改手机）

3. **处理主要联系人**
   - 如果设置为主要联系人，取消该客户的其他主要联系人

4. **更新联系人信息**
   - 更新联系人基本信息
   - 更新联系方式
   - 更新职位、部门
   - 更新其他字段

5. **返回更新结果**

### 关键文件路径
- **API端点**: `service_management/api/v1/contacts.py` - `PUT /api/v1/contacts/{contact_id}`
- **服务层**: `service_management/services/contact_service.py` - `ContactService.update_contact()`

---

## 6.3 查询联系人列表

### 核心业务逻辑说明
根据客户ID查询联系人列表，支持分页和搜索。

### 详细业务逻辑
1. **验证客户存在**
   - 验证客户ID是否存在

2. **查询过滤**
   - 支持按联系人姓名搜索
   - 支持按邮箱、手机号搜索
   - 支持按职位、部门过滤
   - 支持按角色过滤（决策者、影响者等）

3. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

4. **返回结果**
   - 返回联系人列表
   - 标识主要联系人

### 关键文件路径
- **API端点**: `service_management/api/v1/contacts.py` - `GET /api/v1/customers/{customer_id}/contacts`
- **服务层**: `service_management/services/contact_service.py` - `ContactService.get_contact_list()`

---

## 6.4 查询联系人详情

### 核心业务逻辑说明
根据联系人ID查询联系人详细信息。

### 详细业务逻辑
1. **验证联系人存在**
   - 查询联系人是否存在

2. **返回结果**
   - 返回完整的联系人信息

### 关键文件路径
- **API端点**: `service_management/api/v1/contacts.py` - `GET /api/v1/contacts/{contact_id}`
- **服务层**: `service_management/services/contact_service.py` - `ContactService.get_contact_by_id()`

---

## 6.5 删除联系人

### 核心业务逻辑说明
删除联系人，不能删除客户的主要联系人（需要先取消主要联系人设置）。

### 详细业务逻辑
1. **验证联系人存在**
   - 查询联系人是否存在

2. **检查主要联系人**
   - 如果是主要联系人，不能直接删除，需要先取消主要联系人设置

3. **删除联系人**
   - 删除联系人记录

4. **返回删除结果**

### 关键文件路径
- **API端点**: `service_management/api/v1/contacts.py` - `DELETE /api/v1/contacts/{contact_id}`
- **服务层**: `service_management/services/contact_service.py` - `ContactService.delete_contact()`


