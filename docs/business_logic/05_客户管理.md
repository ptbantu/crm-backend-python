# 5. 客户管理

## 5.1 创建客户

### 核心业务逻辑说明
创建新客户，支持企业客户和个人客户，可以设置父客户（客户层级关系），并分配负责人和代理商。

### 详细业务逻辑

#### 5.1.1 客户创建流程
1. **验证输入数据**
   - 验证客户编码唯一性（如果提供编码）
   - 验证客户名称不能为空
   - 验证客户类型（企业/个人）

2. **验证父客户**
   - 如果指定了父客户ID，验证父客户是否存在
   - 父客户必须存在且未被锁定

3. **创建客户记录**
   - 设置客户基本信息（名称、编码、类型）
   - 设置客户来源信息（来源类型、来源ID、渠道ID）
   - 设置客户负责人（`owner_user_id`）
   - 设置代理商信息（`agent_user_id`、`agent_id`）
   - 设置客户级别（`level`）
   - 设置客户行业、描述、标签等

4. **返回创建结果**
   - 返回客户信息（包含父客户名称、负责人名称等）

### 关键文件路径
- **API端点**: `service_management/api/v1/customers.py` - `POST /api/v1/customers`
- **服务层**: `service_management/services/customer_service.py` - `CustomerService.create_customer()`
- **数据访问层**: `service_management/repositories/customer_repository.py`
- **模型定义**: `common/models/customer.py` - `Customer`

### 代码位置引用
```python
# service_management/services/customer_service.py
async def create_customer(self, request: CustomerCreateRequest) -> CustomerResponse:
    # 1. 检查编码是否已存在
    if request.code:
        existing = await self.customer_repo.get_by_code(request.code)
        if existing:
            raise BusinessException(detail=f"客户编码 {request.code} 已存在")
    
    # 2. 验证父客户
    if request.parent_customer_id:
        parent = await self.customer_repo.get_by_id(request.parent_customer_id)
        if not parent:
            raise BusinessException(detail="父客户不存在")
    
    # 3. 创建客户
    customer = Customer(
        name=request.name,
        code=request.code,
        customer_type=request.customer_type,
        customer_source_type=request.customer_source_type,
        parent_customer_id=request.parent_customer_id,
        owner_user_id=request.owner_user_id,
        agent_user_id=request.agent_user_id,
        level=request.level,
        industry=request.industry,
        description=request.description,
        tags=request.tags or [],
    )
    customer = await self.customer_repo.create(customer)
    
    return await self._to_response(customer)
```

### 潜在问题与注意事项
1. **客户编码**: 客户编码可选，但如果提供必须唯一
2. **父客户关系**: 支持客户层级关系，但需要防止循环引用
3. **客户级别**: 客户级别（`level`）用于客户分级管理，影响线索分配和订单处理
4. **数据隔离**: 客户数据按组织隔离，只能查看和操作本组织的客户

---

## 5.2 更新客户

### 核心业务逻辑说明
更新客户信息，包括基本信息、负责人、代理商等，支持修改父客户关系。

### 详细业务逻辑
1. **验证客户存在**
   - 查询客户是否存在

2. **验证输入数据**
   - 如果修改客户编码，验证新编码唯一性（排除自身）
   - 如果修改父客户，验证父客户存在
   - 防止循环引用（不能将客户设置为自己的父客户）

3. **更新客户信息**
   - 更新客户基本信息
   - 更新客户负责人
   - 更新代理商信息
   - 更新客户级别
   - 更新其他字段

4. **返回更新结果**

### 关键文件路径
- **API端点**: `service_management/api/v1/customers.py` - `PUT /api/v1/customers/{customer_id}`
- **服务层**: `service_management/services/customer_service.py` - `CustomerService.update_customer()`

### 代码位置引用
```python
# service_management/services/customer_service.py
async def update_customer(self, customer_id: str, request: CustomerUpdateRequest) -> CustomerResponse:
    customer = await self.customer_repo.get_by_id(customer_id)
    if not customer:
        raise BusinessException(detail="客户不存在", status_code=404)
    
    # 如果更新编码，检查是否已存在（排除自身）
    if request.code is not None and request.code != customer.code:
        existing = await self.customer_repo.get_by_code(request.code)
        if existing:
            raise BusinessException(detail=f"客户编码 {request.code} 已存在")
    
    # 如果更新父客户，验证父客户是否存在并防止循环引用
    if request.parent_customer_id is not None and request.parent_customer_id != customer.parent_customer_id:
        if request.parent_customer_id:
            parent = await self.customer_repo.get_by_id(request.parent_customer_id)
            if not parent:
                raise BusinessException(detail="父客户不存在")
            # 防止循环引用
            if request.parent_customer_id == customer_id:
                raise BusinessException(detail="不能将客户设置为自己的父客户")
    
    # 更新字段
    if request.name is not None:
        customer.name = request.name
    if request.code is not None:
        customer.code = request.code
    # ... 其他字段更新
    
    customer = await self.customer_repo.update(customer)
    return await self._to_response(customer)
```

---

## 5.3 查询客户列表

### 核心业务逻辑说明
根据组织ID查询客户列表，支持分页、搜索和多种过滤条件。

### 详细业务逻辑
1. **数据隔离**
   - 只能查询当前用户所属组织的客户

2. **查询过滤**
   - 支持按客户名称、编码搜索
   - 支持按客户类型过滤（企业/个人）
   - 支持按客户级别过滤
   - 支持按负责人过滤（`owner_user_id`）
   - 支持按行业过滤
   - 支持按标签过滤

3. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

4. **返回结果**
   - 返回客户列表（包含父客户名称、负责人名称等）

### 关键文件路径
- **API端点**: `service_management/api/v1/customers.py` - `GET /api/v1/customers`
- **服务层**: `service_management/services/customer_service.py` - `CustomerService.get_customer_list()`
- **数据访问层**: `service_management/repositories/customer_repository.py` - `get_list()`

---

## 5.4 查询客户详情

### 核心业务逻辑说明
根据客户ID查询客户详细信息，包括基本信息、联系人、订单历史等。

### 详细业务逻辑
1. **验证客户存在**
   - 查询客户是否存在
   - 验证客户是否属于当前组织

2. **查询关联数据**
   - 查询客户联系人列表
   - 查询客户订单列表（可选）
   - 查询客户线索列表（可选）

3. **返回结果**
   - 返回完整的客户信息

### 关键文件路径
- **API端点**: `service_management/api/v1/customers.py` - `GET /api/v1/customers/{customer_id}`
- **服务层**: `service_management/services/customer_service.py` - `CustomerService.get_customer_by_id()`

---

## 5.5 删除客户

### 核心业务逻辑说明
删除客户，需要检查是否有关联数据（订单、线索等），如果有则不能删除。

### 详细业务逻辑
1. **验证客户存在**
   - 查询客户是否存在

2. **检查关联数据**
   - 检查是否有订单关联
   - 检查是否有线索关联
   - 检查是否有联系人关联
   - 如果有关联数据，不能删除

3. **删除客户**
   - 删除客户记录（软删除或物理删除）

4. **返回删除结果**

### 关键文件路径
- **API端点**: `service_management/api/v1/customers.py` - `DELETE /api/v1/customers/{customer_id}`
- **服务层**: `service_management/services/customer_service.py` - `CustomerService.delete_customer()`

---

## 5.6 客户分级管理

### 核心业务逻辑说明
根据客户的业务价值、订单金额、合作时间等因素，对客户进行分级管理（A/B/C/D级）。

### 详细业务逻辑
1. **客户级别定义**
   - A级：高价值客户（订单金额大、合作时间长）
   - B级：中价值客户
   - C级：低价值客户
   - D级：潜在客户

2. **级别计算规则**
   - 根据订单总金额
   - 根据订单数量
   - 根据合作时间
   - 根据客户活跃度

3. **级别更新**
   - 可以手动设置客户级别
   - 可以自动计算客户级别（定时任务）

### 关键文件路径
- **模型定义**: `common/models/customer.py` - `Customer.level`
- **模型定义**: `common/models/customer_level.py` - `CustomerLevel`（客户级别配置表）


