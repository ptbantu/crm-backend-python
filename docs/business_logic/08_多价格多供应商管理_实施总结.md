# 多价格多供应商管理 - 实施总结

**实施日期**: 2024-12-13  
**版本**: v1.0

---

## 实施内容

### 1. 业务逻辑设计文档

**文件**: `docs/business_logic/08_多价格多供应商管理.md`

**内容**:
- 核心概念说明（销售价格 vs 成本价格）
- 销售价格管理逻辑
- 成本价格管理逻辑
- 供应商选择逻辑
- 订单创建与价格快照逻辑
- 利润计算逻辑
- API设计

---

### 2. 服务层实现

#### 2.1 ProductPriceService（产品价格服务）

**文件**: `foundation_service/services/product_price_service.py`

**功能**:
- `get_sales_price()` - 查询销售价格（根据客户等级）
- `get_cost_price()` - 查询成本价格（服务提供方的成本）
- `get_available_suppliers()` - 获取可选供应商列表
- `select_supplier()` - 选择供应商（自动选择或使用指定供应商）

**关键逻辑**:
- 销售价格查询：根据客户等级从 `product_price_list` 表查询
- 成本价格查询：从 `supplier_cost_history` 表查询当前有效版本
- 供应商选择：支持自动选择（成本最低）或指定供应商

#### 2.2 ProfitCalculationService（利润计算服务）

**文件**: `foundation_service/services/profit_calculation_service.py`

**功能**:
- `calculate_order_item_profit()` - 计算订单项利润
- `calculate_order_profit()` - 计算订单总利润

**计算公式**:
```
订单项利润 = (销售价格 - 成本价格) * 数量 - 浮动成本（报销）
订单利润 = Σ(订单项利润) - 订单级浮动成本（报销）
```

#### 2.3 OrderItemService（订单项服务 - 已更新）

**文件**: `foundation_service/services/order_item_service.py`

**更新内容**:
- `create_order_item()` 方法已更新，添加价格快照逻辑
- 创建订单项时自动：
  1. 查询销售价格（根据客户等级）
  2. 选择或验证供应商
  3. 查询成本价格
  4. 计算预估毛利
  5. 快照价格到订单项

---

## 代码结构

```
foundation_service/services/
├── product_price_service.py          # 新增：产品价格服务
├── profit_calculation_service.py      # 新增：利润计算服务
└── order_item_service.py              # 更新：订单项服务（添加价格快照）
```

---

## 数据库表依赖

### 已创建的表

1. **product_price_list** - 销售价格体系表
2. **supplier_cost_history** - 成本价格版本控制表
3. **file_storage** - 文件存储表
4. **biz_expense_records** - 浮动成本/费用报销记录表

### 已修改的表

1. **products** - 添加 `std_duration_days`, `allow_multi_vendor`, `default_supplier_id`
2. **order_items** - 添加供应商和成本相关字段
3. **order_stages** - 添加进度预警字段

---

## API端点（待实现）

根据业务逻辑文档，需要实现以下API端点：

### 销售价格API

- `GET /api/foundation/products/{product_id}/sales-price` - 查询销售价格
- `PUT /api/foundation/products/{product_id}/sales-price` - 更新销售价格

### 成本价格API

- `GET /api/foundation/providers/{provider_id}/products/{product_id}/cost-price` - 查询成本价格
- `POST /api/foundation/providers/{provider_id}/products/{product_id}/cost-price` - 更新成本价格

### 供应商选择API

- `GET /api/foundation/products/{product_id}/suppliers` - 获取可选供应商列表

### 利润计算API

- `GET /api/order-workflow/order-items/{item_id}/profit` - 计算订单项利润
- `GET /api/order-workflow/orders/{order_id}/profit` - 计算订单利润

---

## 使用示例

### 1. 查询销售价格

```python
from foundation_service.services.product_price_service import ProductPriceService

price_service = ProductPriceService(db)
sales_price = await price_service.get_sales_price(
    product_id="uuid",
    customer_id="uuid",
    currency="CNY"
)
# 返回: {"price_cny": "1500.00", "price_idr": "3000000.00", ...}
```

### 2. 查询成本价格

```python
cost_price = await price_service.get_cost_price(
    product_id="uuid",
    supplier_id="uuid"
)
# 返回: {"cost_cny": "1800.00", "cost_idr": "3600000.00", ...}
```

### 3. 选择供应商

```python
supplier = await price_service.select_supplier(
    product_id="uuid",
    preferred_supplier_id="uuid"  # 可选
)
# 返回: 供应商成本价格信息
```

### 4. 计算利润

```python
from foundation_service.services.profit_calculation_service import ProfitCalculationService

profit_service = ProfitCalculationService(db)
profit = await profit_service.calculate_order_item_profit(order_item_id="uuid")
# 返回: {"profit_cny": "150.00", "profit_rate_cny": 0.075, ...}
```

### 5. 创建订单项（自动价格快照）

```python
from foundation_service.services.order_item_service import OrderItemService

order_item_service = OrderItemService(db)
order_item = await order_item_service.create_order_item(
    OrderItemCreateRequest(
        order_id="uuid",
        product_id="uuid",
        quantity=1
        # selected_supplier_id 可选，不提供则自动选择
    )
)
# 自动快照销售价格和成本价格
```

---

## 注意事项

### 1. 数据库模型

由于 `product_price_list` 和 `supplier_cost_history` 表可能还没有SQLAlchemy模型，当前实现使用原生SQL查询。建议后续创建对应的模型类。

### 2. 错误处理

- 如果产品未设置销售价格，会抛出 `NotFoundError`
- 如果服务提供方未设置成本价格，会抛出 `NotFoundError`
- 如果指定的供应商不可用，会抛出 `BusinessException`

### 3. 价格快照

- 订单创建时，会自动快照当前的销售价格和成本价格
- 即使后续价格变更，订单项的快照价格保持不变
- 利润核算基于快照价格，确保历史订单的利润计算准确

### 4. 供应商选择

- 如果产品 `allow_multi_vendor=False`，必须使用 `default_supplier_id`
- 如果未指定供应商，系统会自动选择成本最低的供应商
- 选择供应商时会自动验证 `delivery_type` 与 `supplier_id` 的一致性

---

## 下一步工作

1. **创建数据库模型**:
   - `ProductPriceList` 模型
   - `SupplierCostHistory` 模型
   - `FileStorage` 模型
   - `BizExpenseRecord` 模型

2. **实现API端点**:
   - 销售价格API
   - 成本价格API
   - 供应商选择API
   - 利润计算API

3. **单元测试**:
   - 测试价格查询逻辑
   - 测试供应商选择逻辑
   - 测试利润计算逻辑

4. **集成测试**:
   - 测试订单创建流程
   - 测试价格快照功能
   - 测试利润计算准确性

---

**更新日期**: 2024-12-13
