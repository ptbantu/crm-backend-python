# 8. 服务多供应商多价格管理

## 8.1 业务概述

### 8.1.1 核心业务场景

在企业服务管理系统中，我们面临以下业务场景：

1. **一个服务可以由多个供应商提供**
   - 例如："印尼工作签证 B211" 这个服务，可以由供应商A、供应商B、供应商C等多个供应商提供
   - 每个供应商提供的服务质量、价格、处理时间可能不同

2. **一个供应商可以提供多个服务**
   - 例如：供应商A可以提供"印尼工作签证"、"公司注册"、"财税服务"等多个服务
   - 供应商可以专注于某个领域，也可以提供全系列服务

3. **价格体系复杂**
   - 每个供应商对同一个服务有不同的**成本价**（供应商给我们的价格）
   - 我们对外销售时，需要设置**渠道价**（给渠道代理的价格）、**直客价**（给直接客户的价格）、**列表价**（公开报价）
   - 每种价格都需要支持两种货币：**人民币（CNY）**和**印尼盾（IDR）**

### 8.1.2 业务价值

通过多供应商多价格管理体系，我们可以：

- **灵活选择供应商**：根据客户需求、价格、处理时间等因素，选择最合适的供应商
- **价格策略管理**：针对不同客户类型设置不同的销售价格，实现利润最大化
- **供应商竞争**：多个供应商提供同一服务，形成竞争，有利于获得更好的价格和服务
- **风险分散**：不依赖单一供应商，降低业务风险

---

## 8.2 核心业务概念

### 8.2.1 服务（Product）

**定义**：服务是系统中管理的企业服务产品，例如"印尼工作签证 B211"、"公司注册"等。

**特点**：
- 服务是**全局共享**的，所有供应商都可以提供这个服务
- 服务的基本信息（名称、描述、所需资料等）是统一的
- 修改服务名称时，所有供应商都能看到更新

**示例**：
```
服务名称：印尼工作签证 B211
服务描述：适用于在印尼工作的外国人
所需资料：护照、照片、申请表、工作证明
处理时间：5-7个工作日（通用参考）
```

### 8.2.2 供应商（Supplier）

**定义**：供应商是提供服务的组织，可以是外部供应商或内部组织。

**特点**：
- 供应商在系统中注册为组织（Organization），类型为"vendor"（供应商）
- 每个供应商有唯一标识、名称、联系方式等信息
- 供应商可以设置自己提供哪些服务，以及每个服务的价格

**示例**：
```
供应商A：
- 名称：XX签证服务公司
- 联系方式：电话、邮箱
- 提供服务：印尼工作签证、商务签证、投资签证
- 服务数量：15个
```

### 8.2.3 供应商-服务关联（Vendor Product）

**定义**：供应商和服务之间的关联关系，记录供应商提供某个服务的具体信息。

**关键信息**：
- **成本价**：供应商给我们的价格（支持人民币和印尼盾两种货币）
- **处理天数**：该供应商处理该服务需要多少天（可能和通用时间不同）
- **是否可用**：该供应商当前是否提供此服务
- **是否主要供应商**：是否为主要供应商（优先级更高）
- **优先级**：数字越小优先级越高，用于自动选择供应商

**示例**：
```
服务：印尼工作签证 B211

供应商A的关联信息：
- 成本价：2,000,000 IDR（印尼盾）或 1,000 CNY（人民币）
- 处理天数：5天
- 是否可用：是
- 是否主要供应商：是
- 优先级：1

供应商B的关联信息：
- 成本价：1,800,000 IDR 或 900 CNY
- 处理天数：7天
- 是否可用：是
- 是否主要供应商：否
- 优先级：2
```

### 8.2.4 价格体系

**定义**：系统中管理的四种价格类型，用于不同销售场景。

**四种价格类型**：

1. **成本价（Cost Price）**
   - 供应商给我们的价格
   - 存储在供应商-服务关联中
   - 每个供应商对同一服务有不同的成本价

2. **渠道价（Channel Price）**
   - 我们给渠道代理的价格
   - 存储在服务价格表中
   - 可以是通用价格，也可以是针对特定供应商的价格

3. **直客价（Direct Price）**
   - 我们给直接客户的价格
   - 存储在服务价格表中
   - 通常比渠道价高，比列表价低

4. **列表价（List Price）**
   - 公开报价，最高价格
   - 存储在服务价格表中
   - 用于展示给客户参考

**价格货币**：
- 每种价格都支持两种货币：**人民币（CNY）**和**印尼盾（IDR）**
- 可以只设置一种货币，也可以两种都设置
- 系统会根据汇率自动转换

**示例**：
```
服务：印尼工作签证 B211

成本价（供应商A）：
- CNY：1,000元
- IDR：2,000,000盾

渠道价（我们给代理的价格）：
- CNY：1,200元
- IDR：2,400,000盾

直客价（我们给直接客户的价格）：
- CNY：1,500元
- IDR：3,000,000盾

列表价（公开报价）：
- CNY：2,000元
- IDR：4,000,000盾
```

---

## 8.3 业务流程

### 8.3.1 供应商关联服务流程

**场景**：为供应商添加可以提供的服务

**流程步骤**：

1. **选择供应商**
   - 在供应商列表中选择要操作的供应商
   - 系统显示该供应商的基本信息

2. **选择服务**
   - 浏览系统中的所有服务列表
   - 可以按分类筛选服务
   - 选择要添加的服务（可以多选）

3. **设置默认信息**
   - 设置默认成本价（人民币和/或印尼盾）
   - 设置是否可用（默认可用）
   - 设置是否主要供应商（默认否）
   - 这些信息可以后续修改

4. **批量添加**
   - 系统批量创建供应商-服务关联
   - 如果服务已经关联过，会跳过（不会重复添加）
   - 返回成功和失败的数量

5. **后续管理**
   - 可以查看供应商提供的所有服务
   - 可以修改每个服务的成本价、处理天数等信息
   - 可以设置服务的可用性

**业务规则**：
- 一个供应商可以关联多个服务
- 一个服务可以被多个供应商提供
- 同一个供应商对同一个服务只能有一条关联记录（不会重复）

### 8.3.2 设置供应商成本价流程

**场景**：为供应商的某个服务设置成本价

**流程步骤**：

1. **选择供应商和服务**
   - 在供应商详情页面，选择要设置价格的服务
   - 系统显示该服务的当前价格信息

2. **设置价格**
   - 输入成本价（人民币和/或印尼盾）
   - 至少需要设置一种货币的价格
   - 可以只设置人民币，也可以只设置印尼盾，或者两种都设置

3. **设置生效时间**
   - 可以设置价格生效的时间（默认是明天）
   - 如果设置了未来的生效时间，当前价格会继续有效，直到新价格生效
   - 支持价格历史记录，可以查看价格变化历史

4. **保存价格**
   - 系统保存价格信息
   - 如果设置了未来生效时间，会创建价格历史记录
   - 价格生效后，会自动更新供应商-服务关联中的成本价

**业务规则**：
- 价格必须至少设置一种货币（人民币或印尼盾）
- 生效时间最早只能选择明天（不能设置今天或过去的时间）
- 如果存在未生效的价格，只能修改价格，不能修改生效时间
- 价格变化会记录在价格历史中，可以追溯

### 8.3.3 批量设置价格流程

**场景**：为供应商的多个服务批量设置价格

**流程步骤**：

1. **选择供应商**
   - 在供应商详情页面，查看该供应商提供的所有服务

2. **选择要更新的服务**
   - 可以全选，也可以选择部分服务
   - 系统显示每个服务的当前价格

3. **设置统一价格**
   - 设置统一的成本价（人民币和/或印尼盾）
   - 设置统一的处理天数（可选）
   - 设置统一的可用性（可选）
   - 这些设置会应用到所有选中的服务

4. **批量更新**
   - 系统批量更新所有选中服务的价格
   - 返回成功和失败的数量
   - 如果某个服务更新失败，不影响其他服务

**业务规则**：
- 批量操作只能由系统管理员执行
- 批量设置的价格会立即生效（不支持设置未来生效时间）
- 如果某个服务已经存在未生效的价格，批量操作会跳过该服务

### 8.3.4 查看供应商服务列表流程

**场景**：查看某个供应商提供的所有服务

**流程步骤**：

1. **进入供应商详情**
   - 在供应商列表中选择供应商
   - 系统显示供应商的基本信息

2. **查看服务列表**
   - 系统显示该供应商提供的所有服务
   - 服务按分类分组显示（使用折叠面板）
   - 每个分类显示服务数量

3. **查看服务详情**
   - 点击分类可以展开查看该分类下的所有服务
   - 每个服务显示：
     - 服务名称、编码
     - 成本价（人民币和印尼盾）
     - 处理天数
     - 是否可用
     - 是否主要供应商
     - 价格历史（如果有）

4. **操作服务**
   - 可以编辑单个服务的价格
   - 可以查看价格历史
   - 可以设置服务的可用性

**业务规则**：
- 服务按分类分组，未分类的服务放在最后
- 每个服务显示供应商特定的信息（成本价、处理天数等）
- 可以查看价格变化历史

---

## 8.4 价格管理规则

### 8.4.1 成本价管理

**成本价的特点**：
- 成本价是供应商给我们的价格
- 每个供应商对同一服务有不同的成本价
- 成本价存储在供应商-服务关联中

**成本价设置规则**：
1. **必须至少设置一种货币**：人民币或印尼盾，至少设置一种
2. **支持双货币**：可以同时设置人民币和印尼盾，系统会根据汇率转换
3. **生效时间**：可以设置价格立即生效，也可以设置未来生效时间
4. **价格历史**：每次价格变化都会记录在价格历史中

**成本价使用场景**：
- 计算利润：销售价格 - 成本价 = 利润
- 选择供应商：比较不同供应商的成本价，选择价格最优的
- 成本核算：用于财务成本核算和利润分析

### 8.4.2 销售价格管理

**销售价格的特点**：
- 销售价格是我们对外销售的价格
- 包括渠道价、直客价、列表价三种类型
- 销售价格存储在服务价格表中

**销售价格设置规则**：
1. **价格类型**：必须指定价格类型（渠道价/直客价/列表价）
2. **货币支持**：每种价格类型都支持人民币和印尼盾两种货币
3. **通用价格 vs 供应商特定价格**：
   - 通用价格：适用于所有供应商（organization_id = NULL）
   - 供应商特定价格：只适用于特定供应商（organization_id = 供应商ID）
   - 如果同时存在，优先使用供应商特定价格
4. **生效时间**：支持设置价格生效和失效时间
5. **价格历史**：价格变化会记录在价格历史表中

**销售价格使用场景**：
- **渠道价**：给渠道代理的价格，通常较低，让代理有利润空间
- **直客价**：给直接客户的价格，通常比渠道价高，比列表价低
- **列表价**：公开报价，最高价格，用于展示和参考

### 8.4.3 价格生效时间管理

**生效时间规则**：
1. **立即生效**：如果不设置生效时间，价格立即生效
2. **未来生效**：可以设置价格在未来某个时间生效
3. **最早时间**：价格生效时间最早只能选择明天（不能设置今天或过去的时间）
4. **价格过渡**：如果设置了未来生效时间，当前价格会继续有效，直到新价格生效

**价格历史记录**：
- 每次价格变化都会记录在价格历史表中
- 记录内容包括：旧价格、新价格、生效时间、变更原因、操作人等
- 可以查看价格变化历史，追溯价格变化轨迹

**示例**：
```
2024年1月1日：设置成本价为 1,000 CNY，立即生效
2024年1月15日：设置新成本价为 1,100 CNY，生效时间为 2024年2月1日
- 2024年1月15日 - 2024年1月31日：成本价为 1,000 CNY（旧价格继续有效）
- 2024年2月1日之后：成本价为 1,100 CNY（新价格生效）
```

---

## 8.5 供应商选择逻辑

### 8.5.1 供应商优先级

**优先级规则**：
1. **主要供应商优先**：如果某个供应商被标记为"主要供应商"，优先选择
2. **优先级数字**：数字越小优先级越高（1比2优先级高）
3. **可用性检查**：只选择可用（is_available = True）的供应商
4. **价格比较**：如果优先级相同，比较成本价，选择价格更低的

**示例**：
```
服务：印尼工作签证 B211

供应商A：
- 是否主要供应商：是
- 优先级：1
- 成本价：1,000 CNY
- 是否可用：是

供应商B：
- 是否主要供应商：否
- 优先级：2
- 成本价：900 CNY
- 是否可用：是

供应商C：
- 是否主要供应商：否
- 优先级：1
- 成本价：1,200 CNY
- 是否可用：否（不可用）

选择结果：优先选择供应商A（主要供应商，优先级高）
```

### 8.5.2 供应商选择流程

**自动选择流程**：
1. **筛选可用供应商**：只考虑可用（is_available = True）的供应商
2. **检查主要供应商**：如果有主要供应商，优先选择主要供应商
3. **比较优先级**：如果都是主要供应商或都不是，比较优先级数字
4. **比较价格**：如果优先级相同，比较成本价，选择价格更低的
5. **返回供应商**：返回选中的供应商信息

**手动选择**：
- 在创建订单时，可以手动选择供应商
- 系统会显示所有可用的供应商及其价格信息
- 可以根据价格、处理时间等因素手动选择

---

## 8.6 数据关系说明

### 8.6.1 核心数据关系

**三个核心实体**：
1. **服务（Product）**：企业服务产品
2. **供应商（Supplier/Organization）**：提供服务的组织
3. **供应商-服务关联（VendorProduct）**：供应商和服务之间的关联关系

**关系说明**：
- **多对多关系**：一个供应商可以提供多个服务，一个服务可以被多个供应商提供
- **关联信息**：供应商-服务关联中存储供应商提供该服务的特定信息（成本价、处理天数等）
- **价格信息**：成本价存储在关联中，销售价格存储在服务价格表中

### 8.6.2 价格数据存储

**成本价存储**：
- 存储在供应商-服务关联表（vendor_products）中
- 每个供应商对每个服务有一条关联记录
- 关联记录中包含成本价（人民币和印尼盾）

**销售价格存储**：
- 存储在服务价格表（product_prices）中
- 可以是通用价格（适用于所有供应商），也可以是供应商特定价格
- 支持价格生效时间管理

**价格历史存储**：
- 成本价历史存储在供应商产品价格历史表（vendor_product_price_history）中
- 销售价格历史存储在服务价格历史表（product_price_history）中
- 记录每次价格变化，可以追溯历史

---

## 8.7 销售价格独立设计

### 8.7.1 设计背景与问题

**当前 products 表中的销售价格字段**：
- **渠道价**：price_channel_idr, price_channel_cny
- **直客价**：price_direct_idr, price_direct_cny  
- **列表价**：price_list_idr, price_list_cny
- **历史遗留字段**：price_list, price_channel, price_cost（单货币，已废弃）
- **辅助字段**：default_currency, exchange_rate, price_status, price_locked

**存在的问题**：
1. **价格变动频繁**：销售价格会频繁调整，但 products 表主要存储产品基本信息（名称、描述、分类等），价格变动不应该影响产品基本信息
2. **无法追踪历史**：products 表中的价格字段只能存储当前价格，无法记录价格变化历史，无法追溯某个时间点的价格
3. **时间有效性缺失**：无法支持价格生效时间和失效时间，无法提前设置未来生效的价格
4. **价格管理功能不足**：无法记录价格变更原因、审核流程、变更人等管理信息
5. **订单价格保护**：订单创建后，如果 products 表中的价格调整，会影响已创建订单的价格，需要快照机制保护

### 8.7.2 独立设计方案

**核心设计思路**：
将销售价格从 products 表中独立出来，使用专门的价格表进行管理，实现价格与产品信息的解耦。

**重要设计决策**：
- **一条记录包含所有价格**：一个产品对应一条价格记录，一条记录包含该产品的所有价格类型和货币（渠道价、直客价、列表价的IDR和CNY）
- **原因**：改价格时通常是四个价格一起改动，一条记录更方便管理和维护

**表结构设计**：

1. **product_prices 表**（核心价格表）
   - **用途**：存储所有类型的销售价格（渠道价、直客价、列表价）
   - **关键字段**：
     - `product_id`：产品ID（外键 → products.id）
     - `organization_id`：组织ID（NULL表示通用价格，非NULL表示特定组织价格）
     - **价格字段**（一条记录包含所有价格）：
       - `price_channel_idr`：渠道价-IDR
       - `price_channel_cny`：渠道价-CNY
       - `price_direct_idr`：直客价-IDR
       - `price_direct_cny`：直客价-CNY
       - `price_list_idr`：列表价-IDR
       - `price_list_cny`：列表价-CNY
     - `exchange_rate`：汇率（用于计算）
     - `effective_from`：生效时间
     - `effective_to`：失效时间（NULL表示当前有效）
     - `source`：价格来源（manual, import, contract）
     - `change_reason`：变更原因
     - `changed_by`：变更人ID
   - **设计特点**：
     - **一条记录包含所有价格**：一个产品对应一条价格记录，包含所有价格类型和货币
     - 支持通用价格和特定组织价格（organization_id = NULL 表示通用价格）
     - 支持价格生效时间和失效时间管理
     - 支持价格变更原因记录
     - 改价格时通常是四个价格一起改动，一条记录更方便

2. **product_price_list 表**（客户等级价格表）
   - **用途**：存储客户等级价格（level2-6），用于不同客户等级的差异化定价
   - **关键字段**：
     - `product_id`：产品ID
     - `price_level2_cny/idr`：等级2价格（央企总部和龙头企业）
     - `price_level3_cny/idr`：等级3价格（国有企业和上市公司）
     - `price_level4_cny/idr`：等级4价格（非上市品牌公司）
     - `price_level5_cny/idr`：等级5价格（中小型企业）
     - `price_level6_cny/idr`：等级6价格（个人创业小公司）
     - `effective_from`：生效开始时间
     - `effective_to`：生效结束时间
   - **设计特点**：
     - 一个产品一条记录，包含所有客户等级的价格
     - 支持时间有效性管理
     - 与 product_prices 表配合使用，提供更细粒度的价格管理

3. **order_price_snapshots 表**（订单价格快照表）
   - **用途**：在订单创建时保存价格快照，确保订单价格不受后续价格调整影响
   - **关键字段**：
     - `order_id`：订单ID
     - `product_id`：产品ID
     - `price_type`：价格类型（channel, direct, list）
     - `currency`：货币类型
     - `unit_price`：单价快照
     - `exchange_rate`：汇率快照
     - `customer_level_code`：客户等级代码
     - `customer_level_price`：客户等级价格
     - `snapshot_at`：快照时间
   - **设计特点**：
     - 订单创建时自动保存价格快照
     - 确保订单价格在订单生命周期内保持不变
     - 支持订单价格追溯和审计

4. **price_change_logs 表**（价格变更日志表）
   - **用途**：记录所有价格变更的详细信息，用于审计和追溯
   - **关键字段**：
     - `product_id`：产品ID
     - `price_id`：价格ID（外键 → product_prices.id）
     - `change_type`：变更类型（create, update, delete, activate, deactivate）
     - `price_type`：价格类型
     - `old_price`：变更前价格
     - `new_price`：变更后价格
     - `price_change_amount`：价格变动金额
     - `price_change_percentage`：价格变动百分比
     - `change_reason`：变更原因
     - `changed_by`：变更人ID
     - `affected_orders_count`：受影响订单数量（预估）
   - **设计特点**：
     - 记录每次价格变更的完整信息
     - 支持价格变动影响分析
     - 用于价格审计和追溯

**价格查询逻辑**：
- 查询当前有效价格：从 product_prices 表中查询 `effective_from <= NOW() AND (effective_to IS NULL OR effective_to >= NOW())` 的记录
- 优先使用特定组织价格：如果 organization_id 不为 NULL，优先使用；否则使用通用价格（organization_id = NULL）
- 客户等级价格：从 product_price_list 表中查询对应客户等级的价格
- **重要**：一条记录包含所有价格类型和货币，查询时直接获取对应字段即可

### 8.7.3 设计优势

1. **价格与产品解耦**
   - 产品基本信息（名称、描述、分类）与价格信息分离
   - 价格调整不影响产品基本信息
   - 符合单一职责原则

2. **完整的价格历史追踪**
   - 通过 product_prices 表的时间有效性字段，可以查询任意时间点的价格
   - 通过 price_change_logs 表，可以追溯每次价格变更的详细信息
   - 支持价格审计和合规要求

3. **灵活的时间有效性管理**
   - 支持价格生效时间和失效时间
   - 可以提前设置未来生效的价格
   - 支持价格过渡期管理

4. **订单价格保护**
   - 通过 order_price_snapshots 表，订单创建时保存价格快照
   - 确保订单价格在订单生命周期内保持不变
   - 即使后续价格调整，订单价格不受影响

5. **细粒度的价格管理**
   - 支持通用价格和特定组织价格
   - 支持客户等级价格（product_price_list）
   - 支持价格审核流程
   - 支持价格变更原因记录

6. **价格变更影响分析**
   - 通过 price_change_logs 表记录价格变动影响
   - 可以预估受影响订单数量
   - 支持价格策略优化

### 8.7.4 迁移策略

**过渡期策略**：
1. **保留兼容性**：products 表中的价格字段暂时保留，用于向后兼容
2. **逐步迁移**：新价格设置统一使用 product_prices 表
3. **数据同步**：在过渡期间，可以考虑将 products 表中的价格同步到 product_prices 表
4. **查询逻辑**：优先从 product_prices 表查询价格，如果不存在则从 products 表查询（兼容旧数据）

**最终目标**：
- 完全使用 product_prices 表管理销售价格
- products 表仅保留产品基本信息（名称、描述、分类、状态等）
- 移除 products 表中的价格字段（price_channel_idr, price_channel_cny, price_direct_idr, price_direct_cny, price_list_idr, price_list_cny 等）

### 8.7.5 价格快照机制

**快照时机**：
- 在订单创建时，自动保存订单中所有产品的价格快照
- 快照包括：价格类型、货币、单价、汇率、客户等级价格等

**快照作用**：
1. **价格保护**：确保订单价格在订单生命周期内保持不变
2. **价格追溯**：可以查询订单创建时的价格，用于审计和追溯
3. **价格对比**：可以对比订单价格与当前价格，分析价格变动影响

**快照查询**：
- 通过 order_id 查询订单的所有价格快照
- 通过 product_id 查询某个产品的所有订单价格快照
- 支持价格快照的时间范围查询

### 8.7.6 价格生效时间业务规则

#### 8.7.6.1 核心业务规则

**规则1: 第一条价格必须立即生效**
- 如果产品没有价格记录，设置的第一条价格必须立即生效
- 无论用户设置什么生效时间，第一条价格都强制立即生效
- 系统会记录警告日志，提示用户生效时间被调整

**规则2: 已有未来价格时禁止创建新未来价格**
- 如果产品已有未来生效的价格，在新价格生效前不能创建更多未来价格
- 只能创建立即生效的价格（更新当前价格）
- 如果没有未来价格，允许创建未来价格
- **业务价值**：避免价格时间线混乱，确保价格变更的可预测性，便于提前公告

#### 8.7.6.2 价格生效时间处理逻辑

**立即生效价格（effective_from = None 或 <= 当前时间）**：
- 当前有效价格的 `effective_to` = 当前时间
- 新价格的 `effective_from` = 当前时间
- 新价格的 `effective_to` = None（表示当前有效）

**未来生效价格（effective_from > 当前时间，且没有其他未来价格）**：
- 当前有效价格的 `effective_to` = 新价格生效时间 - 1秒
- 新价格的 `effective_from` = 指定的未来时间
- 新价格的 `effective_to` = None（表示当前有效）
- **业务价值**：在生效时间之前，可以提前公告给销售和相关人员，旧价格仍然有效

**过去生效价格（effective_from < 当前时间，历史修正）**：
- 检查在 `effective_from` 时间点是否有其他价格记录
- 如果冲突，将冲突价格立即失效或删除
- 当前有效价格的 `effective_to` = 当前时间
- 新价格的 `effective_from` = 指定的过去时间

**时间线连续性**：
- 价格生效时间线必须连续，不能有重叠
- 旧价格的 `effective_to` = 新价格的 `effective_from` - 1秒
- 确保查询时能准确获取指定时间点的价格

#### 8.7.6.3 价格验证规则（参考主流CRM系统）

**基础验证**：
- ✅ 产品必须存在
- ✅ 产品状态必须为 `active`
- ✅ 产品价格不能锁定
- ✅ 价格不能为负数
- ✅ 价格为0时给出警告

**价格合理性验证**：
- ✅ 价格不能低于成本价（警告）
- ✅ 价格层级关系：列表价 >= 直客价 >= 渠道价（警告）

**价格变动幅度验证**：
- ✅ 价格变动超过10%时给出警告
- ✅ 价格变动超过50%时给出严重警告

**生效时间验证**：
- ✅ 生效时间不能早于1年前
- ✅ 生效时间不能晚于1年后
- ✅ 未来生效价格建议至少提前1天设置

**其他验证**：
- ✅ 价格修改频率验证（7天内超过5次警告）
- ✅ 变更原因验证（建议填写，至少5个字符）
- ✅ 汇率一致性验证（IDR和CNY价格之间的汇率一致性，容差5%）

**验证结果处理**：
- 如果有错误，抛出异常，阻止价格更新
- 如果有警告，记录日志，但不阻止价格更新

---

## 8.8 权限管理

### 8.8.1 操作权限

**查看权限**：
- 所有用户都可以查看供应商列表和服务列表
- 所有用户都可以查看供应商提供的服务
- 所有用户都可以查看价格信息

**修改权限**：
- **只有系统管理员可以修改供应商价格**
- 普通用户不能修改供应商成本价
- 普通用户不能批量添加供应商服务
- 普通用户不能批量更新价格

**权限检查**：
- 系统在执行价格修改操作前，会检查用户角色
- 只有角色为"ADMIN"的用户才能执行修改操作
- 如果权限不足，系统会拒绝操作并返回错误信息

---

## 8.9 业务场景示例

### 8.9.1 场景一：新供应商入驻

**业务场景**：
一家新的签证服务公司要成为我们的供应商，需要提供"印尼工作签证 B211"和"印尼商务签证 B211A"两个服务。

**操作流程**：
1. 在系统中创建供应商信息（名称、联系方式等）
2. 选择该供应商，进入供应商详情页面
3. 点击"批量添加产品"按钮
4. 选择"印尼工作签证 B211"和"印尼商务签证 B211A"
5. 设置默认成本价（例如：B211 为 1,000 CNY，B211A 为 800 CNY）
6. 设置是否可用为"是"
7. 点击"确认添加"
8. 系统批量创建关联，返回成功数量

**结果**：
- 供应商成功关联了两个服务
- 每个服务都有默认的成本价
- 可以在供应商详情页面查看和管理这些服务

### 8.9.2 场景二：供应商价格调整

**业务场景**：
供应商A通知我们，从下个月1号开始，"印尼工作签证 B211"的成本价从 1,000 CNY 调整为 1,100 CNY。

**操作流程**：
1. 进入供应商A的详情页面
2. 找到"印尼工作签证 B211"服务
3. 点击"编辑价格"按钮
4. 输入新的成本价：1,100 CNY
5. 设置生效时间为下个月1号
6. 点击"保存"

**结果**：
- 当前价格（1,000 CNY）继续有效，直到下个月1号
- 下个月1号开始，价格自动更新为 1,100 CNY
- 价格变化记录在价格历史中，可以查看

### 8.9.3 场景三：批量更新价格

**业务场景**：
供应商B通知我们，他们提供的所有签证类服务的成本价都统一调整为 900 CNY，处理天数统一为 5 天。

**操作流程**：
1. 进入供应商B的详情页面
2. 查看该供应商提供的所有服务
3. 筛选出所有签证类服务（可以通过分类筛选）
4. 点击"批量设置价格"按钮
5. 设置统一的成本价：900 CNY
6. 设置统一的处理天数：5 天
7. 选择要更新的服务（可以全选）
8. 点击"应用"

**结果**：
- 所有选中的服务的成本价都更新为 900 CNY
- 所有选中的服务的处理天数都更新为 5 天
- 系统返回成功更新的数量

### 8.9.4 场景四：选择供应商

**业务场景**：
客户需要办理"印尼工作签证 B211"，我们需要选择最合适的供应商。

**选择逻辑**：
1. 系统查询所有提供"印尼工作签证 B211"服务的供应商
2. 筛选出可用的供应商（is_available = True）
3. 检查是否有主要供应商，如果有，优先选择
4. 如果没有主要供应商，比较优先级数字
5. 如果优先级相同，比较成本价，选择价格更低的
6. 返回选中的供应商信息

**结果**：
- 系统自动选择最合适的供应商
- 显示供应商信息、成本价、处理天数等
- 可以手动选择其他供应商（如果需要）

---

## 8.10 常见问题

### 8.10.1 一个服务可以有多个供应商吗？

**答案**：可以。

一个服务可以由多个供应商提供，这是系统的核心功能。例如，"印尼工作签证 B211"可以由供应商A、供应商B、供应商C等多个供应商提供，每个供应商有不同的成本价、处理天数等。

### 8.10.2 一个供应商可以提供多个服务吗？

**答案**：可以。

一个供应商可以提供多个服务。例如，供应商A可以提供"印尼工作签证"、"公司注册"、"财税服务"等多个服务。

### 8.10.3 成本价和销售价格有什么区别？

**答案**：
- **成本价**：供应商给我们的价格，存储在供应商-服务关联中，每个供应商对同一服务有不同的成本价
- **销售价格**：我们对外销售的价格，包括渠道价、直客价、列表价，存储在服务价格表中，可以是通用价格或供应商特定价格

### 8.10.4 价格可以设置未来生效时间吗？

**答案**：可以。

价格可以设置未来生效时间。如果设置了未来生效时间，当前价格会继续有效，直到新价格生效。价格生效时间最早只能选择明天（不能设置今天或过去的时间）。

### 8.10.5 谁可以修改供应商价格？

**答案**：只有系统管理员可以修改供应商价格。

普通用户只能查看价格信息，不能修改。系统在执行价格修改操作前会检查用户角色，只有角色为"ADMIN"的用户才能执行修改操作。

### 8.10.6 价格历史可以查看吗？

**答案**：可以。

每次价格变化都会记录在价格历史中，可以查看价格变化历史，追溯价格变化轨迹。价格历史包括：旧价格、新价格、生效时间、变更原因、操作人等。

---

## 8.11 总结

服务多供应商多价格管理系统实现了以下核心功能：

1. **多供应商管理**：一个服务可以由多个供应商提供，一个供应商可以提供多个服务
2. **价格体系**：支持成本价、渠道价、直客价、列表价四种价格类型，每种价格支持人民币和印尼盾两种货币
3. **价格管理**：支持设置价格生效时间，支持价格历史记录，可以追溯价格变化
4. **批量操作**：支持批量添加供应商服务，支持批量更新价格，提高操作效率
5. **供应商选择**：根据主要供应商、优先级、价格等因素自动选择最合适的供应商
6. **权限控制**：只有系统管理员可以修改供应商价格，确保数据安全

通过这个系统，我们可以灵活管理供应商和服务，实现价格策略的精细化管理，提高业务效率和利润水平。
