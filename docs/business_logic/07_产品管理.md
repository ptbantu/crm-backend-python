# 7. 产品管理

## 7.1 创建产品

### 核心业务逻辑说明
创建产品/服务，支持多币种定价（IDR、CNY），设置服务属性（处理时间、加急选项等），并关联产品分类。

### 详细业务逻辑

#### 7.1.1 产品创建流程
1. **验证输入数据**
   - 验证产品编码唯一性（如果提供编码）
   - 验证产品名称不能为空

2. **验证产品分类**
   - 如果指定了产品分类，验证分类是否存在且激活
   - 分类必须存在且`is_active = True`

3. **创建产品记录**
   - 设置产品基本信息（名称、编码、分类）
   - 设置服务属性（服务类型、子类型、有效期、处理天数等）
   - 设置多币种价格（成本价、渠道价、直销价、挂牌价）
   - 设置加急选项（是否支持加急、加急处理天数、加急加价）
   - 设置佣金信息（佣金率、佣金金额）
   - 设置服务级别（SLA描述、服务级别）
   - 设置产品状态（激活/暂停）
   - 设置所需文档、备注、标签等

4. **返回创建结果**
   - 返回产品信息（包含分类名称）

### 关键文件路径
- **API端点**: `service_management/api/v1/products.py` - `POST /api/v1/products`
- **服务层**: `service_management/services/product_service.py` - `ProductService.create_product()`
- **数据访问层**: `service_management/repositories/product_repository.py`
- **模型定义**: `common/models/product.py` - `Product`
- **关联模型**: `common/models/product_category.py` - `ProductCategory`

### 代码位置引用
```python
# service_management/services/product_service.py
async def create_product(self, request: ProductCreateRequest) -> ProductResponse:
    # 1. 检查编码是否已存在
    if request.code:
        existing = await self.product_repo.get_by_code(request.code)
        if existing:
            raise BusinessException(detail=f"产品编码 {request.code} 已存在")
    
    # 2. 验证产品分类
    if request.category_id:
        category = await self.category_repo.get_by_id(request.category_id)
        if not category:
            raise BusinessException(detail="分类不存在")
        if not category.is_active:
            raise BusinessException(detail="分类未激活")
    
    # 3. 创建产品
    product = Product(
        name=request.name,
        code=request.code,
        category_id=request.category_id,
        service_type=request.service_type,
        validity_period=request.validity_period,
        processing_days=request.processing_days,
        is_urgent_available=request.is_urgent_available,
        urgent_processing_days=request.urgent_processing_days,
        urgent_price_surcharge=request.urgent_price_surcharge,
        price_cost_idr=request.price_cost_idr,
        price_cost_cny=request.price_cost_cny,
        price_channel_idr=request.price_channel_idr,
        price_channel_cny=request.price_channel_cny,
        price_direct_idr=request.price_direct_idr,
        price_direct_cny=request.price_direct_cny,
        price_list_idr=request.price_list_idr,
        price_list_cny=request.price_list_cny,
        default_currency=request.default_currency,
        commission_rate=request.commission_rate,
        service_level=request.service_level,
        status=request.status,
        is_active=request.is_active,
    )
    product = await self.product_repo.create(product)
    
    return self._to_response(product, category_name)
```

### 潜在问题与注意事项
1. **产品编码**: 产品编码可选，但如果提供必须唯一
2. **多币种定价**: 支持IDR和CNY两种币种，需要维护汇率信息
3. **加急选项**: 加急服务需要额外加价，处理时间更短
4. **产品状态**: 产品可以暂停（`status = 'suspended'`），暂停原因记录在`suspended_reason`字段

---

## 7.2 更新产品

### 核心业务逻辑说明
更新产品信息，包括基本信息、价格、服务属性等。

### 详细业务逻辑
1. **验证产品存在**
   - 查询产品是否存在

2. **验证输入数据**
   - 如果修改产品编码，验证新编码唯一性（排除自身）
   - 如果修改产品分类，验证分类存在且激活

3. **更新产品信息**
   - 更新产品基本信息
   - 更新服务属性
   - 更新价格信息
   - 更新佣金信息
   - 更新其他字段

4. **价格历史记录**
   - 如果价格发生变化，可以记录价格历史（`product_price_history`表）

5. **返回更新结果**

### 关键文件路径
- **API端点**: `service_management/api/v1/products.py` - `PUT /api/v1/products/{product_id}`
- **服务层**: `service_management/services/product_service.py` - `ProductService.update_product()`
- **模型定义**: `common/models/product_price_history.py` - `ProductPriceHistory`

---

## 7.3 查询产品列表

### 核心业务逻辑说明
查询产品列表，支持分页、搜索和多种过滤条件。

### 详细业务逻辑
1. **查询过滤**
   - 支持按产品名称、编码搜索
   - 支持按产品分类过滤
   - 支持按服务类型过滤
   - 支持按产品状态过滤（激活/暂停）
   - 支持按标签过滤

2. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

3. **返回结果**
   - 返回产品列表（包含分类名称、价格信息）

### 关键文件路径
- **API端点**: `service_management/api/v1/products.py` - `GET /api/v1/products`
- **服务层**: `service_management/services/product_service.py` - `ProductService.get_product_list()`

---

## 7.4 查询产品详情

### 核心业务逻辑说明
根据产品ID查询产品详细信息，包括基本信息、价格、服务属性等。

### 详细业务逻辑
1. **验证产品存在**
   - 查询产品是否存在

2. **查询关联数据**
   - 查询产品分类信息
   - 查询产品价格历史（可选）
   - 查询供应商产品信息（可选）

3. **返回结果**
   - 返回完整的产品信息

### 关键文件路径
- **API端点**: `service_management/api/v1/products.py` - `GET /api/v1/products/{product_id}`
- **服务层**: `service_management/services/product_service.py` - `ProductService.get_product_by_id()`

---

## 7.5 产品分类管理

### 核心业务逻辑说明
管理产品分类，支持分类层级关系（父分类、子分类），用于产品分类展示和筛选。

### 详细业务逻辑

#### 7.5.1 创建产品分类
1. **验证输入数据**
   - 验证分类编码唯一性
   - 验证分类名称不能为空

2. **验证父分类**
   - 如果指定了父分类，验证父分类存在且激活
   - 检查循环引用（不能创建循环引用）

3. **创建分类记录**
   - 设置分类基本信息（编码、名称、描述）
   - 设置父分类ID
   - 设置显示顺序

4. **返回创建结果**

#### 7.5.2 查询分类树
1. **查询所有分类**
   - 按组织过滤（如果分类是组织级别的）

2. **构建分类树**
   - 根据父分类ID构建树形结构
   - 按显示顺序排序

3. **返回分类树**

### 关键文件路径
- **API端点**: `service_management/api/v1/product_categories.py`
- **服务层**: `service_management/services/product_category_service.py`
- **模型定义**: `common/models/product_category.py` - `ProductCategory`

---

## 7.6 产品价格管理

### 核心业务逻辑说明
管理产品价格，支持多币种定价，记录价格历史，支持不同销售渠道的不同价格。

### 详细业务逻辑
1. **价格类型**
   - 成本价（`price_cost_*`）：产品成本价格
   - 渠道价（`price_channel_*`）：渠道销售价格
   - 直销价（`price_direct_*`）：直销价格
   - 挂牌价（`price_list_*`）：公开挂牌价格

2. **币种支持**
   - IDR（印尼盾）
   - CNY（人民币）
   - 需要维护汇率（`exchange_rate`）

3. **价格历史**
   - 价格变更时记录历史（`product_price_history`表）
   - 包含变更时间、变更前价格、变更后价格、变更原因

### 关键文件路径
- **模型定义**: `common/models/product.py` - `Product`（价格字段）
- **模型定义**: `common/models/product_price_history.py` - `ProductPriceHistory`

---

## 7.7 服务类型管理

### 核心业务逻辑说明
管理系统服务类型，用于产品分类和服务属性定义。

### 详细业务逻辑

#### 7.7.1 创建服务类型
1. **验证输入数据**
   - 验证服务类型代码唯一性
   - 验证服务类型名称不能为空

2. **创建服务类型记录**
   - 设置服务类型基本信息（代码、名称、描述）
   - 设置显示顺序

3. **返回创建结果**

#### 7.7.2 查询服务类型列表
1. **查询所有服务类型**
   - 支持按状态过滤（激活/禁用）

2. **返回服务类型列表**

### 关键文件路径
- **API端点**: `service_management/api/v1/service_types.py`
- **服务层**: `service_management/services/service_type_service.py`
- **模型定义**: `common/models/service_type.py` - `ServiceType`


