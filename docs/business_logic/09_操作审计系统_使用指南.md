# 操作审计系统 - 使用指南

**创建日期**: 2024-12-13  
**版本**: v1.0

---

## 快速开始

### 1. 导入审计服务

```python
from foundation_service.services.audit_service import AuditService
from foundation_service.decorators import audit_log, get_request_context
from fastapi import Request, Depends
from foundation_service.dependencies import get_db, get_current_user
```

### 2. 基础使用（手动记录）

```python
@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    """创建产品"""
    audit_service = AuditService(db)
    
    # 创建产品
    product = await product_service.create_product(request)
    
    # 记录审计日志
    await audit_service.log_operation(
        operation_type="CREATE",
        entity_type="products",
        entity_id=product.id,
        user_id=current_user.id,
        username=current_user.username,
        data_after=product.dict() if hasattr(product, 'dict') else None,
        **get_request_context(http_request) if http_request else {}
    )
    
    return product
```

### 3. 使用装饰器（推荐）

```python
from foundation_service.decorators import audit_log

@audit_log(
    operation_type="CREATE",
    entity_type="products",
    get_entity_id=lambda result: result.data.id if hasattr(result, 'data') else None,
    get_data_after=lambda result: result.data.dict() if hasattr(result, 'data') and hasattr(result.data, 'dict') else None
)
@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user)
):
    """创建产品"""
    product = await product_service.create_product(request)
    return Result.success(data=product)
```

---

## 详细使用示例

### 示例1：创建操作

```python
@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    audit_service = AuditService(db)
    
    try:
        product = await product_service.create_product(request)
        
        # 记录成功审计日志
        await audit_service.log_operation(
            operation_type="CREATE",
            entity_type="products",
            entity_id=product.id,
            user_id=current_user.id,
            username=current_user.username,
            data_after=product.dict() if hasattr(product, 'dict') else None,
            status="SUCCESS",
            **get_request_context(http_request) if http_request else {}
        )
        
        return Result.success(data=product)
    except Exception as e:
        # 记录失败审计日志
        await audit_service.log_operation(
            operation_type="CREATE",
            entity_type="products",
            user_id=current_user.id,
            username=current_user.username,
            status="FAILURE",
            error_message=str(e),
            error_code=type(e).__name__,
            **get_request_context(http_request) if http_request else {}
        )
        raise
```

### 示例2：更新操作（记录变更）

```python
@router.put("/products/{product_id}")
async def update_product(
    product_id: str,
    request: ProductUpdateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    audit_service = AuditService(db)
    
    # 查询更新前的数据
    old_product = await product_service.get_product_by_id(product_id)
    
    # 执行更新
    new_product = await product_service.update_product(product_id, request)
    
    # 计算变更字段
    changed_fields = []
    if old_product and new_product:
        old_dict = old_product.dict() if hasattr(old_product, 'dict') else {}
        new_dict = new_product.dict() if hasattr(new_product, 'dict') else {}
        changed_fields = [k for k in new_dict.keys() if old_dict.get(k) != new_dict.get(k)]
    
    # 记录审计日志
    await audit_service.log_operation(
        operation_type="UPDATE",
        entity_type="products",
        entity_id=product_id,
        user_id=current_user.id,
        username=current_user.username,
        data_before=old_product.dict() if old_product and hasattr(old_product, 'dict') else None,
        data_after=new_product.dict() if hasattr(new_product, 'dict') else None,
        changed_fields=changed_fields,
        status="SUCCESS",
        **get_request_context(http_request) if http_request else {}
    )
    
    return Result.success(data=new_product)
```

### 示例3：删除操作

```python
@router.delete("/products/{product_id}")
async def delete_product(
    product_id: str,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    audit_service = AuditService(db)
    
    # 查询删除前的数据
    product = await product_service.get_product_by_id(product_id)
    
    # 执行删除
    await product_service.delete_product(product_id)
    
    # 记录审计日志
    await audit_service.log_operation(
        operation_type="DELETE",
        entity_type="products",
        entity_id=product_id,
        user_id=current_user.id,
        username=current_user.username,
        data_before=product.dict() if product and hasattr(product, 'dict') else None,
        status="SUCCESS",
        **get_request_context(http_request) if http_request else {}
    )
    
    return Result.success()
```

### 示例4：价格变更操作

```python
@router.put("/products/{product_id}/sales-price")
async def update_sales_price(
    product_id: str,
    request: SalesPriceUpdateRequest,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    audit_service = AuditService(db)
    
    # 查询更新前的价格
    old_price = await price_service.get_sales_price(product_id)
    
    # 执行更新
    new_price = await price_service.update_sales_price(product_id, request)
    
    # 记录审计日志
    await audit_service.log_operation(
        operation_type="PRICE_CHANGE",
        entity_type="product_price_list",
        entity_id=new_price.id if hasattr(new_price, 'id') else None,
        user_id=current_user.id,
        username=current_user.username,
        data_before=old_price,
        data_after=new_price.dict() if hasattr(new_price, 'dict') else None,
        changed_fields=["price_level2_cny", "price_level3_cny", ...],  # 实际变更的字段
        status="SUCCESS",
        notes="更新销售价格",
        **get_request_context(http_request) if http_request else {}
    )
    
    return Result.success(data=new_price)
```

### 示例5：批量操作（使用batch_id）

```python
@router.post("/products/batch-import")
async def batch_import_products(
    file: UploadFile,
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
    http_request: Request = None
):
    import uuid
    
    audit_service = AuditService(db)
    batch_id = str(uuid.uuid4())  # 生成批次ID
    
    products = await import_service.import_from_excel(file)
    
    # 批量记录审计日志
    for product in products:
        await audit_service.log_operation(
            operation_type="CREATE",
            entity_type="products",
            entity_id=product.id,
            user_id=current_user.id,
            username=current_user.username,
            data_after=product.dict() if hasattr(product, 'dict') else None,
            operation_source="IMPORT",
            batch_id=batch_id,  # 关联到同一个批次
            **get_request_context(http_request) if http_request else {}
        )
    
    return Result.success(data={"batch_id": batch_id, "count": len(products)})
```

---

## 查询审计日志

### 查询某个实体的变更历史

```python
@router.get("/products/{product_id}/audit-history")
async def get_product_audit_history(
    product_id: str,
    page: int = Query(1, ge=1),
    size: int = Query(20, ge=1, le=100),
    db: AsyncSession = Depends(get_db)
):
    """查询产品的变更历史"""
    audit_service = AuditService(db)
    
    history = await audit_service.get_entity_history(
        entity_type="products",
        entity_id=product_id,
        page=page,
        size=size
    )
    
    return Result.success(data=history)
```

### 查询某个用户的操作记录

```python
@router.get("/users/{user_id}/audit-logs")
async def get_user_audit_logs(
    user_id: str,
    start_date: Optional[datetime] = Query(None),
    end_date: Optional[datetime] = Query(None),
    page: int = Query(1, ge=1),
    size: int = Query(20, ge=1, le=100),
    db: AsyncSession = Depends(get_db)
):
    """查询用户的操作记录"""
    audit_service = AuditService(db)
    
    logs = await audit_service.get_audit_logs(
        user_id=user_id,
        start_date=start_date,
        end_date=end_date,
        page=page,
        size=size
    )
    
    return Result.success(data=logs)
```

---

## 最佳实践

### 1. 统一使用审计服务

在所有关键操作中使用审计服务，包括：
- CRUD操作（创建、更新、删除）
- 价格变更
- 状态变更
- 权限变更
- 登录/登出

### 2. 记录完整的上下文信息

- 总是传递 `user_id` 和 `username`
- 总是传递请求上下文（IP、User-Agent等）
- 记录操作前后的数据（特别是UPDATE和DELETE操作）

### 3. 错误处理

- 操作成功和失败都要记录
- 失败时记录错误信息和错误码
- 审计日志记录失败不应该影响主业务

### 4. 性能考虑

- 审计日志记录是异步的，不阻塞主业务
- 大数据量操作使用 `batch_id` 关联
- 定期归档历史审计日志

---

## 注意事项

1. **数据序列化**: 确保 `data_before` 和 `data_after` 中的数据可以被JSON序列化
2. **敏感信息**: 不要在审计日志中记录密码、token等敏感信息
3. **数据量**: 对于大对象，可以只记录关键字段
4. **性能**: 审计日志记录是异步的，但大量记录仍可能影响性能

---

**更新日期**: 2024-12-13
