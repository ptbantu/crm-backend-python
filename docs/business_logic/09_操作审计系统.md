# 操作审计系统

**创建日期**: 2024-12-13  
**版本**: v1.0  
**状态**: 设计阶段

**重要说明**: 本系统设计为新增功能，**不修改现有的代码结构**。审计日志记录在API层添加，复用现有的 `get_current_user_id` 函数获取用户信息。详见 [集成指南](./09_操作审计系统_集成指南.md)

---

## 目录

1. [概述](#1-概述)
2. [审计需求](#2-审计需求)
3. [数据库设计](#3-数据库设计)
4. [审计服务设计](#4-审计服务设计)
5. [实现方案](#5-实现方案)
6. [使用示例](#6-使用示例)

---

## 1. 概述

### 1.1 业务目标

实现全系统操作审计，记录所有关键操作，包括：
- **操作记录**: 谁、什么时候、做了什么操作
- **数据变更**: 操作前后的数据变化
- **操作结果**: 操作成功或失败
- **操作上下文**: IP地址、用户代理、请求路径等

### 1.2 审计范围

需要审计的操作类型：
- **CREATE**: 创建记录（产品、订单、客户等）
- **UPDATE**: 更新记录
- **DELETE**: 删除记录
- **VIEW**: 查看敏感信息（可选）
- **LOGIN**: 用户登录
- **LOGOUT**: 用户登出
- **PRICE_CHANGE**: 价格变更
- **STATUS_CHANGE**: 状态变更
- **PERMISSION_CHANGE**: 权限变更

需要审计的业务对象：
- 产品/服务
- 订单/订单项
- 客户/联系人
- 用户/角色/权限
- 组织
- 价格（销售价格、成本价格）
- 报销记录
- 文件上传/删除

---

## 2. 审计需求

### 2.1 必须记录的信息

1. **操作基本信息**:
   - 操作类型（CREATE/UPDATE/DELETE等）
   - 操作对象（表名、记录ID）
   - 操作时间
   - 操作人（用户ID、用户名）

2. **数据变更信息**:
   - 操作前的数据（JSON格式）
   - 操作后的数据（JSON格式）
   - 变更字段列表

3. **操作上下文**:
   - IP地址
   - 用户代理（User-Agent）
   - 请求路径
   - 请求方法
   - 请求参数

4. **操作结果**:
   - 操作状态（SUCCESS/FAILURE）
   - 错误信息（如果失败）

### 2.2 可选记录的信息

- 操作耗时
- 操作批次号（用于关联多个操作）
- 操作备注
- 操作来源（API/后台/导入等）

---

## 3. 数据库设计

### 3.1 审计日志表（operation_audit_logs）

```sql
CREATE TABLE `operation_audit_logs` (
  `id` CHAR(36) NOT NULL DEFAULT (UUID()),
  
  -- 操作基本信息
  `operation_type` VARCHAR(50) NOT NULL COMMENT '操作类型: CREATE, UPDATE, DELETE, VIEW, LOGIN, LOGOUT等',
  `entity_type` VARCHAR(100) NOT NULL COMMENT '实体类型（表名）: products, orders, customers等',
  `entity_id` CHAR(36) DEFAULT NULL COMMENT '实体ID（记录ID）',
  
  -- 操作人信息
  `user_id` CHAR(36) NOT NULL COMMENT '操作人ID',
  `username` VARCHAR(255) DEFAULT NULL COMMENT '操作人用户名（冗余字段，便于查询）',
  `organization_id` CHAR(36) DEFAULT NULL COMMENT '操作人所属组织ID',
  
  -- 操作时间
  `operated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  
  -- 数据变更
  `data_before` JSON DEFAULT NULL COMMENT '操作前的数据（JSON格式）',
  `data_after` JSON DEFAULT NULL COMMENT '操作后的数据（JSON格式）',
  `changed_fields` JSON DEFAULT NULL COMMENT '变更字段列表（JSON数组）',
  
  -- 操作上下文
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT 'IP地址',
  `user_agent` VARCHAR(500) DEFAULT NULL COMMENT '用户代理',
  `request_path` VARCHAR(500) DEFAULT NULL COMMENT '请求路径',
  `request_method` VARCHAR(10) DEFAULT NULL COMMENT '请求方法（GET/POST/PUT/DELETE）',
  `request_params` JSON DEFAULT NULL COMMENT '请求参数（JSON格式）',
  
  -- 操作结果
  `status` VARCHAR(20) NOT NULL DEFAULT 'SUCCESS' COMMENT '操作状态: SUCCESS, FAILURE',
  `error_message` TEXT DEFAULT NULL COMMENT '错误信息（如果失败）',
  `error_code` VARCHAR(50) DEFAULT NULL COMMENT '错误码',
  
  -- 其他信息
  `operation_source` VARCHAR(50) DEFAULT 'API' COMMENT '操作来源: API, ADMIN, IMPORT, BATCH等',
  `batch_id` CHAR(36) DEFAULT NULL COMMENT '批次ID（用于关联多个操作）',
  `duration_ms` INT DEFAULT NULL COMMENT '操作耗时（毫秒）',
  `notes` TEXT DEFAULT NULL COMMENT '备注说明',
  
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  PRIMARY KEY (`id`),
  KEY `ix_audit_operation_type` (`operation_type`),
  KEY `ix_audit_entity` (`entity_type`, `entity_id`),
  KEY `ix_audit_user` (`user_id`),
  KEY `ix_audit_organization` (`organization_id`),
  KEY `ix_audit_operated_at` (`operated_at` DESC),
  KEY `ix_audit_status` (`status`),
  KEY `ix_audit_batch` (`batch_id`),
  CONSTRAINT `fk_audit_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_audit_organization` FOREIGN KEY (`organization_id`) REFERENCES `organizations` (`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='操作审计日志表';
```

### 3.2 索引设计

- `ix_audit_operation_type`: 按操作类型查询
- `ix_audit_entity`: 按实体类型和ID查询（查询某个记录的变更历史）
- `ix_audit_user`: 按用户查询（查询某个用户的操作记录）
- `ix_audit_organization`: 按组织查询
- `ix_audit_operated_at`: 按时间查询（时间倒序）
- `ix_audit_status`: 按状态查询（查询失败的操作）
- `ix_audit_batch`: 按批次查询（查询批量操作）

---

## 4. 审计服务设计

### 4.1 AuditService（审计服务）

**功能**:
- `log_operation()` - 记录操作
- `get_audit_logs()` - 查询审计日志
- `get_entity_history()` - 查询某个实体的变更历史

**设计原则**:
- 异步记录，不阻塞主业务
- 支持批量记录
- 自动提取请求上下文（IP、User-Agent等）
- 自动序列化数据变更

### 4.2 审计装饰器

**功能**:
- 自动记录函数调用
- 自动提取参数和返回值
- 自动记录执行时间
- 自动捕获异常

### 4.3 审计中间件

**功能**:
- 自动记录所有API请求
- 自动提取请求上下文
- 支持过滤（不记录某些操作）

---

## 5. 实现方案

### 5.1 方案一：装饰器模式（推荐）

**优点**:
- 灵活，可以选择性地审计
- 代码侵入性小
- 可以自定义审计逻辑

**缺点**:
- 需要在每个函数上添加装饰器
- 可能遗漏某些操作

**实现**:
```python
@audit_log(operation_type="CREATE", entity_type="products")
async def create_product(request: ProductCreateRequest):
    # 业务逻辑
    pass
```

### 5.2 方案二：中间件模式

**优点**:
- 自动记录所有API请求
- 无需修改业务代码
- 统一管理

**缺点**:
- 可能记录过多无用信息
- 难以记录业务层面的操作（如价格变更）

**实现**:
```python
@app.middleware("http")
async def audit_middleware(request, call_next):
    # 记录请求
    # 调用下一个中间件
    # 记录响应
    pass
```

### 5.3 方案三：混合模式（推荐）

**结合装饰器和中间件**:
- 中间件：记录所有API请求（基础审计）
- 装饰器：记录关键业务操作（详细审计）

---

## 6. 使用示例

### 6.1 基础使用

```python
from foundation_service.services.audit_service import AuditService

audit_service = AuditService(db)

# 记录操作
await audit_service.log_operation(
    operation_type="CREATE",
    entity_type="products",
    entity_id=product.id,
    user_id=current_user.id,
    data_before=None,
    data_after=product.dict(),
    status="SUCCESS"
)
```

### 6.2 使用装饰器

```python
from foundation_service.decorators import audit_log

@audit_log(operation_type="CREATE", entity_type="products")
async def create_product(request: ProductCreateRequest):
    product = await service.create_product(request)
    return product
```

### 6.3 查询审计日志

```python
# 查询某个产品的变更历史
history = await audit_service.get_entity_history(
    entity_type="products",
    entity_id=product_id
)

# 查询某个用户的操作记录
user_logs = await audit_service.get_audit_logs(
    user_id=user_id,
    start_date=start_date,
    end_date=end_date
)
```

---

## 7. 实施计划

### 7.1 第一阶段：基础功能

- [ ] 创建审计日志表
- [ ] 实现 AuditService
- [ ] 实现审计装饰器
- [ ] 实现审计中间件

### 7.2 第二阶段：集成到关键模块

- [ ] 产品管理模块
- [ ] 订单管理模块
- [ ] 客户管理模块
- [ ] 用户管理模块
- [ ] 价格管理模块

### 7.3 第三阶段：查询和报表

- [ ] 审计日志查询API
- [ ] 变更历史查询API
- [ ] 审计报表

---

**更新日期**: 2024-12-13  
**版本**: v1.0
