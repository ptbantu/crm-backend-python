# 3. 组织管理

## 3.1 创建组织

### 核心业务逻辑说明
系统管理员创建新组织，自动创建组织管理员用户，并初始化组织的基础数据（角色、权限等）。

### 详细业务逻辑

#### 3.1.1 组织创建流程
1. **验证权限**
   - 只有系统管理员可以创建组织

2. **验证输入数据**
   - 验证组织名称唯一性
   - 验证组织代码唯一性（如果提供）
   - 验证邮箱格式（如果提供）

3. **创建组织记录**
   - 生成组织ID（UUID）
   - 设置组织基本信息（名称、代码、类型等）
   - 设置组织状态（默认激活）
   - 设置组织商业信息（行业、规模、地址等）

4. **创建组织管理员**
   - 自动创建管理员用户账号
   - 用户名格式：`admin@{organization_code}` 或 `admin@{organization_id}`
   - 初始密码：系统生成或使用默认密码
   - 分配管理员角色（`admin`角色）

5. **初始化组织数据**
   - 创建默认角色（管理员、销售、客服等）
   - 分配默认权限给角色
   - 创建组织域名关联（如果提供域名）

6. **返回创建结果**
   - 返回组织信息
   - 返回管理员账号信息（包含初始密码）

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `POST /api/v1/organizations`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.create_organization()`
- **数据访问层**: `foundation_service/repositories/organization_repository.py`
- **模型定义**: `common/models/organization.py` - `Organization`
- **关联模型**: `common/models/user.py` - `User`
- **关联模型**: `common/models/organization_employee.py` - `OrganizationEmployee`

### 代码位置引用
```python
# foundation_service/services/organization_service.py
async def create_organization(
    self, 
    request: OrganizationCreateRequest, 
    created_by: str
) -> OrganizationResponse:
    # 1. 验证组织名称唯一性
    existing = await self.org_repo.get_by_name(request.name)
    if existing:
        raise BusinessException(detail="组织名称已存在", status_code=400)
    
    # 2. 验证组织代码唯一性
    if request.code:
        existing = await self.org_repo.get_by_code(request.code)
        if existing:
            raise BusinessException(detail="组织代码已存在", status_code=400)
    
    # 3. 创建组织
    organization = Organization(
        id=str(uuid.uuid4()),
        name=request.name,
        code=request.code,
        organization_type=request.organization_type,
        industry=request.industry,
        scale=request.scale,
        address=request.address,
        city=request.city,
        province=request.province,
        country=request.country,
        postal_code=request.postal_code,
        contact_email=request.contact_email,
        contact_phone=request.contact_phone,
        is_active=True,
    )
    organization = await self.org_repo.create(organization)
    
    # 4. 创建管理员用户
    admin_username = f"admin@{organization.code or organization.id}"
    admin_password = generate_random_password()  # 或使用默认密码
    
    admin_user = User(
        id=f"{organization.id}-0001",
        username=admin_username,
        email=request.admin_email,
        password_hash=hash_password(admin_password),
        full_name="系统管理员",
        is_active=True,
    )
    admin_user = await self.user_repo.create(admin_user)
    
    # 5. 创建组织员工关系
    org_employee = OrganizationEmployee(
        user_id=admin_user.id,
        organization_id=organization.id,
        employee_number="0001",
        department="管理部",
        position="管理员",
        is_active=True,
    )
    await self.org_employee_repo.create(org_employee)
    
    # 6. 分配管理员角色
    admin_role = await self.role_repo.get_by_code("admin", organization.id)
    if admin_role:
        user_role = UserRole(user_id=admin_user.id, role_id=admin_role.id)
        await self.user_role_repo.create(user_role)
    
    await self.db.commit()
    return OrganizationResponse(
        ...,
        admin_account={
            "username": admin_username,
            "password": admin_password,  # 仅创建时返回
        }
    )
```

### 潜在问题与注意事项
1. **管理员账号**: 创建组织时自动创建管理员，确保组织有初始管理员
2. **初始密码**: 初始密码应通过安全方式（邮件、短信）发送给管理员
3. **默认角色**: 需要预先定义默认角色模板，或从系统模板复制
4. **组织代码**: 组织代码用于生成管理员用户名，应确保唯一性

---

## 3.2 更新组织

### 核心业务逻辑说明
更新组织基本信息，包括名称、地址、联系方式等，但不能修改组织ID和代码。

### 详细业务逻辑
1. **验证权限**
   - 只有组织管理员可以更新组织信息

2. **验证输入数据**
   - 验证组织名称唯一性（如果修改名称）
   - 验证邮箱格式（如果修改邮箱）

3. **更新组织信息**
   - 更新组织基本信息
   - 更新组织商业信息
   - 更新组织财务信息（如果提供）

4. **返回更新结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `PUT /api/v1/organizations/{organization_id}`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.update_organization()`

---

## 3.3 查询组织列表

### 核心业务逻辑说明
系统管理员查询所有组织列表，支持分页、搜索和过滤。

### 详细业务逻辑
1. **验证权限**
   - 只有系统管理员可以查看所有组织
   - 普通用户只能查看自己所属的组织

2. **查询过滤**
   - 支持按组织名称、代码搜索
   - 支持按组织类型、行业过滤
   - 支持按状态过滤（激活/禁用）

3. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

4. **返回结果**
   - 返回组织列表
   - 包含组织基本信息

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `GET /api/v1/organizations`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.get_organization_list()`

---

## 3.4 查询组织详情

### 核心业务逻辑说明
根据组织ID查询组织详细信息，包括基本信息、商业信息、财务信息等。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有查看组织详情的权限
   - 普通用户只能查看自己所属的组织

2. **查询组织信息**
   - 查询组织基本信息
   - 查询组织商业信息
   - 查询组织财务信息
   - 查询组织认证信息

3. **返回结果**
   - 返回完整的组织信息

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `GET /api/v1/organizations/{organization_id}`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.get_organization_by_id()`

---

## 3.5 锁定/解锁组织

### 核心业务逻辑说明
系统管理员可以锁定或解锁组织，锁定后组织下所有用户无法登录。

### 详细业务逻辑
1. **验证权限**
   - 只有系统管理员可以锁定/解锁组织

2. **更新组织状态**
   - 锁定：设置`is_locked = True`，记录锁定时间和原因
   - 解锁：设置`is_locked = False`，清除锁定信息

3. **影响用户**
   - 锁定组织后，组织下所有用户无法登录
   - 解锁组织后，用户可以正常登录（如果用户本身未被锁定）

4. **返回结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `POST /api/v1/organizations/{organization_id}/lock`, `POST /api/v1/organizations/{organization_id}/unlock`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.lock_organization()`, `OrganizationService.unlock_organization()`

---

## 3.6 组织域名管理

### 核心业务逻辑说明
管理组织的域名关联，支持多域名绑定，用于单点登录（SSO）和域名识别。

### 详细业务逻辑
1. **添加域名**
   - 验证域名格式
   - 验证域名唯一性（一个域名只能绑定一个组织）
   - 创建`organization_domains`记录
   - 创建`organization_domain_relations`记录

2. **删除域名**
   - 删除域名关联记录
   - 检查是否有其他关联

3. **查询域名列表**
   - 根据组织ID查询所有关联域名

### 关键文件路径
- **API端点**: `foundation_service/api/v1/organizations.py` - `POST /api/v1/organizations/{organization_id}/domains`
- **服务层**: `foundation_service/services/organization_service.py` - `OrganizationService.add_domain()`, `OrganizationService.remove_domain()`
- **模型定义**: `common/models/organization_domain.py` - `OrganizationDomain`, `OrganizationDomainRelation`


