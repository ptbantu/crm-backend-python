# 2. 用户管理

## 2.1 创建用户

### 核心业务逻辑说明
管理员创建新用户，系统自动生成用户ID（基于组织ID和序列号），设置初始密码，并分配角色。

### 详细业务逻辑

#### 2.1.1 用户创建流程
1. **验证权限**
   - 检查当前用户是否有创建用户的权限
   - 验证用户所属组织

2. **验证输入数据**
   - 验证用户名/邮箱唯一性
   - 验证邮箱格式
   - 验证手机号格式（如果提供）
   - 验证密码强度（如果提供）

3. **生成用户ID**
   - 查询组织下当前最大用户序列号
   - 生成格式：`{organization_id}-{sequence_number}`
   - 例如：`org-001-0001`

4. **创建用户记录**
   - 如果提供了密码，使用bcrypt哈希密码
   - 设置用户基本信息（姓名、邮箱、手机等）
   - 设置用户状态（默认激活）
   - 设置用户所属组织（通过`organization_employees`表）

5. **分配角色**
   - 如果提供了角色列表，创建`user_roles`记录
   - 验证角色是否存在且属于同一组织

6. **返回创建结果**
   - 返回用户基本信息（不包含密码）

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `POST /api/v1/users`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.create_user()`
- **数据访问层**: `foundation_service/repositories/user_repository.py`
- **模型定义**: `common/models/user.py` - `User`
- **关联模型**: `common/models/organization_employee.py` - `OrganizationEmployee`
- **关联模型**: `common/models/user_role.py` - `UserRole`

### 代码位置引用
```python
# foundation_service/services/user_service.py
async def create_user(self, request: UserCreateRequest, created_by: str) -> UserResponse:
    # 1. 验证用户名/邮箱唯一性
    existing = await self.user_repo.get_by_username_or_email(
        request.username or request.email
    )
    if existing:
        raise BusinessException(detail="用户名或邮箱已存在", status_code=400)
    
    # 2. 获取组织信息
    org_employee = await self.org_employee_repo.get_by_user_id(created_by)
    if not org_employee:
        raise BusinessException(detail="创建者不属于任何组织", status_code=400)
    
    # 3. 生成用户ID
    max_sequence = await self.user_repo.get_max_sequence_by_organization(
        org_employee.organization_id
    )
    user_id = f"{org_employee.organization_id}-{str(max_sequence + 1).zfill(4)}"
    
    # 4. 哈希密码
    password_hash = hash_password(request.password) if request.password else None
    
    # 5. 创建用户
    user = User(
        id=user_id,
        username=request.username,
        email=request.email,
        password_hash=password_hash,
        full_name=request.full_name,
        phone=request.phone,
        is_active=request.is_active if request.is_active is not None else True,
    )
    user = await self.user_repo.create(user)
    
    # 6. 创建组织员工关系
    org_employee = OrganizationEmployee(
        user_id=user.id,
        organization_id=org_employee.organization_id,
        employee_number=request.employee_number,
        department=request.department,
        position=request.position,
        is_active=True,
    )
    await self.org_employee_repo.create(org_employee)
    
    # 7. 分配角色
    if request.role_ids:
        for role_id in request.role_ids:
            user_role = UserRole(user_id=user.id, role_id=role_id)
            await self.user_role_repo.create(user_role)
    
    await self.db.commit()
    return UserResponse.model_validate(user)
```

### 潜在问题与注意事项
1. **用户ID生成**: 用户ID基于组织ID和序列号，确保在同一组织内唯一
2. **密码处理**: 如果未提供密码，用户需要通过密码重置流程设置密码
3. **组织关联**: 用户必须通过`organization_employees`表关联到组织
4. **角色验证**: 分配的角色必须属于同一组织

---

## 2.2 更新用户

### 核心业务逻辑说明
更新用户基本信息，包括姓名、邮箱、手机、部门、职位等，但不能修改用户ID和密码（密码需单独接口）。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有更新用户的权限
   - 验证用户是否属于同一组织（普通用户只能更新自己）

2. **验证输入数据**
   - 验证邮箱唯一性（如果修改邮箱）
   - 验证手机号格式（如果修改手机）

3. **更新用户信息**
   - 更新用户基本信息
   - 更新组织员工信息（部门、职位等）

4. **更新角色**
   - 如果提供了角色列表，先删除旧角色，再创建新角色

5. **返回更新结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `PUT /api/v1/users/{user_id}`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.update_user()`

---

## 2.3 查询用户列表

### 核心业务逻辑说明
根据组织ID查询用户列表，支持分页、搜索和过滤。

### 详细业务逻辑
1. **数据隔离**
   - 只能查询当前用户所属组织的用户
   - 管理员可以查看所有用户，普通用户只能查看自己

2. **查询过滤**
   - 支持按姓名、邮箱、手机号搜索
   - 支持按部门、职位过滤
   - 支持按状态过滤（激活/禁用）

3. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

4. **返回结果**
   - 返回用户列表（不包含密码）
   - 包含用户所属组织和角色信息

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `GET /api/v1/users`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.get_user_list()`
- **数据访问层**: `foundation_service/repositories/user_repository.py` - `get_list()`

---

## 2.4 查询用户详情

### 核心业务逻辑说明
根据用户ID查询用户详细信息，包括基本信息、组织信息、角色和权限。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有查看用户详情的权限
   - 验证用户是否属于同一组织

2. **查询用户信息**
   - 查询用户基本信息
   - 查询用户所属组织信息
   - 查询用户角色列表
   - 查询用户权限列表

3. **返回结果**
   - 返回完整的用户信息

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `GET /api/v1/users/{user_id}`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.get_user_by_id()`

---

## 2.5 删除用户

### 核心业务逻辑说明
软删除用户（标记为禁用），不能物理删除用户（保留历史数据）。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有删除用户的权限
   - 不能删除自己

2. **检查用户状态**
   - 检查用户是否已被删除
   - 检查用户是否有未完成的业务数据（订单、线索等）

3. **软删除用户**
   - 设置`is_active = False`
   - 设置删除时间和删除人

4. **清理关联数据**
   - 可选：取消用户的所有角色分配

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `DELETE /api/v1/users/{user_id}`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.delete_user()`

---

## 2.6 锁定/解锁用户

### 核心业务逻辑说明
管理员可以锁定或解锁用户账户，锁定后用户无法登录。

### 详细业务逻辑
1. **验证权限**
   - 只有管理员可以锁定/解锁用户
   - 不能锁定自己

2. **更新用户状态**
   - 锁定：设置`is_locked = True`，记录锁定时间和原因
   - 解锁：设置`is_locked = False`，清除锁定信息

3. **返回结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `POST /api/v1/users/{user_id}/lock`, `POST /api/v1/users/{user_id}/unlock`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.lock_user()`, `UserService.unlock_user()`

---

## 2.7 重置密码

### 核心业务逻辑说明
管理员重置用户密码，生成临时密码或发送密码重置链接。

### 详细业务逻辑
1. **验证权限**
   - 只有管理员可以重置其他用户密码

2. **生成新密码**
   - 生成随机密码或临时密码
   - 使用bcrypt哈希密码

3. **更新用户密码**
   - 更新`password_hash`字段
   - 可选：设置`password_reset_required = True`，要求用户首次登录时修改密码

4. **发送通知**
   - 可选：发送密码重置邮件或通知

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `POST /api/v1/users/{user_id}/reset-password`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.reset_password()`

---

## 2.8 修改密码

### 核心业务逻辑说明
用户修改自己的密码，需要提供旧密码进行验证。

### 详细业务逻辑
1. **验证旧密码**
   - 验证提供的旧密码是否正确

2. **验证新密码**
   - 验证新密码强度
   - 验证新密码不能与旧密码相同

3. **更新密码**
   - 使用bcrypt哈希新密码
   - 更新`password_hash`字段
   - 清除`password_reset_required`标志

4. **返回结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/users.py` - `POST /api/v1/users/change-password`
- **服务层**: `foundation_service/services/user_service.py` - `UserService.change_password()`


