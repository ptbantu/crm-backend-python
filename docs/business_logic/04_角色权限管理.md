# 4. 角色权限管理

## 4.1 创建角色

### 核心业务逻辑说明
组织管理员创建新角色，定义角色的名称、代码和描述，并分配权限。

### 详细业务逻辑

#### 4.1.1 角色创建流程
1. **验证权限**
   - 检查当前用户是否有创建角色的权限
   - 验证用户所属组织

2. **验证输入数据**
   - 验证角色代码唯一性（在同一组织内）
   - 验证角色名称不能为空

3. **检查预设角色**
   - 预设角色（如`admin`、`sales`、`customer_service`）不能创建，只能使用
   - 验证角色代码是否与预设角色冲突

4. **创建角色记录**
   - 设置角色基本信息（名称、代码、描述）
   - 设置角色类型（系统角色/自定义角色）
   - 设置角色状态（默认激活）

5. **分配权限**
   - 如果提供了权限列表，创建`role_permissions`记录
   - 验证权限是否存在

6. **返回创建结果**
   - 返回角色信息（包含权限列表）

### 关键文件路径
- **API端点**: `foundation_service/api/v1/roles.py` - `POST /api/v1/roles`
- **服务层**: `foundation_service/services/role_service.py` - `RoleService.create_role()`
- **数据访问层**: `foundation_service/repositories/role_repository.py`
- **模型定义**: `common/models/role.py` - `Role`
- **关联模型**: `common/models/permission.py` - `RolePermission`

### 代码位置引用
```python
# foundation_service/services/role_service.py
async def create_role(
    self, 
    request: RoleCreateRequest, 
    organization_id: str,
    created_by: str
) -> RoleResponse:
    # 1. 验证角色代码唯一性
    existing = await self.role_repo.get_by_code(request.code, organization_id)
    if existing:
        raise BusinessException(detail=f"角色代码 '{request.code}' 已存在", status_code=400)
    
    # 2. 检查预设角色
    preset_roles = ["admin", "sales", "customer_service", "manager"]
    if request.code in preset_roles:
        raise BusinessException(detail="不能创建预设角色", status_code=400)
    
    # 3. 创建角色
    role = Role(
        id=str(uuid.uuid4()),
        code=request.code,
        name=request.name,
        description=request.description,
        organization_id=organization_id,
        role_type="custom",  # 自定义角色
        is_active=request.is_active if request.is_active is not None else True,
    )
    role = await self.role_repo.create(role)
    
    # 4. 分配权限
    if request.permission_ids:
        for permission_id in request.permission_ids:
            permission = await self.permission_repo.get_by_id(permission_id)
            if not permission:
                continue  # 跳过不存在的权限
            
            role_permission = RolePermission(
                role_id=role.id,
                permission_id=permission_id,
            )
            await self.role_permission_repo.create(role_permission)
    
    await self.db.commit()
    await self.db.refresh(role)
    
    # 5. 获取权限列表
    permissions = await self.permission_service.get_role_permissions(role.id)
    
    return RoleResponse(
        id=role.id,
        code=role.code,
        name=role.name,
        description=role.description,
        permissions=[p.code for p in permissions],
        is_active=role.is_active,
        created_at=role.created_at,
        updated_at=role.updated_at,
    )
```

### 潜在问题与注意事项
1. **预设角色**: 预设角色不能修改或删除，只能使用
2. **权限验证**: 分配权限时应验证权限是否存在且属于同一组织
3. **角色代码**: 角色代码在同一组织内必须唯一
4. **权限继承**: 可以考虑实现角色权限继承（父角色权限自动继承给子角色）

---

## 4.2 更新角色

### 核心业务逻辑说明
更新角色信息，包括名称、描述和权限分配，但不能修改角色代码和类型。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有更新角色的权限
   - 不能更新预设角色

2. **验证输入数据**
   - 验证角色名称不能为空

3. **更新角色信息**
   - 更新角色名称和描述
   - 更新角色状态

4. **更新权限**
   - 删除旧权限分配
   - 创建新权限分配

5. **返回更新结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/roles.py` - `PUT /api/v1/roles/{role_id}`
- **服务层**: `foundation_service/services/role_service.py` - `RoleService.update_role()`

---

## 4.3 删除角色

### 核心业务逻辑说明
删除角色，需要检查是否有用户使用该角色，如果有则不能删除。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有删除角色的权限
   - 不能删除预设角色

2. **检查角色使用情况**
   - 查询是否有用户分配了该角色
   - 如果有用户使用，不能删除

3. **删除角色**
   - 删除角色权限关联
   - 删除角色记录

4. **返回删除结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/roles.py` - `DELETE /api/v1/roles/{role_id}`
- **服务层**: `foundation_service/services/role_service.py` - `RoleService.delete_role()`

---

## 4.4 查询角色列表

### 核心业务逻辑说明
根据组织ID查询角色列表，支持分页和搜索。

### 详细业务逻辑
1. **数据隔离**
   - 只能查询当前用户所属组织的角色

2. **查询过滤**
   - 支持按角色名称、代码搜索
   - 支持按角色类型过滤（系统角色/自定义角色）
   - 支持按状态过滤（激活/禁用）

3. **分页处理**
   - 支持分页参数（page, size）
   - 返回总数和分页信息

4. **返回结果**
   - 返回角色列表（包含权限数量）

### 关键文件路径
- **API端点**: `foundation_service/api/v1/roles.py` - `GET /api/v1/roles`
- **服务层**: `foundation_service/services/role_service.py` - `RoleService.get_role_list()`

---

## 4.5 查询角色详情

### 核心业务逻辑说明
根据角色ID查询角色详细信息，包括基本信息、权限列表和用户数量。

### 详细业务逻辑
1. **验证权限**
   - 检查当前用户是否有查看角色详情的权限
   - 验证角色是否属于同一组织

2. **查询角色信息**
   - 查询角色基本信息
   - 查询角色权限列表
   - 查询使用该角色的用户数量

3. **返回结果**
   - 返回完整的角色信息

### 关键文件路径
- **API端点**: `foundation_service/api/v1/roles.py` - `GET /api/v1/roles/{role_id}`
- **服务层**: `foundation_service/services/role_service.py` - `RoleService.get_role_by_id()`

---

## 4.6 权限管理

### 核心业务逻辑说明
管理系统权限，包括权限的创建、更新、查询，以及权限与角色的关联。

### 详细业务逻辑

#### 4.6.1 创建权限
1. **验证权限**
   - 只有系统管理员可以创建权限

2. **验证输入数据**
   - 验证权限代码唯一性
   - 验证权限名称不能为空

3. **创建权限记录**
   - 设置权限基本信息（代码、名称、描述）
   - 设置权限类型（菜单权限/操作权限）
   - 设置权限资源（资源类型、资源ID）

4. **返回创建结果**

#### 4.6.2 查询权限列表
1. **查询所有权限**
   - 支持按权限类型过滤
   - 支持按资源类型过滤

2. **返回权限列表**

#### 4.6.3 分配权限给角色
1. **验证权限**
   - 检查当前用户是否有分配权限的权限

2. **验证输入数据**
   - 验证角色存在
   - 验证权限存在

3. **创建角色权限关联**
   - 创建`role_permissions`记录

4. **返回结果**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/permissions.py`
- **服务层**: `foundation_service/services/permission_service.py`
- **模型定义**: `common/models/permission.py` - `Permission`, `RolePermission`

---

## 4.7 菜单管理

### 核心业务逻辑说明
管理系统菜单，包括菜单的创建、更新、查询，以及菜单与权限的关联。

### 详细业务逻辑

#### 4.7.1 创建菜单
1. **验证权限**
   - 只有系统管理员可以创建菜单

2. **验证输入数据**
   - 验证菜单代码唯一性
   - 验证菜单名称不能为空
   - 如果指定了父菜单，验证父菜单存在

3. **创建菜单记录**
   - 设置菜单基本信息（代码、名称、路径、图标等）
   - 设置菜单层级关系（父菜单ID）
   - 设置菜单显示顺序

4. **关联权限**
   - 如果提供了权限ID，创建`menu_permissions`记录

5. **返回创建结果**

#### 4.7.2 查询菜单树
1. **查询所有菜单**
   - 按组织过滤（如果菜单是组织级别的）

2. **构建菜单树**
   - 根据父菜单ID构建树形结构
   - 按显示顺序排序

3. **过滤用户权限**
   - 根据用户权限过滤菜单（只显示用户有权限的菜单）

4. **返回菜单树**

### 关键文件路径
- **API端点**: `foundation_service/api/v1/menus.py`
- **服务层**: `foundation_service/services/permission_service.py` - `PermissionService.create_menu()`, `PermissionService.get_menu_tree()`
- **模型定义**: `common/models/permission.py` - `Menu`, `MenuPermission`

---

## 4.8 用户权限检查

### 核心业务逻辑说明
检查用户是否有特定权限，用于API接口的权限验证。

### 详细业务逻辑
1. **获取用户角色**
   - 查询用户的所有角色

2. **获取角色权限**
   - 查询所有角色的权限列表
   - 合并去重

3. **检查权限**
   - 检查用户权限列表中是否包含目标权限
   - 支持通配符权限（如`user:*`匹配所有用户相关权限）

4. **返回检查结果**

### 关键文件路径
- **服务层**: `foundation_service/services/permission_service.py` - `PermissionService.check_user_permission()`
- **工具函数**: `common/auth.py` - `require_permission()`（装饰器）

### 代码位置引用
```python
# foundation_service/services/permission_service.py
async def check_user_permission(
    self, 
    user_id: str, 
    permission_code: str
) -> bool:
    """检查用户是否有指定权限"""
    # 1. 获取用户角色
    user_roles = await self.user_role_repo.get_by_user_id(user_id)
    if not user_roles:
        return False
    
    role_ids = [ur.role_id for ur in user_roles]
    
    # 2. 获取角色权限
    role_permissions = await self.role_permission_repo.get_by_role_ids(role_ids)
    permission_codes = {rp.permission.code for rp in role_permissions}
    
    # 3. 检查权限（支持通配符）
    if permission_code in permission_codes:
        return True
    
    # 检查通配符权限
    for code in permission_codes:
        if code.endswith("*") and permission_code.startswith(code[:-1]):
            return True
    
    return False
```


