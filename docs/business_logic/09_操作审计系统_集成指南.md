# 操作审计系统 - 集成指南

**创建日期**: 2024-12-13  
**版本**: v1.0

---

## 概述

本文档说明如何将操作审计系统集成到现有的业务模块中，**复用现有的用户获取逻辑**，不修改现有代码结构。

---

## 现有模式分析

### 1. 用户获取方式

现有代码使用以下方式获取当前用户：

```python
from foundation_service.dependencies import get_current_user_id

# 在API端点中
@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    http_request: Request,
    db: AsyncSession = Depends(get_db)
):
    user_id = get_current_user_id(http_request)
    # 使用user_id
```

### 2. 现有审计字段

部分模型已有审计字段：
- `Order.created_by` / `Order.updated_by`
- 其他模型可能也有类似字段

---

## 集成方案

### 方案：在API层添加审计日志记录

**原则**:
- 不修改现有的服务层代码
- 在API端点中添加审计日志记录
- 复用现有的 `get_current_user_id` 函数
- 审计日志记录失败不影响主业务

### 集成步骤

#### 1. 在API端点中添加审计日志

```python
from foundation_service.services.audit_service import AuditService
from foundation_service.decorators import get_request_context
from foundation_service.dependencies import get_current_user_id
from fastapi import Request

@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    http_request: Request,
    db: AsyncSession = Depends(get_db)
):
    """创建产品"""
    user_id = get_current_user_id(http_request)
    audit_service = AuditService(db)
    
    try:
        # 执行业务逻辑
        service = ProductService(db)
        product = await service.create_product(request)
        
        # 记录审计日志（异步，不阻塞）
        if user_id:
            await audit_service.log_operation(
                operation_type="CREATE",
                entity_type="products",
                entity_id=product.id,
                user_id=user_id,
                data_after=product.dict() if hasattr(product, 'dict') else None,
                status="SUCCESS",
                **get_request_context(http_request)
            )
        
        return Result.success(data=product, message="产品/服务创建成功")
    except Exception as e:
        # 记录失败审计日志
        if user_id:
            await audit_service.log_operation(
                operation_type="CREATE",
                entity_type="products",
                user_id=user_id,
                status="FAILURE",
                error_message=str(e),
                error_code=type(e).__name__,
                **get_request_context(http_request)
            )
        raise
```

#### 2. 更新操作（记录变更）

```python
@router.put("/products/{product_id}")
async def update_product(
    product_id: str,
    request: ProductUpdateRequest,
    http_request: Request,
    db: AsyncSession = Depends(get_db)
):
    """更新产品"""
    user_id = get_current_user_id(http_request)
    audit_service = AuditService(db)
    
    try:
        # 查询更新前的数据
        service = ProductService(db)
        old_product = await service.get_product_by_id(product_id)
        
        # 执行更新
        new_product = await service.update_product(product_id, request)
        
        # 计算变更字段
        changed_fields = []
        if old_product and new_product:
            old_dict = old_product.dict() if hasattr(old_product, 'dict') else {}
            new_dict = new_product.dict() if hasattr(new_product, 'dict') else {}
            changed_fields = [k for k in new_dict.keys() if old_dict.get(k) != new_dict.get(k)]
        
        # 记录审计日志
        if user_id:
            await audit_service.log_operation(
                operation_type="UPDATE",
                entity_type="products",
                entity_id=product_id,
                user_id=user_id,
                data_before=old_product.dict() if old_product and hasattr(old_product, 'dict') else None,
                data_after=new_product.dict() if hasattr(new_product, 'dict') else None,
                changed_fields=changed_fields,
                status="SUCCESS",
                **get_request_context(http_request)
            )
        
        return Result.success(data=new_product, message="产品/服务更新成功")
    except Exception as e:
        if user_id:
            await audit_service.log_operation(
                operation_type="UPDATE",
                entity_type="products",
                entity_id=product_id,
                user_id=user_id,
                status="FAILURE",
                error_message=str(e),
                error_code=type(e).__name__,
                **get_request_context(http_request)
            )
        raise
```

#### 3. 删除操作

```python
@router.delete("/products/{product_id}")
async def delete_product(
    product_id: str,
    http_request: Request,
    db: AsyncSession = Depends(get_db)
):
    """删除产品"""
    user_id = get_current_user_id(http_request)
    audit_service = AuditService(db)
    
    try:
        # 查询删除前的数据
        service = ProductService(db)
        product = await service.get_product_by_id(product_id)
        
        # 执行删除
        await service.delete_product(product_id)
        
        # 记录审计日志
        if user_id:
            await audit_service.log_operation(
                operation_type="DELETE",
                entity_type="products",
                entity_id=product_id,
                user_id=user_id,
                data_before=product.dict() if product and hasattr(product, 'dict') else None,
                status="SUCCESS",
                **get_request_context(http_request)
            )
        
        return Result.success(message="产品/服务删除成功")
    except Exception as e:
        if user_id:
            await audit_service.log_operation(
                operation_type="DELETE",
                entity_type="products",
                entity_id=product_id,
                user_id=user_id,
                status="FAILURE",
                error_message=str(e),
                error_code=type(e).__name__,
                **get_request_context(http_request)
            )
        raise
```

---

## 需要集成的API端点

### 产品管理 (`foundation_service/api/v1/products.py`)

- [ ] `POST /products` - 创建产品
- [ ] `PUT /products/{product_id}` - 更新产品
- [ ] `DELETE /products/{product_id}` - 删除产品

### 订单管理 (`foundation_service/api/v1/orders.py`)

- [ ] `POST /orders` - 创建订单
- [ ] `PUT /orders/{order_id}` - 更新订单
- [ ] `DELETE /orders/{order_id}` - 删除订单

### 订单项管理 (`foundation_service/api/v1/order_items.py`)

- [ ] `POST /order-items` - 创建订单项
- [ ] `PUT /order-items/{item_id}` - 更新订单项
- [ ] `DELETE /order-items/{item_id}` - 删除订单项

### 客户管理 (`foundation_service/api/v1/customers.py`)

- [ ] `POST /customers` - 创建客户
- [ ] `PUT /customers/{customer_id}` - 更新客户
- [ ] `DELETE /customers/{customer_id}` - 删除客户

### 用户管理 (`foundation_service/api/v1/users.py`)

- [ ] `POST /users` - 创建用户
- [ ] `PUT /users/{user_id}` - 更新用户
- [ ] `DELETE /users/{user_id}` - 删除用户
- [ ] `POST /auth/login` - 用户登录（特殊操作）
- [ ] `POST /auth/logout` - 用户登出（特殊操作）

### 价格管理（新增API）

- [ ] `PUT /products/{product_id}/sales-price` - 更新销售价格
- [ ] `POST /providers/{provider_id}/products/{product_id}/cost-price` - 更新成本价格

---

## 辅助函数（可选）

为了简化代码，可以创建一个辅助函数：

```python
# foundation_service/utils/audit_helper.py
from typing import Optional, Dict, Any
from fastapi import Request
from sqlalchemy.ext.asyncio import AsyncSession
from foundation_service.services.audit_service import AuditService
from foundation_service.decorators import get_request_context
from foundation_service.dependencies import get_current_user_id

async def log_audit_operation(
    db: AsyncSession,
    request: Request,
    operation_type: str,
    entity_type: str,
    entity_id: Optional[str] = None,
    data_before: Optional[Dict] = None,
    data_after: Optional[Dict] = None,
    changed_fields: Optional[list] = None,
    status: str = "SUCCESS",
    error_message: Optional[str] = None,
    error_code: Optional[str] = None,
    notes: Optional[str] = None
):
    """
    记录审计日志的辅助函数
    
    自动获取用户ID和请求上下文
    """
    user_id = get_current_user_id(request)
    if not user_id:
        return  # 如果没有用户ID，不记录审计日志
    
    audit_service = AuditService(db)
    await audit_service.log_operation(
        operation_type=operation_type,
        entity_type=entity_type,
        entity_id=entity_id,
        user_id=user_id,
        data_before=data_before,
        data_after=data_after,
        changed_fields=changed_fields,
        status=status,
        error_message=error_message,
        error_code=error_code,
        notes=notes,
        **get_request_context(request)
    )
```

**使用示例**:

```python
from foundation_service.utils.audit_helper import log_audit_operation

@router.post("/products")
async def create_product(
    request: ProductCreateRequest,
    http_request: Request,
    db: AsyncSession = Depends(get_db)
):
    try:
        service = ProductService(db)
        product = await service.create_product(request)
        
        # 记录审计日志
        await log_audit_operation(
            db=db,
            request=http_request,
            operation_type="CREATE",
            entity_type="products",
            entity_id=product.id,
            data_after=product.dict() if hasattr(product, 'dict') else None
        )
        
        return Result.success(data=product)
    except Exception as e:
        await log_audit_operation(
            db=db,
            request=http_request,
            operation_type="CREATE",
            entity_type="products",
            status="FAILURE",
            error_message=str(e),
            error_code=type(e).__name__
        )
        raise
```

---

## 注意事项

1. **不修改服务层**: 审计日志记录只在API层添加，不修改现有的服务层代码
2. **错误处理**: 审计日志记录失败不应该影响主业务，使用try-except包裹
3. **用户ID检查**: 如果没有用户ID（未登录），不记录审计日志
4. **性能**: 审计日志记录是异步的，但大量记录仍可能影响性能，考虑使用后台任务

---

**更新日期**: 2024-12-13
