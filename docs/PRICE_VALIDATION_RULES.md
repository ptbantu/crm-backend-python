# 价格验证规则文档

## 概述

本文档参考市面上主流CRM系统（如Salesforce、Microsoft Dynamics、SAP CRM等）的价格管理最佳实践，定义了全面的价格变更验证规则。

---

## 1. 基础验证规则

### 1.1 产品存在性验证
- ✅ **规则**: 产品必须存在
- **错误级别**: Error
- **错误消息**: "产品 {product_id} 不存在"

### 1.2 产品状态验证
- ✅ **规则**: 产品状态必须为 `active`
- **错误级别**: Error
- **错误消息**: 
  - "产品已停用，无法修改价格"（status = discontinued）
  - "产品已暂停，无法修改价格"（status = suspended）

### 1.3 价格锁定验证
- ✅ **规则**: 产品价格不能锁定
- **错误级别**: Error
- **错误消息**: "产品价格已锁定，无法修改"

---

## 2. 价格值验证规则

### 2.1 价格非负验证
- ✅ **规则**: 价格不能为负数
- **错误级别**: Error
- **错误消息**: "{price_type} 价格不能为负数"

### 2.2 价格为零验证
- ✅ **规则**: 价格为0时给出警告
- **警告级别**: Warning
- **警告消息**: "{price_type} 价格为0，请确认是否正确"

### 2.3 价格精度验证
- ✅ **规则**: 价格精度不能超过2位小数
- **警告级别**: Warning
- **警告消息**: "{price_type} 价格精度超过2位小数，将四舍五入"

---

## 3. 价格合理性验证规则

### 3.1 价格不能低于成本价
- ✅ **规则**: 销售价格不能低于成本价
- **警告级别**: Warning
- **警告消息**: "{price_type} ({price}) 低于成本价 ({cost})，可能导致亏损"
- **业务价值**: 防止定价错误导致亏损

### 3.2 价格层级关系验证
- ✅ **规则**: 列表价 >= 直客价 >= 渠道价
- **警告级别**: Warning
- **警告消息**: 
  - "列表价应大于等于直客价"
  - "直客价应大于等于渠道价"
  - "列表价应大于等于渠道价"
- **业务价值**: 确保价格体系的一致性

---

## 4. 价格变动幅度验证规则

### 4.1 价格变动幅度警告
- ✅ **规则**: 价格变动超过10%时给出警告
- **警告级别**: Warning
- **阈值**: 10%
- **警告消息**: "{price_type} 变动幅度较大 ({percentage}%)，从 {old_price} 变更为 {new_price}"

### 4.2 价格变动幅度严重警告
- ✅ **规则**: 价格变动超过50%时给出严重警告
- **警告级别**: Warning
- **阈值**: 50%
- **警告消息**: "{price_type} 变动幅度过大 ({percentage}%)，从 {old_price} 变更为 {new_price}，请确认是否正确"
- **业务价值**: 防止误操作导致的价格异常变动

---

## 5. 生效时间验证规则

### 5.1 生效时间不能太早
- ✅ **规则**: 生效时间不能早于1年前
- **错误级别**: Error
- **错误消息**: "生效时间不能早于1年前：{effective_from}"

### 5.2 生效时间不能太晚
- ✅ **规则**: 生效时间不能晚于1年后
- **警告级别**: Warning
- **警告消息**: "生效时间较晚（{effective_from}），请确认是否需要提前公告"

### 5.3 未来生效时间建议
- ✅ **规则**: 未来生效价格建议至少提前1天设置
- **警告级别**: Warning
- **警告消息**: "未来生效价格建议至少提前1天设置，以便提前公告给销售和相关人员"
- **业务价值**: 确保有足够时间进行公告和准备

---

## 6. 价格修改频率验证规则

### 6.1 频繁修改警告
- ✅ **规则**: 7天内价格修改超过5次时给出警告
- **警告级别**: Warning
- **阈值**: 7天内5次
- **警告消息**: "该产品在最近7天内已修改价格 {count} 次，频繁修改可能影响业务稳定性"
- **业务价值**: 防止价格频繁变动影响业务稳定性

---

## 7. 变更原因验证规则

### 7.1 变更原因必填建议
- ✅ **规则**: 建议填写价格变更原因
- **警告级别**: Warning
- **警告消息**: "建议填写价格变更原因，便于追溯和审计"

### 7.2 变更原因长度验证
- ✅ **规则**: 变更原因不能太短
- **警告级别**: Warning
- **阈值**: 至少5个字符
- **警告消息**: "价格变更原因过短，建议提供更详细的说明"
- **业务价值**: 确保变更原因有足够的追溯价值

---

## 8. 汇率一致性验证规则

### 8.1 IDR和CNY价格汇率一致性
- ✅ **规则**: IDR和CNY价格之间的汇率应该与产品汇率一致（容差5%）
- **警告级别**: Warning
- **容差**: 5%
- **警告消息**: "{price_type} 汇率不一致：IDR {idr_price} / CNY {cny_price} ≈ {calculated_rate}，产品汇率：{exchange_rate}"
- **业务价值**: 确保多货币价格的一致性

---

## 9. 业务规则验证

### 9.1 第一条价格必须立即生效
- ✅ **规则**: 产品没有价格时，第一条价格必须立即生效
- **实现**: 强制将 `effective_from` 设置为当前时间
- **日志**: 记录警告日志

### 9.2 已有未来价格时禁止创建新未来价格
- ✅ **规则**: 如果产品已有未来价格，禁止创建新的未来价格
- **错误级别**: Error
- **错误消息**: "产品已有未来生效的价格（生效时间: {effective_from}），在新价格生效前不能创建更多未来价格。请先等待现有未来价格生效，或设置立即生效的价格。"
- **业务价值**: 避免价格时间线混乱，确保价格变更的可预测性

---

## 10. 验证结果处理

### 10.1 错误处理
- **行为**: 如果有任何错误，抛出 `BusinessException`，阻止价格更新
- **消息格式**: "价格验证失败：\n- {error1}\n- {error2}"

### 10.2 警告处理
- **行为**: 如果有警告，记录到日志，但不阻止价格更新
- **日志级别**: WARNING
- **日志内容**: 包含所有警告信息

### 10.3 验证详情
- **返回内容**: 
  - `is_valid`: 是否通过验证
  - `errors`: 错误列表
  - `warnings`: 警告列表
  - `validation_details`: 验证详情（如价格变动幅度等）

---

## 11. 参考的CRM系统

### 11.1 Salesforce
- 价格变动幅度验证
- 价格层级关系验证
- 变更原因必填

### 11.2 Microsoft Dynamics 365
- 价格不能低于成本价
- 价格修改频率限制
- 生效时间验证

### 11.3 SAP CRM
- 价格精度验证
- 汇率一致性验证
- 价格历史记录完整性

---

## 12. 实施建议

### 12.1 配置化阈值
建议将以下阈值配置化：
- 价格变动幅度警告阈值（默认10%）
- 价格变动幅度严重警告阈值（默认50%）
- 价格修改频率阈值（默认7天5次）
- 生效时间范围（默认1年）
- 汇率一致性容差（默认5%）

### 12.2 扩展性
- 支持自定义验证规则
- 支持不同产品类别的不同验证规则
- 支持不同组织的不同验证规则

### 12.3 监控和告警
- 记录所有验证结果
- 对频繁的价格变动进行告警
- 对价格异常变动进行告警

---

## 13. 总结

本文档定义了全面的价格验证规则，参考了主流CRM系统的最佳实践，确保：
1. **数据完整性**: 价格数据符合业务规则
2. **业务合理性**: 价格变动符合业务逻辑
3. **可追溯性**: 价格变更原因清晰
4. **稳定性**: 防止价格频繁变动
5. **一致性**: 多货币价格保持一致
