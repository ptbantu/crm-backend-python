# BANTU CRM ID 生成规则手册

本文档详细说明 BANTU CRM 系统中各种业务实体的 ID 生成规则和格式，便于开发人员和用户理解和使用。

## 📋 目录

- [ID 生成规则概述](#id-生成规则概述)
- [标准 ID 格式](#标准-id-格式)
- [各业务实体 ID 模板](#各业务实体-id-模板)
- [特殊 ID 格式](#特殊-id-格式)
- [ID 生成器使用说明](#id-生成器使用说明)
- [常见问题](#常见问题)

---

## ID 生成规则概述

BANTU CRM 系统使用统一的 ID 生成器来管理各种业务实体的 ID，确保：
- ✅ **唯一性**：每个 ID 在系统中唯一
- ✅ **可读性**：ID 包含业务含义（前缀、日期）
- ✅ **可追溯性**：通过 ID 可以了解创建时间
- ✅ **并发安全**：支持高并发场景下的 ID 生成

### ID 类型分类

1. **标准业务 ID**：使用统一生成器（`IDGenerator`）
2. **特殊业务 ID**：有特定格式要求（订单号、报销单号等）
3. **UUID**：用于某些特殊场景（如审计日志 ID）

---

## 标准 ID 格式

### 格式结构

```
{前缀}{日期}{序号}
```

- **前缀**：2-5 个字母，标识业务模块
- **日期**：YYYYMMDD 或 YYYYMMDDHH（按天或按小时分组）
- **序号**：4-5 位数字，从 00001 开始递增

### 示例

```
ORG2024122000001    # 组织ID，2024年12月20日创建的第1个组织
CUS2024122000001    # 客户ID，2024年12月20日创建的第1个客户
ORD2024122000001    # 订单ID，2024年12月20日创建的第1个订单
```

---

## 各业务实体 ID 模板

### 1. 组织 (Organization)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Organization` |
| **前缀** | `ORG` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `ORG{YYYYMMDD}{00001-99999}` |
| **示例** | `ORG2024122000001` |
| **说明** | 每天最多可创建 99,999 个组织 |

### 2. 客户 (Customer)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Customer` |
| **前缀** | `CUS` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `CUS{YYYYMMDD}{00001-99999}` |
| **示例** | `CUS2024122000001` |
| **说明** | 每天最多可创建 99,999 个客户 |

### 3. 订单 (Order)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Order` |
| **前缀** | `ORD` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `ORD{YYYYMMDD}{00001-99999}` |
| **示例** | `ORD2024122000001` |
| **说明** | 每天最多可创建 99,999 个订单 |

### 4. 产品 (Product)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Product` |
| **前缀** | `PRD` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `PRD{YYYYMMDD}{00001-99999}` |
| **示例** | `PRD2024122000001` |
| **说明** | 每天最多可创建 99,999 个产品 |

### 5. 线索 (Lead)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Lead` |
| **前缀** | `LEAD` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `LEAD{YYYYMMDD}{00001-99999}` |
| **示例** | `LEAD2024122000001` |
| **说明** | 每天最多可创建 99,999 个线索 |

### 6. 商机 (Opportunity)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Opportunity` |
| **前缀** | `OPP` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `OPP{YYYYMMDD}{00001-99999}` |
| **示例** | `OPP2024122000001` |
| **说明** | 每天最多可创建 99,999 个商机 |

### 7. 角色 (Role)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Role` |
| **前缀** | `ROLE` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `ROLE{YYYYMMDD}{00001-99999}` |
| **示例** | `ROLE2024122000001` |
| **说明** | 每天最多可创建 99,999 个角色 |

### 8. 权限 (Permission)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Permission` |
| **前缀** | `PERM` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `PERM{YYYYMMDD}{00001-99999}` |
| **示例** | `PERM2024122000001` |
| **说明** | 每天最多可创建 99,999 个权限 |

### 9. 联系人 (Contact)

| 项目 | 值 |
|------|-----|
| **模块名称** | `Contact` |
| **前缀** | `CONT` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `CONT{YYYYMMDD}{00001-99999}` |
| **示例** | `CONT2024122000001` |
| **说明** | 每天最多可创建 99,999 个联系人 |

### 10. 服务记录 (ServiceRecord)

| 项目 | 值 |
|------|-----|
| **模块名称** | `ServiceRecord` |
| **前缀** | `SREC` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `SREC{YYYYMMDD}{00001-99999}` |
| **示例** | `SREC2024122000001` |
| **说明** | 每天最多可创建 99,999 个服务记录 |

### 11. 催款任务 (CollectionTask)

| 项目 | 值 |
|------|-----|
| **模块名称** | `CollectionTask` |
| **前缀** | `CTSK` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `CTSK{YYYYMMDD}{00001-99999}` |
| **示例** | `CTSK2024122000001` |
| **说明** | 每天最多可创建 99,999 个催款任务 |

### 12. 临时链接 (TemporaryLink)

| 项目 | 值 |
|------|-----|
| **模块名称** | `TemporaryLink` |
| **前缀** | `TLNK` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `TLNK{YYYYMMDD}{00001-99999}` |
| **示例** | `TLNK2024122000001` |
| **说明** | 每天最多可创建 99,999 个临时链接 |

### 13. 系统配置 (SystemConfig)

| 项目 | 值 |
|------|-----|
| **模块名称** | `SystemConfig` |
| **前缀** | `SYS` |
| **日期格式** | `YYYYMMDD` |
| **序号长度** | 5 位 |
| **格式** | `SYS{YYYYMMDD}{00001-99999}` |
| **示例** | `SYS2024122000001` |
| **说明** | 每天最多可创建 99,999 个系统配置 |

### 14. 审计日志 (AuditLog)

| 项目 | 值 |
|------|-----|
| **模块名称** | `AuditLog` |
| **前缀** | `AUDIT` |
| **日期格式** | `YYYYMMDDHH`（按小时分组） |
| **序号长度** | 4 位 |
| **格式** | `AUDIT{YYYYMMDDHH}{0001-9999}` |
| **示例** | `AUDIT20241220140001` |
| **说明** | 每小时最多可创建 9,999 条审计日志 |

---

## 特殊 ID 格式

### 1. 用户 ID (User)

用户 ID 使用特殊规则，格式为：`{组织ID前缀}{序号}`

| 项目 | 值 |
|------|-----|
| **模块名称** | `User` |
| **格式** | `{组织ID前N位}{序号}` |
| **最大长度** | 36 位 |
| **示例** | `ORG20241220000011`（组织ID为 `ORG2024122000001`，第1个用户） |
| **说明** | 
- 用户ID基于组织ID生成
- 序号从1开始，为该组织内的用户序号
- 如果组织ID + 序号超过36位，会截断组织ID部分
- 如果序号本身超过36位，只保留序号的后36位

**生成逻辑：**
```python
user_id = f"{organization_id[:max_length]}{sequence}"
# 其中 max_length = 36 - len(str(sequence))
```

### 2. 订单号 (Order Number)

订单号使用特殊格式，包含随机字符串：

| 项目 | 值 |
|------|-----|
| **格式** | `ORD-{YYYYMMDD}-{随机6位字符串}` |
| **示例** | `ORD-20241220-A3B5C7` |
| **说明** | 
- 前缀：`ORD`
- 日期：`YYYYMMDD`
- 随机字符串：6位字母数字组合
- 配置项：`ORDER_NUMBER_PREFIX`（默认：`ORD`）

### 3. 报销单号 (Expense Number)

报销单号按天生成，每天从 001 开始：

| 项目 | 值 |
|------|-----|
| **格式** | `EXP-{YYYYMMDD}-{001-999}` |
| **示例** | `EXP-20241220-001` |
| **说明** | 
- 前缀：`EXP`
- 日期：`YYYYMMDD`
- 序号：每天从 001 开始，最多 999
- 通过数据库触发器自动生成

---

## ID 生成器使用说明

### 代码示例

```python
from common.utils.id_generator import IDGenerator
from sqlalchemy.ext.asyncio import AsyncSession

# 初始化生成器
generator = IDGenerator(db)

# 生成组织ID
org_id = await generator.generate_id("Organization")
# 返回: "ORG2024122000001"

# 生成客户ID
customer_id = await generator.generate_id("Customer")
# 返回: "CUS2024122000001"

# 生成用户ID（需要组织ID）
user_id = await generator.generate_id("User", organization_id="ORG2024122000001")
# 返回: "ORG20241220000011"

# 生成审计日志ID
audit_id = await generator.generate_id("AuditLog")
# 返回: "AUDIT20241220140001"
```

### 配置说明

ID 生成规则配置在 `common/utils/id_config.py`：

```python
# 前缀配置
MODULE_PREFIXES = {
    "Organization": "ORG",
    "Customer": "CUS",
    "Order": "ORD",
    # ...
}

# 序号长度配置
SEQUENCE_LENGTHS = {
    "AuditLog": 4,  # 审计日志使用4位
    "default": 5,   # 默认5位
}

# 日期格式配置
DATE_FORMATS = {
    "AuditLog": "%Y%m%d%H",  # 按小时分组
    "default": "%Y%m%d",      # 按天分组
}
```

---

## 常见问题

### Q1: ID 长度限制是多少？

**A:** 所有 ID 的最大长度为 **36 位**（数据库字段限制）。如果生成的 ID 超过此长度，系统会报错。

### Q2: 如果某天创建的数量超过序号上限怎么办？

**A:** 
- 标准模块（5位序号）：每天最多 99,999 个，超过会报错
- 审计日志（4位序号）：每小时最多 9,999 条，超过会报错
- 建议：如果业务量较大，可以调整序号长度或日期格式

### Q3: ID 可以自定义吗？

**A:** 
- 标准业务 ID：**不建议**自定义，使用统一生成器确保唯一性
- 特殊业务 ID（订单号、报销单号）：可以在配置中修改前缀

### Q4: 如何查看某个 ID 的创建时间？

**A:** 
- 标准 ID：从日期部分提取（第4-11位或第6-15位）
- 例如：`ORG2024122000001` → 2024年12月20日

### Q5: 用户 ID 为什么特殊？

**A:** 
- 用户 ID 需要与组织关联，使用组织 ID 前缀可以快速识别用户所属组织
- 格式：`{组织ID前缀}{序号}`，便于数据隔离和查询

### Q6: 订单号为什么使用随机字符串？

**A:** 
- 订单号需要对外展示，使用随机字符串可以：
  - 避免暴露业务量信息
  - 增加安全性（不易猜测）
  - 保持唯一性

---

## 相关文件

- **ID 生成器**：`common/utils/id_generator.py`
- **ID 配置**：`common/utils/id_config.py`
- **数据库表**：`id_sequences`（存储序号信息）

---

## 更新日志

- **2024-12-27**：创建文档，整理所有业务实体的 ID 生成规则

---

## 联系方式

如有问题或建议，请联系开发团队。
